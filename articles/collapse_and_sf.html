<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>collapse and sf • collapse</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<!-- katex math --><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css" integrity="sha384-nB0miv6/jRmo5UMMR1wu3Gz6NLsoTkbqJghGIsx//Rlm+ZU03BU6SQNC66uf4l5+" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js" integrity="sha384-7zkQWkzuo3B5mTepMUcHkMB5jZaolc2xDwL6VFqjFALcbeS9Ggm/Yr2r3Dy4lfFg" crossorigin="anonymous"></script><script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js" integrity="sha384-43gviWU0YVjaDtb/GhzOouOXtZMP/7XUzwPTstBeZFe/+rCMvRwr4yROQP43s0Xk" crossorigin="anonymous" onload="renderMathInElement(document.body);"></script><script src="../katex-auto.js"></script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="collapse and sf">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">collapse</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Released version">2.1.1</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Documentation</a></li>
<li class="active nav-item"><a class="nav-link" href="../articles/index.html">Vignettes</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">News</a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://sebkrantz.github.io/Rblog/">Blog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://bsky.app/profile/rcollapse.bsky.social" aria-label="BlueSky"><span class="fa fa-bluesky"></span></a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://twitter.com/collapse_R" aria-label="Twitter"><span class="fa fa-twitter"></span></a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/SebKrantz/collapse" aria-label="GitHub"><span class="fa fa-github"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>collapse and sf</h1>
            <h3 data-toc-skip class="subtitle">Fast Manipulation of
Simple Features Data Frames</h3>
                        <h4 data-toc-skip class="author">Sebastian
Krantz and Grant McDermott</h4>
            
            <h4 data-toc-skip class="date">2024-04-19</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/SebKrantz/collapse/blob/master/vignettes/collapse_and_sf.Rmd" class="external-link"><code>vignettes/collapse_and_sf.Rmd</code></a></small>
      <div class="d-none name"><code>collapse_and_sf.Rmd</code></div>
    </div>

    
    
<style type="text/css">
pre {
  max-height: 900px;
  overflow-y: auto;
}

pre[class] {
  max-height: 900px;
}
</style>
<!--
*collapse* is a C/C++ based package for data transformation and statistical computing in R. It's aims are:

1. To facilitate complex data transformation, exploration and computing tasks in R.
2. To help make R code fast, flexible, parsimonious and programmer friendly. 
--><p>This short vignette focuses on using <em>collapse</em> with the
popular <em>sf</em> package by Edzer Pebesma. It shows that
<em>collapse</em> supports easy manipulation of <em>sf</em> data frames,
at computation speeds far above <em>dplyr</em>.</p>
<p><em>collapse</em> v1.6.0 added internal support for <em>sf</em> data
frames by having most essential functions (e.g.,
<code>fselect/gv</code>, <code>fsubset/ss</code>,
<code>fgroup_by</code>, <code>findex_by</code>, <code>qsu</code>,
<code>descr</code>, <code>varying</code>, <code>funique</code>,
<code>roworder</code>, <code>rsplit</code>, <code>fcompute</code>, …)
internally handle the geometry column.</p>
<p>To demonstrate this, we can load a test dataset provided by
<em>sf</em>:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://sebkrantz.github.io/collapse/">collapse</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/" class="external-link">sf</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">nc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html" class="external-link">st_read</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"shape/nc.shp"</span>, package <span class="op">=</span> <span class="st">"sf"</span><span class="op">)</span>, quiet <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>sf_max_print <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span><span class="va">nc</span></span>
<span><span class="co"># Simple feature collection with 100 features and 14 fields</span></span>
<span><span class="co"># Geometry type: MULTIPOLYGON</span></span>
<span><span class="co"># Dimension:     XY</span></span>
<span><span class="co"># Bounding box:  xmin: -84.32385 ymin: 33.88199 xmax: -75.45698 ymax: 36.58965</span></span>
<span><span class="co"># Geodetic CRS:  NAD27</span></span>
<span><span class="co"># First 3 features:</span></span>
<span><span class="co">#    AREA PERIMETER CNTY_ CNTY_ID      NAME  FIPS FIPSNO CRESS_ID BIR74 SID74 NWBIR74 BIR79 SID79</span></span>
<span><span class="co"># 1 0.114     1.442  1825    1825      Ashe 37009  37009        5  1091     1      10  1364     0</span></span>
<span><span class="co"># 2 0.061     1.231  1827    1827 Alleghany 37005  37005        3   487     0      10   542     3</span></span>
<span><span class="co"># 3 0.143     1.630  1828    1828     Surry 37171  37171       86  3188     5     208  3616     6</span></span>
<span><span class="co">#   NWBIR79                       geometry</span></span>
<span><span class="co"># 1      19 MULTIPOLYGON (((-81.47276 3...</span></span>
<span><span class="co"># 2      12 MULTIPOLYGON (((-81.23989 3...</span></span>
<span><span class="co"># 3     260 MULTIPOLYGON (((-80.45634 3...</span></span></code></pre></div>
<div class="section level2">
<h2 id="summarising-sf-data-frames">Summarising sf Data Frames<a class="anchor" aria-label="anchor" href="#summarising-sf-data-frames"></a>
</h2>
<p>Computing summary statistics on <em>sf</em> data frames automatically
excludes the ‘geometry’ column:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Which columns have at least 2 non-missing distinct values</span></span>
<span><span class="fu"><a href="../reference/varying.html">varying</a></span><span class="op">(</span><span class="va">nc</span><span class="op">)</span> </span>
<span><span class="co">#      AREA PERIMETER     CNTY_   CNTY_ID      NAME      FIPS    FIPSNO  CRESS_ID     BIR74     SID74 </span></span>
<span><span class="co">#      TRUE      TRUE      TRUE      TRUE      TRUE      TRUE      TRUE      TRUE      TRUE      TRUE </span></span>
<span><span class="co">#   NWBIR74     BIR79     SID79   NWBIR79 </span></span>
<span><span class="co">#      TRUE      TRUE      TRUE      TRUE</span></span>
<span></span>
<span><span class="co"># Quick summary stats</span></span>
<span><span class="fu"><a href="../reference/qsu.html">qsu</a></span><span class="op">(</span><span class="va">nc</span><span class="op">)</span></span>
<span><span class="co">#              N     Mean         SD    Min    Max</span></span>
<span><span class="co"># AREA       100   0.1263     0.0492  0.042  0.241</span></span>
<span><span class="co"># PERIMETER  100    1.673     0.4823  0.999   3.64</span></span>
<span><span class="co"># CNTY_      100  1985.96   106.5166   1825   2241</span></span>
<span><span class="co"># CNTY_ID    100  1985.96   106.5166   1825   2241</span></span>
<span><span class="co"># NAME       100        -          -      -      -</span></span>
<span><span class="co"># FIPS       100        -          -      -      -</span></span>
<span><span class="co"># FIPSNO     100    37100     58.023  37001  37199</span></span>
<span><span class="co"># CRESS_ID   100     50.5    29.0115      1    100</span></span>
<span><span class="co"># BIR74      100  3299.62  3848.1651    248  21588</span></span>
<span><span class="co"># SID74      100     6.67     7.7812      0     44</span></span>
<span><span class="co"># NWBIR74    100  1050.81  1432.9117      1   8027</span></span>
<span><span class="co"># BIR79      100  4223.92  5179.4582    319  30757</span></span>
<span><span class="co"># SID79      100     8.36     9.4319      0     57</span></span>
<span><span class="co"># NWBIR79    100  1352.81  1975.9988      3  11631</span></span>
<span></span>
<span><span class="co"># Detailed statistics description of each column</span></span>
<span><span class="fu"><a href="../reference/descr.html">descr</a></span><span class="op">(</span><span class="va">nc</span><span class="op">)</span></span>
<span><span class="co"># Dataset: nc, 14 Variables, N = 100</span></span>
<span><span class="co"># ----------------------------------------------------------------------------------------------------</span></span>
<span><span class="co"># AREA (numeric): </span></span>
<span><span class="co"># Statistics</span></span>
<span><span class="co">#     N  Ndist  Mean    SD   Min   Max  Skew  Kurt</span></span>
<span><span class="co">#   100     77  0.13  0.05  0.04  0.24  0.48   2.5</span></span>
<span><span class="co"># Quantiles</span></span>
<span><span class="co">#     1%    5%   10%   25%   50%   75%  90%   95%   99%</span></span>
<span><span class="co">#   0.04  0.06  0.06  0.09  0.12  0.15  0.2  0.21  0.24</span></span>
<span><span class="co"># ----------------------------------------------------------------------------------------------------</span></span>
<span><span class="co"># PERIMETER (numeric): </span></span>
<span><span class="co"># Statistics</span></span>
<span><span class="co">#     N  Ndist  Mean    SD  Min   Max  Skew  Kurt</span></span>
<span><span class="co">#   100     96  1.67  0.48    1  3.64  1.48  5.95</span></span>
<span><span class="co"># Quantiles</span></span>
<span><span class="co">#   1%    5%   10%   25%   50%   75%  90%   95%  99%</span></span>
<span><span class="co">#    1  1.09  1.19  1.32  1.61  1.86  2.2  2.72  3.2</span></span>
<span><span class="co"># ----------------------------------------------------------------------------------------------------</span></span>
<span><span class="co"># CNTY_ (numeric): </span></span>
<span><span class="co"># Statistics</span></span>
<span><span class="co">#     N  Ndist     Mean      SD   Min   Max  Skew  Kurt</span></span>
<span><span class="co">#   100    100  1985.96  106.52  1825  2241  0.26  2.32</span></span>
<span><span class="co"># Quantiles</span></span>
<span><span class="co">#        1%       5%     10%      25%   50%      75%   90%     95%      99%</span></span>
<span><span class="co">#   1826.98  1832.95  1837.9  1902.25  1982  2067.25  2110  2156.3  2238.03</span></span>
<span><span class="co"># ----------------------------------------------------------------------------------------------------</span></span>
<span><span class="co"># CNTY_ID (numeric): </span></span>
<span><span class="co"># Statistics</span></span>
<span><span class="co">#     N  Ndist     Mean      SD   Min   Max  Skew  Kurt</span></span>
<span><span class="co">#   100    100  1985.96  106.52  1825  2241  0.26  2.32</span></span>
<span><span class="co"># Quantiles</span></span>
<span><span class="co">#        1%       5%     10%      25%   50%      75%   90%     95%      99%</span></span>
<span><span class="co">#   1826.98  1832.95  1837.9  1902.25  1982  2067.25  2110  2156.3  2238.03</span></span>
<span><span class="co"># ----------------------------------------------------------------------------------------------------</span></span>
<span><span class="co"># NAME (character): </span></span>
<span><span class="co"># Statistics</span></span>
<span><span class="co">#     N  Ndist</span></span>
<span><span class="co">#   100    100</span></span>
<span><span class="co"># Table</span></span>
<span><span class="co">#                Freq  Perc</span></span>
<span><span class="co"># Ashe              1     1</span></span>
<span><span class="co"># Alleghany         1     1</span></span>
<span><span class="co"># Surry             1     1</span></span>
<span><span class="co"># Currituck         1     1</span></span>
<span><span class="co"># Northampton       1     1</span></span>
<span><span class="co"># Hertford          1     1</span></span>
<span><span class="co"># Camden            1     1</span></span>
<span><span class="co"># Gates             1     1</span></span>
<span><span class="co"># Warren            1     1</span></span>
<span><span class="co"># Stokes            1     1</span></span>
<span><span class="co"># Caswell           1     1</span></span>
<span><span class="co"># Rockingham        1     1</span></span>
<span><span class="co"># Granville         1     1</span></span>
<span><span class="co"># Person            1     1</span></span>
<span><span class="co"># ... 86 Others    86    86</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># Summary of Table Frequencies</span></span>
<span><span class="co">#    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. </span></span>
<span><span class="co">#       1       1       1       1       1       1 </span></span>
<span><span class="co"># ----------------------------------------------------------------------------------------------------</span></span>
<span><span class="co"># FIPS (character): </span></span>
<span><span class="co"># Statistics</span></span>
<span><span class="co">#     N  Ndist</span></span>
<span><span class="co">#   100    100</span></span>
<span><span class="co"># Table</span></span>
<span><span class="co">#                Freq  Perc</span></span>
<span><span class="co"># 37009             1     1</span></span>
<span><span class="co"># 37005             1     1</span></span>
<span><span class="co"># 37171             1     1</span></span>
<span><span class="co"># 37053             1     1</span></span>
<span><span class="co"># 37131             1     1</span></span>
<span><span class="co"># 37091             1     1</span></span>
<span><span class="co"># 37029             1     1</span></span>
<span><span class="co"># 37073             1     1</span></span>
<span><span class="co"># 37185             1     1</span></span>
<span><span class="co"># 37169             1     1</span></span>
<span><span class="co"># 37033             1     1</span></span>
<span><span class="co"># 37157             1     1</span></span>
<span><span class="co"># 37077             1     1</span></span>
<span><span class="co"># 37145             1     1</span></span>
<span><span class="co"># ... 86 Others    86    86</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># Summary of Table Frequencies</span></span>
<span><span class="co">#    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. </span></span>
<span><span class="co">#       1       1       1       1       1       1 </span></span>
<span><span class="co"># ----------------------------------------------------------------------------------------------------</span></span>
<span><span class="co"># FIPSNO (numeric): </span></span>
<span><span class="co"># Statistics</span></span>
<span><span class="co">#     N  Ndist   Mean     SD    Min    Max  Skew  Kurt</span></span>
<span><span class="co">#   100    100  37100  58.02  37001  37199    -0   1.8</span></span>
<span><span class="co"># Quantiles</span></span>
<span><span class="co">#         1%       5%      10%      25%    50%      75%      90%      95%       99%</span></span>
<span><span class="co">#   37002.98  37010.9  37020.8  37050.5  37100  37149.5  37179.2  37189.1  37197.02</span></span>
<span><span class="co"># ----------------------------------------------------------------------------------------------------</span></span>
<span><span class="co"># CRESS_ID (integer): </span></span>
<span><span class="co"># Statistics</span></span>
<span><span class="co">#     N  Ndist  Mean     SD  Min  Max  Skew  Kurt</span></span>
<span><span class="co">#   100    100  50.5  29.01    1  100     0   1.8</span></span>
<span><span class="co"># Quantiles</span></span>
<span><span class="co">#     1%    5%   10%    25%   50%    75%   90%    95%    99%</span></span>
<span><span class="co">#   1.99  5.95  10.9  25.75  50.5  75.25  90.1  95.05  99.01</span></span>
<span><span class="co"># ----------------------------------------------------------------------------------------------------</span></span>
<span><span class="co"># BIR74 (numeric): </span></span>
<span><span class="co"># Statistics</span></span>
<span><span class="co">#     N  Ndist     Mean       SD  Min    Max  Skew   Kurt</span></span>
<span><span class="co">#   100    100  3299.62  3848.17  248  21588  2.79  11.79</span></span>
<span><span class="co"># Quantiles</span></span>
<span><span class="co">#       1%      5%    10%   25%     50%   75%     90%    95%       99%</span></span>
<span><span class="co">#   283.64  419.75  531.8  1077  2180.5  3936  6725.7  11193  20378.22</span></span>
<span><span class="co"># ----------------------------------------------------------------------------------------------------</span></span>
<span><span class="co"># SID74 (numeric): </span></span>
<span><span class="co"># Statistics</span></span>
<span><span class="co">#     N  Ndist  Mean    SD  Min  Max  Skew   Kurt</span></span>
<span><span class="co">#   100     23  6.67  7.78    0   44  2.44  10.28</span></span>
<span><span class="co"># Quantiles</span></span>
<span><span class="co">#   1%  5%  10%  25%  50%   75%   90%    95%    99%</span></span>
<span><span class="co">#    0   0    0    2    4  8.25  15.1  18.25  38.06</span></span>
<span><span class="co"># ----------------------------------------------------------------------------------------------------</span></span>
<span><span class="co"># NWBIR74 (numeric): </span></span>
<span><span class="co"># Statistics</span></span>
<span><span class="co">#     N  Ndist     Mean       SD  Min   Max  Skew   Kurt</span></span>
<span><span class="co">#   100     93  1050.81  1432.91    1  8027  2.83  11.84</span></span>
<span><span class="co"># Quantiles</span></span>
<span><span class="co">#   1%    5%   10%  25%    50%     75%     90%     95%      99%</span></span>
<span><span class="co">#    1  9.95  39.2  190  697.5  1168.5  2231.8  3942.9  7052.84</span></span>
<span><span class="co"># ----------------------------------------------------------------------------------------------------</span></span>
<span><span class="co"># BIR79 (numeric): </span></span>
<span><span class="co"># Statistics</span></span>
<span><span class="co">#     N  Ndist     Mean       SD  Min    Max  Skew  Kurt</span></span>
<span><span class="co">#   100    100  4223.92  5179.46  319  30757  2.99  13.1</span></span>
<span><span class="co"># Quantiles</span></span>
<span><span class="co">#       1%     5%    10%      25%   50%   75%   90%       95%       99%</span></span>
<span><span class="co">#   349.69  539.3  675.7  1336.25  2636  4889  8313  14707.45  26413.87</span></span>
<span><span class="co"># ----------------------------------------------------------------------------------------------------</span></span>
<span><span class="co"># SID79 (numeric): </span></span>
<span><span class="co"># Statistics</span></span>
<span><span class="co">#     N  Ndist  Mean    SD  Min  Max  Skew  Kurt</span></span>
<span><span class="co">#   100     28  8.36  9.43    0   57  2.28  9.88</span></span>
<span><span class="co"># Quantiles</span></span>
<span><span class="co">#   1%  5%  10%  25%  50%    75%  90%  95%    99%</span></span>
<span><span class="co">#    0   0    1    2    5  10.25   21   26  38.19</span></span>
<span><span class="co"># ----------------------------------------------------------------------------------------------------</span></span>
<span><span class="co"># NWBIR79 (numeric): </span></span>
<span><span class="co"># Statistics</span></span>
<span><span class="co">#     N  Ndist     Mean    SD  Min    Max  Skew   Kurt</span></span>
<span><span class="co">#   100     98  1352.81  1976    3  11631  3.18  14.45</span></span>
<span><span class="co"># Quantiles</span></span>
<span><span class="co">#     1%    5%   10%    25%    50%      75%     90%     95%       99%</span></span>
<span><span class="co">#   3.99  11.9  44.7  250.5  874.5  1406.75  2987.9  5090.5  10624.17</span></span>
<span><span class="co"># ----------------------------------------------------------------------------------------------------</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="selecting-columns-and-subsetting">Selecting Columns and Subsetting<a class="anchor" aria-label="anchor" href="#selecting-columns-and-subsetting"></a>
</h2>
<p>We can select columns from the <em>sf</em> data frame without having
to worry about taking along ‘geometry’:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Selecting a sequence of columns</span></span>
<span><span class="fu"><a href="../reference/select_replace_vars.html">fselect</a></span><span class="op">(</span><span class="va">nc</span>, <span class="va">AREA</span>, <span class="va">NAME</span><span class="op">:</span><span class="va">FIPSNO</span><span class="op">)</span></span>
<span><span class="co"># Simple feature collection with 100 features and 4 fields</span></span>
<span><span class="co"># Geometry type: MULTIPOLYGON</span></span>
<span><span class="co"># Dimension:     XY</span></span>
<span><span class="co"># Bounding box:  xmin: -84.32385 ymin: 33.88199 xmax: -75.45698 ymax: 36.58965</span></span>
<span><span class="co"># Geodetic CRS:  NAD27</span></span>
<span><span class="co"># First 3 features:</span></span>
<span><span class="co">#    AREA      NAME  FIPS FIPSNO                       geometry</span></span>
<span><span class="co"># 1 0.114      Ashe 37009  37009 MULTIPOLYGON (((-81.47276 3...</span></span>
<span><span class="co"># 2 0.061 Alleghany 37005  37005 MULTIPOLYGON (((-81.23989 3...</span></span>
<span><span class="co"># 3 0.143     Surry 37171  37171 MULTIPOLYGON (((-80.45634 3...</span></span>
<span></span>
<span><span class="co"># Same using standard evaluation (gv is a shorthand for get_vars())</span></span>
<span><span class="fu"><a href="https://sebkrantz.github.io/collapse/reference/select_replace_vars.html">gv</a></span><span class="op">(</span><span class="va">nc</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"AREA"</span>, <span class="st">"NAME"</span>, <span class="st">"FIPS"</span>, <span class="st">"FIPSNO"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># Simple feature collection with 100 features and 4 fields</span></span>
<span><span class="co"># Geometry type: MULTIPOLYGON</span></span>
<span><span class="co"># Dimension:     XY</span></span>
<span><span class="co"># Bounding box:  xmin: -84.32385 ymin: 33.88199 xmax: -75.45698 ymax: 36.58965</span></span>
<span><span class="co"># Geodetic CRS:  NAD27</span></span>
<span><span class="co"># First 3 features:</span></span>
<span><span class="co">#    AREA      NAME  FIPS FIPSNO                       geometry</span></span>
<span><span class="co"># 1 0.114      Ashe 37009  37009 MULTIPOLYGON (((-81.47276 3...</span></span>
<span><span class="co"># 2 0.061 Alleghany 37005  37005 MULTIPOLYGON (((-81.23989 3...</span></span>
<span><span class="co"># 3 0.143     Surry 37171  37171 MULTIPOLYGON (((-80.45634 3...</span></span></code></pre></div>
<p>The same applies to subsetting rows (and columns):</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># A fast and enhanced version of base::subset</span></span>
<span><span class="fu"><a href="../reference/fsubset.html">fsubset</a></span><span class="op">(</span><span class="va">nc</span>, <span class="va">AREA</span> <span class="op">&gt;</span> <span class="fu"><a href="../reference/fmean.html">fmean</a></span><span class="op">(</span><span class="va">AREA</span><span class="op">)</span>, <span class="va">AREA</span>, <span class="va">NAME</span><span class="op">:</span><span class="va">FIPSNO</span><span class="op">)</span></span>
<span><span class="co"># Simple feature collection with 44 features and 4 fields</span></span>
<span><span class="co"># Geometry type: MULTIPOLYGON</span></span>
<span><span class="co"># Dimension:     XY</span></span>
<span><span class="co"># Bounding box:  xmin: -84.32385 ymin: 33.88199 xmax: -75.45698 ymax: 36.58965</span></span>
<span><span class="co"># Geodetic CRS:  NAD27</span></span>
<span><span class="co"># First 3 features:</span></span>
<span><span class="co">#    AREA        NAME  FIPS FIPSNO                       geometry</span></span>
<span><span class="co"># 1 0.143       Surry 37171  37171 MULTIPOLYGON (((-80.45634 3...</span></span>
<span><span class="co"># 2 0.153 Northampton 37131  37131 MULTIPOLYGON (((-77.21767 3...</span></span>
<span><span class="co"># 3 0.153  Rockingham 37157  37157 MULTIPOLYGON (((-79.53051 3...</span></span>
<span></span>
<span><span class="co"># A fast version of `[` (where i is used and optionally j)</span></span>
<span><span class="fu"><a href="../reference/fsubset.html">ss</a></span><span class="op">(</span><span class="va">nc</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"AREA"</span>, <span class="st">"NAME"</span>, <span class="st">"FIPS"</span>, <span class="st">"FIPSNO"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># Simple feature collection with 10 features and 4 fields</span></span>
<span><span class="co"># Geometry type: MULTIPOLYGON</span></span>
<span><span class="co"># Dimension:     XY</span></span>
<span><span class="co"># Bounding box:  xmin: -84.32385 ymin: 33.88199 xmax: -75.45698 ymax: 36.58965</span></span>
<span><span class="co"># Geodetic CRS:  NAD27</span></span>
<span><span class="co"># First 3 features:</span></span>
<span><span class="co">#    AREA      NAME  FIPS FIPSNO                       geometry</span></span>
<span><span class="co"># 1 0.114      Ashe 37009  37009 MULTIPOLYGON (((-81.47276 3...</span></span>
<span><span class="co"># 2 0.061 Alleghany 37005  37005 MULTIPOLYGON (((-81.23989 3...</span></span>
<span><span class="co"># 3 0.143     Surry 37171  37171 MULTIPOLYGON (((-80.45634 3...</span></span></code></pre></div>
<p>This is significantly faster than using <code>[</code>,
<code><a href="https://rdrr.io/r/base/subset.html" class="external-link">base::subset()</a></code>, <code><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">dplyr::select()</a></code> or
<code><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">dplyr::filter()</a></code>:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/joshuaulrich/microbenchmark/" class="external-link">microbenchmark</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Selecting columns</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html" class="external-link">microbenchmark</a></span><span class="op">(</span>collapse <span class="op">=</span> <span class="fu"><a href="../reference/select_replace_vars.html">fselect</a></span><span class="op">(</span><span class="va">nc</span>, <span class="va">AREA</span>, <span class="va">NAME</span><span class="op">:</span><span class="va">FIPSNO</span><span class="op">)</span>, </span>
<span>               dplyr <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">nc</span>, <span class="va">AREA</span>, <span class="va">NAME</span><span class="op">:</span><span class="va">FIPSNO</span><span class="op">)</span>,</span>
<span>               collapse2 <span class="op">=</span> <span class="fu"><a href="https://sebkrantz.github.io/collapse/reference/select_replace_vars.html">gv</a></span><span class="op">(</span><span class="va">nc</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"AREA"</span>, <span class="st">"NAME"</span>, <span class="st">"FIPS"</span>, <span class="st">"FIPSNO"</span><span class="op">)</span><span class="op">)</span>, </span>
<span>               sf <span class="op">=</span> <span class="va">nc</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"AREA"</span>, <span class="st">"NAME"</span>, <span class="st">"FIPS"</span>, <span class="st">"FIPSNO"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co"># Unit: microseconds</span></span>
<span><span class="co">#       expr     min       lq      mean   median       uq      max neval</span></span>
<span><span class="co">#   collapse   3.034   3.9565   5.19429   5.1865   5.6990   22.878   100</span></span>
<span><span class="co">#      dplyr 431.279 452.2915 505.29015 466.3750 493.8450 3356.342   100</span></span>
<span><span class="co">#  collapse2   2.665   3.4850   4.59610   4.4075   5.0635   14.391   100</span></span>
<span><span class="co">#         sf 105.165 114.1235 120.39732 118.0390 124.9270  156.497   100</span></span>
<span><span class="co"># Subsetting</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html" class="external-link">microbenchmark</a></span><span class="op">(</span>collapse <span class="op">=</span> <span class="fu"><a href="../reference/fsubset.html">fsubset</a></span><span class="op">(</span><span class="va">nc</span>, <span class="va">AREA</span> <span class="op">&gt;</span> <span class="fu"><a href="../reference/fmean.html">fmean</a></span><span class="op">(</span><span class="va">AREA</span><span class="op">)</span>, <span class="va">AREA</span>, <span class="va">NAME</span><span class="op">:</span><span class="va">FIPSNO</span><span class="op">)</span>, </span>
<span>               dplyr <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">nc</span>, <span class="va">AREA</span>, <span class="va">NAME</span><span class="op">:</span><span class="va">FIPSNO</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">AREA</span> <span class="op">&gt;</span> <span class="fu"><a href="../reference/fmean.html">fmean</a></span><span class="op">(</span><span class="va">AREA</span><span class="op">)</span><span class="op">)</span>,</span>
<span>               collapse2 <span class="op">=</span> <span class="fu"><a href="../reference/fsubset.html">ss</a></span><span class="op">(</span><span class="va">nc</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"AREA"</span>, <span class="st">"NAME"</span>, <span class="st">"FIPS"</span>, <span class="st">"FIPSNO"</span><span class="op">)</span><span class="op">)</span>, </span>
<span>               sf <span class="op">=</span> <span class="va">nc</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"AREA"</span>, <span class="st">"NAME"</span>, <span class="st">"FIPS"</span>, <span class="st">"FIPSNO"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co"># Unit: microseconds</span></span>
<span><span class="co">#       expr     min       lq       mean   median        uq      max neval</span></span>
<span><span class="co">#   collapse   9.676  11.5825   15.01707  14.4730   16.8920   30.463   100</span></span>
<span><span class="co">#      dplyr 890.643 917.6415 1055.40970 941.7085 1009.7890 5546.685   100</span></span>
<span><span class="co">#  collapse2   2.829   3.5465    5.40585   4.8995    6.4165   20.541   100</span></span>
<span><span class="co">#         sf 176.997 187.6160  202.72286 200.7565  210.8220  340.464   100</span></span></code></pre></div>
<p>However, <em>collapse</em> functions don’t subset the ‘agr’ attribute
on selecting columns, which (if specified) relates columns (attributes)
to the geometry, and also don’t modify the ‘bbox’ attribute giving the
overall boundaries of a set of geometries when subsetting the
<em>sf</em> data frame. Keeping the full ‘agr’ attribute is not
problematic for all practical purposes, but not changing ‘bbox’ upon
subsetting may lead to too large margins when plotting the geometries of
a subset <em>sf</em> data frame.</p>
<p>One way to to change this is calling <code><a href="https://r-spatial.github.io/sf/reference/valid.html" class="external-link">st_make_valid()</a></code> on
the subset frame; but <code><a href="https://r-spatial.github.io/sf/reference/valid.html" class="external-link">st_make_valid()</a></code> is very expensive,
thus unless the subset frame is very small, it is better to use
<code>[</code>, <code><a href="https://rdrr.io/r/base/subset.html" class="external-link">base::subset()</a></code> or
<code><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">dplyr::filter()</a></code> in cases where the bounding box size
matters.</p>
</div>
<div class="section level2">
<h2 id="aggregation-and-grouping">Aggregation and Grouping<a class="anchor" aria-label="anchor" href="#aggregation-and-grouping"></a>
</h2>
<p>The flexibility and speed of <code><a href="../reference/collap.html">collap()</a></code> for aggregation
can be used on <em>sf</em> data frames. A separate method for
<em>sf</em> objects was not considered necessary as one can simply
aggregate the geometry column using <code><a href="https://r-spatial.github.io/sf/reference/geos_combine.html" class="external-link">st_union()</a></code>:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Aggregating by variable SID74 using the median for numeric and the mode for categorical columns</span></span>
<span><span class="fu"><a href="../reference/collap.html">collap</a></span><span class="op">(</span><span class="va">nc</span>, <span class="op">~</span> <span class="va">SID74</span>, custom <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>fmedian <span class="op">=</span> <span class="va">is.numeric</span>, </span>
<span>                                  fmode <span class="op">=</span> <span class="va">is.character</span>, </span>
<span>                                  st_union <span class="op">=</span> <span class="st">"geometry"</span><span class="op">)</span><span class="op">)</span> <span class="co"># or use is.list to fetch the geometry</span></span>
<span><span class="co"># Simple feature collection with 23 features and 15 fields</span></span>
<span><span class="co"># Geometry type: MULTIPOLYGON</span></span>
<span><span class="co"># Dimension:     XY</span></span>
<span><span class="co"># Bounding box:  xmin: -84.32385 ymin: 33.88199 xmax: -75.45698 ymax: 36.58965</span></span>
<span><span class="co"># Geodetic CRS:  NAD27</span></span>
<span><span class="co"># First 3 features:</span></span>
<span><span class="co">#     AREA PERIMETER  CNTY_ CNTY_ID      NAME  FIPS FIPSNO CRESS_ID BIR74 SID74 SID74 NWBIR74  BIR79</span></span>
<span><span class="co"># 1 0.0780    1.3070 1950.0  1950.0 Alleghany 37005  37073     37.0   487     0     0    40.0  594.0</span></span>
<span><span class="co"># 2 0.0810    1.2880 1887.0  1887.0      Ashe 37009  37137     69.0   751     1     1   148.0  899.0</span></span>
<span><span class="co"># 3 0.1225    1.6435 1959.5  1959.5   Caswell 37033  37078     39.5  1271     2     2   382.5 1676.5</span></span>
<span><span class="co">#   SID79 NWBIR79                       geometry</span></span>
<span><span class="co"># 1     1      45 MULTIPOLYGON (((-83.69563 3...</span></span>
<span><span class="co"># 2     1     176 MULTIPOLYGON (((-80.02406 3...</span></span>
<span><span class="co"># 3     2     452 MULTIPOLYGON (((-77.16129 3...</span></span></code></pre></div>
<p><em>sf</em> data frames can also be grouped and then aggregated using
<code><a href="../reference/fsummarise.html">fsummarise()</a></code>:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nc</span> <span class="op">|&gt;</span> <span class="fu"><a href="../reference/GRP.html">fgroup_by</a></span><span class="op">(</span><span class="va">SID74</span><span class="op">)</span></span>
<span><span class="co"># Simple feature collection with 100 features and 14 fields</span></span>
<span><span class="co"># Geometry type: MULTIPOLYGON</span></span>
<span><span class="co"># Dimension:     XY</span></span>
<span><span class="co"># Bounding box:  xmin: -84.32385 ymin: 33.88199 xmax: -75.45698 ymax: 36.58965</span></span>
<span><span class="co"># Geodetic CRS:  NAD27</span></span>
<span><span class="co"># First 3 features:</span></span>
<span><span class="co">#    AREA PERIMETER CNTY_ CNTY_ID      NAME  FIPS FIPSNO CRESS_ID BIR74 SID74 NWBIR74 BIR79 SID79</span></span>
<span><span class="co"># 1 0.114     1.442  1825    1825      Ashe 37009  37009        5  1091     1      10  1364     0</span></span>
<span><span class="co"># 2 0.061     1.231  1827    1827 Alleghany 37005  37005        3   487     0      10   542     3</span></span>
<span><span class="co"># 3 0.143     1.630  1828    1828     Surry 37171  37171       86  3188     5     208  3616     6</span></span>
<span><span class="co">#   NWBIR79                       geometry</span></span>
<span><span class="co"># 1      19 MULTIPOLYGON (((-81.47276 3...</span></span>
<span><span class="co"># 2      12 MULTIPOLYGON (((-81.23989 3...</span></span>
<span><span class="co"># 3     260 MULTIPOLYGON (((-80.45634 3...</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># Grouped by:  SID74  [23 | 4 (4) 1-13]</span></span>
<span></span>
<span><span class="va">nc</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="../reference/GRP.html">fgroup_by</a></span><span class="op">(</span><span class="va">SID74</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/fsummarise.html">fsummarise</a></span><span class="op">(</span>AREA_Ag <span class="op">=</span> <span class="fu"><a href="../reference/fsum.html">fsum</a></span><span class="op">(</span><span class="va">AREA</span><span class="op">)</span>, </span>
<span>             Perimeter_Ag <span class="op">=</span> <span class="fu"><a href="../reference/fnth_fmedian.html">fmedian</a></span><span class="op">(</span><span class="va">PERIMETER</span><span class="op">)</span>,</span>
<span>             geometry <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_combine.html" class="external-link">st_union</a></span><span class="op">(</span><span class="va">geometry</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># Simple feature collection with 23 features and 3 fields</span></span>
<span><span class="co"># Geometry type: MULTIPOLYGON</span></span>
<span><span class="co"># Dimension:     XY</span></span>
<span><span class="co"># Bounding box:  xmin: -84.32385 ymin: 33.88199 xmax: -75.45698 ymax: 36.58965</span></span>
<span><span class="co"># Geodetic CRS:  NAD27</span></span>
<span><span class="co"># First 3 features:</span></span>
<span><span class="co">#   SID74 AREA_Ag Perimeter_Ag                       geometry</span></span>
<span><span class="co"># 1     0   1.103       1.3070 MULTIPOLYGON (((-83.69563 3...</span></span>
<span><span class="co"># 2     1   0.914       1.2880 MULTIPOLYGON (((-80.02406 3...</span></span>
<span><span class="co"># 3     2   1.047       1.6435 MULTIPOLYGON (((-77.16129 3...</span></span></code></pre></div>
<p>Typically most of the time in aggregation is consumed by
<code><a href="https://r-spatial.github.io/sf/reference/geos_combine.html" class="external-link">st_union()</a></code> so that the speed of <em>collapse</em> does not
really become visible on most datasets. A faster alternative is to use
<em>geos</em> (<em>sf</em> backend for planar geometries) or <em>s2</em>
(<em>sf</em> backend for spherical geometries) directly:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Using s2 backend: sensible for larger tasks</span></span>
<span><span class="va">nc</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="../reference/ftransform.html">fmutate</a></span><span class="op">(</span>geometry <span class="op">=</span> <span class="fu">s2</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/s2/reference/as_s2_geography.html" class="external-link">as_s2_geography</a></span><span class="op">(</span><span class="va">geometry</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/GRP.html">fgroup_by</a></span><span class="op">(</span><span class="va">SID74</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/fsummarise.html">fsummarise</a></span><span class="op">(</span>AREA_Ag <span class="op">=</span> <span class="fu"><a href="../reference/fsum.html">fsum</a></span><span class="op">(</span><span class="va">AREA</span><span class="op">)</span>, </span>
<span>             Perimeter_Ag <span class="op">=</span> <span class="fu"><a href="../reference/fnth_fmedian.html">fmedian</a></span><span class="op">(</span><span class="va">PERIMETER</span><span class="op">)</span>,</span>
<span>             geometry <span class="op">=</span> <span class="fu">s2</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/s2/reference/s2_boundary.html" class="external-link">s2_union_agg</a></span><span class="op">(</span><span class="va">geometry</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/ftransform.html">fmutate</a></span><span class="op">(</span>geometry <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sfc.html" class="external-link">st_as_sfc</a></span><span class="op">(</span><span class="va">geometry</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># Simple feature collection with 23 features and 3 fields</span></span>
<span><span class="co"># Geometry type: MULTIPOLYGON</span></span>
<span><span class="co"># Dimension:     XY</span></span>
<span><span class="co"># Bounding box:  xmin: -84.32385 ymin: 33.88199 xmax: -75.45698 ymax: 36.58965</span></span>
<span><span class="co"># Geodetic CRS:  WGS 84</span></span>
<span><span class="co"># First 3 features:</span></span>
<span><span class="co">#   SID74 AREA_Ag Perimeter_Ag                       geometry</span></span>
<span><span class="co"># 1     0   1.103       1.3070 MULTIPOLYGON (((-83.69563 3...</span></span>
<span><span class="co"># 2     1   0.914       1.2880 MULTIPOLYGON (((-80.02406 3...</span></span>
<span><span class="co"># 3     2   1.047       1.6435 MULTIPOLYGON (((-77.16129 3...</span></span></code></pre></div>
<p>In general, also upon aggregation with <em>collapse</em>, functions
<code><a href="https://r-spatial.github.io/sf/reference/st_as_sfc.html" class="external-link">st_as_sfc()</a></code>, <code><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html" class="external-link">st_as_sf()</a></code>, or, in the worst
case, <code><a href="https://r-spatial.github.io/sf/reference/valid.html" class="external-link">st_make_valid()</a></code>, may need to be invoked to ensure
valid <em>sf</em> object output. Functions <code><a href="../reference/collap.html">collap()</a></code> and
<code><a href="../reference/fsummarise.html">fsummarise()</a></code> are attribute preserving but do not give
special regard to geometry columns.</p>
<p>One exception that both avoids the high cost of spatial functions in
aggregation and any need for ex-post conversion/validation is
aggregating spatial panel data over the time-dimension. Such panels can
quickly be aggregated using <code><a href="../reference/ffirst_flast.html">ffirst()</a></code> or
<code><a href="../reference/ffirst_flast.html">flast()</a></code> to aggregate the geometry:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Creating a panel-dataset by simply duplicating nc for 2 different years</span></span>
<span><span class="va">pnc</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/rowbind.html">rowbind</a></span><span class="op">(</span>`2000` <span class="op">=</span> <span class="va">nc</span>, `2001` <span class="op">=</span> <span class="va">nc</span>, idcol <span class="op">=</span> <span class="st">"Year"</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="../reference/quick-conversion.html">as_integer_factor</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">pnc</span> </span>
<span><span class="co"># Simple feature collection with 200 features and 15 fields</span></span>
<span><span class="co"># Geometry type: MULTIPOLYGON</span></span>
<span><span class="co"># Dimension:     XY</span></span>
<span><span class="co"># Bounding box:  xmin: -84.32385 ymin: 33.88199 xmax: -75.45698 ymax: 36.58965</span></span>
<span><span class="co"># Geodetic CRS:  NAD27</span></span>
<span><span class="co"># First 3 features:</span></span>
<span><span class="co">#   Year  AREA PERIMETER CNTY_ CNTY_ID      NAME  FIPS FIPSNO CRESS_ID BIR74 SID74 NWBIR74 BIR79</span></span>
<span><span class="co"># 1 2000 0.114     1.442  1825    1825      Ashe 37009  37009        5  1091     1      10  1364</span></span>
<span><span class="co"># 2 2000 0.061     1.231  1827    1827 Alleghany 37005  37005        3   487     0      10   542</span></span>
<span><span class="co"># 3 2000 0.143     1.630  1828    1828     Surry 37171  37171       86  3188     5     208  3616</span></span>
<span><span class="co">#   SID79 NWBIR79                       geometry</span></span>
<span><span class="co"># 1     0      19 MULTIPOLYGON (((-81.47276 3...</span></span>
<span><span class="co"># 2     3      12 MULTIPOLYGON (((-81.23989 3...</span></span>
<span><span class="co"># 3     6     260 MULTIPOLYGON (((-80.45634 3...</span></span>
<span></span>
<span><span class="co"># Aggregating by NAME, using the last value for all categorical data</span></span>
<span><span class="fu"><a href="../reference/collap.html">collap</a></span><span class="op">(</span><span class="va">pnc</span>, <span class="op">~</span> <span class="va">NAME</span>, <span class="va">fmedian</span>, catFUN <span class="op">=</span> <span class="va">flast</span>, cols <span class="op">=</span> <span class="op">-</span><span class="fl">1L</span><span class="op">)</span></span>
<span><span class="co"># Simple feature collection with 100 features and 15 fields</span></span>
<span><span class="co"># Geometry type: MULTIPOLYGON</span></span>
<span><span class="co"># Dimension:     XY</span></span>
<span><span class="co"># Bounding box:  xmin: -84.32385 ymin: 33.88199 xmax: -75.45698 ymax: 36.58965</span></span>
<span><span class="co"># Geodetic CRS:  NAD27</span></span>
<span><span class="co"># First 3 features:</span></span>
<span><span class="co">#    AREA PERIMETER CNTY_ CNTY_ID      NAME      NAME  FIPS FIPSNO CRESS_ID BIR74 SID74 NWBIR74 BIR79</span></span>
<span><span class="co"># 1 0.111     1.392  1904    1904  Alamance  Alamance 37001  37001        1  4672    13    1243  5767</span></span>
<span><span class="co"># 2 0.066     1.070  1950    1950 Alexander Alexander 37003  37003        2  1333     0     128  1683</span></span>
<span><span class="co"># 3 0.061     1.231  1827    1827 Alleghany Alleghany 37005  37005        3   487     0      10   542</span></span>
<span><span class="co">#   SID79 NWBIR79                       geometry</span></span>
<span><span class="co"># 1    11    1397 MULTIPOLYGON (((-79.24619 3...</span></span>
<span><span class="co"># 2     2     150 MULTIPOLYGON (((-81.10889 3...</span></span>
<span><span class="co"># 3     3      12 MULTIPOLYGON (((-81.23989 3...</span></span>
<span></span>
<span><span class="co"># Using fsummarise to aggregate just two variables and the geometry</span></span>
<span><span class="va">pnc_ag</span> <span class="op">&lt;-</span> <span class="va">pnc</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="../reference/GRP.html">fgroup_by</a></span><span class="op">(</span><span class="va">NAME</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/fsummarise.html">fsummarise</a></span><span class="op">(</span>AREA_Ag <span class="op">=</span> <span class="fu"><a href="../reference/fsum.html">fsum</a></span><span class="op">(</span><span class="va">AREA</span><span class="op">)</span>, </span>
<span>             Perimeter_Ag <span class="op">=</span> <span class="fu"><a href="../reference/fnth_fmedian.html">fmedian</a></span><span class="op">(</span><span class="va">PERIMETER</span><span class="op">)</span>,</span>
<span>             geometry <span class="op">=</span> <span class="fu"><a href="../reference/ffirst_flast.html">flast</a></span><span class="op">(</span><span class="va">geometry</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># The geometry is still valid... (slt = shorthand for fselect)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://sebkrantz.github.io/collapse/reference/select_replace_vars.html">slt</a></span><span class="op">(</span><span class="va">pnc_ag</span>, <span class="va">AREA_Ag</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<p><img src="https://raw.githubusercontent.com/SebKrantz/collapse/master/vignettes/figure/AREA_Ag-1.png" alt="plot of chunk AREA_Ag" width="100%"></p>
</div>
</div>
<div class="section level2">
<h2 id="indexing">Indexing<a class="anchor" aria-label="anchor" href="#indexing"></a>
</h2>
<p><em>sf</em> data frames can also become <a href="https://sebkrantz.github.io/collapse/reference/indexing.html"><em>indexed
frames</em></a> (spatio-temporal panels):</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pnc</span> <span class="op">&lt;-</span> <span class="va">pnc</span> <span class="op">|&gt;</span> <span class="fu"><a href="../reference/indexing.html">findex_by</a></span><span class="op">(</span><span class="va">CNTY_ID</span>, <span class="va">Year</span><span class="op">)</span></span>
<span><span class="va">pnc</span> </span>
<span><span class="co"># Simple feature collection with 200 features and 15 fields</span></span>
<span><span class="co"># Geometry type: MULTIPOLYGON</span></span>
<span><span class="co"># Dimension:     XY</span></span>
<span><span class="co"># Bounding box:  xmin: -84.32385 ymin: 33.88199 xmax: -75.45698 ymax: 36.58965</span></span>
<span><span class="co"># Geodetic CRS:  NAD27</span></span>
<span><span class="co"># First 3 features:</span></span>
<span><span class="co">#   Year  AREA PERIMETER CNTY_ CNTY_ID      NAME  FIPS FIPSNO CRESS_ID BIR74 SID74 NWBIR74 BIR79</span></span>
<span><span class="co"># 1 2000 0.114     1.442  1825    1825      Ashe 37009  37009        5  1091     1      10  1364</span></span>
<span><span class="co"># 2 2000 0.061     1.231  1827    1827 Alleghany 37005  37005        3   487     0      10   542</span></span>
<span><span class="co"># 3 2000 0.143     1.630  1828    1828     Surry 37171  37171       86  3188     5     208  3616</span></span>
<span><span class="co">#   SID79 NWBIR79                       geometry</span></span>
<span><span class="co"># 1     0      19 MULTIPOLYGON (((-81.47276 3...</span></span>
<span><span class="co"># 2     3      12 MULTIPOLYGON (((-81.23989 3...</span></span>
<span><span class="co"># 3     6     260 MULTIPOLYGON (((-80.45634 3...</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># Indexed by:  CNTY_ID [100] | Year [2]</span></span>
<span><span class="fu"><a href="../reference/qsu.html">qsu</a></span><span class="op">(</span><span class="va">pnc</span><span class="op">$</span><span class="va">AREA</span><span class="op">)</span></span>
<span><span class="co">#          N/T    Mean      SD     Min     Max</span></span>
<span><span class="co"># Overall  200  0.1263  0.0491   0.042   0.241</span></span>
<span><span class="co"># Between  100  0.1263  0.0492   0.042   0.241</span></span>
<span><span class="co"># Within     2  0.1263       0  0.1263  0.1263</span></span>
<span><span class="fu"><a href="../reference/ftransform.html">settransform</a></span><span class="op">(</span><span class="va">pnc</span>, AREA_diff <span class="op">=</span> <span class="fu"><a href="../reference/fdiff.html">fdiff</a></span><span class="op">(</span><span class="va">AREA</span><span class="op">)</span><span class="op">)</span> </span>
<span><span class="fu"><a href="../reference/psmat.html">psmat</a></span><span class="op">(</span><span class="va">pnc</span><span class="op">$</span><span class="va">AREA_diff</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#      2000 2001</span></span>
<span><span class="co"># 1825   NA    0</span></span>
<span><span class="co"># 1827   NA    0</span></span>
<span><span class="co"># 1828   NA    0</span></span>
<span><span class="co"># 1831   NA    0</span></span>
<span><span class="co"># 1832   NA    0</span></span>
<span><span class="co"># 1833   NA    0</span></span>
<span><span class="va">pnc</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/indexing.html">unindex</a></span><span class="op">(</span><span class="va">pnc</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="unique-values-ordering-splitting-binding">Unique Values, Ordering, Splitting, Binding<a class="anchor" aria-label="anchor" href="#unique-values-ordering-splitting-binding"></a>
</h2>
<p>Functions <code><a href="../reference/funique.html">funique()</a></code> and <code>roworder[v]()</code>
ignore the ‘geometry’ column in determining the unique values / order of
rows when applied to <em>sf</em> data frames. <code><a href="../reference/rsplit.html">rsplit()</a></code> can
be used to (recursively) split an <em>sf</em> data frame into multiple
chunks.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Splitting by SID74</span></span>
<span><span class="fu"><a href="../reference/rsplit.html">rsplit</a></span><span class="op">(</span><span class="va">nc</span>, <span class="op">~</span> <span class="va">SID74</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="co"># $`0`</span></span>
<span><span class="co"># Simple feature collection with 13 features and 13 fields</span></span>
<span><span class="co"># Geometry type: MULTIPOLYGON</span></span>
<span><span class="co"># Dimension:     XY</span></span>
<span><span class="co"># Bounding box:  xmin: -84.32385 ymin: 33.88199 xmax: -75.45698 ymax: 36.58965</span></span>
<span><span class="co"># Geodetic CRS:  NAD27</span></span>
<span><span class="co"># First 3 features:</span></span>
<span><span class="co">#    AREA PERIMETER CNTY_ CNTY_ID      NAME  FIPS FIPSNO CRESS_ID BIR74 NWBIR74 BIR79 SID79 NWBIR79</span></span>
<span><span class="co"># 1 0.061     1.231  1827    1827 Alleghany 37005  37005        3   487      10   542     3      12</span></span>
<span><span class="co"># 2 0.062     1.547  1834    1834    Camden 37029  37029       15   286     115   350     2     139</span></span>
<span><span class="co"># 3 0.091     1.284  1835    1835     Gates 37073  37073       37   420     254   594     2     371</span></span>
<span><span class="co">#                         geometry</span></span>
<span><span class="co"># 1 MULTIPOLYGON (((-81.23989 3...</span></span>
<span><span class="co"># 2 MULTIPOLYGON (((-76.00897 3...</span></span>
<span><span class="co"># 3 MULTIPOLYGON (((-76.56251 3...</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># $`1`</span></span>
<span><span class="co"># Simple feature collection with 11 features and 13 fields</span></span>
<span><span class="co"># Geometry type: MULTIPOLYGON</span></span>
<span><span class="co"># Dimension:     XY</span></span>
<span><span class="co"># Bounding box:  xmin: -84.32385 ymin: 33.88199 xmax: -75.45698 ymax: 36.58965</span></span>
<span><span class="co"># Geodetic CRS:  NAD27</span></span>
<span><span class="co"># First 3 features:</span></span>
<span><span class="co">#    AREA PERIMETER CNTY_ CNTY_ID      NAME  FIPS FIPSNO CRESS_ID BIR74 NWBIR74 BIR79 SID79 NWBIR79</span></span>
<span><span class="co"># 1 0.114     1.442  1825    1825      Ashe 37009  37009        5  1091      10  1364     0      19</span></span>
<span><span class="co"># 2 0.070     2.968  1831    1831 Currituck 37053  37053       27   508     123   830     2     145</span></span>
<span><span class="co"># 3 0.124     1.428  1837    1837    Stokes 37169  37169       85  1612     160  2038     5     176</span></span>
<span><span class="co">#                         geometry</span></span>
<span><span class="co"># 1 MULTIPOLYGON (((-81.47276 3...</span></span>
<span><span class="co"># 2 MULTIPOLYGON (((-76.00897 3...</span></span>
<span><span class="co"># 3 MULTIPOLYGON (((-80.02567 3...</span></span></code></pre></div>
<p>The default in <code><a href="../reference/rsplit.html">rsplit()</a></code> for data frames is
<code>simplify = TRUE</code>, which, for a single LHS variable, would
just split the column-vector. This does not apply to <em>sf</em> data
frames as the ‘geometry’ column is always selected as well.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Only splitting Area</span></span>
<span><span class="fu"><a href="../reference/rsplit.html">rsplit</a></span><span class="op">(</span><span class="va">nc</span>, <span class="va">AREA</span> <span class="op">~</span> <span class="va">SID74</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="co"># $`0`</span></span>
<span><span class="co"># Simple feature collection with 13 features and 1 field</span></span>
<span><span class="co"># Geometry type: MULTIPOLYGON</span></span>
<span><span class="co"># Dimension:     XY</span></span>
<span><span class="co"># Bounding box:  xmin: -84.32385 ymin: 33.88199 xmax: -75.45698 ymax: 36.58965</span></span>
<span><span class="co"># Geodetic CRS:  NAD27</span></span>
<span><span class="co"># First 3 features:</span></span>
<span><span class="co">#    AREA                       geometry</span></span>
<span><span class="co"># 1 0.061 MULTIPOLYGON (((-81.23989 3...</span></span>
<span><span class="co"># 2 0.062 MULTIPOLYGON (((-76.00897 3...</span></span>
<span><span class="co"># 3 0.091 MULTIPOLYGON (((-76.56251 3...</span></span>
<span></span>
<span><span class="co"># For data frames the default simplify = TRUE drops the data frame structure</span></span>
<span><span class="fu"><a href="../reference/rsplit.html">rsplit</a></span><span class="op">(</span><span class="fu"><a href="../reference/quick-conversion.html">qDF</a></span><span class="op">(</span><span class="va">nc</span><span class="op">)</span>, <span class="va">AREA</span> <span class="op">~</span> <span class="va">SID74</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="co"># $`0`</span></span>
<span><span class="co">#  [1] 0.061 0.062 0.091 0.064 0.059 0.080 0.066 0.099 0.094 0.078 0.131 0.167 0.051</span></span></code></pre></div>
<p><em>sf</em> data frames can be combined using <code><a href="../reference/rowbind.html">rowbind()</a></code>,
which, by default, preserves the attributes of the first object.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Splitting by each row and recombining</span></span>
<span><span class="va">nc_combined</span> <span class="op">&lt;-</span> <span class="va">nc</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="../reference/rsplit.html">rsplit</a></span><span class="op">(</span><span class="fu"><a href="../reference/efficient-programming.html">seq_row</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="../reference/rowbind.html">rowbind</a></span><span class="op">(</span><span class="op">)</span> </span>
<span><span class="fu"><a href="https://rdrr.io/r/base/identical.html" class="external-link">identical</a></span><span class="op">(</span><span class="va">nc</span>, <span class="va">nc_combined</span><span class="op">)</span></span>
<span><span class="co"># [1] TRUE</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="transformations">Transformations<a class="anchor" aria-label="anchor" href="#transformations"></a>
</h2>
<p>For transforming and computing columns, <code><a href="../reference/ftransform.html">fmutate()</a></code> and
<code>ftransform[v]()</code> apply as to any other data frame.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/ftransform.html">fmutate</a></span><span class="op">(</span><span class="va">nc</span>, gsum_AREA <span class="op">=</span> <span class="fu"><a href="../reference/fsum.html">fsum</a></span><span class="op">(</span><span class="va">AREA</span>, <span class="va">SID74</span>, TRA <span class="op">=</span> <span class="st">"fill"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co"># Simple feature collection with 6 features and 15 fields</span></span>
<span><span class="co"># Geometry type: MULTIPOLYGON</span></span>
<span><span class="co"># Dimension:     XY</span></span>
<span><span class="co"># Bounding box:  xmin: -81.74107 ymin: 36.07282 xmax: -75.77316 ymax: 36.58965</span></span>
<span><span class="co"># Geodetic CRS:  NAD27</span></span>
<span><span class="co"># First 3 features:</span></span>
<span><span class="co">#    AREA PERIMETER CNTY_ CNTY_ID      NAME  FIPS FIPSNO CRESS_ID BIR74 SID74 NWBIR74 BIR79 SID79</span></span>
<span><span class="co"># 1 0.114     1.442  1825    1825      Ashe 37009  37009        5  1091     1      10  1364     0</span></span>
<span><span class="co"># 2 0.061     1.231  1827    1827 Alleghany 37005  37005        3   487     0      10   542     3</span></span>
<span><span class="co"># 3 0.143     1.630  1828    1828     Surry 37171  37171       86  3188     5     208  3616     6</span></span>
<span><span class="co">#   NWBIR79                       geometry gsum_AREA</span></span>
<span><span class="co"># 1      19 MULTIPOLYGON (((-81.47276 3...     0.914</span></span>
<span><span class="co"># 2      12 MULTIPOLYGON (((-81.23989 3...     1.103</span></span>
<span><span class="co"># 3     260 MULTIPOLYGON (((-80.45634 3...     1.380</span></span>
<span></span>
<span><span class="co"># Same thing, more expensive</span></span>
<span><span class="va">nc</span> <span class="op">|&gt;</span> <span class="fu"><a href="../reference/GRP.html">fgroup_by</a></span><span class="op">(</span><span class="va">SID74</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="../reference/ftransform.html">fmutate</a></span><span class="op">(</span>gsum_AREA <span class="op">=</span> <span class="fu"><a href="../reference/fsum.html">fsum</a></span><span class="op">(</span><span class="va">AREA</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="../reference/GRP.html">fungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co"># Simple feature collection with 6 features and 15 fields</span></span>
<span><span class="co"># Geometry type: MULTIPOLYGON</span></span>
<span><span class="co"># Dimension:     XY</span></span>
<span><span class="co"># Bounding box:  xmin: -81.74107 ymin: 36.07282 xmax: -75.77316 ymax: 36.58965</span></span>
<span><span class="co"># Geodetic CRS:  NAD27</span></span>
<span><span class="co"># First 3 features:</span></span>
<span><span class="co">#    AREA PERIMETER CNTY_ CNTY_ID      NAME  FIPS FIPSNO CRESS_ID BIR74 SID74 NWBIR74 BIR79 SID79</span></span>
<span><span class="co"># 1 0.114     1.442  1825    1825      Ashe 37009  37009        5  1091     1      10  1364     0</span></span>
<span><span class="co"># 2 0.061     1.231  1827    1827 Alleghany 37005  37005        3   487     0      10   542     3</span></span>
<span><span class="co"># 3 0.143     1.630  1828    1828     Surry 37171  37171       86  3188     5     208  3616     6</span></span>
<span><span class="co">#   NWBIR79                       geometry gsum_AREA</span></span>
<span><span class="co"># 1      19 MULTIPOLYGON (((-81.47276 3...     0.914</span></span>
<span><span class="co"># 2      12 MULTIPOLYGON (((-81.23989 3...     1.103</span></span>
<span><span class="co"># 3     260 MULTIPOLYGON (((-80.45634 3...     1.380</span></span></code></pre></div>
<p>Special attention to <em>sf</em> data frames is afforded by
<code><a href="../reference/ftransform.html">fcompute()</a></code>, which can be used to compute new columns
dropping existing ones - except for the geometry column and any columns
selected through the <code>keep</code> argument.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/ftransform.html">fcompute</a></span><span class="op">(</span><span class="va">nc</span>, scaled_AREA <span class="op">=</span> <span class="fu"><a href="../reference/fscale.html">fscale</a></span><span class="op">(</span><span class="va">AREA</span><span class="op">)</span>, </span>
<span>             gsum_AREA <span class="op">=</span> <span class="fu"><a href="../reference/fsum.html">fsum</a></span><span class="op">(</span><span class="va">AREA</span>, <span class="va">SID74</span>, TRA <span class="op">=</span> <span class="st">"fill"</span><span class="op">)</span>, </span>
<span>         keep <span class="op">=</span> <span class="fu"><a href="../reference/small-helpers.html">.c</a></span><span class="op">(</span><span class="va">AREA</span>, <span class="va">SID74</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># Simple feature collection with 100 features and 4 fields</span></span>
<span><span class="co"># Geometry type: MULTIPOLYGON</span></span>
<span><span class="co"># Dimension:     XY</span></span>
<span><span class="co"># Bounding box:  xmin: -84.32385 ymin: 33.88199 xmax: -75.45698 ymax: 36.58965</span></span>
<span><span class="co"># Geodetic CRS:  NAD27</span></span>
<span><span class="co"># First 3 features:</span></span>
<span><span class="co">#    AREA SID74 scaled_AREA gsum_AREA                       geometry</span></span>
<span><span class="co"># 1 0.114     1  -0.2491860     0.914 MULTIPOLYGON (((-81.47276 3...</span></span>
<span><span class="co"># 2 0.061     0  -1.3264176     1.103 MULTIPOLYGON (((-81.23989 3...</span></span>
<span><span class="co"># 3 0.143     5   0.3402426     1.380 MULTIPOLYGON (((-80.45634 3...</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="conversion-to-and-from-sf">Conversion to and from <em>sf</em><a class="anchor" aria-label="anchor" href="#conversion-to-and-from-sf"></a>
</h2>
<p>The quick converters <code><a href="../reference/quick-conversion.html">qDF()</a></code>, <code><a href="../reference/quick-conversion.html">qDT()</a></code>, and
<code><a href="../reference/quick-conversion.html">qTBL()</a></code> can be used to efficiently convert <em>sf</em> data
frames to standard data frames, <em>data.table</em>’s or
<em>tibbles</em>, and the result can be converted back to the original
<em>sf</em> data frame using <code><a href="../reference/small-helpers.html">setAttrib()</a></code>,
<code><a href="../reference/small-helpers.html">copyAttrib()</a></code> or <code><a href="../reference/small-helpers.html">copyMostAttrib()</a></code>.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-datatable.com" class="external-link">data.table</a></span><span class="op">)</span></span>
<span><span class="co"># Create a data.table on the fly to do an fast grouped rolling mean and back to sf</span></span>
<span><span class="fu"><a href="../reference/quick-conversion.html">qDT</a></span><span class="op">(</span><span class="va">nc</span><span class="op">)</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>roll_AREA <span class="op">=</span> <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/froll.html" class="external-link">frollmean</a></span><span class="op">(</span><span class="va">AREA</span>, <span class="fl">2</span><span class="op">)</span>, <span class="va">geometry</span><span class="op">)</span>, by <span class="op">=</span> <span class="va">SID74</span><span class="op">]</span> <span class="op">|&gt;</span> <span class="fu"><a href="../reference/small-helpers.html">copyMostAttrib</a></span><span class="op">(</span><span class="va">nc</span><span class="op">)</span></span>
<span><span class="co"># Simple feature collection with 100 features and 2 fields</span></span>
<span><span class="co"># Geometry type: MULTIPOLYGON</span></span>
<span><span class="co"># Dimension:     XY</span></span>
<span><span class="co"># Bounding box:  xmin: -84.32385 ymin: 33.88199 xmax: -75.45698 ymax: 36.58965</span></span>
<span><span class="co"># Geodetic CRS:  NAD27</span></span>
<span><span class="co"># First 3 features:</span></span>
<span><span class="co">#   SID74 roll_AREA                       geometry</span></span>
<span><span class="co"># 1     1        NA MULTIPOLYGON (((-81.47276 3...</span></span>
<span><span class="co"># 2     1     0.092 MULTIPOLYGON (((-76.00897 3...</span></span>
<span><span class="co"># 3     1     0.097 MULTIPOLYGON (((-80.02567 3...</span></span></code></pre></div>
<p>The easiest way to strip a geometry column off an <em>sf</em> data
frame is via the function <code><a href="../reference/extract_list.html">atomic_elem()</a></code>, which removes
list-like columns and, by default, also the class attribute. For
example, we can create a <em>data.table</em> without list column
using</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/quick-conversion.html">qDT</a></span><span class="op">(</span><span class="fu"><a href="../reference/extract_list.html">atomic_elem</a></span><span class="op">(</span><span class="va">nc</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#     AREA PERIMETER CNTY_ CNTY_ID        NAME   FIPS FIPSNO CRESS_ID BIR74 SID74 NWBIR74 BIR79 SID79</span></span>
<span><span class="co">#    &lt;num&gt;     &lt;num&gt; &lt;num&gt;   &lt;num&gt;      &lt;char&gt; &lt;char&gt;  &lt;num&gt;    &lt;int&gt; &lt;num&gt; &lt;num&gt;   &lt;num&gt; &lt;num&gt; &lt;num&gt;</span></span>
<span><span class="co"># 1: 0.114     1.442  1825    1825        Ashe  37009  37009        5  1091     1      10  1364     0</span></span>
<span><span class="co"># 2: 0.061     1.231  1827    1827   Alleghany  37005  37005        3   487     0      10   542     3</span></span>
<span><span class="co"># 3: 0.143     1.630  1828    1828       Surry  37171  37171       86  3188     5     208  3616     6</span></span>
<span><span class="co"># 4: 0.070     2.968  1831    1831   Currituck  37053  37053       27   508     1     123   830     2</span></span>
<span><span class="co"># 5: 0.153     2.206  1832    1832 Northampton  37131  37131       66  1421     9    1066  1606     3</span></span>
<span><span class="co"># 6: 0.097     1.670  1833    1833    Hertford  37091  37091       46  1452     7     954  1838     5</span></span>
<span><span class="co">#    NWBIR79</span></span>
<span><span class="co">#      &lt;num&gt;</span></span>
<span><span class="co"># 1:      19</span></span>
<span><span class="co"># 2:      12</span></span>
<span><span class="co"># 3:     260</span></span>
<span><span class="co"># 4:     145</span></span>
<span><span class="co"># 5:    1197</span></span>
<span><span class="co"># 6:    1237</span></span></code></pre></div>
<p>This is also handy for other functions such as <code><a href="../reference/join.html">join()</a></code>
and <code><a href="../reference/pivot.html">pivot()</a></code>, which are class agnostic like all of
<em>collapse</em>, but do not have any built-in logic to deal with the
<em>sf</em> column.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Use atomic_elem() to strip geometry off y in left join</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/identical.html" class="external-link">identical</a></span><span class="op">(</span><span class="va">nc</span>, <span class="fu"><a href="../reference/join.html">join</a></span><span class="op">(</span><span class="va">nc</span>, <span class="fu"><a href="../reference/extract_list.html">atomic_elem</a></span><span class="op">(</span><span class="va">nc</span><span class="op">)</span>, overid <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># left join: nc[AREA, PERIMETER, CNTY_, CNTY_ID, NAME, FIPS, FIPSNO, CRESS_ID, BIR74, SID74, NWBIR74, BIR79, SID79, NWBIR79] 100/100 (100%) &lt;m:m&gt; y[AREA, PERIMETER, CNTY_, CNTY_ID, NAME, FIPS, FIPSNO, CRESS_ID, BIR74, SID74, NWBIR74, BIR79, SID79, NWBIR79] 100/100 (100%)</span></span>
<span><span class="co"># [1] TRUE</span></span>
<span></span>
<span><span class="co"># In pivot: presently need to specify what to do with geometry column</span></span>
<span><span class="fu"><a href="../reference/pivot.html">pivot</a></span><span class="op">(</span><span class="va">nc</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"CNTY_ID"</span>, <span class="st">"geometry"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co"># Simple feature collection with 6 features and 3 fields</span></span>
<span><span class="co"># Geometry type: MULTIPOLYGON</span></span>
<span><span class="co"># Dimension:     XY</span></span>
<span><span class="co"># Bounding box:  xmin: -81.74107 ymin: 36.07282 xmax: -75.77316 ymax: 36.58965</span></span>
<span><span class="co"># Geodetic CRS:  NAD27</span></span>
<span><span class="co"># First 3 features:</span></span>
<span><span class="co">#   CNTY_ID                       geometry variable value</span></span>
<span><span class="co"># 1    1825 MULTIPOLYGON (((-81.47276 3...     AREA 0.114</span></span>
<span><span class="co"># 2    1827 MULTIPOLYGON (((-81.23989 3...     AREA 0.061</span></span>
<span><span class="co"># 3    1828 MULTIPOLYGON (((-80.45634 3...     AREA 0.143</span></span>
<span><span class="co"># Or use</span></span>
<span><span class="fu"><a href="../reference/pivot.html">pivot</a></span><span class="op">(</span><span class="fu"><a href="../reference/quick-conversion.html">qDT</a></span><span class="op">(</span><span class="fu"><a href="../reference/extract_list.html">atomic_elem</a></span><span class="op">(</span><span class="va">nc</span><span class="op">)</span><span class="op">)</span>, <span class="st">"CNTY_ID"</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#    CNTY_ID variable  value</span></span>
<span><span class="co">#      &lt;num&gt;   &lt;fctr&gt; &lt;char&gt;</span></span>
<span><span class="co"># 1:    1825     AREA  0.114</span></span>
<span><span class="co"># 2:    1827     AREA  0.061</span></span>
<span><span class="co"># 3:    1828     AREA  0.143</span></span>
<span><span class="co"># 4:    1831     AREA   0.07</span></span>
<span><span class="co"># 5:    1832     AREA  0.153</span></span>
<span><span class="co"># 6:    1833     AREA  0.097</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="support-for-units">Support for <em>units</em><a class="anchor" aria-label="anchor" href="#support-for-units"></a>
</h2>
<p>Since v2.0.13, <em>collapse</em> explicitly supports/preserves
<em>units</em> objects through dedicated methods that preserve the
‘units’ class wherever sensible.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nc_dist</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html" class="external-link">st_centroid</a></span><span class="op">(</span><span class="va">nc</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_measures.html" class="external-link">st_distance</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">nc_dist</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span></span>
<span><span class="co"># Units: [m]</span></span>
<span><span class="co">#          [,1]     [,2]     [,3]</span></span>
<span><span class="co"># [1,]     0.00 34020.35 72728.02</span></span>
<span><span class="co"># [2,] 34020.35     0.00 40259.55</span></span>
<span><span class="co"># [3,] 72728.02 40259.55     0.00</span></span>
<span></span>
<span><span class="fu"><a href="../reference/fmean.html">fmean</a></span><span class="op">(</span><span class="va">nc_dist</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co"># Units: [m]</span></span>
<span><span class="co"># [1] 250543.9 237040.0 217941.5 337016.5 250380.2 269604.6</span></span>
<span><span class="fu"><a href="../reference/fndistinct.html">fndistinct</a></span><span class="op">(</span><span class="va">nc_dist</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co"># [1] 100 100 100 100 100 100</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="conclusion">Conclusion<a class="anchor" aria-label="anchor" href="#conclusion"></a>
</h2>
<p><em>collapse</em> provides no deep integration with the <em>sf</em>
ecosystem and cannot perform spatial operations, but offers sufficient
features and flexibility to painlessly manipulate <em>sf</em> data
frames at much greater speeds than <em>dplyr</em>.</p>
<p>This requires a bit of care by the user though to ensure that the
returned <em>sf</em> objects are valid, especially following aggregation
and subsetting.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Sebastian Krantz.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.9000.</p>
</div>

    </footer>
</div>





  </body>
</html>
