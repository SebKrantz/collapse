<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>collapse's Handling of R Objects • collapse</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="48x48" href="../favicon-48x48.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="collapse's Handling of R Objects">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">collapse</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Released version">2.1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Documentation</a></li>
<li class="active nav-item"><a class="nav-link" href="../articles/index.html">Vignettes</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">News</a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://sebkrantz.github.io/Rblog/">Blog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://bsky.app/profile/rcollapse.bsky.social" aria-label="BlueSky"><span class="fa fa-bluesky"></span></a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://twitter.com/collapse_R" aria-label="Twitter"><span class="fa fa-twitter"></span></a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/SebKrantz/collapse" aria-label="GitHub"><span class="fa fa-github"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>collapse's Handling of R Objects</h1>
            <h3 data-toc-skip class="subtitle">A Quick View Behind the
Scenes of Class-Agnostic R Programming</h3>
                        <h4 data-toc-skip class="author">Sebastian
Krantz</h4>
            
            <h4 data-toc-skip class="date">2025-03-10</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/SebKrantz/collapse/blob/v2.1.0/vignettes/collapse_object_handling.Rmd" class="external-link"><code>vignettes/collapse_object_handling.Rmd</code></a></small>
      <div class="d-none name"><code>collapse_object_handling.Rmd</code></div>
    </div>

    
    
<p>This much-requested vignette provides some details about how
<em>collapse</em> deals with various R objects. It is principally a
digest of cumulative details provided in the <a href="https://sebkrantz.github.io/collapse/news/index.html">NEWS</a> for
various releases since v1.4.0.</p>
<div class="section level2">
<h2 id="overview">Overview<a class="anchor" aria-label="anchor" href="#overview"></a>
</h2>
<p><em>collapse</em> provides a class-agnostic architecture permitting
computations on a very broad range of R objects. It provides explicit
support for base R classes and data types (<em>logical</em>,
<em>integer</em>, <em>double</em>, <em>character</em>, <em>list</em>,
<em>data.frame</em>, <em>matrix</em>, <em>factor</em>, <em>Date</em>,
<em>POSIXct</em>, <em>ts</em>) and their popular extensions, including
<em>integer64</em>, <em>data.table</em>, <em>tibble</em>,
<em>grouped_df</em>, <em>xts</em>/<em>zoo</em>, <em>pseries</em>,
<em>pdata.frame</em>, <em>units</em>, and <em>sf</em> (no geometric
operations).</p>
<p>It also introduces <a href="https://sebkrantz.github.io/collapse/reference/GRP.html"><em>GRP_df</em></a>
as a more performant and class-agnostic grouped data frame, and <a href="https://sebkrantz.github.io/collapse/reference/indexing.html"><em>indexed_series</em>
and <em>indexed_frame</em></a> classes as modern class-agnostic
successors of <em>pseries</em>, <em>pdata.frame</em>. These objects
inherit the classes they succeed and are handled through
<code>.pseries</code>, <code>.pdata.frame</code>, and
<code>.grouped_df</code> methods, which also support the original
(<em>plm</em> / <em>dplyr</em>) implementations (details below).</p>
<p>All other objects are handled internally at the C or R level using
general principles extended by specific considerations for some of the
above classes. I start with summarizing the general principles, which
enable the usage of <em>collapse</em> with further classes it does not
explicitly support.</p>
</div>
<div class="section level2">
<h2 id="general-principles">General Principles<a class="anchor" aria-label="anchor" href="#general-principles"></a>
</h2>
<p>In general, <em>collapse</em> preserves attributes and classes of R
objects in statistical and data manipulation operations unless their
preservation involves a <strong>high-risk</strong> of yielding something
wrong/useless. Risky operations change the dimensions or internal data
type (<code><a href="https://rdrr.io/r/base/typeof.html" class="external-link">typeof()</a></code>) of an R object.</p>
<p>To <em>collapse</em>’s R and C code, there exist 3 principal types of
R objects: atomic vectors, matrices, and lists - which are often assumed
to be data frames. Most data manipulation functions in
<em>collapse</em>, like <code><a href="../reference/ftransform.html">fmutate()</a></code>, only support lists,
whereas statistical functions - like the S3 generic <a href="https://sebkrantz.github.io/collapse/reference/fast-statistical-functions.html"><em>Fast
Statistical Functions</em></a> like <code><a href="../reference/fmean.html">fmean()</a></code> - generally
support all 3 types of objects.</p>
<p>S3 generic functions initially dispatch to <code>.default</code>,
<code>.matrix</code>, <code>.data.frame</code>, and (hidden)
<code>.list</code> methods.
<!-- The `.default` method has an internal check and dispatches to the `.matrix` method if `is.matrix(x) && !inherits(x, "matrix")`^[This guards against the automatic application of the `.default` method to matrix-like objects which do not inherit the "matrix" class (such as *xts*) while still allowing the user to manually call the default method on matrices.]. -->
The <code>.list</code> method generally dispatches to the
<code>.data.frame</code> method. These basic methods, and other
non-generic functions in <em>collapse</em>, then decide how exactly to
handle the object based on the statistical operation performed and
attribute handling principles mostly implemented in C.</p>
<p>The simplest case arises when an operation preserves the dimensions
of the object, such as <code>fscale(x)</code> or
<code>fmutate(data, across(a:c, log))</code>. In this case, all
attributes of <code>x / data</code> are fully preserved<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content='&lt;p&gt;Preservation implies a shallow copy of the attribute
lists from the original object to the result object. A shallow copy is
memory-efficient and means we are copying the list containing the
attributes in memory, but not the attributes themselves. Whenever I talk
about copying attributes, I mean a shallow copy, not a deep copy. You
can perform shallow copies with &lt;a href="https://sebkrantz.github.io/collapse/reference/small-helpers.html"&gt;helper
functions&lt;/a&gt; &lt;code&gt;&lt;a href="../reference/small-helpers.html"&gt;copyAttrib()&lt;/a&gt;&lt;/code&gt; or
&lt;code&gt;&lt;a href="../reference/small-helpers.html"&gt;copyMostAttrib()&lt;/a&gt;&lt;/code&gt;, and directly set attribute lists using
&lt;code&gt;&lt;a href="../reference/small-helpers.html"&gt;setAttrib()&lt;/a&gt;&lt;/code&gt; or &lt;code&gt;&lt;a href="../reference/small-helpers.html"&gt;setattrib()&lt;/a&gt;&lt;/code&gt;.&lt;/p&gt;'><sup>1</sup></a>.</p>
<p>Another simple case for matrices and lists arises when a statistical
operation reduces them to a single dimension such as
<code>fmean(x)</code>, where, under the <code>drop = TRUE</code> default
of <a href="https://sebkrantz.github.io/collapse/reference/fast-statistical-functions.html"><em>Fast
Statistical Functions</em></a>, all attributes apart from (column-)names
are dropped and a (named) vector of means is returned.</p>
<p>For atomic vectors, a statistical operation like
<code>fmean(x)</code> will preserve the attributes (except for
<em>ts</em> objects), as the object could have useful properties such as
labels or units.</p>
<p>More complex cases involve changing the dimensions of an object. If
the number of rows is preserved
e.g. <code>fmutate(data, a_b = a / b)</code> or
<code>flag(x, -1:1)</code>, only the (column-)names attribute of the
object is modified. If the number of rows is reduced
e.g. <code>fmean(x, g)</code>, all attributes are also retained under
suitable modifications of the (row-)names attribute. However, if
<code>x</code> is a matrix, other attributes than row- or column-names
are only retained if <code>!is.object(x)</code>, that is, if the matrix
does not have a ‘class’ attribute. For atomic vectors, attributes are
retained if <code>!inherits(x, "ts")</code>, as aggregating a time
series will break the class. This also applies to columns in a data
frame being aggregated.</p>
<p>When data is transformed using statistics as provided by the <a href="https://sebkrantz.github.io/collapse/reference/TRA.html"><code>TRA()</code>
function</a> e.g. <code>TRA(x, STATS, operation, groups)</code> and the
like-named argument to the <a href="https://sebkrantz.github.io/collapse/reference/fast-statistical-functions.html"><em>Fast
Statistical Functions</em></a>, operations that simply modify the input
(<code>x</code>) in a statistical sense (<code>"replace_na"</code>,
<code>"-"</code>, <code>"-+"</code>, <code>"/"</code>, <code>"+"</code>,
<code>"*"</code>, <code>"%%"</code>, <code>"-%%"</code>) just copy the
attributes to the transformed object. Operations <code>"fill"</code> and
<code>"replace"</code> are more tricky, since here <code>x</code> is
replaced with <code>STATS</code>, which could be of a different class or
data type. The following rules apply: (1) the result has the same data
type as <code>STATS</code>; (2) if <code>is.object(STATS)</code>, the
attributes of <code>STATS</code> are preserved; (3) otherwise the
attributes of <code>x</code> are preserved unless
<code>is.object(x) &amp;&amp; typeof(x) != typeof(STATS)</code>; (4) an
exemption to this rule is made if <code>x</code> is a factor and an
integer replacement is offered to STATS
e.g. <code>fnobs(factor, group, TRA = "fill")</code>. In that case, the
attributes of <code>x</code> are copied except for the ‘class’ and
‘levels’ attributes. These rules were devised considering the
possibility that <code>x</code> may have important information attached
to it which should be preserved in data transformations, such as a
<code>"label"</code> attribute.</p>
<p>Another rather complex case arises when manipulating data with
<em>collapse</em> using base R functions,
e.g. <code>BY(mtcars$mpg, mtcars$cyl, mad)</code> or
<code>mtcars |&gt; fgroup_by(cyl, vs, am) |&gt; fsummarise(mad_mpg = mad(mpg))</code>.
In this case, <em>collapse</em> internally uses base R functions
<code>lapply</code> and <code><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist()</a></code>, following efficient
splitting with <code><a href="../reference/GRP.html">gsplit()</a></code> (which preserves all attributes).
Concretely, the result is computed as
<code>y = unlist(lapply(gsplit(x, g), FUN, ...), FALSE, FALSE)</code>,
where in the examples <code>x</code> is <code>mtcars$mpg</code>,
<code>g</code> is the grouping variable(s), <code>FUN = mad</code>, and
<code>y</code> is <code>mad(x)</code> in each group. To follow its
policy of attribute preservation as closely as possible,
<em>collapse</em> then calls an internal function
<code>y_final = copyMostAttributes(y, x)</code>, which copies the
attributes of <code>x</code> to <code>y</code> if both are deemed
compatible<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content='&lt;p&gt;Concretely, attributes are copied
&lt;code&gt;if (typeof(x) == typeof(y) &amp;amp;&amp;amp; (identical(class(x), class(y)) || typeof(y) != "integer" || inherits(x, c("IDate", "ITime"))) &amp;amp;&amp;amp; !(length(x) != length(y) &amp;amp;&amp;amp; inherits(x, "ts")))&lt;/code&gt;.
The first part of the condition is easy: if &lt;code&gt;x&lt;/code&gt; and
&lt;code&gt;y&lt;/code&gt; are of different data types we do not copy attributes.
The second condition states that to copy attributes we also need to
ensure that &lt;code&gt;x&lt;/code&gt; and &lt;code&gt;y&lt;/code&gt; are either or the same
class or &lt;code&gt;y&lt;/code&gt; is not integer or &lt;code&gt;x&lt;/code&gt; is not an
integer-based date or time (= classes provided by &lt;em&gt;data.table&lt;/em&gt;).
The main reason for this clause is to guard against cases where we are
counting something on an integer-based variable such as a factor
e.g. &lt;code&gt;BY(factor, group, function(x) length(unique(x)))&lt;/code&gt;. The
case where the result is also a factor
e.g. &lt;code&gt;BY(factor, group, function(x) x[1])&lt;/code&gt; is dealt with
because &lt;code&gt;&lt;a href="https://rdrr.io/r/base/unlist.html" class="external-link"&gt;unlist()&lt;/a&gt;&lt;/code&gt; preserves factors, so
&lt;code&gt;identical(class(x), class(y))&lt;/code&gt; is &lt;code&gt;TRUE&lt;/code&gt;. The
last part of the expression again guards against reducing the length of
univariate time series and then copying the attributes.&lt;/p&gt;'><sup>2</sup></a>
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mo>≈</mo><annotation encoding="application/x-tex">\approx</annotation></semantics></math>
of the same data type). If they are deemed incompatible,
<code>copyMostAttributes</code> still checks if <code>x</code> has a
<code>"label"</code> attribute and copies that one to
<code>y</code>.</p>
<p>So to summarize the general principles: <em>collapse</em> just tries
to preserve attributes in all cases except where it is likely to break
something, beholding the way most commonly used R classes and objects
behave. The most likely operations that break something are when
aggregating matrices which have a class (such as
<em>mts</em>/<em>xts</em>) or univariate time series (<em>ts</em>), when
data is to be replaced by another object, or when applying an unknown
function to a vector by groups and assembling the result with
<code><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist()</a></code>. In the latter cases, particular attention is paid
to integer vectors and factors, as we often count something generating
integers, and malformed factors need to be avoided.</p>
<p>The following section provides some further details for some
<em>collapse</em> functions and supported classes.</p>
</div>
<div class="section level2">
<h2 id="specific-functions-and-classes">Specific Functions and Classes<a class="anchor" aria-label="anchor" href="#specific-functions-and-classes"></a>
</h2>
<div class="section level4">
<h4 id="object-conversions">Object Conversions<a class="anchor" aria-label="anchor" href="#object-conversions"></a>
</h4>
<p><a href="https://sebkrantz.github.io/collapse/reference/quick-conversion.html">Quick
conversion functions</a> <code>qDF</code>, <code>qDT</code>,
<code><a href="../reference/quick-conversion.html">qTBL()</a></code> and <code>qM</code> (to create data.frame’s,
<em>data.table</em>’s, <em>tibble</em>’s and matrices from arbitrary R
objects) by default (<code>keep.attr = FALSE</code>) perform very strict
conversions, where all attributes non-essential to the class are dropped
from the input object. This is to ensure that, following conversion,
objects behave exactly the way users expect. This is different from the
behavior of functions like <code><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame()</a></code>,
<code><a href="https://rdatatable.gitlab.io/data.table/reference/as.data.table.html" class="external-link">as.data.table()</a></code>, <code><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble()</a></code> or
<code><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix()</a></code> e.g. <code>as.matrix(EuStockMarkets)</code>
just returns <code>EuStockMarkets</code> whereas
<code>qM(EuStockMarkets)</code> returns a plain matrix without time
series attributes. This behavior can be changed by setting
<code>keep.attr = TRUE</code>,
i.e. <code>qM(EuStockMarkets, keep.attr = TRUE)</code>.</p>
</div>
<div class="section level4">
<h4 id="selecting-columns-by-data-type">Selecting Columns by Data Type<a class="anchor" aria-label="anchor" href="#selecting-columns-by-data-type"></a>
</h4>
<p>Functions <a href="https://sebkrantz.github.io/collapse/reference/select_replace_vars.html"><code>num_vars()</code>,
<code>cat_vars()</code> (the opposite of <code>num_vars()</code>),
<code>char_vars()</code> etc.</a> are implemented in C to avoid the need
to check data frame columns by applying an R function such as
<code><a href="https://rdrr.io/r/base/numeric.html" class="external-link">is.numeric()</a></code>. For <code>is.numeric</code>, the C
implementation is equivalent to
<code>is_numeric_C &lt;- function(x) typeof(x) %in% c("integer", "double") &amp;&amp; !inherits(x, c("factor", "Date", "POSIXct", "yearmon", "yearqtr"))</code>.
This of course does not respect the behavior of other classes that
define methods for <code>is.numeric</code>
e.g. <code>is.numeric.foo &lt;- function(x) FALSE</code>, then for
<code>y = structure(rnorm(100), class = "foo")</code>,
<code>is.numeric(y)</code> is <code>FALSE</code> but
<code>num_vars(data.frame(y))</code> still returns it. Correct behavior
in this case requires <code>get_vars(data.frame(y), is.numeric)</code>.
A particular case to be aware of is when using <code><a href="../reference/collap.html">collap()</a></code>
with the <code>FUN</code> and <code>catFUN</code> arguments, where the C
code (<code>is_numeric_C</code>) is used internally to decide whether a
column is numeric or categorical. <em>collapse</em> does not support
statistical operations on complex data.</p>
</div>
<div class="section level4">
<h4 id="parsing-of-time-ids">Parsing of Time-IDs<a class="anchor" aria-label="anchor" href="#parsing-of-time-ids"></a>
</h4>
<p><a href="https://sebkrantz.github.io/collapse/reference/time-series-panel-series.html"><em>Time
Series Functions</em></a> <code>flag</code>, <code>fdiff</code>,
<code>fgrowth</code> and <code>psacf/pspacf/psccf</code> (and the
operators <code>L/F/D/Dlog/G</code>) have a <code>t</code> argument to
pass time-ids for fully identified temporal operations on time series
and panel data. If <code>t</code> is a plain numeric vector or a factor,
it is coerced to integer using <code><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer()</a></code>, and the
integer steps are used as time steps. This is premised on the
observation that the most common form of temporal identifier is a
numeric variable denoting calendar years. If on the other hand
<code>t</code> is a numeric time object such that
<code>is.object(t) &amp;&amp; is.numeric(unclass(t))</code> (e.g. Date,
POSIXct, etc.), then it is passed through <code><a href="../reference/timeid.html">timeid()</a></code> which
computes the greatest common divisor of the vector and generates an
integer time-id in that way. Users are therefore advised to use
appropriate classes to represent time steps e.g. for monthly data
<code><a href="https://rdrr.io/pkg/zoo/man/yearmon.html" class="external-link">zoo::yearmon</a></code> would be appropriate. It is also possible to
pass non-numeric <code>t</code>, such as character or list/data.frame.
In such cases ordered grouping is applied to generate an integer
time-id, but this should rather be avoided.</p>
</div>
<div class="section level4">
<h4 id="xtszoo-time-series">
<em>xts</em>/<em>zoo</em> Time Series<a class="anchor" aria-label="anchor" href="#xtszoo-time-series"></a>
</h4>
<p><em>xts</em>/<em>zoo</em> time series are handled through
<code>.zoo</code> methods to all relevant functions. These methods are
simple and all follow this pattern:
<code>FUN.zoo &lt;- function(x, ...) if(is.matrix(x)) FUN.matrix(x, ...) else FUN.default(x, ....)</code>.
Thus the general principles apply. Time-Series function do not
automatically use the index for indexed computations, partly for
consistency with native methods where this is also not the case
(e.g. <code>lag.xts</code> does not perform an indexed lag), and partly
because, as outlined above, the index does not necessarily accurately
reflect the time structure. Thus the user must exercise discretion to
perform an indexed lag on <em>xts</em>/<em>zoo</em>. For example:
<code>flag(xts_daily, 1:3, t = index(xts_daily))</code> or
<code>flag(xts_monthly, 1:3, t = zoo::as.yearmon(index(xts_monthly)))</code>.</p>
</div>
<div class="section level4">
<h4 id="support-for-sf-and-units">Support for <em>sf</em> and <em>units</em><a class="anchor" aria-label="anchor" href="#support-for-sf-and-units"></a>
</h4>
<p><em>collapse</em> internally supports <em>sf</em> by seeking to avoid
their undue destruction through removal of the ‘geometry’ column in data
manipulation operations. This is simply implemented through an
additional check in the C programs used to subset columns of data: if
the object is an <em>sf</em> data frame, the ‘geometry’ column is added
to the column selection. Other functions like <code><a href="../reference/funique.html">funique()</a></code> or
<code><a href="../reference/roworder.html">roworder()</a></code> have internal facilities to avoid sorting or
grouping on the ‘geometry’ column. Again other functions like
<code><a href="../reference/descr.html">descr()</a></code> and <code><a href="../reference/qsu.html">qsu()</a></code> simply omit the geometry
column in their statistical calculations. A short <a href="https://sebkrantz.github.io/collapse/articles/collapse_and_sf.html">vignette</a>
describes the integration of <em>collapse</em> and <em>sf</em> in a bit
more detail. In summary: <em>collapse</em> supports <em>sf</em> by
seeking to appropriately deal with the ‘geometry’ column. It cannot
perform geometrical operations. For example, after subsetting with
<code><a href="../reference/fsubset.html">fsubset()</a></code>, the bounding box attribute of the geometry is
unaltered and likely too large.</p>
<p>Regarding <em>units</em> objects, all relevant functions also have
simple methods of the form
<code>FUN.units &lt;- function(x, ...) copyMostAttrib(if(is.matrix(x)) FUN.matrix(x, ...), x) else FUN.default(x, ....)</code>.
According to the general principles, the default method preserves the
units class, whereas the matrix method does not if <code>FUN</code>
aggregates the data. The use of <code><a href="../reference/small-helpers.html">copyMostAttrib()</a></code>, which
copies all attributes apart from <code>"dim"</code>,
<code>"dimnames"</code>, and <code>"names"</code>, ensures that the
returned objects are still <em>units</em>.</p>
</div>
<div class="section level4">
<h4 id="support-for-data-table">Support for <em>data.table</em><a class="anchor" aria-label="anchor" href="#support-for-data-table"></a>
</h4>
<p><em>collapse</em> provides quite thorough support for
<em>data.table</em>. The simplest level of support is that it avoids
assigning descriptive (character) row names to <em>data.table</em>’s
e.g. <code>fmean(mtcars, mtcars$cyl)</code> has row-names corresponding
to the groups but <code>fmean(qDT(mtcars), mtcars$cyl)</code> does
not.</p>
<p><em>collapse</em> further supports <em>data.table</em>’s reference
semantics (<code>set*</code>, <code>:=</code>). To be able to add
columns by reference (e.g. <code>DT[, new := 1]</code>),
<em>data.table</em>’s are implemented as overallocated lists<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content='&lt;p&gt;Notably, additional (hidden) column pointers are
allocated to be able to add columns without taking a shallow copy of the
&lt;em&gt;data.table&lt;/em&gt;, and an &lt;code&gt;".internal.selfref"&lt;/code&gt; attribute
containing an external pointer is used to check if any shallow copy was
made using base R commands like &lt;code&gt;&amp;lt;-&lt;/code&gt;.&lt;/p&gt;'><sup>3</sup></a>.
<em>collapse</em> copied some C code from <em>data.table</em> to do the
overallocation and generate the <code>".internal.selfref"</code>
attribute, so that <code><a href="../reference/quick-conversion.html">qDT()</a></code> creates a valid and fully
functional <em>data.table</em>. To enable seamless data manipulation
combining <em>collapse</em> and <em>data.table</em>, all data
manipulation functions in <em>collapse</em> call this C code at the end
and return a valid (overallocated) <em>data.table</em>. However, because
this overallocation comes at a computational cost of 2-3 microseconds, I
have opted against also adding it to the <code>.data.frame</code>
methods of statistical functions. Concretely, this means that
<code>res &lt;- DT |&gt; fgroup_by(id) |&gt; fsummarise(mu_a = fmean(a))</code>
gives a fully functional <em>data.table</em>
i.e. <code>res[, new := 1]</code> works, but
<code>res2 &lt;- DT |&gt; fgroup_by(id) |&gt; fmean()</code> gives a
non-overallocated <em>data.table</em> such that
<code>res2[, new := 1]</code> will still work but issue a warning. In
this case,
<code>res2 &lt;- DT |&gt; fgroup_by(id) |&gt; fmean() |&gt; qDT()</code>
can be used to avoid the warning. This, to me, seems a reasonable
trade-off between flexibility and performance. More details and examples
are provided in the <a href="https://sebkrantz.github.io/collapse/articles/collapse_and_data.table.html"><em>collapse</em>
and <em>data.table</em> vignette</a>.</p>
</div>
<div class="section level4">
<h4 id="class-agnostic-grouped-and-indexed-data-frames">Class-Agnostic Grouped and Indexed Data Frames<a class="anchor" aria-label="anchor" href="#class-agnostic-grouped-and-indexed-data-frames"></a>
</h4>
<p>As indicated in the introductory remarks, <em>collapse</em> provides
a fast <a href="https://sebkrantz.github.io/collapse/reference/GRP.html">class-agnostic
grouped data frame</a> created with <code><a href="../reference/GRP.html">fgroup_by()</a></code>, and fast
<a href="https://sebkrantz.github.io/collapse/reference/indexing.html">class-agnostic
indexed time series and panel data</a>, created with
<code><a href="../reference/indexing.html">findex_by()</a></code>/<code><a href="../reference/indexing.html">reindex()</a></code>. Class-agnostic means
that the object that is grouped/indexed continues to behave as before
except in <em>collapse</em> operations utilizing the ‘groups’/‘index_df’
attributes.</p>
<p>The grouped data frame is implemented as follows:
<code><a href="../reference/GRP.html">fgroup_by()</a></code> saves the class of the input data, calls
<code><a href="../reference/GRP.html">GRP()</a></code> on the columns being grouped, and attaches the
resulting ‘GRP’ object in a <code>"groups"</code> attribute. It then
assigns a class attribute as follows</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">clx</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">.X</span><span class="op">)</span> <span class="co"># .X is the data frame being grouped, clx is its class</span></span>
<span><span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/match.html" class="external-link">match</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"GRP_df"</span>, <span class="st">"grouped_df"</span>, <span class="st">"data.frame"</span><span class="op">)</span>, <span class="va">clx</span>, nomatch <span class="op">=</span> <span class="fl">0L</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">.X</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"GRP_df"</span>,  <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">mp</span> <span class="op">&lt;-</span> <span class="va">m</span><span class="op">[</span><span class="va">m</span> <span class="op">!=</span> <span class="fl">0L</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="va">clx</span><span class="op">[</span><span class="op">-</span><span class="va">mp</span><span class="op">]</span> <span class="kw">else</span> <span class="va">clx</span>, <span class="st">"grouped_df"</span>, <span class="kw">if</span><span class="op">(</span><span class="va">m</span><span class="op">[</span><span class="fl">3L</span><span class="op">]</span><span class="op">)</span> <span class="st">"data.frame"</span><span class="op">)</span> </span></code></pre></div>
<p>In words: a class <code>"GRP_df"</code> is added in front, followed
by the classes of the original object<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content='&lt;p&gt;Removing
&lt;code&gt;c("GRP_df", "grouped_df", "data.frame")&lt;/code&gt; if present to avoid
duplicate classes and allowing grouped data to be re-grouped.&lt;/p&gt;'><sup>4</sup></a>, followed by <code>"grouped_df"</code> and
finally <code>"data.frame"</code>, if present. The <code>"GRP_df"</code>
class is for dealing appropriately with the object through methods for
<code><a href="https://rdrr.io/r/base/print.html" class="external-link">print()</a></code> and subsetting (<code>[</code>, <code>[[</code>),
e.g. <code>print.GRP_df</code> fetches the grouping object, prints
<code>fungroup(.X)</code><a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content='&lt;p&gt;Which reverses the changes of &lt;code&gt;&lt;a href="../reference/GRP.html"&gt;fgroup_by()&lt;/a&gt;&lt;/code&gt;
so that the print method for the original object &lt;code&gt;.X&lt;/code&gt; is
called.&lt;/p&gt;'><sup>5</sup></a>, and then prints a summary of the grouping.
<code>[.GRP_df</code> works similarly: it saves the groups, calls
<code>[</code> on <code>fungroup(.X)</code>, and attaches the groups
again if the result is a list with the same number of rows. So
<em>collapse</em> has no issues printing and handling grouped
<em>data.table</em>’s, <em>tibbles</em>, <em>sf</em> data frames, etc. -
they continue to behave as usual. Now <em>collapse</em> has various
functions with a <code>.grouped_df</code> method to deal with grouped
data frames. For example <code>fmean.grouped_df</code>, in a nutshell,
fetches the attached ‘GRP’ object using <code>GRP.grouped_df</code>, and
calls <code>fmean.data.frame</code> on <code>fungroup(data)</code>,
passing the ‘GRP’ object to the <code>g</code> argument for grouped
computation. Here the general principles outlined above apply so that
the resulting object has the same attributes as the input.</p>
<p>This architecture has an additional advantage: it allows
<code>GRP.grouped_df</code> to examine the grouping object and check if
it was created by <em>collapse</em> (class ‘GRP’) or by <em>dplyr</em>.
If the latter is the case, an efficient C routine is called to convert
the <em>dplyr</em> grouping object to a ‘GRP’ object so that all
<code>.grouped_df</code> methods in <em>collapse</em> apply to data
frames created with either <code><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">dplyr::group_by()</a></code> or
<code><a href="../reference/GRP.html">fgroup_by()</a></code>.</p>
<p>The <em>indexed_frame</em> works similarly. It inherits from
<em>pdata.frame</em> so that <code>.pdata.frame</code> methods in
<em>collapse</em> deal with both <em>indexed_frame</em>’s of arbitrary
classes and <em>pdata.frame</em>’s created with <em>plm</em>.</p>
<p>A notable difference to both <em>grouped_df</em> and
<em>pdata.frame</em> is that <em>indexed_frame</em> is a deeply indexed
data structure: each variable inside an <em>indexed_frame</em> is an
<em>indexed_series</em> which contains in its <em>index_df</em>
attribute an external pointer to the <em>index_df</em> attribute of the
frame. Functions with <em>pseries</em> methods operating on
<em>indexed_series</em> stored inside the frame (such as
<code>with(data, flag(column))</code>) can fetch the index from this
pointer. This allows worry-free application inside arbitrary data
masking environments (<code>with</code>, <code>%$%</code>,
<code>attach</code>, etc..) and estimation commands (<code>glm</code>,
<code>feols</code>, <code>lmrob</code> etc..) without duplication of the
index in memory. As you may have guessed, <em>indexed_series</em> are
also class-agnostic and inherit from <em>pseries</em>. Any vector or
matrix of any class can become an <em>indexed_series</em>.</p>
<p>Further levels of generality are that indexed series and frames allow
one, two or more variables in the index to support both time series and
complex panels, natively deal with irregularity in time<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content="&lt;p&gt;This is done through the creation of a time-factor in
the &lt;em&gt;index_df&lt;/em&gt; attribute whose levels represent time steps, i.e.,
the factor will have unused levels for gaps in time.&lt;/p&gt;"><sup>6</sup></a>, and provide a rich
set of methods for subsetting and manipulation which also subset the
<em>index_df</em> attribute, including internal methods for
<code><a href="../reference/fsubset.html">fsubset()</a></code>, <code><a href="../reference/funique.html">funique()</a></code>, <code>roworder(v)</code>
and <code><a href="../reference/efficient-programming.html">na_omit()</a></code>. So <em>indexed_frame</em> and
<em>indexed_series</em> is a rich and general structure permitting fully
time-aware computations on nearly any R object. See <a href="https://sebkrantz.github.io/collapse/reference/indexing.html"><code>?indexing</code></a>
for more information.</p>
</div>
</div>
<div class="section level2">
<h2 id="conclusion">Conclusion<a class="anchor" aria-label="anchor" href="#conclusion"></a>
</h2>
<p><em>collapse</em> handles R objects in a preserving and fairly
intelligent manner, allowing seamless compatibility with many common
data classes in R, and statistical workflows that preserve attributes
(labels, units, etc.) of the data. This is implemented through general
principles and some specific considerations/exemptions mostly
implemented in C - as detailed in this vignette.</p>
<p>The main benefits of this design are generality and execution speed:
<em>collapse</em> has much fewer R-level method dispatches and function
calls than other frameworks used to perform statistical or data
manipulation operations, it behaves predictably, and may also work well
with your simple new class.</p>
<p>The main disadvantage is that the general principles and exemptions
are hard-coded in C and thus may not work with specific classes. A
prominent example where <em>collapse</em> simply fails is
<em>lubridate</em>’s <em>interval</em> class (<a href="https://github.com/SebKrantz/collapse/issues/186" class="external-link">#186</a>, <a href="https://github.com/SebKrantz/collapse/issues/418" class="external-link">#418</a>), which
has a <code>"starts"</code> attribute of the same length as the data
that is preserved but not subset in <em>collapse</em> operations.</p>
</div>

  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Sebastian Krantz.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.9000.</p>
</div>

    </footer>
</div>





  </body>
</html>
