<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Developing with collapse • collapse</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<!-- katex math --><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css" integrity="sha384-nB0miv6/jRmo5UMMR1wu3Gz6NLsoTkbqJghGIsx//Rlm+ZU03BU6SQNC66uf4l5+" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js" integrity="sha384-7zkQWkzuo3B5mTepMUcHkMB5jZaolc2xDwL6VFqjFALcbeS9Ggm/Yr2r3Dy4lfFg" crossorigin="anonymous"></script><script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js" integrity="sha384-43gviWU0YVjaDtb/GhzOouOXtZMP/7XUzwPTstBeZFe/+rCMvRwr4yROQP43s0Xk" crossorigin="anonymous" onload="renderMathInElement(document.body);"></script><script src="../katex-auto.js"></script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Developing with collapse">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">collapse</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Released version">2.1.3</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Documentation</a></li>
<li class="active nav-item"><a class="nav-link" href="../articles/index.html">Vignettes</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">News</a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://sebkrantz.github.io/Rblog/">Blog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://bsky.app/profile/rcollapse.bsky.social" aria-label="BlueSky"><span class="fa fa-bluesky"></span></a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://twitter.com/collapse_R" aria-label="Twitter"><span class="fa fa-twitter"></span></a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/SebKrantz/collapse" aria-label="GitHub"><span class="fa fa-github"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Developing with collapse</h1>
            <h3 data-toc-skip class="subtitle">Or: How to Code
Efficiently in R</h3>
                        <h4 data-toc-skip class="author">Sebastian
Krantz</h4>
            
            <h4 data-toc-skip class="date">2024-12-30</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/SebKrantz/collapse/blob/v2.1.3/vignettes/developing_with_collapse.Rmd" class="external-link"><code>vignettes/developing_with_collapse.Rmd</code></a></small>
      <div class="d-none name"><code>developing_with_collapse.Rmd</code></div>
    </div>

    
    
<style type="text/css">
pre {
  max-height: 500px;
  overflow-y: auto;
}

pre[class] {
  max-height: 500px;
}
</style>
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p><em>collapse</em> offers an integrated suite of C/C++-based
statistical and data manipulation functions, many low-level tools for
memory efficient programming, and a <a href="https://sebkrantz.github.io/collapse/articles/collapse_object_handling.html">class-agnostic
architecture</a> that seamlessly supports vectors, matrices, and data
frame-like objects. These features make it an ideal backend for
high-performance statistical packages. This vignette is meant to provide
some recommendations for developing with <em>collapse</em>. It is
complementary to the earlier <a href="https://sebkrantz.github.io/Rblog/2020/09/13/programming-with-collapse/" class="external-link">blog
post on programming with <em>collapse</em></a> which readers are also
encouraged to consult. The vignette adds 3 important points for writing
efficient R/<em>collapse</em> code.</p>
</div>
<div class="section level2">
<h2 id="point-1-be-minimalistic-in-computations">Point 1: Be Minimalistic in Computations<a class="anchor" aria-label="anchor" href="#point-1-be-minimalistic-in-computations"></a>
</h2>
<p><em>collapse</em> supports different types of R objects (vectors,
matrices, data frames + variants) and it can perform grouped operations
on them using different types of grouping information (plain vectors,
‘qG’<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content="&lt;p&gt;Alias for quick-group.&lt;/p&gt;"><sup>1</sup></a>
objects, factors, ‘GRP’ objects, grouped or indexed data frames).
Grouping can be sorted or unsorted. A key for very efficient code is to
use the minimal required operations/objects to get the job done.</p>
<p>Suppose you want to sum an object <code>x</code> by groups using a
grouping vector <code>g</code>. If the grouping is only needed once,
this should be done using the internal grouping of <code><a href="../reference/fsum.html">fsum()</a></code>
without creating external grouping objects - <code>fsum(x, g)</code> for
aggregation and <code>fsum(x, g, TRA = "fill")</code> for expansion:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/fmean.html">fmean</a></span><span class="op">(</span><span class="va">mtcars</span><span class="op">$</span><span class="va">mpg</span>, <span class="va">mtcars</span><span class="op">$</span><span class="va">cyl</span><span class="op">)</span></span>
<span><span class="co">#        4        6        8 </span></span>
<span><span class="co"># 26.66364 19.74286 15.10000</span></span>
<span><span class="fu"><a href="../reference/fmean.html">fmean</a></span><span class="op">(</span><span class="va">mtcars</span><span class="op">$</span><span class="va">mpg</span>, <span class="va">mtcars</span><span class="op">$</span><span class="va">cyl</span>, TRA <span class="op">=</span> <span class="st">"fill"</span><span class="op">)</span></span>
<span><span class="co">#  [1] 19.74286 19.74286 26.66364 19.74286 15.10000 19.74286 15.10000 26.66364 26.66364 19.74286</span></span>
<span><span class="co"># [11] 19.74286 15.10000 15.10000 15.10000 15.10000 15.10000 15.10000 26.66364 26.66364 26.66364</span></span>
<span><span class="co"># [21] 26.66364 15.10000 15.10000 15.10000 15.10000 26.66364 26.66364 26.66364 15.10000 19.74286</span></span>
<span><span class="co"># [31] 15.10000 26.66364</span></span></code></pre></div>
<p>The expansion case is very efficient because it internally uses
unsorted grouping. Apart from the default sorted aggregation, these
functions efficiently convert your input <code>g</code> into the
minimally required information.</p>
<p>In the aggregation case, we can improve performance by also using
unsorted grouping, e.g., <code>fsum(x, qF(g, sort = FALSE))</code> or
<code>fsum(x, qG(g, sort = FALSE), use.g.names = FALSE)</code> if the
group-names are not needed. It is advisable to also set argument
<code>na.exclude = FALSE</code> in <code><a href="../reference/qF.html">qF()</a></code>/<code><a href="../reference/qF.html">qG()</a></code>
to add a class ‘na.included’ which precludes internal missing value
checks in <code><a href="../reference/fsum.html">fsum()</a></code> and friends. If <code>g</code> is a plain
vector or the first-appearance order of groups should be kept even if
<code>g</code> is a factor, use <code>group(g)</code> instead of
<code>qG(g, sort = FALSE, na.exclude = FALSE)</code>.<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content='&lt;p&gt;&lt;code&gt;&lt;a href="../reference/group.html"&gt;group()&lt;/a&gt;&lt;/code&gt; directly calls a C-based hashing
algorithm which works for all types of vectors and lists of vectors/data
frames. Missing values are treated as distinct elements.&lt;/p&gt;'><sup>2</sup></a> Set
<code>use.g.names = FALSE</code> if not needed (can abbreviate as
<code>use = FALSE</code>), and, if your data has no missing values, set
<code>na.rm = FALSE</code> for maximum performance.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">1e7</span><span class="op">)</span> <span class="co"># 10 million random obs</span></span>
<span><span class="va">g</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample.int</a></span><span class="op">(</span><span class="fl">1e6</span>, <span class="fl">1e7</span>, <span class="cn">TRUE</span><span class="op">)</span> <span class="co"># 1 Million random groups</span></span>
<span><span class="va">oldopts</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/collapse-options.html">set_collapse</a></span><span class="op">(</span>na.rm <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="co"># No missing values: maximum performance</span></span>
<span><span class="fu">microbenchmark</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html" class="external-link">microbenchmark</a></span><span class="op">(</span></span>
<span>  internal <span class="op">=</span> <span class="fu"><a href="../reference/fsum.html">fsum</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">g</span><span class="op">)</span>,</span>
<span>  internal_expand <span class="op">=</span> <span class="fu"><a href="../reference/fsum.html">fsum</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">g</span>, TRA <span class="op">=</span> <span class="st">"fill"</span><span class="op">)</span>,</span>
<span>  qF1 <span class="op">=</span> <span class="fu"><a href="../reference/fsum.html">fsum</a></span><span class="op">(</span><span class="va">x</span>, <span class="fu"><a href="../reference/qF.html">qF</a></span><span class="op">(</span><span class="va">g</span>, sort <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  qF2 <span class="op">=</span> <span class="fu"><a href="../reference/fsum.html">fsum</a></span><span class="op">(</span><span class="va">x</span>, <span class="fu"><a href="../reference/qF.html">qF</a></span><span class="op">(</span><span class="va">g</span>, sort <span class="op">=</span> <span class="cn">FALSE</span>, na.exclude <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  qG1 <span class="op">=</span> <span class="fu"><a href="../reference/fsum.html">fsum</a></span><span class="op">(</span><span class="va">x</span>, <span class="fu"><a href="../reference/qF.html">qG</a></span><span class="op">(</span><span class="va">g</span>, sort <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>, use <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>,</span>
<span>  qG2 <span class="op">=</span> <span class="fu"><a href="../reference/fsum.html">fsum</a></span><span class="op">(</span><span class="va">x</span>, <span class="fu"><a href="../reference/qF.html">qG</a></span><span class="op">(</span><span class="va">g</span>, sort <span class="op">=</span> <span class="cn">FALSE</span>, na.exclude <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>, use <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>,</span>
<span>  group <span class="op">=</span> <span class="fu"><a href="../reference/fsum.html">fsum</a></span><span class="op">(</span><span class="va">x</span>, <span class="fu"><a href="../reference/group.html">group</a></span><span class="op">(</span><span class="va">g</span><span class="op">)</span>, use <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>, <span class="co"># Same as above basically</span></span>
<span>  GRP1 <span class="op">=</span> <span class="fu"><a href="../reference/fsum.html">fsum</a></span><span class="op">(</span><span class="va">x</span>, <span class="fu"><a href="../reference/GRP.html">GRP</a></span><span class="op">(</span><span class="va">g</span><span class="op">)</span><span class="op">)</span>, </span>
<span>  GRP2 <span class="op">=</span> <span class="fu"><a href="../reference/fsum.html">fsum</a></span><span class="op">(</span><span class="va">x</span>, <span class="fu"><a href="../reference/GRP.html">GRP</a></span><span class="op">(</span><span class="va">g</span>, sort <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span>, </span>
<span>  GRP3 <span class="op">=</span> <span class="fu"><a href="../reference/fsum.html">fsum</a></span><span class="op">(</span><span class="va">x</span>, <span class="fu"><a href="../reference/GRP.html">GRP</a></span><span class="op">(</span><span class="va">g</span>, sort <span class="op">=</span> <span class="cn">FALSE</span>, return.groups <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>, use <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co"># Unit: milliseconds</span></span>
<span><span class="co">#             expr       min        lq      mean    median        uq      max neval</span></span>
<span><span class="co">#         internal 119.62078 124.61575 133.51499 129.24721 136.84295 187.9376   100</span></span>
<span><span class="co">#  internal_expand  87.45751  93.53473 101.63398  97.34573 105.04102 195.5121   100</span></span>
<span><span class="co">#              qF1  98.40816 101.62102 110.80120 105.03839 112.72224 265.5931   100</span></span>
<span><span class="co">#              qF2  86.75518  89.82823 100.47122  93.89814 103.04776 194.9115   100</span></span>
<span><span class="co">#              qG1  88.38563  92.44846 103.28242  97.29579 105.35159 202.8058   100</span></span>
<span><span class="co">#              qG2  72.94851  76.86912  87.05558  79.43137  86.15307 262.4734   100</span></span>
<span><span class="co">#            group  74.08335  77.19435  87.62058  82.58726  90.61506 162.0318   100</span></span>
<span><span class="co">#             GRP1 145.13799 149.54178 163.89938 154.71379 164.11361 297.5056   100</span></span>
<span><span class="co">#             GRP2  95.83557  99.05297 109.58577 103.34950 112.50322 266.9996   100</span></span>
<span><span class="co">#             GRP3  82.56629  86.15699  97.54058  90.40781  98.05956 328.7744   100</span></span></code></pre></div>
<p>Factors and ‘qG’ objects are efficient inputs to all
statistical/transformation functions except for <code><a href="../reference/fnth_fmedian.html">fmedian()</a></code>,
<code><a href="../reference/fnth_fmedian.html">fnth()</a></code>, <code><a href="../reference/fmode.html">fmode()</a></code>, <code><a href="../reference/fndistinct.html">fndistinct()</a></code>,
and split-apply-combine operations using
<code><a href="../reference/BY.html">BY()</a></code>/<code><a href="../reference/GRP.html">gsplit()</a></code>. For repeated grouped operations
involving those, it makes sense to create ‘GRP’ objects using
<code><a href="../reference/GRP.html">GRP()</a></code>. These objects are more expensive to create but
provide more complete information.<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content='&lt;p&gt;See &lt;code&gt;&lt;a href="../reference/GRP.html"&gt;?GRP&lt;/a&gt;&lt;/code&gt;, in particular the ‘Value’
section.&lt;/p&gt;'><sup>3</sup></a> If sorting is not needed, set
<code>sort = FALSE</code>, and if aggregation or the unique groups/names
are not needed set <code>return.groups = FALSE</code>.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">f</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/qF.html">qF</a></span><span class="op">(</span><span class="va">g</span><span class="op">)</span>; <span class="va">f2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/qF.html">qF</a></span><span class="op">(</span><span class="va">g</span>, na.exclude <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">gg</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/group.html">group</a></span><span class="op">(</span><span class="va">g</span><span class="op">)</span> <span class="co"># Same as qG(g, sort = FALSE, na.exclude = FALSE)</span></span>
<span><span class="va">grp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/GRP.html">GRP</a></span><span class="op">(</span><span class="va">g</span><span class="op">)</span></span>
<span><span class="co"># Simple functions: factors are efficient inputs</span></span>
<span><span class="fu">microbenchmark</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html" class="external-link">microbenchmark</a></span><span class="op">(</span></span>
<span>  factor <span class="op">=</span> <span class="fu"><a href="../reference/fsum.html">fsum</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">f</span><span class="op">)</span>,</span>
<span>  factor_nona <span class="op">=</span> <span class="fu"><a href="../reference/fsum.html">fsum</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">f2</span><span class="op">)</span>,</span>
<span>  qG_nona <span class="op">=</span> <span class="fu"><a href="../reference/fsum.html">fsum</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">gg</span><span class="op">)</span>,</span>
<span>  qG_nona_nonam <span class="op">=</span> <span class="fu"><a href="../reference/fsum.html">fsum</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">gg</span>, use <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>,</span>
<span>  GRP <span class="op">=</span> <span class="fu"><a href="../reference/fsum.html">fsum</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">grp</span><span class="op">)</span>,</span>
<span>  GRP_nonam <span class="op">=</span> <span class="fu"><a href="../reference/fsum.html">fsum</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">grp</span>, use <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co"># Unit: milliseconds</span></span>
<span><span class="co">#           expr      min       lq     mean   median       uq      max neval</span></span>
<span><span class="co">#         factor 16.02514 16.49498 17.50705 17.11619 18.16497 21.72975   100</span></span>
<span><span class="co">#    factor_nona 12.72911 13.15124 14.41943 13.87850 15.03540 23.27144   100</span></span>
<span><span class="co">#        qG_nona 14.30178 14.95450 20.48179 15.67930 17.34989 57.15597   100</span></span>
<span><span class="co">#  qG_nona_nonam 11.57118 12.00423 13.12157 12.49071 13.61801 23.31219   100</span></span>
<span><span class="co">#            GRP 12.83345 13.08907 14.45512 13.95154 15.21594 21.46473   100</span></span>
<span><span class="co">#      GRP_nonam 12.67589 13.22139 14.15271 13.76600 14.84057 20.36359   100</span></span>
<span></span>
<span><span class="co"># Complex functions: more information helps</span></span>
<span><span class="fu">microbenchmark</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html" class="external-link">microbenchmark</a></span><span class="op">(</span></span>
<span>  qG <span class="op">=</span> <span class="fu"><a href="../reference/fnth_fmedian.html">fmedian</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">gg</span>, use <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>,</span>
<span>  GRP <span class="op">=</span> <span class="fu"><a href="../reference/fnth_fmedian.html">fmedian</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">grp</span>, use <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>, times <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span><span class="co"># Unit: milliseconds</span></span>
<span><span class="co">#  expr      min       lq     mean   median       uq      max neval</span></span>
<span><span class="co">#    qG 258.4450 261.9357 267.2520 264.2608 267.4161 297.1552    10</span></span>
<span><span class="co">#   GRP 191.8623 193.0631 196.0935 193.4358 194.6245 210.3685    10</span></span>
<span><span class="fu"><a href="../reference/collapse-options.html">set_collapse</a></span><span class="op">(</span><span class="va">oldopts</span><span class="op">)</span></span></code></pre></div>
<p>Why not always use <code><a href="../reference/group.html">group()</a></code> for unsorted grouping with
simple functions? You can do that, but
<code><a href="../reference/qF.html">qF()</a></code>/<code><a href="../reference/qF.html">qG()</a></code> are a bit smarter when it comes to
handling input factors/‘qG’ objects whereas <code><a href="../reference/group.html">group()</a></code> hashes
every vector:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">microbenchmark</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html" class="external-link">microbenchmark</a></span><span class="op">(</span></span>
<span>  factor_factor <span class="op">=</span> <span class="fu"><a href="../reference/qF.html">qF</a></span><span class="op">(</span><span class="va">f</span><span class="op">)</span>,</span>
<span>  <span class="co"># This checks NA's and adds 'na.included' class -&gt; full deep copy</span></span>
<span>  factor_factor2 <span class="op">=</span> <span class="fu"><a href="../reference/qF.html">qF</a></span><span class="op">(</span><span class="va">f</span>, na.exclude <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>, </span>
<span>  <span class="co"># NA checking costs.. incurred in fsum() and friends</span></span>
<span>  check_na <span class="op">=</span> <span class="fu">collapse</span><span class="fu">:::</span><span class="fu">is.nmfactor</span><span class="op">(</span><span class="va">f</span><span class="op">)</span>, </span>
<span>  check_na2 <span class="op">=</span> <span class="fu">collapse</span><span class="fu">:::</span><span class="fu">is.nmfactor</span><span class="op">(</span><span class="va">f2</span><span class="op">)</span>,</span>
<span>  factor_qG <span class="op">=</span> <span class="fu"><a href="../reference/qF.html">qF</a></span><span class="op">(</span><span class="va">gg</span><span class="op">)</span>,</span>
<span>  qG_factor <span class="op">=</span> <span class="fu"><a href="../reference/qF.html">qG</a></span><span class="op">(</span><span class="va">f</span><span class="op">)</span>,</span>
<span>  qG_qG <span class="op">=</span> <span class="fu"><a href="../reference/qF.html">qG</a></span><span class="op">(</span><span class="va">gg</span><span class="op">)</span>,</span>
<span>  group_factor <span class="op">=</span> <span class="fu"><a href="../reference/group.html">group</a></span><span class="op">(</span><span class="va">f</span><span class="op">)</span>,</span>
<span>  group_qG <span class="op">=</span> <span class="fu"><a href="../reference/group.html">group</a></span><span class="op">(</span><span class="va">gg</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co"># Unit: nanoseconds</span></span>
<span><span class="co">#            expr      min         lq        mean     median         uq      max neval</span></span>
<span><span class="co">#   factor_factor     1107     2562.5     6925.31     7298.0     9676.0    19270   100</span></span>
<span><span class="co">#  factor_factor2  5926960  6147663.0  6898849.83  6235136.5  6421686.5 15325349   100</span></span>
<span><span class="co">#        check_na  3440474  3503880.5  3525056.59  3513597.5  3524770.0  3927185   100</span></span>
<span><span class="co">#       check_na2      287     1496.5     3325.10     3341.5     4243.5     9922   100</span></span>
<span><span class="co">#       factor_qG     2583    11644.0    15105.63    15887.5    18614.0    31898   100</span></span>
<span><span class="co">#       qG_factor     1927     4284.5    10171.28     9614.5    13796.5    50799   100</span></span>
<span><span class="co">#           qG_qG     1476     2583.0     6674.39     6498.5     8897.0    23124   100</span></span>
<span><span class="co">#    group_factor 16066629 16300165.0 17378151.76 16489011.0 16858872.0 54181582   100</span></span>
<span><span class="co">#        group_qG 13824175 14194917.5 15083957.81 14347396.5 14700345.0 22289117   100</span></span></code></pre></div>
<p>Only in rare cases are grouped/indexed data frames created with
<code><a href="../reference/GRP.html">fgroup_by()</a></code>/<code><a href="../reference/indexing.html">findex_by()</a></code> needed in package
code. Likewise, functions like
<code><a href="../reference/fsummarise.html">fsummarise()</a></code>/<code><a href="../reference/ftransform.html">fmutate()</a></code> are essentially
wrappers. For example</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mtcars</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/GRP.html">fgroup_by</a></span><span class="op">(</span><span class="va">cyl</span>, <span class="va">vs</span>, <span class="va">am</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/fsummarise.html">fsummarise</a></span><span class="op">(</span>mpg <span class="op">=</span> <span class="fu"><a href="../reference/fsum.html">fsum</a></span><span class="op">(</span><span class="va">mpg</span><span class="op">)</span>,</span>
<span>             <span class="fu"><a href="../reference/across.html">across</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">carb</span>, <span class="va">hp</span>, <span class="va">qsec</span><span class="op">)</span>, <span class="va">fmean</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#   cyl vs am   mpg     carb        hp     qsec</span></span>
<span><span class="co"># 1   4  0  1  26.0 2.000000  91.00000 16.70000</span></span>
<span><span class="co"># 2   4  1  0  68.7 1.666667  84.66667 20.97000</span></span>
<span><span class="co"># 3   4  1  1 198.6 1.428571  80.57143 18.70000</span></span>
<span><span class="co"># 4   6  0  1  61.7 4.666667 131.66667 16.32667</span></span>
<span><span class="co"># 5   6  1  0  76.5 2.500000 115.25000 19.21500</span></span>
<span><span class="co"># 6   8  0  0 180.6 3.083333 194.16667 17.14250</span></span>
<span><span class="co"># 7   8  0  1  30.8 6.000000 299.50000 14.55000</span></span></code></pre></div>
<p>is the same as (again <code>use = FALSE</code> abbreviates
<code>use.g.names = FALSE</code>)</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">g</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/GRP.html">GRP</a></span><span class="op">(</span><span class="va">mtcars</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"cyl"</span>, <span class="st">"vs"</span>, <span class="st">"am"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/select_replace_vars.html">add_vars</a></span><span class="op">(</span><span class="va">g</span><span class="op">$</span><span class="va">groups</span>,</span>
<span>  <span class="fu"><a href="../reference/select_replace_vars.html">get_vars</a></span><span class="op">(</span><span class="va">mtcars</span>, <span class="st">"mpg"</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="../reference/fsum.html">fsum</a></span><span class="op">(</span><span class="va">g</span>, use <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/select_replace_vars.html">get_vars</a></span><span class="op">(</span><span class="va">mtcars</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"carb"</span>, <span class="st">"hp"</span>, <span class="st">"qsec"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="../reference/fmean.html">fmean</a></span><span class="op">(</span><span class="va">g</span>, use <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#   cyl vs am   mpg     carb        hp     qsec</span></span>
<span><span class="co"># 1   4  0  1  26.0 2.000000  91.00000 16.70000</span></span>
<span><span class="co"># 2   4  1  0  68.7 1.666667  84.66667 20.97000</span></span>
<span><span class="co"># 3   4  1  1 198.6 1.428571  80.57143 18.70000</span></span>
<span><span class="co"># 4   6  0  1  61.7 4.666667 131.66667 16.32667</span></span>
<span><span class="co"># 5   6  1  0  76.5 2.500000 115.25000 19.21500</span></span>
<span><span class="co"># 6   8  0  0 180.6 3.083333 194.16667 17.14250</span></span>
<span><span class="co"># 7   8  0  1  30.8 6.000000 299.50000 14.55000</span></span></code></pre></div>
<p>To be clear: nothing prevents you from using these wrappers - they
are quite efficient - but if you want to change all inputs
programmatically it makes sense to go down one level - your code will
also become safer.<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content='&lt;p&gt;If you do use &lt;code&gt;&lt;a href="../reference/GRP.html"&gt;fgroup_by()&lt;/a&gt;&lt;/code&gt; in a package use
it with non-standard evaluation, e.g.,
&lt;code&gt;fgroup_by(cyl, vs, am)&lt;/code&gt;. Don’t do
&lt;code&gt;ind &amp;lt;- c("cyl", "vs", "am")&lt;/code&gt; and then
&lt;code&gt;fgroup_by(ind)&lt;/code&gt; as the data may contain a column called
&lt;code&gt;ind&lt;/code&gt;. For such cases use &lt;code&gt;group_by_vars(ind)&lt;/code&gt;.&lt;/p&gt;'><sup>4</sup></a></p>
<p>In general, think carefully about how to vectorize in a minimalistic
and memory efficient way. You will find that you can craft very
parsimonious and efficient code to solve complicated problems.</p>
<p>For example, after merging multiple spatial datasets, I had some of
the same map features (businesses) from multiple sources, and, unwilling
to match features individually across data sources, I decided to keep
the richest source covering each feature type and location. After
creating a feature <code>importance</code> indicator comparable across
sources, the deduplication expression ended up being a single line of
the form:
<code>fsubset(data, source == fmode(source, list(location, type), importance, "fill"))</code>
- keep features from the importance-weighted most frequent source by
location and type.</p>
<p>If an effective <em>collapse</em> solution is not apparent, other
packages may offer efficient solutions. Check out the <a href="https://fastverse.github.io/fastverse/" class="external-link"><em>fastverse</em></a> and
its <a href="https://fastverse.github.io/fastverse/#suggested-extensions" class="external-link">suggested
packages list</a>. For example if you want to efficiently replace
multiple items in a vector, <code>kit::vswitch()/nswitch()</code> can be
pretty magical. Also functions like
<code>data.table::set()/rowid()</code> etc. are great.</p>
</div>
<div class="section level2">
<h2 id="point-2-think-about-memory-and-optimize">Point 2: Think About Memory and Optimize<a class="anchor" aria-label="anchor" href="#point-2-think-about-memory-and-optimize"></a>
</h2>
<p>R programs are inefficient for 2 principal reasons: (1) operations
are not vectorized; (2) too many intermediate objects/copies are
created. <em>collapse</em>’s vectorized statistical functions help with
(1), but it also provides many <a href="https://sebkrantz.github.io/collapse/reference/efficient-programming.html">efficient
programming functions</a> to deal with (2).</p>
<p>One source of inefficiency in R code is the widespread use of logical
vectors. For example</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">1e6</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">x</span><span class="op">[</span><span class="va">x</span> <span class="op">==</span> <span class="fl">0</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">NA</span></span></code></pre></div>
<p>where <code>x == 0</code> creates a logical vector of 1 million
elements just to indicate to R which elements of <code>x</code> are
<code>0</code>. In <em>collapse</em>, <code>setv(x, 0, NA)</code> is the
efficient equivalent. This also works if we don’t want to replace with
<code>NA</code> but with another vector <code>y</code>:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">1e6</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/efficient-programming.html">setv</a></span><span class="op">(</span><span class="va">x</span>, <span class="cn">NA</span>, <span class="va">y</span><span class="op">)</span> <span class="co"># Replaces missing x with y</span></span></code></pre></div>
<p>is much better than</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">y</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">]</span></span></code></pre></div>
<p><code><a href="../reference/efficient-programming.html">setv()</a></code> is quite versatile and also works with indices
and logical vectors instead of elements to search for. You can also
invert the query by setting <code>invert = TRUE</code>.</p>
<p>In more complex workflows, we may wish to save the logical vector,
e.g., <code>xmiss &lt;- is.na(x)</code>, and use it repeatedly. One
aspect to note here is that logical vectors are inefficient for
subsetting compared to indices:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">xNA</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/efficient-programming.html">na_insert</a></span><span class="op">(</span><span class="va">x</span>, prop <span class="op">=</span> <span class="fl">0.4</span><span class="op">)</span></span>
<span><span class="va">xmiss</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">xNA</span><span class="op">)</span></span>
<span><span class="va">ind</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">xmiss</span><span class="op">)</span></span>
<span><span class="fu">bench</span><span class="fu">::</span><span class="fu">mark</span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="va">xmiss</span><span class="op">]</span>, <span class="va">x</span><span class="op">[</span><span class="va">ind</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co"># # A tibble: 2 × 6</span></span>
<span><span class="co">#   expression      min   median `itr/sec` mem_alloc `gc/sec`</span></span>
<span><span class="co">#   &lt;bch:expr&gt; &lt;bch:tm&gt; &lt;bch:tm&gt;     &lt;dbl&gt; &lt;bch:byt&gt;    &lt;dbl&gt;</span></span>
<span><span class="co"># 1 x[xmiss]     3.34ms   3.58ms      269.    8.39MB     4.21</span></span>
<span><span class="co"># 2 x[ind]     771.74µs 972.11µs     1025.    3.05MB     6.61</span></span></code></pre></div>
<p>Thus, indices are always preferable. With <em>collapse</em>, they can
be created directly using <code>whichNA(xNA)</code> in this case, or
<code>whichv(x, 0)</code> for <code>which(x == 0)</code> or any other
number. Also here there exist an <code>invert = TRUE</code> argument
covering the <code>!=</code> case. For convenience, infix operators
<code>x %==% 0</code> and <code>x %!=% 0</code> wrap
<code>whichv(x, 0)</code> and <code>whichv(x, 0, invert = TRUE)</code>,
respectively.</p>
<p>Similarly, <code><a href="../reference/fmatch.html">fmatch()</a></code> supports faster matching with
associated operators <code>%iin%</code> and <code>%!iin%</code> which
also return indices, e.g., <code>letters %iin% c("a", "b")</code>
returns <code>1:2</code>. This can also be used in subsetting:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">bench</span><span class="fu">::</span><span class="fu">mark</span><span class="op">(</span></span>
<span>  `%in%` <span class="op">=</span> <span class="fu"><a href="../reference/fsubset.html">fsubset</a></span><span class="op">(</span><span class="va">wlddev</span>, <span class="va">iso3c</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"USA"</span>, <span class="st">"DEU"</span>, <span class="st">"ITA"</span>, <span class="st">"GBR"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  `%iin%` <span class="op">=</span> <span class="fu"><a href="../reference/fsubset.html">fsubset</a></span><span class="op">(</span><span class="va">wlddev</span>, <span class="va">iso3c</span> <span class="op"><a href="../reference/fmatch.html">%iin%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"USA"</span>, <span class="st">"DEU"</span>, <span class="st">"ITA"</span>, <span class="st">"GBR"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co"># # A tibble: 2 × 6</span></span>
<span><span class="co">#   expression      min   median `itr/sec` mem_alloc `gc/sec`</span></span>
<span><span class="co">#   &lt;bch:expr&gt; &lt;bch:tm&gt; &lt;bch:tm&gt;     &lt;dbl&gt; &lt;bch:byt&gt;    &lt;dbl&gt;</span></span>
<span><span class="co"># 1 %in%        146.8µs  165.7µs     6008.     3.8MB     2.12</span></span>
<span><span class="co"># 2 %iin%        17.3µs   23.6µs    39878.   130.4KB    23.9</span></span></code></pre></div>
<p>Likewise, <code>anyNA(), allNA(), anyv()</code> and
<code><a href="../reference/efficient-programming.html">allv()</a></code> help avoid expressions like <code>any(x == 0)</code>
in favor of <code>anyv(x, 0)</code>. Other convenience functions exist
such as <code>na_rm(x)</code> for the common <code>x[!is.na(x)]</code>
expression which is extremely inefficient.</p>
<p>Another hint here particularly for data frame subsetting is the
<code><a href="../reference/fsubset.html">ss()</a></code> function, which has an argument
<code>check = FALSE</code> to avoid checks on indices (small effect with
this data size):</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ind</span> <span class="op">&lt;-</span> <span class="va">wlddev</span><span class="op">$</span><span class="va">iso3c</span> <span class="op"><a href="../reference/fmatch.html">%!iin%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"USA"</span>, <span class="st">"DEU"</span>, <span class="st">"ITA"</span>, <span class="st">"GBR"</span><span class="op">)</span></span>
<span><span class="fu">microbenchmark</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html" class="external-link">microbenchmark</a></span><span class="op">(</span></span>
<span>  withcheck <span class="op">=</span> <span class="fu"><a href="../reference/fsubset.html">ss</a></span><span class="op">(</span><span class="va">wlddev</span>, <span class="va">ind</span><span class="op">)</span>,</span>
<span>  nocheck <span class="op">=</span> <span class="fu"><a href="../reference/fsubset.html">ss</a></span><span class="op">(</span><span class="va">wlddev</span>, <span class="va">ind</span>, check <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co"># Unit: microseconds</span></span>
<span><span class="co">#       expr    min       lq     mean   median       uq     max neval</span></span>
<span><span class="co">#  withcheck 48.749 106.6615 124.4366 122.1595 143.8895 256.619   100</span></span>
<span><span class="co">#    nocheck 47.355 105.5750 126.9225 119.6380 150.8595 344.113   100</span></span></code></pre></div>
<p>Another common source of inefficiencies is copies produced in
statistical operations. For example</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span>; <span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span>; <span class="va">z</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span></span>
<span><span class="va">res</span> <span class="op">&lt;-</span> <span class="va">x</span> <span class="op">+</span> <span class="va">y</span> <span class="op">+</span> <span class="va">z</span> <span class="co"># Creates 2 copies</span></span></code></pre></div>
<p>For this particular case <code>res &lt;- kit::psum(x, y, z)</code>
offers an efficient solution<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content="&lt;p&gt;In general, also see other packages, in particular
&lt;em&gt;kit&lt;/em&gt; and &lt;em&gt;data.table&lt;/em&gt; for useful programming functions.&lt;/p&gt;"><sup>5</sup></a>. A more general solution is</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">res</span> <span class="op">&lt;-</span> <span class="va">x</span> <span class="op">+</span> <span class="va">y</span></span>
<span><span class="va">res</span> <span class="op"><a href="../reference/efficient-programming.html">%+=%</a></span> <span class="va">z</span></span></code></pre></div>
<p><em>collapse</em>’s <code>%+=%</code>, <code>%-=%</code>,
<code>%*=%</code> and <code>%/=%</code> operators are wrappers around
the <code><a href="../reference/efficient-programming.html">setop()</a></code> function which also works with matrices and
data frames.<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content="&lt;p&gt;&lt;em&gt;Note&lt;/em&gt; that infix operators do not obey the rules
of arithmetic but are always evaluated from left to right.&lt;/p&gt;"><sup>6</sup></a> This function also has a
<code>rowwise</code> argument for operations between vectors and
matrix/data.frame rows:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/quick-conversion.html">qM</a></span><span class="op">(</span><span class="va">mtcars</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/efficient-programming.html">setop</a></span><span class="op">(</span><span class="va">m</span>, <span class="st">"*"</span>, <span class="fu"><a href="../reference/efficient-programming.html">seq_col</a></span><span class="op">(</span><span class="va">m</span><span class="op">)</span>, rowwise <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">m</span> <span class="op">/</span> <span class="fu"><a href="../reference/quick-conversion.html">qM</a></span><span class="op">(</span><span class="va">mtcars</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#                   mpg cyl disp hp drat wt qsec  vs  am gear carb</span></span>
<span><span class="co"># Mazda RX4           1   2    3  4    5  6    7 NaN   9   10   11</span></span>
<span><span class="co"># Mazda RX4 Wag       1   2    3  4    5  6    7 NaN   9   10   11</span></span>
<span><span class="co"># Datsun 710          1   2    3  4    5  6    7   8   9   10   11</span></span>
<span><span class="co"># Hornet 4 Drive      1   2    3  4    5  6    7   8 NaN   10   11</span></span>
<span><span class="co"># Hornet Sportabout   1   2    3  4    5  6    7 NaN NaN   10   11</span></span>
<span><span class="co"># Valiant             1   2    3  4    5  6    7   8 NaN   10   11</span></span></code></pre></div>
<p>Some functions like <code><a href="../reference/efficient-programming.html">na_locf()</a></code>/<code><a href="../reference/efficient-programming.html">na_focb()</a></code>
also have <code>set = TRUE</code> arguments to perform operations by
reference.<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content='&lt;p&gt;Note that &lt;code&gt;&lt;a href="../reference/efficient-programming.html"&gt;na_locf()&lt;/a&gt;&lt;/code&gt;/&lt;code&gt;&lt;a href="../reference/efficient-programming.html"&gt;na_focb()&lt;/a&gt;&lt;/code&gt;
are not vectorized across groups, thus, if using them in a grouped
&lt;code&gt;&lt;a href="../reference/ftransform.html"&gt;fmutate()&lt;/a&gt;&lt;/code&gt; call, adding &lt;code&gt;set = TRUE&lt;/code&gt; will save
some memory on intermediate objects.&lt;/p&gt;'><sup>7</sup></a> There is also <code><a href="../reference/TRA.html">setTRA()</a></code> for
(grouped) transformations by reference, wrapping
<code>TRA(..., set = TRUE)</code>. Since <code>TRA</code> is added as an
argument to all <a href="https://sebkrantz.github.io/collapse/reference/fast-statistical-functions.html"><em>Fast
Statistical Functions</em></a>, <code>set = TRUE</code> can be passed
down to modify by reference. For example:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/fnth_fmedian.html">fmedian</a></span><span class="op">(</span><span class="va">iris</span><span class="op">$</span><span class="va">Sepal.Length</span>, <span class="va">iris</span><span class="op">$</span><span class="va">Species</span>, TRA <span class="op">=</span> <span class="st">"fill"</span>, set <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>Is the same as
<code>setTRA(iris$Sepal.Length, fmedian(iris$Sepal.Length, iris$Species), "fill", iris$Species)</code>,
replacing the values of the <code>Sepal.Length</code> vector with its
species median by reference:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">iris</span><span class="op">)</span></span>
<span><span class="co">#   Sepal.Length Sepal.Width Petal.Length Petal.Width Species</span></span>
<span><span class="co"># 1            5         3.5          1.4         0.2  setosa</span></span>
<span><span class="co"># 2            5         3.0          1.4         0.2  setosa</span></span>
<span><span class="co"># 3            5         3.2          1.3         0.2  setosa</span></span>
<span><span class="co"># 4            5         3.1          1.5         0.2  setosa</span></span>
<span><span class="co"># 5            5         3.6          1.4         0.2  setosa</span></span>
<span><span class="co"># 6            5         3.9          1.7         0.4  setosa</span></span></code></pre></div>
<p>This <code>set</code> argument can be invoked anywhere, also inside
<code><a href="../reference/ftransform.html">fmutate()</a></code> calls with/without groups. This can also be done
in combination with other transformations (sweeping operations). For
example, the following turns the columns of the matrix into
proportions.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/fsum.html">fsum</a></span><span class="op">(</span><span class="va">m</span>, TRA <span class="op">=</span> <span class="st">"/"</span>, set <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/fsum.html">fsum</a></span><span class="op">(</span><span class="va">m</span><span class="op">)</span> <span class="co"># Check</span></span>
<span><span class="co">#  mpg  cyl disp   hp drat   wt qsec   vs   am gear carb </span></span>
<span><span class="co">#    1    1    1    1    1    1    1    1    1    1    1</span></span></code></pre></div>
<p>In summary, think what is really needed to complete a task and keep
things to a minimum in terms of both computations and memory. Let’s do a
final exercise in this regard and create a hyper-efficient function for
univariate linear regression by groups:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">greg</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">y</span>, <span class="va">x</span>, <span class="va">g</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">g</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/group.html">group</a></span><span class="op">(</span><span class="va">g</span><span class="op">)</span></span>
<span>  <span class="va">dmx</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fmean.html">fmean</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">g</span>, TRA <span class="op">=</span> <span class="st">"-"</span>, na.rm <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>  <span class="op">(</span><span class="fu"><a href="../reference/fsum.html">fsum</a></span><span class="op">(</span><span class="va">y</span>, <span class="va">g</span>, <span class="va">dmx</span>, use <span class="op">=</span> <span class="cn">FALSE</span>, na.rm <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op"><a href="../reference/efficient-programming.html">%/=%</a></span></span>
<span>   <span class="fu"><a href="../reference/fsum.html">fsum</a></span><span class="op">(</span><span class="va">dmx</span>, <span class="va">g</span>, <span class="va">dmx</span>, use <span class="op">=</span> <span class="cn">FALSE</span>, na.rm <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Test</span></span>
<span><span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">1e7</span><span class="op">)</span></span>
<span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">1e7</span><span class="op">)</span></span>
<span><span class="va">g</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample.int</a></span><span class="op">(</span><span class="fl">1e6</span>, <span class="fl">1e7</span>, <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">microbenchmark</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html" class="external-link">microbenchmark</a></span><span class="op">(</span><span class="fu">greg</span><span class="op">(</span><span class="va">y</span>, <span class="va">x</span>, <span class="va">g</span><span class="op">)</span>, <span class="fu"><a href="../reference/group.html">group</a></span><span class="op">(</span><span class="va">g</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># Unit: milliseconds</span></span>
<span><span class="co">#           expr       min        lq     mean    median        uq      max neval</span></span>
<span><span class="co">#  greg(y, x, g) 131.39639 138.68961 153.1586 145.78243 161.48137 305.5862   100</span></span>
<span><span class="co">#       group(g)  62.41733  64.80468  72.2558  68.87266  73.21657 153.1643   100</span></span></code></pre></div>
<p>The expression computed by <code>greg()</code> amounts to
<code>sum(y * (x - mean(x)))/sum((x - mean(x))^2)</code> for each group,
which is equivalent to <code>cov(x, y)/var(x)</code>, but very
efficient, requiring exactly one full copy of <code>x</code> to create a
group-demeaned vector, <code>dmx</code>, and then using the
<code>w</code> (weights) argument to <code><a href="../reference/fsum.html">fsum()</a></code> to sum the
products (<code>y * dmx</code> and <code>dmx * dmx</code>) on the fly,
including a division by reference avoiding an additional copy. One
cannot do much better coding a grouped regression directly in C.</p>
</div>
<div class="section level2">
<h2 id="point-3-internally-favor-primitive-r-objects-and-functions">Point 3: Internally Favor Primitive R Objects and Functions<a class="anchor" aria-label="anchor" href="#point-3-internally-favor-primitive-r-objects-and-functions"></a>
</h2>
<p>This partly reiterates Point 1 but now with a focus on internal data
representation rather than grouping and computing. The point could also
be bluntly stated as: ‘vectors, matrices and lists are good, data frames
and complex objects are bad’.</p>
<p>Many frameworks seem to imply the opposite - the <em>tidyverse</em>
encourages you to cast your data as a tidy tibble, and
<em>data.table</em> offers you a more efficient data frame. But these
objects are internally complex, and, in the case of <em>data.table</em>,
only efficient because of the internal C-level algorithms for large-data
manipulation. You should always take a step back to ask yourself: for
the statistical software I am writing, do I need this complexity?
Complex objects require complex methods to manipulate them, thus, when
using them, you incur the cost of everything that goes on in these
methods. Vectors, matrices, and lists are much more efficient in R and
<em>collapse</em> provides you with many options to manipulate them
directly.</p>
<p>It may surprise you to hear that, internally, <em>collapse</em> does
not use data frame-like objects at all. Instead, such objects are cast
to lists using <code>unclass(data)</code>,
<code>class(data) &lt;- NULL</code>, or
<code>attributes(data) &lt;- NULL</code>. This is advisable if you want
to write fast package code for data frame-like objects.</p>
<p>The benchmark below illustrates that basically everything you do on a
<em>data.frame</em> is more expensive than on the equivalent list.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">l</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">unclass</a></span><span class="op">(</span><span class="va">mtcars</span><span class="op">)</span></span>
<span><span class="va">nam</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">mtcars</span><span class="op">)</span></span>
<span><span class="fu">microbenchmark</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html" class="external-link">microbenchmark</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">mtcars</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">mtcars</span>, <span class="st">"names"</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">l</span><span class="op">)</span>,</span>
<span>               <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">mtcars</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">nam</span>, <span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">mtcars</span>, <span class="st">"names"</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">nam</span>, <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">l</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">nam</span>,</span>
<span>               <span class="va">mtcars</span><span class="op">[[</span><span class="st">"mpg"</span><span class="op">]</span><span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/r/base/base-internal.html" class="external-link">.subset2</a></span><span class="op">(</span><span class="va">mtcars</span>, <span class="st">"mpg"</span><span class="op">)</span>, <span class="va">l</span><span class="op">[[</span><span class="st">"mpg"</span><span class="op">]</span><span class="op">]</span>,</span>
<span>               <span class="va">mtcars</span><span class="op">[</span><span class="fl">3</span><span class="op">:</span><span class="fl">8</span><span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/r/base/base-internal.html" class="external-link">.subset</a></span><span class="op">(</span><span class="va">mtcars</span>, <span class="fl">3</span><span class="op">:</span><span class="fl">8</span><span class="op">)</span>, <span class="va">l</span><span class="op">[</span><span class="fl">3</span><span class="op">:</span><span class="fl">8</span><span class="op">]</span>,</span>
<span>               <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">mtcars</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">mtcars</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">unclass</a></span><span class="op">(</span><span class="va">mtcars</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">l</span><span class="op">)</span>,</span>
<span>               <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">mtcars</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/base-internal.html" class="external-link">.subset2</a></span><span class="op">(</span><span class="va">mtcars</span>, <span class="fl">1L</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">l</span><span class="op">[[</span><span class="fl">1L</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># Unit: nanoseconds</span></span>
<span><span class="co">#                          expr  min   lq    mean median     uq   max neval</span></span>
<span><span class="co">#                 names(mtcars)  164  205  240.26    246  246.0   410   100</span></span>
<span><span class="co">#         attr(mtcars, "names")   41   82  109.88     82  123.0  1476   100</span></span>
<span><span class="co">#                      names(l)    0    0   24.60     41   41.0    82   100</span></span>
<span><span class="co">#          names(mtcars) &lt;- nam  451  492  651.90    656  697.0  3321   100</span></span>
<span><span class="co">#  attr(mtcars, "names") &lt;- nam  287  369  480.52    451  492.0  4346   100</span></span>
<span><span class="co">#               names(l) &lt;- nam  164  246  276.34    246  287.0   533   100</span></span>
<span><span class="co">#               mtcars[["mpg"]] 2009 2091 2363.65   2173 2296.0 15539   100</span></span>
<span><span class="co">#       .subset2(mtcars, "mpg")   41   41   68.88     82   82.0   164   100</span></span>
<span><span class="co">#                    l[["mpg"]]   41   82   78.31     82   82.0   205   100</span></span>
<span><span class="co">#                   mtcars[3:8] 5166 5371 5607.98   5453 5576.0 15908   100</span></span>
<span><span class="co">#          .subset(mtcars, 3:8)  246  246  321.03    287  328.0  2788   100</span></span>
<span><span class="co">#                        l[3:8]  246  287  305.45    287  328.0   492   100</span></span>
<span><span class="co">#                  ncol(mtcars) 1025 1107 1200.07   1189 1230.0  2255   100</span></span>
<span><span class="co">#                length(mtcars)  164  205  249.28    246  266.5   492   100</span></span>
<span><span class="co">#       length(unclass(mtcars))  123  164  176.71    164  164.0   861   100</span></span>
<span><span class="co">#                     length(l)    0    0   18.86      0   41.0   287   100</span></span>
<span><span class="co">#                  nrow(mtcars) 1025 1107 1239.84   1148 1230.0  6642   100</span></span>
<span><span class="co">#  length(.subset2(mtcars, 1L))   41   82  113.57     82  123.0  1845   100</span></span>
<span><span class="co">#               length(l[[1L]])   41   82  100.45     82  123.0   492   100</span></span></code></pre></div>
<p>By means of further illustration, let’s recreate the
<code><a href="../reference/pwcor_pwcov_pwnobs.html">pwnobs()</a></code> function in <em>collapse</em> which counts
pairwise missing values. The list method is written in R. A basic
implementation is:<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content="&lt;p&gt;By Point 2 this implementation is not ideal because I am
creating two logical vectors for each iteration of the inner loop, but I
currently don’t see any way to write this more efficiently.&lt;/p&gt;"><sup>8</sup></a></p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pwnobs_list</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">X</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">dg</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fnobs.html">fnobs</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span></span>
<span>    <span class="va">n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span></span>
<span>    <span class="va">nr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span></span>
<span>    <span class="va">N.mat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="va">dg</span><span class="op">)</span></span>
<span>    <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="op">(</span><span class="va">n</span> <span class="op">-</span> <span class="fl">1L</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">miss</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">X</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>        <span class="kw">for</span> <span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="op">(</span><span class="va">i</span> <span class="op">+</span> <span class="fl">1L</span><span class="op">)</span><span class="op">:</span><span class="va">n</span><span class="op">)</span> <span class="va">N.mat</span><span class="op">[</span><span class="va">i</span>, <span class="va">j</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">N.mat</span><span class="op">[</span><span class="va">j</span>, <span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">nr</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">miss</span> <span class="op">|</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">X</span><span class="op">[[</span><span class="va">j</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">N.mat</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">dg</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">N.mat</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">dg</span><span class="op">)</span></span>
<span>    <span class="va">N.mat</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">mtcNA</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/efficient-programming.html">na_insert</a></span><span class="op">(</span><span class="va">mtcars</span>, prop <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span></span>
<span><span class="fu">pwnobs_list</span><span class="op">(</span><span class="va">mtcNA</span><span class="op">)</span></span>
<span><span class="co">#      mpg cyl disp hp drat wt qsec vs am gear carb</span></span>
<span><span class="co"># mpg   26  20   20 20   20 20   21 22 21   21   22</span></span>
<span><span class="co"># cyl   20  26   21 20   22 21   22 22 22   23   20</span></span>
<span><span class="co"># disp  20  21   26 22   22 23   22 22 21   21   22</span></span>
<span><span class="co"># hp    20  20   22 26   21 23   22 20 20   21   21</span></span>
<span><span class="co"># drat  20  22   22 21   26 23   21 21 20   21   21</span></span>
<span><span class="co"># wt    20  21   23 23   23 26   22 21 21   20   20</span></span>
<span><span class="co"># qsec  21  22   22 22   21 22   26 22 20   22   20</span></span>
<span><span class="co"># vs    22  22   22 20   21 21   22 26 20   23   21</span></span>
<span><span class="co"># am    21  22   21 20   20 21   20 20 26   20   21</span></span>
<span><span class="co"># gear  21  23   21 21   21 20   22 23 20   26   20</span></span>
<span><span class="co"># carb  22  20   22 21   21 20   20 21 21   20   26</span></span></code></pre></div>
<p>Now with the above tips we can optimize this as follows:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pwnobs_list_opt</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">X</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">dg</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fnobs.html">fnobs.data.frame</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span>    <span class="va">n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span></span>
<span>    <span class="va">nr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">X</span><span class="op">[[</span><span class="fl">1L</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>    <span class="va">N.mat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="va">dg</span><span class="op">)</span></span>
<span>    <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="op">(</span><span class="va">n</span> <span class="op">-</span> <span class="fl">1L</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">miss</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">X</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>        <span class="kw">for</span> <span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="op">(</span><span class="va">i</span> <span class="op">+</span> <span class="fl">1L</span><span class="op">)</span><span class="op">:</span><span class="va">n</span><span class="op">)</span> <span class="va">N.mat</span><span class="op">[</span><span class="va">i</span>, <span class="va">j</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">N.mat</span><span class="op">[</span><span class="va">j</span>, <span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">nr</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">miss</span> <span class="op">|</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">X</span><span class="op">[[</span><span class="va">j</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/dimnames.html" class="external-link">dimnames</a></span><span class="op">(</span><span class="va">N.mat</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">dg</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">dg</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">N.mat</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/identical.html" class="external-link">identical</a></span><span class="op">(</span><span class="fu">pwnobs_list</span><span class="op">(</span><span class="va">mtcNA</span><span class="op">)</span>, <span class="fu">pwnobs_list_opt</span><span class="op">(</span><span class="va">mtcNA</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># [1] TRUE</span></span>
<span></span>
<span><span class="fu">microbenchmark</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html" class="external-link">microbenchmark</a></span><span class="op">(</span><span class="fu">pwnobs_list</span><span class="op">(</span><span class="va">mtcNA</span><span class="op">)</span>, <span class="fu">pwnobs_list_opt</span><span class="op">(</span><span class="va">mtcNA</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># Unit: microseconds</span></span>
<span><span class="co">#                    expr     min       lq      mean  median      uq     max neval</span></span>
<span><span class="co">#      pwnobs_list(mtcNA) 153.217 160.1255 185.09696 179.744 215.004 241.654   100</span></span>
<span><span class="co">#  pwnobs_list_opt(mtcNA)  27.429  31.1600  33.38507  32.964  35.137  45.387   100</span></span></code></pre></div>
<p>Evidently, the optimized function is 6x faster on this (small)
dataset and we have changed nothing to the loops doing the computation.
With larger data the difference is less stark, but you never know what’s
going on in methods you have not written and how they scale. My advice
is: try to avoid them, use simple objects and take full control over
your code. This also makes your code more robust and you can create
class-agnostic code. If the latter is your intent the <a href="https://sebkrantz.github.io/collapse/articles/collapse_object_handling.html">vignette
on <em>collapse</em>’s object handling</a> will also be helpful.</p>
<p>If you only use <em>collapse</em> functions this discussion is void -
all <em>collapse</em> functions designed for data frames, including
<code><a href="../reference/join.html">join()</a></code>, <code><a href="../reference/pivot.html">pivot()</a></code>, <code><a href="../reference/fsubset.html">fsubset()</a></code>, etc.,
internally handle your data as a list and are equally efficient on data
frames and lists. However, if you want to use base R semantics
(<code>[</code>, etc.) alongside <em>collapse</em> and other functions,
it makes sense to unclass incoming data frame-like objects and reclass
them at the end.</p>
<p>If you don’t want to internally convert data frames to lists, at
least use functions <code><a href="https://rdrr.io/r/base/base-internal.html" class="external-link">.subset()</a></code>, <code><a href="https://rdrr.io/r/base/base-internal.html" class="external-link">.subset2()</a></code>, or
<code><a href="../reference/select_replace_vars.html">collapse::get_vars()</a></code> to efficiently extract columns and
<code><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr()</a></code> to extract/set attributes. With matrices, use
<code><a href="https://rdrr.io/r/base/dimnames.html" class="external-link">dimnames()</a></code> directly instead of <code><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames()</a></code> and
<code><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames()</a></code> which wrap it.</p>
<p>Also avoid <code><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame()</a></code> and friends to
coerce/recreate data frame-like objects. It is quite easy to construct a
<em>data.frame</em> from a list:</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">l</span>, <span class="st">"row.names"</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/base-internal.html" class="external-link">.set_row_names</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">l</span><span class="op">[[</span><span class="fl">1L</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">l</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="st">"data.frame"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">l</span>, <span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">#   mpg cyl disp  hp drat    wt  qsec vs am gear carb</span></span>
<span><span class="co"># 1  21   6  160 110  3.9 2.620 16.46  0  1    4    4</span></span>
<span><span class="co"># 2  21   6  160 110  3.9 2.875 17.02  0  1    4    4</span></span></code></pre></div>
<p>You can also use <em>collapse</em> functions <code><a href="../reference/quick-conversion.html">qDF()</a></code>,
<code><a href="../reference/quick-conversion.html">qDT()</a></code> and <code><a href="../reference/quick-conversion.html">qTBL()</a></code> to efficiently convert/create
<em>data.frame</em>’s, <em>data.table</em>’s, and <em>tibble</em>’s:</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-datatable.com" class="external-link">data.table</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tibble.tidyverse.org/" class="external-link">tibble</a></span><span class="op">)</span></span>
<span><span class="fu">microbenchmark</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html" class="external-link">microbenchmark</a></span><span class="op">(</span><span class="fu"><a href="../reference/quick-conversion.html">qDT</a></span><span class="op">(</span><span class="va">mtcars</span><span class="op">)</span>, <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/as.data.table.html" class="external-link">as.data.table</a></span><span class="op">(</span><span class="va">mtcars</span><span class="op">)</span>,</span>
<span>                               <span class="fu"><a href="../reference/quick-conversion.html">qTBL</a></span><span class="op">(</span><span class="va">mtcars</span><span class="op">)</span>, <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span><span class="va">mtcars</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># Unit: microseconds</span></span>
<span><span class="co">#                   expr    min     lq     mean  median      uq      max neval</span></span>
<span><span class="co">#            qDT(mtcars)  2.952  3.280  6.35705  3.5670  3.8130  269.534   100</span></span>
<span><span class="co">#  as.data.table(mtcars) 34.194 36.572 44.93641 37.4535 39.2985  697.410   100</span></span>
<span><span class="co">#           qTBL(mtcars)  2.419  2.583  3.19267  2.8700  2.9930   38.704   100</span></span>
<span><span class="co">#      as_tibble(mtcars) 48.257 49.569 71.56304 50.4095 52.5005 2050.533   100</span></span>
<span></span>
<span><span class="va">l</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">unclass</a></span><span class="op">(</span><span class="va">mtcars</span><span class="op">)</span></span>
<span><span class="fu">microbenchmark</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html" class="external-link">microbenchmark</a></span><span class="op">(</span><span class="fu"><a href="../reference/quick-conversion.html">qDF</a></span><span class="op">(</span><span class="va">l</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">l</span><span class="op">)</span>, <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/as.data.table.html" class="external-link">as.data.table</a></span><span class="op">(</span><span class="va">l</span><span class="op">)</span>, <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span><span class="va">l</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># Unit: microseconds</span></span>
<span><span class="co">#              expr     min       lq      mean   median      uq     max neval</span></span>
<span><span class="co">#            qDF(l)   1.722   2.2140   4.51779   2.4600   2.747 199.424   100</span></span>
<span><span class="co">#  as.data.frame(l) 210.412 225.1515 242.65973 248.3370 254.569 301.186   100</span></span>
<span><span class="co">#  as.data.table(l)  70.889  77.2030  90.30086  83.0045  88.683 798.393   100</span></span>
<span><span class="co">#      as_tibble(l)  55.350  61.8690  68.20924  67.0760  72.898 139.769   100</span></span></code></pre></div>
<p><em>collapse</em> also provides functions like
<code><a href="../reference/small-helpers.html">setattrib()</a></code>, <code><a href="../reference/small-helpers.html">copyMostAttrib()</a></code>, etc., to
efficiently attach attributes again. So another efficient workflow for
general data frame-like objects is to save the attributes
<code>ax &lt;- attributes(data)</code>, manipulate it as a list
<code>attributes(data) &lt;- NULL</code>, modify <code>ax$names</code>
and <code>ax$row.names</code> as needed and then use
<code>setattrib(data, ax)</code> before returning.</p>
</div>
<div class="section level2">
<h2 id="some-notes-on-global-options">Some Notes on Global Options<a class="anchor" aria-label="anchor" href="#some-notes-on-global-options"></a>
</h2>
<p><em>collapse</em> has its own set of global options which can be set
using <code><a href="../reference/collapse-options.html">set_collapse()</a></code> and retrieved using
<code><a href="../reference/collapse-options.html">get_collapse()</a></code>.<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content='&lt;p&gt;This is done mainly for efficiency reasons, but also do
implement advanced options such as namespace masking (options
&lt;code&gt;mask&lt;/code&gt; and &lt;code&gt;remove&lt;/code&gt;). The options are stored in an
internal environment called &lt;code&gt;.op&lt;/code&gt; visible in the
documentation of some functions such as &lt;code&gt;&lt;a href="../reference/fmean.html"&gt;fmean()&lt;/a&gt;&lt;/code&gt; when used
to set argument defaults.&lt;/p&gt;'><sup>9</sup></a> This confers responsibilities upon package
developers as setting these options inside a package also affects how
<em>collapse</em> behaves outside of your package.</p>
<p>In general, the same rules apply as for setting other R options
through <code><a href="https://rdrr.io/r/base/options.html" class="external-link">options()</a></code> or <code><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par()</a></code>: they need to be
reset using <code><a href="https://rdrr.io/r/base/on.exit.html" class="external-link">on.exit()</a></code> so that the user choices are
unaffected even if your package function breaks. For example, if you
want a block of code multithreaded and without missing value skipping
for maximum performance:</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fast_function</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="co"># Your code...</span></span>
<span></span>
<span>  <span class="va">oldopts</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/collapse-options.html">set_collapse</a></span><span class="op">(</span>nthreads <span class="op">=</span> <span class="fl">4</span>, na.rm <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/on.exit.html" class="external-link">on.exit</a></span><span class="op">(</span><span class="fu"><a href="../reference/collapse-options.html">set_collapse</a></span><span class="op">(</span><span class="va">oldopts</span><span class="op">)</span><span class="op">)</span> </span>
<span>  </span>
<span>  <span class="co"># Multithreaded code...</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Namespace masking (options <code>mask</code> and <code>remove</code>)
should not be set inside packages because it may have unintended
side-effects for the user (e.g., <em>collapse</em> appears at the top of
the <code><a href="https://rdrr.io/r/base/search.html" class="external-link">search()</a></code> path afterwards).</p>
<p>Conversely, user choices in <code><a href="../reference/collapse-options.html">set_collapse()</a></code> also affect
your package code, except for namespace masking as you should specify
explicitly which <em>collapse</em> functions you are using (e.g., via
<code>importFrom("collapse", "fmean")</code> in NAMESPACE or
<code><a href="../reference/fmean.html">collapse::fmean()</a></code> in your code).</p>
<p>Particularly options <code>na.rm</code>, <code>nthreads</code>, and
<code>sort</code>, if set by the user, will impact your code, unless you
explicitly set the targeted arguments (e.g., <code>nthreads</code> and
<code>na.rm</code> in statistical functions like <code><a href="../reference/fmean.html">fmean()</a></code>,
and <code>sort</code> arguments in grouping functions like
<code><a href="../reference/GRP.html">GRP()</a></code>/<code><a href="../reference/qF.html">qF()</a></code>/<code><a href="../reference/qF.html">qG()</a></code>/<code><a href="../reference/GRP.html">fgroup_by()</a></code>).</p>
<p>My general view is that this is not necessary - if the user sets
<code>set_collapse(na.rm = FALSE)</code> because data has no missing
values, then it is good if that also speeds up your package functions.
However, if your package code generates missing values and expects
<em>collapse</em> functions to skip them you should take care of this
using either <code><a href="../reference/collapse-options.html">set_collapse()</a></code> + <code><a href="https://rdrr.io/r/base/on.exit.html" class="external-link">on.exit()</a></code> or
explicitly setting <code>na.rm = TRUE</code> in all relevant
functions.</p>
<p>Also watch out for internally-grouped aggregations using <a href="https://sebkrantz.github.io/collapse/reference/fast-statistical-functions.html"><em>Fast
Statistical Functions</em></a>, which are affected by global
defaults:</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/fmean.html">fmean</a></span><span class="op">(</span><span class="va">mtcars</span><span class="op">$</span><span class="va">mpg</span>, <span class="va">mtcars</span><span class="op">$</span><span class="va">cyl</span><span class="op">)</span></span>
<span><span class="co">#        4        6        8 </span></span>
<span><span class="co"># 26.66364 19.74286 15.10000</span></span>
<span><span class="va">oldopts</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/collapse-options.html">set_collapse</a></span><span class="op">(</span>sort <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/fmean.html">fmean</a></span><span class="op">(</span><span class="va">mtcars</span><span class="op">$</span><span class="va">mpg</span>, <span class="va">mtcars</span><span class="op">$</span><span class="va">cyl</span><span class="op">)</span></span>
<span><span class="co">#        6        4        8 </span></span>
<span><span class="co"># 19.74286 26.66364 15.10000</span></span></code></pre></div>
<p>Statistical functions do not have <code>sort</code> arguments, thus,
if it is crucial that the output remains sorted, ensure that a sorted
factor, ‘qG’, or ‘GRP’ object is passed:</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/fmean.html">fmean</a></span><span class="op">(</span><span class="va">mtcars</span><span class="op">$</span><span class="va">mpg</span>, <span class="fu"><a href="../reference/qF.html">qF</a></span><span class="op">(</span><span class="va">mtcars</span><span class="op">$</span><span class="va">cyl</span>, sort <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#        4        6        8 </span></span>
<span><span class="co"># 26.66364 19.74286 15.10000</span></span>
<span><span class="fu"><a href="../reference/collapse-options.html">set_collapse</a></span><span class="op">(</span><span class="va">oldopts</span><span class="op">)</span></span></code></pre></div>
<p>Of course, you can also check which options the user has set and
adjust your code, e.g. </p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Your code ...</span></span>
<span><span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="../reference/collapse-options.html">get_collapse</a></span><span class="op">(</span><span class="st">"sort"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">oldopts</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/collapse-options.html">set_collapse</a></span><span class="op">(</span>sort <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/on.exit.html" class="external-link">on.exit</a></span><span class="op">(</span><span class="fu"><a href="../reference/collapse-options.html">set_collapse</a></span><span class="op">(</span><span class="va">oldopts</span><span class="op">)</span><span class="op">)</span> </span>
<span><span class="op">}</span></span>
<span><span class="co"># Critical code ...</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="conclusion">Conclusion<a class="anchor" aria-label="anchor" href="#conclusion"></a>
</h2>
<p><em>collapse</em> can become a game-changer for your statistical
software development in R, enabling you to write programs that
effectively run like C while accomplishing complex statistical/data
tasks with few lines of code. This however requires taking a closer look
at the package, in particular the <a href="https://sebkrantz.github.io/collapse/reference/collapse-documentation.html">documentation</a>,
and following the advice given in this vignette.</p>
</div>

  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Sebastian Krantz.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.9000.</p>
</div>

    </footer>
</div>





  </body>
</html>
