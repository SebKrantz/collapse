<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Introduction to collapse • collapse</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<!-- katex math --><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css" integrity="sha384-nB0miv6/jRmo5UMMR1wu3Gz6NLsoTkbqJghGIsx//Rlm+ZU03BU6SQNC66uf4l5+" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js" integrity="sha384-7zkQWkzuo3B5mTepMUcHkMB5jZaolc2xDwL6VFqjFALcbeS9Ggm/Yr2r3Dy4lfFg" crossorigin="anonymous"></script><script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js" integrity="sha384-43gviWU0YVjaDtb/GhzOouOXtZMP/7XUzwPTstBeZFe/+rCMvRwr4yROQP43s0Xk" crossorigin="anonymous" onload="renderMathInElement(document.body);"></script><script src="../katex-auto.js"></script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Introduction to collapse">
<meta name="robots" content="noindex">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">collapse</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="In-development version">2.1.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Documentation</a></li>
<li class="active nav-item"><a class="nav-link" href="../articles/index.html">Vignettes</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">News</a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://sebkrantz.github.io/Rblog/">Blog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://bsky.app/profile/rcollapse.bsky.social" aria-label="BlueSky"><span class="fa fa-bluesky"></span></a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://twitter.com/collapse_R" aria-label="Twitter"><span class="fa fa-twitter"></span></a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/SebKrantz/collapse" aria-label="GitHub"><span class="fa fa-github"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Introduction to collapse</h1>
            <h3 data-toc-skip class="subtitle">Advanced and Fast Data
Transformation in R</h3>
                        <h4 data-toc-skip class="author">Sebastian
Krantz</h4>
            
            <h4 data-toc-skip class="date">2021-06-27</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/SebKrantz/collapse/blob/master/vignettes/collapse_intro.Rmd" class="external-link"><code>vignettes/collapse_intro.Rmd</code></a></small>
      <div class="d-none name"><code>collapse_intro.Rmd</code></div>
    </div>

    
    
<style type="text/css">
pre {
  max-height: 500px;
  overflow-y: auto;
}

pre[class] {
  max-height: 500px;
}
</style>
<p><em>collapse</em> is a C/C++ based package for data transformation
and statistical computing in R. It’s aims are:</p>
<ol style="list-style-type: decimal">
<li>To facilitate complex data transformation, exploration and computing
tasks in R.</li>
<li>To help make R code fast, flexible, parsimonious and programmer
friendly.</li>
</ol>
<p>This vignette demonstrates these two points and introduces all main
features of the package in a structured way. The chapters are pretty
self-contained, however the first chapters introduce the data and faster
data manipulation functions which are used throughout the rest of this
vignette.</p>
<!-- structured with an overarching aim to instruct the reader how to write fast R code for (advanced) data manipulation with *collapse*. -->
<hr>
<p><strong>Notes:</strong></p>
<ul>
<li><p>Apart from this vignette, <em>collapse</em> comes with a built-in
structured documentation available under
<code><a href="../reference/collapse-documentation.html">help("collapse-documentation")</a></code> after installing the
package, and <code><a href="../reference/collapse-package.html">help("collapse-package")</a></code> provides a compact
set of examples for quick-start. A cheat sheet is available at <a href="https://raw.githubusercontent.com/rstudio/cheatsheets/master/collapse.pdf" class="external-link">Rstudio</a>.
<!-- To learn *collapse* as quickly as possible it is possibly better to consult those resources than going through this document.  --></p></li>
<li><p>The two other vignettes focus on the integration of
<em>collapse</em> with <em>dplyr</em> workflows (recommended for
<em>dplyr</em> / <em>tidyverse</em> users), and on the integration of
<em>collapse</em> with the <em>plm</em> package (+ some advanced
programming with panel data).</p></li>
<li><p>Documentation and vignettes can also be viewed <a href="https://sebkrantz.github.io/collapse/">online</a>.</p></li>
</ul>
<!-- - All benchmarks are run with a Windows 8.1 laptop, 2x 2.2 GHZ Intel i5 processor, 8GB DDR3 RAM and a Samsung 850 EVO SSD.  --><hr>
<div class="section level2">
<h2 id="why-collapse">Why <em>collapse</em>?<a class="anchor" aria-label="anchor" href="#why-collapse"></a>
</h2>
<p><em>collapse</em> is a high-performance package that extends and
enhances the data-manipulation capabilities of R and existing popular
packages (such as <em>dplyr</em>, <em>data.table</em>, and matrix
packages). It’s main focus is on grouped and weighted statistical
programming, complex aggregations and transformations, time series and
panel data operations, and programming with lists of data objects. The
lead author is an applied economist and created the package mainly to
facilitate advanced computations on varied and complex data, in
particular surveys, (multivariate) time series, multilevel / panel data,
and lists / model objects.</p>
<p>A secondary aspect to applied work is that data is often imported
into R from richer data structures (such as STATA, SPSS or SAS files
imported with <em>haven</em>). This called for an intelligent suite of
data manipulation functions that can both utilize aspects of the richer
data structure (such as variable labels), and preserve the data
structure / attributes in computations. Sometimes specialized classes
like <em>xts</em>, <em>pdata.frame</em> and <em>grouped_df</em> can also
become very useful to manipulate certain types of data. Thus
<em>collapse</em> was built to explicitly supports these classes, while
preserving most other classes / data structures in R.
<!-- , enabling flexible, efficient and non-destructive workflows with complex data.  --></p>
<p>Another objective was to radically improve the speed of R code by
extensively relying on efficient algorithms in C/C++ and the faster
components of base R. <em>collapse</em> ranks among the fastest R
packages, and performs many grouped and/or weighted computations
noticeably faster than <em>dplyr</em> or <em>data.table</em>.</p>
<p>A final development objective was to channel this performance through
a stable and well conceived user API providing extensive and optimized
programming capabilities (in standard evaluation) while also
facilitating quick use and easy integration with existing data
manipulation frameworks (in particular <em>dplyr</em> /
<em>tidyverse</em> and <em>data.table</em>, both relying on non-standard
evaluation).</p>
<!--
*collapse* also provides exemplary documentation (built-in, vignettes, website) and testing. Testing currently covers all core features of the package, amounting to > 7700 unit tests, with extensive testing of statistical functions and computations.

The name of the package derives from the 'collapse' command for multi-type aggregation in the STATA statistical software. This was the first function in this package (later renamed to `collap` to avoid naming conflicts with *dplyr*). -->
</div>
<div class="section level2">
<h2 id="data-and-summary-tools">1. Data and Summary Tools<a class="anchor" aria-label="anchor" href="#data-and-summary-tools"></a>
</h2>
<p>We begin by introducing some powerful summary tools along with the 2
panel datasets <em>collapse</em> provides which are used throughout this
vignette. If you are just interested in programming you can skip this
section. Apart from the 2 datasets that come with <em>collapse</em>
(<code>wlddev</code> and <code>GGDC10S</code>), this vignette uses a few
well known datasets from base R: <code>mtcars</code>, <code>iris</code>,
<code>airquality</code>, and the time series <code>Airpassengers</code>
and <code>EuStockMarkets</code>.</p>
<div class="section level3">
<h3 id="wlddev---world-bank-development-data">1.1 <code>wlddev</code> - World Bank Development Data<a class="anchor" aria-label="anchor" href="#wlddev---world-bank-development-data"></a>
</h3>
<p>This dataset contains 5 key World Bank Development Indicators
covering 216 countries for up to 61 years (1960-2020). It is a balanced
balanced panel with <span class="math inline">216 \times 61 =
13176</span> observations. –&gt;</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://sebkrantz.github.io/collapse/">collapse</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">wlddev</span><span class="op">)</span></span>
<span><span class="co">#       country iso3c       date year decade     region     income  OECD PCGDP LIFEEX GINI       ODA</span></span>
<span><span class="co"># 1 Afghanistan   AFG 1961-01-01 1960   1960 South Asia Low income FALSE    NA 32.446   NA 116769997</span></span>
<span><span class="co"># 2 Afghanistan   AFG 1962-01-01 1961   1960 South Asia Low income FALSE    NA 32.962   NA 232080002</span></span>
<span><span class="co"># 3 Afghanistan   AFG 1963-01-01 1962   1960 South Asia Low income FALSE    NA 33.471   NA 112839996</span></span>
<span><span class="co"># 4 Afghanistan   AFG 1964-01-01 1963   1960 South Asia Low income FALSE    NA 33.971   NA 237720001</span></span>
<span><span class="co"># 5 Afghanistan   AFG 1965-01-01 1964   1960 South Asia Low income FALSE    NA 34.463   NA 295920013</span></span>
<span><span class="co"># 6 Afghanistan   AFG 1966-01-01 1965   1960 South Asia Low income FALSE    NA 34.948   NA 341839996</span></span>
<span><span class="co">#       POP</span></span>
<span><span class="co"># 1 8996973</span></span>
<span><span class="co"># 2 9169410</span></span>
<span><span class="co"># 3 9351441</span></span>
<span><span class="co"># 4 9543205</span></span>
<span><span class="co"># 5 9744781</span></span>
<span><span class="co"># 6 9956320</span></span>
<span></span>
<span><span class="co"># The variables have "label" attributes. Use vlabels() to get and set labels</span></span>
<span><span class="fu"><a href="../reference/small-helpers.html">namlab</a></span><span class="op">(</span><span class="va">wlddev</span>, class <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#    Variable     Class</span></span>
<span><span class="co"># 1   country character</span></span>
<span><span class="co"># 2     iso3c    factor</span></span>
<span><span class="co"># 3      date      Date</span></span>
<span><span class="co"># 4      year   integer</span></span>
<span><span class="co"># 5    decade   integer</span></span>
<span><span class="co"># 6    region    factor</span></span>
<span><span class="co"># 7    income    factor</span></span>
<span><span class="co"># 8      OECD   logical</span></span>
<span><span class="co"># 9     PCGDP   numeric</span></span>
<span><span class="co"># 10   LIFEEX   numeric</span></span>
<span><span class="co"># 11     GINI   numeric</span></span>
<span><span class="co"># 12      ODA   numeric</span></span>
<span><span class="co"># 13      POP   numeric</span></span>
<span><span class="co">#                                                                                Label</span></span>
<span><span class="co"># 1                                                                       Country Name</span></span>
<span><span class="co"># 2                                                                       Country Code</span></span>
<span><span class="co"># 3                                                         Date Recorded (Fictitious)</span></span>
<span><span class="co"># 4                                                                               Year</span></span>
<span><span class="co"># 5                                                                             Decade</span></span>
<span><span class="co"># 6                                                                             Region</span></span>
<span><span class="co"># 7                                                                       Income Level</span></span>
<span><span class="co"># 8                                                            Is OECD Member Country?</span></span>
<span><span class="co"># 9                                                 GDP per capita (constant 2010 US$)</span></span>
<span><span class="co"># 10                                           Life expectancy at birth, total (years)</span></span>
<span><span class="co"># 11                                                  Gini index (World Bank estimate)</span></span>
<span><span class="co"># 12 Net official development assistance and official aid received (constant 2018 US$)</span></span>
<span><span class="co"># 13                                                                 Population, total</span></span></code></pre></div>
<p>Of the categorical identifiers, the date variable was artificially
generated to have an example dataset that contains all common data types
frequently encountered in R. A detailed statistical description of this
data is computed by <code>descr</code>:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># A fast and detailed statistical description</span></span>
<span><span class="fu"><a href="../reference/descr.html">descr</a></span><span class="op">(</span><span class="va">wlddev</span><span class="op">)</span></span>
<span><span class="co"># Dataset: wlddev, 13 Variables, N = 13176</span></span>
<span><span class="co"># ----------------------------------------------------------------------------------------------------</span></span>
<span><span class="co"># country (character): Country Name</span></span>
<span><span class="co"># Statistics</span></span>
<span><span class="co">#       N  Ndist</span></span>
<span><span class="co">#   13176    216</span></span>
<span><span class="co"># Table</span></span>
<span><span class="co">#                       Freq   Perc</span></span>
<span><span class="co"># Afghanistan             61   0.46</span></span>
<span><span class="co"># Albania                 61   0.46</span></span>
<span><span class="co"># Algeria                 61   0.46</span></span>
<span><span class="co"># American Samoa          61   0.46</span></span>
<span><span class="co"># Andorra                 61   0.46</span></span>
<span><span class="co"># Angola                  61   0.46</span></span>
<span><span class="co"># Antigua and Barbuda     61   0.46</span></span>
<span><span class="co"># Argentina               61   0.46</span></span>
<span><span class="co"># Armenia                 61   0.46</span></span>
<span><span class="co"># Aruba                   61   0.46</span></span>
<span><span class="co"># Australia               61   0.46</span></span>
<span><span class="co"># Austria                 61   0.46</span></span>
<span><span class="co"># Azerbaijan              61   0.46</span></span>
<span><span class="co"># Bahamas, The            61   0.46</span></span>
<span><span class="co"># ... 202 Others       12322  93.52</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># Summary of Table Frequencies</span></span>
<span><span class="co">#    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. </span></span>
<span><span class="co">#      61      61      61      61      61      61 </span></span>
<span><span class="co"># ----------------------------------------------------------------------------------------------------</span></span>
<span><span class="co"># iso3c (factor): Country Code</span></span>
<span><span class="co"># Statistics</span></span>
<span><span class="co">#       N  Ndist</span></span>
<span><span class="co">#   13176    216</span></span>
<span><span class="co"># Table</span></span>
<span><span class="co">#                  Freq   Perc</span></span>
<span><span class="co"># ABW                61   0.46</span></span>
<span><span class="co"># AFG                61   0.46</span></span>
<span><span class="co"># AGO                61   0.46</span></span>
<span><span class="co"># ALB                61   0.46</span></span>
<span><span class="co"># AND                61   0.46</span></span>
<span><span class="co"># ARE                61   0.46</span></span>
<span><span class="co"># ARG                61   0.46</span></span>
<span><span class="co"># ARM                61   0.46</span></span>
<span><span class="co"># ASM                61   0.46</span></span>
<span><span class="co"># ATG                61   0.46</span></span>
<span><span class="co"># AUS                61   0.46</span></span>
<span><span class="co"># AUT                61   0.46</span></span>
<span><span class="co"># AZE                61   0.46</span></span>
<span><span class="co"># BDI                61   0.46</span></span>
<span><span class="co"># ... 202 Others  12322  93.52</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># Summary of Table Frequencies</span></span>
<span><span class="co">#    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. </span></span>
<span><span class="co">#      61      61      61      61      61      61 </span></span>
<span><span class="co"># ----------------------------------------------------------------------------------------------------</span></span>
<span><span class="co"># date (Date): Date Recorded (Fictitious)</span></span>
<span><span class="co"># Statistics</span></span>
<span><span class="co">#          N       Ndist         Min         Max  </span></span>
<span><span class="co">#      13176          61  1961-01-01  2021-01-01  </span></span>
<span><span class="co"># ----------------------------------------------------------------------------------------------------</span></span>
<span><span class="co"># year (integer): Year</span></span>
<span><span class="co"># Statistics</span></span>
<span><span class="co">#       N  Ndist  Mean     SD   Min   Max  Skew  Kurt</span></span>
<span><span class="co">#   13176     61  1990  17.61  1960  2020    -0   1.8</span></span>
<span><span class="co"># Quantiles</span></span>
<span><span class="co">#     1%    5%   10%   25%   50%   75%   90%   95%   99%</span></span>
<span><span class="co">#   1960  1963  1966  1975  1990  2005  2014  2017  2020</span></span>
<span><span class="co"># ----------------------------------------------------------------------------------------------------</span></span>
<span><span class="co"># decade (integer): Decade</span></span>
<span><span class="co"># Statistics</span></span>
<span><span class="co">#       N  Ndist     Mean     SD   Min   Max  Skew  Kurt</span></span>
<span><span class="co">#   13176      7  1985.57  17.51  1960  2020  0.03  1.79</span></span>
<span><span class="co"># Quantiles</span></span>
<span><span class="co">#     1%    5%   10%   25%   50%   75%   90%   95%   99%</span></span>
<span><span class="co">#   1960  1960  1960  1970  1990  2000  2010  2010  2020</span></span>
<span><span class="co"># ----------------------------------------------------------------------------------------------------</span></span>
<span><span class="co"># region (factor): Region</span></span>
<span><span class="co"># Statistics</span></span>
<span><span class="co">#       N  Ndist</span></span>
<span><span class="co">#   13176      7</span></span>
<span><span class="co"># Table</span></span>
<span><span class="co">#                             Freq   Perc</span></span>
<span><span class="co"># Europe &amp; Central Asia       3538  26.85</span></span>
<span><span class="co"># Sub-Saharan Africa          2928  22.22</span></span>
<span><span class="co"># Latin America &amp; Caribbean   2562  19.44</span></span>
<span><span class="co"># East Asia &amp; Pacific         2196  16.67</span></span>
<span><span class="co"># Middle East &amp; North Africa  1281   9.72</span></span>
<span><span class="co"># South Asia                   488   3.70</span></span>
<span><span class="co"># North America                183   1.39</span></span>
<span><span class="co"># ----------------------------------------------------------------------------------------------------</span></span>
<span><span class="co"># income (factor): Income Level</span></span>
<span><span class="co"># Statistics</span></span>
<span><span class="co">#       N  Ndist</span></span>
<span><span class="co">#   13176      4</span></span>
<span><span class="co"># Table</span></span>
<span><span class="co">#                      Freq   Perc</span></span>
<span><span class="co"># High income          4819  36.57</span></span>
<span><span class="co"># Upper middle income  3660  27.78</span></span>
<span><span class="co"># Lower middle income  2867  21.76</span></span>
<span><span class="co"># Low income           1830  13.89</span></span>
<span><span class="co"># ----------------------------------------------------------------------------------------------------</span></span>
<span><span class="co"># OECD (logical): Is OECD Member Country?</span></span>
<span><span class="co"># Statistics</span></span>
<span><span class="co">#       N  Ndist</span></span>
<span><span class="co">#   13176      2</span></span>
<span><span class="co"># Table</span></span>
<span><span class="co">#         Freq   Perc</span></span>
<span><span class="co"># FALSE  10980  83.33</span></span>
<span><span class="co"># TRUE    2196  16.67</span></span>
<span><span class="co"># ----------------------------------------------------------------------------------------------------</span></span>
<span><span class="co"># PCGDP (numeric): GDP per capita (constant 2010 US$)</span></span>
<span><span class="co"># Statistics (28.13% NAs)</span></span>
<span><span class="co">#      N  Ndist      Mean        SD     Min        Max  Skew   Kurt</span></span>
<span><span class="co">#   9470   9470  12048.78  19077.64  132.08  196061.42  3.13  17.12</span></span>
<span><span class="co"># Quantiles</span></span>
<span><span class="co">#       1%      5%     10%      25%      50%       75%       90%       95%       99%</span></span>
<span><span class="co">#   227.71  399.62  555.55  1303.19  3767.16  14787.03  35646.02  48507.84  92340.28</span></span>
<span><span class="co"># ----------------------------------------------------------------------------------------------------</span></span>
<span><span class="co"># LIFEEX (numeric): Life expectancy at birth, total (years)</span></span>
<span><span class="co"># Statistics (11.43% NAs)</span></span>
<span><span class="co">#       N  Ndist  Mean     SD    Min    Max   Skew  Kurt</span></span>
<span><span class="co">#   11670  10548  64.3  11.48  18.91  85.42  -0.67  2.67</span></span>
<span><span class="co"># Quantiles</span></span>
<span><span class="co">#      1%     5%    10%    25%    50%    75%    90%    95%    99%</span></span>
<span><span class="co">#   35.83  42.77  46.83  56.36  67.44  72.95  77.08  79.34  82.36</span></span>
<span><span class="co"># ----------------------------------------------------------------------------------------------------</span></span>
<span><span class="co"># GINI (numeric): Gini index (World Bank estimate)</span></span>
<span><span class="co"># Statistics (86.76% NAs)</span></span>
<span><span class="co">#      N  Ndist   Mean   SD   Min   Max  Skew  Kurt</span></span>
<span><span class="co">#   1744    368  38.53  9.2  20.7  65.8   0.6  2.53</span></span>
<span><span class="co"># Quantiles</span></span>
<span><span class="co">#     1%    5%   10%   25%   50%  75%   90%    95%   99%</span></span>
<span><span class="co">#   24.6  26.3  27.6  31.5  36.4   45  52.6  55.98  60.5</span></span>
<span><span class="co"># ----------------------------------------------------------------------------------------------------</span></span>
<span><span class="co"># ODA (numeric): Net official development assistance and official aid received (constant 2018 US$)</span></span>
<span><span class="co"># Statistics (34.67% NAs)</span></span>
<span><span class="co">#      N  Ndist        Mean          SD          Min             Max  Skew    Kurt</span></span>
<span><span class="co">#   8608   7832  454'720131  868'712654  -997'679993  2.56715605e+10  6.98  114.89</span></span>
<span><span class="co"># Quantiles</span></span>
<span><span class="co">#             1%           5%          10%          25%         50%         75%             90%</span></span>
<span><span class="co">#   -12'593999.7  1'363500.01  8'347000.31  44'887499.8  165'970001  495'042503  1.18400697e+09</span></span>
<span><span class="co">#              95%             99%</span></span>
<span><span class="co">#   1.93281696e+09  3.73380782e+09</span></span>
<span><span class="co"># ----------------------------------------------------------------------------------------------------</span></span>
<span><span class="co"># POP (numeric): Population, total</span></span>
<span><span class="co"># Statistics (1.95% NAs)</span></span>
<span><span class="co">#       N  Ndist         Mean          SD   Min             Max  Skew    Kurt</span></span>
<span><span class="co">#   12919  12877  24'245971.6  102'120674  2833  1.39771500e+09  9.75  108.91</span></span>
<span><span class="co"># Quantiles</span></span>
<span><span class="co">#        1%       5%      10%     25%       50%        75%          90%          95%         99%</span></span>
<span><span class="co">#   8698.84  31083.3  62268.4  443791  4'072517  12'816178  46'637331.4  81'177252.5  308'862641</span></span>
<span><span class="co"># ----------------------------------------------------------------------------------------------------</span></span></code></pre></div>
<p>The output of <code>descr</code> can be converted into a tidy data
frame using:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="../reference/descr.html">descr</a></span><span class="op">(</span><span class="va">wlddev</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#   Variable     Class                      Label     N Ndist   Min   Max     Mean       SD</span></span>
<span><span class="co"># 1  country character               Country Name 13176   216    NA    NA       NA       NA</span></span>
<span><span class="co"># 2    iso3c    factor               Country Code 13176   216    NA    NA       NA       NA</span></span>
<span><span class="co"># 3     date      Date Date Recorded (Fictitious) 13176    61 -3287 18628       NA       NA</span></span>
<span><span class="co"># 4     year   integer                       Year 13176    61  1960  2020 1990.000 17.60749</span></span>
<span><span class="co"># 5   decade   integer                     Decade 13176     7  1960  2020 1985.574 17.51175</span></span>
<span><span class="co"># 6   region    factor                     Region 13176     7    NA    NA       NA       NA</span></span>
<span><span class="co">#            Skew     Kurt   1%   5%  10%  25%  50%  75%  90%  95%  99%</span></span>
<span><span class="co"># 1            NA       NA   NA   NA   NA   NA   NA   NA   NA   NA   NA</span></span>
<span><span class="co"># 2            NA       NA   NA   NA   NA   NA   NA   NA   NA   NA   NA</span></span>
<span><span class="co"># 3            NA       NA   NA   NA   NA   NA   NA   NA   NA   NA   NA</span></span>
<span><span class="co"># 4 -5.812381e-16 1.799355 1960 1963 1966 1975 1990 2005 2014 2017 2020</span></span>
<span><span class="co"># 5  3.256512e-02 1.791726 1960 1960 1960 1970 1990 2000 2010 2010 2020</span></span>
<span><span class="co"># 6            NA       NA   NA   NA   NA   NA   NA   NA   NA   NA   NA</span></span></code></pre></div>
<p>Note that <code>descr</code> does not require data to be labeled.
Since <code>wlddev</code> is a panel data set tracking countries over
time, we might be interested in checking which variables are
time-varying, with the function <code>varying</code>:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/varying.html">varying</a></span><span class="op">(</span><span class="va">wlddev</span>, <span class="va">wlddev</span><span class="op">$</span><span class="va">iso3c</span><span class="op">)</span></span>
<span><span class="co"># country   iso3c    date    year  decade  region  income    OECD   PCGDP  LIFEEX    GINI     ODA </span></span>
<span><span class="co">#   FALSE   FALSE    TRUE    TRUE    TRUE   FALSE   FALSE   FALSE    TRUE    TRUE    TRUE    TRUE </span></span>
<span><span class="co">#     POP </span></span>
<span><span class="co">#    TRUE</span></span></code></pre></div>
<p><code>varying</code> tells us that all 5 variables
<code>PCGDP</code>, <code>LIFEEX</code>, <code>GINI</code>,
<code>ODA</code> and <code>POP</code> vary over time. However the
<code>OECD</code> variable does not, so this data does not track when
countries entered the OECD. We can also have a more detailed look
letting <code>varying</code> check the variation in each country:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fu"><a href="../reference/varying.html">varying</a></span><span class="op">(</span><span class="va">wlddev</span>, <span class="va">wlddev</span><span class="op">$</span><span class="va">iso3c</span>, any_group <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#     country iso3c date year decade region income  OECD PCGDP LIFEEX GINI  ODA  POP</span></span>
<span><span class="co"># ABW   FALSE FALSE TRUE TRUE   TRUE  FALSE  FALSE FALSE  TRUE   TRUE   NA TRUE TRUE</span></span>
<span><span class="co"># AFG   FALSE FALSE TRUE TRUE   TRUE  FALSE  FALSE FALSE  TRUE   TRUE   NA TRUE TRUE</span></span>
<span><span class="co"># AGO   FALSE FALSE TRUE TRUE   TRUE  FALSE  FALSE FALSE  TRUE   TRUE TRUE TRUE TRUE</span></span>
<span><span class="co"># ALB   FALSE FALSE TRUE TRUE   TRUE  FALSE  FALSE FALSE  TRUE   TRUE TRUE TRUE TRUE</span></span>
<span><span class="co"># AND   FALSE FALSE TRUE TRUE   TRUE  FALSE  FALSE FALSE  TRUE     NA   NA   NA TRUE</span></span>
<span><span class="co"># ARE   FALSE FALSE TRUE TRUE   TRUE  FALSE  FALSE FALSE  TRUE   TRUE TRUE TRUE TRUE</span></span></code></pre></div>
<p><code>NA</code> indicates that there are no data for this country. In
general data is varying if it has two or more distinct non-missing
values. We could also take a closer look at observation counts and
distinct values using:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fu"><a href="../reference/fnobs.html">fnobs</a></span><span class="op">(</span><span class="va">wlddev</span>, <span class="va">wlddev</span><span class="op">$</span><span class="va">iso3c</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#     country iso3c date year decade region income OECD PCGDP LIFEEX GINI ODA POP</span></span>
<span><span class="co"># ABW      61    61   61   61     61     61     61   61    32     60    0  20  60</span></span>
<span><span class="co"># AFG      61    61   61   61     61     61     61   61    18     60    0  60  60</span></span>
<span><span class="co"># AGO      61    61   61   61     61     61     61   61    40     60    3  58  60</span></span>
<span><span class="co"># ALB      61    61   61   61     61     61     61   61    40     60    9  32  60</span></span>
<span><span class="co"># AND      61    61   61   61     61     61     61   61    50      0    0   0  60</span></span>
<span><span class="co"># ARE      61    61   61   61     61     61     61   61    45     60    2  45  60</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fu"><a href="../reference/fndistinct.html">fndistinct</a></span><span class="op">(</span><span class="va">wlddev</span>, <span class="va">wlddev</span><span class="op">$</span><span class="va">iso3c</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#     country iso3c date year decade region income OECD PCGDP LIFEEX GINI ODA POP</span></span>
<span><span class="co"># ABW       1     1   61   61      7      1      1    1    32     60    0  20  60</span></span>
<span><span class="co"># AFG       1     1   61   61      7      1      1    1    18     60    0  60  60</span></span>
<span><span class="co"># AGO       1     1   61   61      7      1      1    1    40     59    3  58  60</span></span>
<span><span class="co"># ALB       1     1   61   61      7      1      1    1    40     59    9  32  60</span></span>
<span><span class="co"># AND       1     1   61   61      7      1      1    1    50      0    0   0  60</span></span>
<span><span class="co"># ARE       1     1   61   61      7      1      1    1    45     60    2  45  60</span></span></code></pre></div>
<p>Note that <code>varying</code> is more efficient than
<code>fndistinct</code>, although both functions are very fast. Even
more powerful summary methods for multilevel / panel data are provided
by <code>qsu</code> (shorthand for <em>quick-summary</em>). It is
modeled after <em>STATA</em>’s <em>summarize</em> and
<em>xtsummarize</em> commands. Calling <code>qsu</code> on the data
gives a concise summary. We can subset columns internally using the
<code>cols</code> argument:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/qsu.html">qsu</a></span><span class="op">(</span><span class="va">wlddev</span>, cols <span class="op">=</span> <span class="fl">9</span><span class="op">:</span><span class="fl">12</span>, higher <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="co"># higher adds skewness and kurtosis</span></span>
<span><span class="co">#             N        Mean          SD          Min             Max     Skew     Kurt</span></span>
<span><span class="co"># PCGDP    9470   12048.778  19077.6416     132.0776      196061.417   3.1276  17.1154</span></span>
<span><span class="co"># LIFEEX  11670     64.2963     11.4764       18.907         85.4171  -0.6748   2.6718</span></span>
<span><span class="co"># GINI     1744     38.5341      9.2006         20.7            65.8    0.596   2.5329</span></span>
<span><span class="co"># ODA      8608  454'720131  868'712654  -997'679993  2.56715605e+10   6.9832  114.889</span></span></code></pre></div>
<p>We could easily compute these statistics by region:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/qsu.html">qsu</a></span><span class="op">(</span><span class="va">wlddev</span>, by <span class="op">=</span> <span class="op">~</span><span class="va">region</span>, cols <span class="op">=</span> <span class="fl">9</span><span class="op">:</span><span class="fl">12</span>, vlabels <span class="op">=</span> <span class="cn">TRUE</span>, higher <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co"># , , PCGDP: GDP per capita (constant 2010 US$)</span></span>
<span><span class="co"># </span></span>
<span><span class="co">#                                N        Mean          SD         Min         Max    Skew     Kurt</span></span>
<span><span class="co"># East Asia &amp; Pacific         1467  10513.2441  14383.5507    132.0776  71992.1517  1.6392   4.7419</span></span>
<span><span class="co"># Europe &amp; Central Asia       2243  25992.9618  26435.1316    366.9354  196061.417  2.2022  10.1977</span></span>
<span><span class="co"># Latin America &amp; Caribbean   1976   7628.4477   8818.5055   1005.4085  88391.3331  4.1702  29.3739</span></span>
<span><span class="co"># Middle East &amp; North Africa   842  13878.4213  18419.7912    578.5996  116232.753  2.4178   9.7669</span></span>
<span><span class="co"># North America                180    48699.76  24196.2855  16405.9053  113236.091   0.938   2.9688</span></span>
<span><span class="co"># South Asia                   382   1235.9256   1611.2232    265.9625    8476.564  2.7874  10.3402</span></span>
<span><span class="co"># Sub-Saharan Africa          2380   1840.0259   2596.0104    164.3366  20532.9523  3.1161  14.4175</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># , , LIFEEX: Life expectancy at birth, total (years)</span></span>
<span><span class="co"># </span></span>
<span><span class="co">#                                N     Mean       SD      Min      Max     Skew    Kurt</span></span>
<span><span class="co"># East Asia &amp; Pacific         1807  65.9445  10.1633   18.907   85.078   -0.856  4.3125</span></span>
<span><span class="co"># Europe &amp; Central Asia       3046  72.1625   5.7602   45.369  85.4171  -0.5594  4.0434</span></span>
<span><span class="co"># Latin America &amp; Caribbean   2107  68.3486   7.3768   41.762  82.1902  -1.0357  3.9379</span></span>
<span><span class="co"># Middle East &amp; North Africa  1226  66.2508   9.8306   29.919  82.8049  -0.8782  3.3054</span></span>
<span><span class="co"># North America                144  76.2867   3.5734  68.8978  82.0488  -0.1963   1.976</span></span>
<span><span class="co"># South Asia                   480  57.5585  11.3004   32.446   78.921  -0.2623  2.1147</span></span>
<span><span class="co"># Sub-Saharan Africa          2860   51.581   8.6876   26.172  74.5146   0.1452  2.7245</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># , , GINI: Gini index (World Bank estimate)</span></span>
<span><span class="co"># </span></span>
<span><span class="co">#                               N     Mean      SD   Min   Max     Skew    Kurt</span></span>
<span><span class="co"># East Asia &amp; Pacific         154  37.7571  5.0318  27.8  49.1   0.3631  2.3047</span></span>
<span><span class="co"># Europe &amp; Central Asia       798  31.9114  4.5809  20.7  48.4   0.2989  2.5254</span></span>
<span><span class="co"># Latin America &amp; Caribbean   413  49.9557  5.4821  34.4  63.3  -0.0386  2.3631</span></span>
<span><span class="co"># Middle East &amp; North Africa   91  36.0143  5.2073    26  47.4   0.0241  1.9209</span></span>
<span><span class="co"># North America                49  37.4816  3.6972    31  41.5  -0.4282  1.4577</span></span>
<span><span class="co"># South Asia                   46  33.8804  3.9898  25.9  43.8   0.4205  2.7748</span></span>
<span><span class="co"># Sub-Saharan Africa          193  44.6606  8.2003  29.8  65.8   0.6598  2.8451</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># , , ODA: Net official development assistance and official aid received (constant 2018 US$)</span></span>
<span><span class="co"># </span></span>
<span><span class="co">#                                N            Mean              SD           Min             Max</span></span>
<span><span class="co"># East Asia &amp; Pacific         1537      352'017964      622'847624   -997'679993  4.04487988e+09</span></span>
<span><span class="co"># Europe &amp; Central Asia        787      402'455286      568'237036   -322'070007  4.34612988e+09</span></span>
<span><span class="co"># Latin America &amp; Caribbean   1972      172'880081      260'781049   -444'040009  2.99568994e+09</span></span>
<span><span class="co"># Middle East &amp; North Africa  1105      732'380009  1.52108993e+09   -141'789993  2.56715605e+10</span></span>
<span><span class="co"># North America                 39      468717.916     10'653560.8  -15'869999.9     61'509998.3</span></span>
<span><span class="co"># South Asia                   466  1.27049955e+09  1.61492889e+09   -247'369995  8.75425977e+09</span></span>
<span><span class="co"># Sub-Saharan Africa          2702      486'371750      656'336230  -18'409999.8  1.18790801e+10</span></span>
<span><span class="co">#                               Skew     Kurt</span></span>
<span><span class="co"># East Asia &amp; Pacific          2.722  11.5221</span></span>
<span><span class="co"># Europe &amp; Central Asia       3.1305  15.2525</span></span>
<span><span class="co"># Latin America &amp; Caribbean   3.3259  22.4569</span></span>
<span><span class="co"># Middle East &amp; North Africa  6.6304  79.2238</span></span>
<span><span class="co"># North America               4.8602  29.3092</span></span>
<span><span class="co"># South Asia                  1.7923    6.501</span></span>
<span><span class="co"># Sub-Saharan Africa          4.5456  48.8447</span></span></code></pre></div>
<p>Computing summary statistics by country is of course also possible
but would be too much information. Fortunately <code>qsu</code> lets us
do something much more powerful:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/qsu.html">qsu</a></span><span class="op">(</span><span class="va">wlddev</span>, pid <span class="op">=</span> <span class="op">~</span> <span class="va">iso3c</span>, cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">4</span>,<span class="fl">9</span><span class="op">:</span><span class="fl">12</span><span class="op">)</span>, vlabels <span class="op">=</span> <span class="cn">TRUE</span>, higher <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co"># , , country: Country Name</span></span>
<span><span class="co"># </span></span>
<span><span class="co">#            N/T  Mean  SD  Min  Max  Skew  Kurt</span></span>
<span><span class="co"># Overall  13176     -   -    -    -     -     -</span></span>
<span><span class="co"># Between    216     -   -    -    -     -     -</span></span>
<span><span class="co"># Within      61     -   -    -    -     -     -</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># , , year: Year</span></span>
<span><span class="co"># </span></span>
<span><span class="co">#            N/T  Mean       SD   Min   Max  Skew    Kurt</span></span>
<span><span class="co"># Overall  13176  1990  17.6075  1960  2020    -0  1.7994</span></span>
<span><span class="co"># Between    216  1990        0  1990  1990     -       -</span></span>
<span><span class="co"># Within      61  1990  17.6075  1960  2020    -0  1.7994</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># , , PCGDP: GDP per capita (constant 2010 US$)</span></span>
<span><span class="co"># </span></span>
<span><span class="co">#              N/T        Mean          SD          Min         Max    Skew     Kurt</span></span>
<span><span class="co"># Overall     9470   12048.778  19077.6416     132.0776  196061.417  3.1276  17.1154</span></span>
<span><span class="co"># Between      206  12962.6054  20189.9007     253.1886   141200.38  3.1263  16.2299</span></span>
<span><span class="co"># Within   45.9709   12048.778   6723.6808  -33504.8721  76767.5254  0.6576  17.2003</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># , , LIFEEX: Life expectancy at birth, total (years)</span></span>
<span><span class="co"># </span></span>
<span><span class="co">#              N/T     Mean       SD      Min      Max     Skew    Kurt</span></span>
<span><span class="co"># Overall    11670  64.2963  11.4764   18.907  85.4171  -0.6748  2.6718</span></span>
<span><span class="co"># Between      207  64.9537   9.8936  40.9663  85.4171  -0.5012  2.1693</span></span>
<span><span class="co"># Within   56.3768  64.2963   6.0842  32.9068  84.4198  -0.2643  3.7027</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># , , GINI: Gini index (World Bank estimate)</span></span>
<span><span class="co"># </span></span>
<span><span class="co">#              N/T     Mean      SD      Min      Max    Skew    Kurt</span></span>
<span><span class="co"># Overall     1744  38.5341  9.2006     20.7     65.8   0.596  2.5329</span></span>
<span><span class="co"># Between      167  39.4233  8.1356  24.8667  61.7143  0.5832  2.8256</span></span>
<span><span class="co"># Within   10.4431  38.5341  2.9277  25.3917  55.3591  0.3263  5.3389</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># , , ODA: Net official development assistance and official aid received (constant 2018 US$)</span></span>
<span><span class="co"># </span></span>
<span><span class="co">#              N/T        Mean          SD              Min             Max    Skew      Kurt</span></span>
<span><span class="co"># Overall     8608  454'720131  868'712654      -997'679993  2.56715605e+10  6.9832   114.889</span></span>
<span><span class="co"># Between      178  439'168412  569'049959       468717.916  3.62337432e+09   2.355    9.9487</span></span>
<span><span class="co"># Within   48.3596  454'720131  650'709624  -2.44379420e+09  2.45610972e+10  9.6047  263.3716</span></span></code></pre></div>
<p>The above output reports 3 sets of summary statistics for each
variable: Statistics computed on the <em>Overall</em> (raw) data, and on
the <em>Between</em>-country (i.e. country averaged) and
<em>Within</em>-country (i.e. country-demeaned) data<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content="&lt;p&gt;in the &lt;em&gt;Within&lt;/em&gt; data, the overall mean was added
back after subtracting out country means, to preserve the level of the
data, see also section 6.5.&lt;/p&gt;"><sup>1</sup></a>. This is a powerful
way to summarize panel data because aggregating the data by country
gives us a cross-section of countries with no variation over time,
whereas subtracting country specific means from the data eliminates all
cross-sectional variation.
<!-- Thus we summarize the variation in our panel in 3 different ways: First we consider the raw data, then we create a cross-section of countries and summarize that, and then we sweep that cross-section out of the raw data and pretend we have a time series. --></p>
<p>So what can these statistics tell us about our data? The
<code>N/T</code> columns shows that for <code>PCGDP</code> we have 8995
total observations, that we observe GDP data for 203 countries and that
we have on average 44.3 observations (time-periods) per country. In
contrast the GINI Index is only available for 161 countries with 8.4
observations on average. The <em>Overall</em> and <em>Within</em> mean
of the data are identical by definition, and the <em>Between</em> mean
would also be the same in a balanced panel with no missing observations.
In practice we have unequal amounts of observations for different
countries, thus countries have different weights in the <em>Overall</em>
mean and the difference between <em>Overall</em> and
<em>Between</em>-country mean reflects this discrepancy. The most
interesting statistic in this summary arguably is the standard
deviation, and in particular the comparison of the <em>Between</em>-SD
reflecting the variation between countries and the <em>Within</em>-SD
reflecting average variation over time. This comparison shows that
PCGDP, LIFEEX and GINI vary more between countries, but ODA received
varies more within countries over time. The 0 <em>Between</em>-SD for
the year variable and the fact that the <em>Overall</em> and
<em>Within</em>-SD are equal shows that year is individual invariant.
Thus <code>qsu</code> also provides the same information as
<code>varying</code>, but with additional details on the relative
magnitudes of cross-sectional and time series variation. It is also a
common pattern that the <em>kurtosis</em> increases in
within-transformed data, while the <em>skewness</em> decreases in most
cases.</p>
<!-- The output above is a 3D array of statistics which can also be subsetted (`[`) or permuted using `aperm()`.  -->
<p>We could also do all of that by regions to have a look at the between
and within country variations inside and across different World
regions:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/qsu.html">qsu</a></span><span class="op">(</span><span class="va">wlddev</span>, by <span class="op">=</span> <span class="op">~</span> <span class="va">region</span>, pid <span class="op">=</span> <span class="op">~</span> <span class="va">iso3c</span>, cols <span class="op">=</span> <span class="fl">9</span><span class="op">:</span><span class="fl">12</span>, vlabels <span class="op">=</span> <span class="cn">TRUE</span>, higher <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co"># , , Overall, PCGDP: GDP per capita (constant 2010 US$)</span></span>
<span><span class="co"># </span></span>
<span><span class="co">#                              N/T        Mean          SD         Min         Max    Skew     Kurt</span></span>
<span><span class="co"># East Asia &amp; Pacific         1467  10513.2441  14383.5507    132.0776  71992.1517  1.6392   4.7419</span></span>
<span><span class="co"># Europe &amp; Central Asia       2243  25992.9618  26435.1316    366.9354  196061.417  2.2022  10.1977</span></span>
<span><span class="co"># Latin America &amp; Caribbean   1976   7628.4477   8818.5055   1005.4085  88391.3331  4.1702  29.3739</span></span>
<span><span class="co"># Middle East &amp; North Africa   842  13878.4213  18419.7912    578.5996  116232.753  2.4178   9.7669</span></span>
<span><span class="co"># North America                180    48699.76  24196.2855  16405.9053  113236.091   0.938   2.9688</span></span>
<span><span class="co"># South Asia                   382   1235.9256   1611.2232    265.9625    8476.564  2.7874  10.3402</span></span>
<span><span class="co"># Sub-Saharan Africa          2380   1840.0259   2596.0104    164.3366  20532.9523  3.1161  14.4175</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># , , Between, PCGDP: GDP per capita (constant 2010 US$)</span></span>
<span><span class="co"># </span></span>
<span><span class="co">#                             N/T        Mean          SD         Min         Max    Skew     Kurt</span></span>
<span><span class="co"># East Asia &amp; Pacific          34  10513.2441   12771.742    444.2899  39722.0077  1.1488   2.7089</span></span>
<span><span class="co"># Europe &amp; Central Asia        56  25992.9618   24051.035    809.4753   141200.38  2.0026   9.0733</span></span>
<span><span class="co"># Latin America &amp; Caribbean    38   7628.4477   8470.9708   1357.3326  77403.7443  4.4548  32.4956</span></span>
<span><span class="co"># Middle East &amp; North Africa   20  13878.4213  17251.6962   1069.6596  64878.4021  1.9508   6.0796</span></span>
<span><span class="co"># North America                 3    48699.76  18604.4369  35260.4708  74934.5874  0.7065      1.5</span></span>
<span><span class="co"># South Asia                    8   1235.9256   1488.3669      413.68   6621.5002  3.0546  11.3083</span></span>
<span><span class="co"># Sub-Saharan Africa           47   1840.0259   2234.3254    253.1886   9922.0052  2.1442   6.8259</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># , , Within, PCGDP: GDP per capita (constant 2010 US$)</span></span>
<span><span class="co"># </span></span>
<span><span class="co">#                                 N/T       Mean          SD          Min         Max     Skew</span></span>
<span><span class="co"># East Asia &amp; Pacific         43.1471  12048.778   6615.8248  -11964.6472   49541.463    0.824</span></span>
<span><span class="co"># Europe &amp; Central Asia       40.0536  12048.778  10971.0483  -33504.8721  76767.5254   0.4307</span></span>
<span><span class="co"># Latin America &amp; Caribbean        52  12048.778   2451.2636    -354.1639  23036.3668   0.1259</span></span>
<span><span class="co"># Middle East &amp; North Africa     42.1  12048.778   6455.0512  -18674.4049  63665.0446   1.8525</span></span>
<span><span class="co"># North America                    60  12048.778  15470.4609  -29523.1017  50350.2816  -0.2451</span></span>
<span><span class="co"># South Asia                    47.75  12048.778    617.0934   10026.9155   14455.865   0.9846</span></span>
<span><span class="co"># Sub-Saharan Africa          50.6383  12048.778    1321.764    4846.3834  24883.1246   1.3879</span></span>
<span><span class="co">#                                Kurt</span></span>
<span><span class="co"># East Asia &amp; Pacific          8.9418</span></span>
<span><span class="co"># Europe &amp; Central Asia        7.4139</span></span>
<span><span class="co"># Latin America &amp; Caribbean    7.1939</span></span>
<span><span class="co"># Middle East &amp; North Africa  23.0457</span></span>
<span><span class="co"># North America                3.2075</span></span>
<span><span class="co"># South Asia                   5.6366</span></span>
<span><span class="co"># Sub-Saharan Africa          28.0186</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># , , Overall, LIFEEX: Life expectancy at birth, total (years)</span></span>
<span><span class="co"># </span></span>
<span><span class="co">#                              N/T     Mean       SD      Min      Max     Skew    Kurt</span></span>
<span><span class="co"># East Asia &amp; Pacific         1807  65.9445  10.1633   18.907   85.078   -0.856  4.3125</span></span>
<span><span class="co"># Europe &amp; Central Asia       3046  72.1625   5.7602   45.369  85.4171  -0.5594  4.0434</span></span>
<span><span class="co"># Latin America &amp; Caribbean   2107  68.3486   7.3768   41.762  82.1902  -1.0357  3.9379</span></span>
<span><span class="co"># Middle East &amp; North Africa  1226  66.2508   9.8306   29.919  82.8049  -0.8782  3.3054</span></span>
<span><span class="co"># North America                144  76.2867   3.5734  68.8978  82.0488  -0.1963   1.976</span></span>
<span><span class="co"># South Asia                   480  57.5585  11.3004   32.446   78.921  -0.2623  2.1147</span></span>
<span><span class="co"># Sub-Saharan Africa          2860   51.581   8.6876   26.172  74.5146   0.1452  2.7245</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># , , Between, LIFEEX: Life expectancy at birth, total (years)</span></span>
<span><span class="co"># </span></span>
<span><span class="co">#                             N/T     Mean      SD      Min      Max     Skew    Kurt</span></span>
<span><span class="co"># East Asia &amp; Pacific          32  65.9445  7.6833  49.7995  77.9008  -0.3832  2.4322</span></span>
<span><span class="co"># Europe &amp; Central Asia        55  72.1625  4.4378  60.1129  85.4171  -0.6584  2.8874</span></span>
<span><span class="co"># Latin America &amp; Caribbean    40  68.3486  4.9199  53.4918  82.1902  -0.9947  4.1617</span></span>
<span><span class="co"># Middle East &amp; North Africa   21  66.2508   5.922  52.5371  76.7395  -0.3181  3.0331</span></span>
<span><span class="co"># North America                 3  76.2867  1.3589  74.8065  78.4175   0.1467  1.6356</span></span>
<span><span class="co"># South Asia                    8  57.5585  5.6158  49.1972  69.3429   0.6643  3.1288</span></span>
<span><span class="co"># Sub-Saharan Africa           48   51.581   5.657  40.9663  71.5749   1.1333   4.974</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># , , Within, LIFEEX: Life expectancy at birth, total (years)</span></span>
<span><span class="co"># </span></span>
<span><span class="co">#                                 N/T     Mean      SD      Min      Max     Skew    Kurt</span></span>
<span><span class="co"># East Asia &amp; Pacific         56.4688  64.2963  6.6528  32.9068  83.9918  -0.3949  3.9528</span></span>
<span><span class="co"># Europe &amp; Central Asia       55.3818  64.2963  3.6723  46.3045  78.6265  -0.0307  3.7576</span></span>
<span><span class="co"># Latin America &amp; Caribbean    52.675  64.2963  5.4965  46.7831  79.5026  -0.3827  2.9936</span></span>
<span><span class="co"># Middle East &amp; North Africa   58.381  64.2963  7.8467  41.6187  78.8872  -0.6216   2.808</span></span>
<span><span class="co"># North America                    48  64.2963  3.3049  54.7766  69.4306  -0.4327  2.3027</span></span>
<span><span class="co"># South Asia                       60  64.2963  9.8062  41.4342  83.0122  -0.0946  2.1035</span></span>
<span><span class="co"># Sub-Saharan Africa          59.5833  64.2963  6.5933  41.5678  84.4198   0.0811  2.7821</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># , , Overall, GINI: Gini index (World Bank estimate)</span></span>
<span><span class="co"># </span></span>
<span><span class="co">#                             N/T     Mean      SD   Min   Max     Skew    Kurt</span></span>
<span><span class="co"># East Asia &amp; Pacific         154  37.7571  5.0318  27.8  49.1   0.3631  2.3047</span></span>
<span><span class="co"># Europe &amp; Central Asia       798  31.9114  4.5809  20.7  48.4   0.2989  2.5254</span></span>
<span><span class="co"># Latin America &amp; Caribbean   413  49.9557  5.4821  34.4  63.3  -0.0386  2.3631</span></span>
<span><span class="co"># Middle East &amp; North Africa   91  36.0143  5.2073    26  47.4   0.0241  1.9209</span></span>
<span><span class="co"># North America                49  37.4816  3.6972    31  41.5  -0.4282  1.4577</span></span>
<span><span class="co"># South Asia                   46  33.8804  3.9898  25.9  43.8   0.4205  2.7748</span></span>
<span><span class="co"># Sub-Saharan Africa          193  44.6606  8.2003  29.8  65.8   0.6598  2.8451</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># , , Between, GINI: Gini index (World Bank estimate)</span></span>
<span><span class="co"># </span></span>
<span><span class="co">#                             N/T     Mean      SD      Min      Max     Skew    Kurt</span></span>
<span><span class="co"># East Asia &amp; Pacific          23  37.7571  4.3005     30.8  45.8857   0.4912   2.213</span></span>
<span><span class="co"># Europe &amp; Central Asia        49  31.9114  4.0611  24.8667   40.935   0.3323   2.291</span></span>
<span><span class="co"># Latin America &amp; Caribbean    25  49.9557  4.0492     41.1     57.9     0.03  2.2573</span></span>
<span><span class="co"># Middle East &amp; North Africa   15  36.0143  4.7002    29.05     42.7  -0.2035  1.6815</span></span>
<span><span class="co"># North America                 2  37.4816  3.3563  33.1222  40.0129  -0.5503  1.3029</span></span>
<span><span class="co"># South Asia                    7  33.8804  3.0052  30.3556     38.8   0.2786  1.4817</span></span>
<span><span class="co"># Sub-Saharan Africa           46  44.6606  6.8844    34.52  61.7143   0.9464  3.2302</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># , , Within, GINI: Gini index (World Bank estimate)</span></span>
<span><span class="co"># </span></span>
<span><span class="co">#                                 N/T     Mean      SD      Min      Max     Skew    Kurt</span></span>
<span><span class="co"># East Asia &amp; Pacific          6.6957  38.5341  2.6125  31.0187  45.8901  -0.0585  3.0933</span></span>
<span><span class="co"># Europe &amp; Central Asia       16.2857  38.5341  2.1195  31.2841  50.1387   0.6622  6.1763</span></span>
<span><span class="co"># Latin America &amp; Caribbean     16.52  38.5341  3.6955  25.3917  48.8341  -0.0506  2.7603</span></span>
<span><span class="co"># Middle East &amp; North Africa   6.0667  38.5341  2.2415  31.7675   45.777   0.0408  4.7415</span></span>
<span><span class="co"># North America                  24.5  38.5341  1.5507  33.0212  42.7119  -1.3213  6.8321</span></span>
<span><span class="co"># South Asia                   6.5714  38.5341  2.6244  32.8341  45.0675  -0.1055  2.6885</span></span>
<span><span class="co"># Sub-Saharan Africa           4.1957  38.5341  4.4553  27.9452  55.3591   0.6338  4.4174</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># , , Overall, ODA: Net official development assistance and official aid received (constant 2018 US$)</span></span>
<span><span class="co"># </span></span>
<span><span class="co">#                              N/T            Mean              SD           Min             Max</span></span>
<span><span class="co"># East Asia &amp; Pacific         1537      352'017964      622'847624   -997'679993  4.04487988e+09</span></span>
<span><span class="co"># Europe &amp; Central Asia        787      402'455286      568'237036   -322'070007  4.34612988e+09</span></span>
<span><span class="co"># Latin America &amp; Caribbean   1972      172'880081      260'781049   -444'040009  2.99568994e+09</span></span>
<span><span class="co"># Middle East &amp; North Africa  1105      732'380009  1.52108993e+09   -141'789993  2.56715605e+10</span></span>
<span><span class="co"># North America                 39      468717.916     10'653560.8  -15'869999.9     61'509998.3</span></span>
<span><span class="co"># South Asia                   466  1.27049955e+09  1.61492889e+09   -247'369995  8.75425977e+09</span></span>
<span><span class="co"># Sub-Saharan Africa          2702      486'371750      656'336230  -18'409999.8  1.18790801e+10</span></span>
<span><span class="co">#                               Skew     Kurt</span></span>
<span><span class="co"># East Asia &amp; Pacific          2.722  11.5221</span></span>
<span><span class="co"># Europe &amp; Central Asia       3.1305  15.2525</span></span>
<span><span class="co"># Latin America &amp; Caribbean   3.3259  22.4569</span></span>
<span><span class="co"># Middle East &amp; North Africa  6.6304  79.2238</span></span>
<span><span class="co"># North America               4.8602  29.3092</span></span>
<span><span class="co"># South Asia                  1.7923    6.501</span></span>
<span><span class="co"># Sub-Saharan Africa          4.5456  48.8447</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># , , Between, ODA: Net official development assistance and official aid received (constant 2018 US$)</span></span>
<span><span class="co"># </span></span>
<span><span class="co">#                             N/T            Mean              SD          Min             Max</span></span>
<span><span class="co"># East Asia &amp; Pacific          31      352'017964      457'183279  1'654615.38  1.63585532e+09</span></span>
<span><span class="co"># Europe &amp; Central Asia        32      402'455286      438'074771  12'516000.1  2.05456932e+09</span></span>
<span><span class="co"># Latin America &amp; Caribbean    37      172'880081      167'160838  2'225483.88      538'386665</span></span>
<span><span class="co"># Middle East &amp; North Africa   21      732'380009      775'418887   3'112820.5  2.86174883e+09</span></span>
<span><span class="co"># North America                 1      468717.916               0   468717.916      468717.916</span></span>
<span><span class="co"># South Asia                    8  1.27049955e+09  1.18347893e+09  27'152499.9  3.62337432e+09</span></span>
<span><span class="co"># Sub-Saharan Africa           48      486'371750      397'995105  28'801206.9  1.55049113e+09</span></span>
<span><span class="co">#                               Skew    Kurt</span></span>
<span><span class="co"># East Asia &amp; Pacific         1.7771  5.1361</span></span>
<span><span class="co"># Europe &amp; Central Asia       2.0449  7.2489</span></span>
<span><span class="co"># Latin America &amp; Caribbean   0.8981  2.4954</span></span>
<span><span class="co"># Middle East &amp; North Africa  1.1363  3.6377</span></span>
<span><span class="co"># North America                    -       -</span></span>
<span><span class="co"># South Asia                  0.7229  2.4072</span></span>
<span><span class="co"># Sub-Saharan Africa          0.9871  3.1513</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># , , Within, ODA: Net official development assistance and official aid received (constant 2018 US$)</span></span>
<span><span class="co"># </span></span>
<span><span class="co">#                                 N/T        Mean              SD              Min             Max</span></span>
<span><span class="co"># East Asia &amp; Pacific         49.5806  454'720131      422'992450  -2.04042108e+09  3.59673152e+09</span></span>
<span><span class="co"># Europe &amp; Central Asia       24.5938  454'720131      361'916875  -1.08796786e+09  3.30549004e+09</span></span>
<span><span class="co"># Latin America &amp; Caribbean   53.2973  454'720131      200'159960      -527'706542  3.28976141e+09</span></span>
<span><span class="co"># Middle East &amp; North Africa   52.619  454'720131  1.30860235e+09  -2.34610870e+09  2.45610972e+10</span></span>
<span><span class="co"># North America                    39  454'720131     10'653560.8       438'381413      515'761411</span></span>
<span><span class="co"># South Asia                    58.25  454'720131  1.09880524e+09  -2.44379420e+09  5.58560558e+09</span></span>
<span><span class="co"># Sub-Saharan Africa          56.2917  454'720131      521'897637      -952'168698  1.12814455e+10</span></span>
<span><span class="co">#                               Skew     Kurt</span></span>
<span><span class="co"># East Asia &amp; Pacific         0.2908  14.4428</span></span>
<span><span class="co"># Europe &amp; Central Asia       2.3283  18.6937</span></span>
<span><span class="co"># Latin America &amp; Caribbean   3.7015  41.7506</span></span>
<span><span class="co"># Middle East &amp; North Africa  7.8663  117.987</span></span>
<span><span class="co"># North America               4.8602  29.3092</span></span>
<span><span class="co"># South Asia                  1.8418   9.4588</span></span>
<span><span class="co"># Sub-Saharan Africa          5.2349  86.1042</span></span></code></pre></div>
<p>Notice that the output here is a 4D array of summary statistics,
which we could also subset (<code>[</code>) or permute
(<code>aperm</code>) to view these statistics in any convenient way. If
we don’t like the array, we can also output as a nested list of
statistics matrices:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">l</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/qsu.html">qsu</a></span><span class="op">(</span><span class="va">wlddev</span>, by <span class="op">=</span> <span class="op">~</span> <span class="va">region</span>, pid <span class="op">=</span> <span class="op">~</span> <span class="va">iso3c</span>, cols <span class="op">=</span> <span class="fl">9</span><span class="op">:</span><span class="fl">12</span>, vlabels <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>         higher <span class="op">=</span> <span class="cn">TRUE</span>, array <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">l</span>, give.attr <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co"># List of 4</span></span>
<span><span class="co">#  $ PCGDP: GDP per capita (constant 2010 US$)                                             :List of 3</span></span>
<span><span class="co">#   ..$ Overall: 'qsu' num [1:7, 1:7] 1467 2243 1976 842 180 ...</span></span>
<span><span class="co">#   ..$ Between: 'qsu' num [1:7, 1:7] 34 56 38 20 3 ...</span></span>
<span><span class="co">#   ..$ Within : 'qsu' num [1:7, 1:7] 43.1 40.1 52 42.1 60 ...</span></span>
<span><span class="co">#  $ LIFEEX: Life expectancy at birth, total (years)                                       :List of 3</span></span>
<span><span class="co">#   ..$ Overall: 'qsu' num [1:7, 1:7] 1807 3046 2107 1226 144 ...</span></span>
<span><span class="co">#   ..$ Between: 'qsu' num [1:7, 1:7] 32 55 40 21 3 ...</span></span>
<span><span class="co">#   ..$ Within : 'qsu' num [1:7, 1:7] 56.5 55.4 52.7 58.4 48 ...</span></span>
<span><span class="co">#  $ GINI: Gini index (World Bank estimate)                                                :List of 3</span></span>
<span><span class="co">#   ..$ Overall: 'qsu' num [1:7, 1:7] 154 798 413 91 49 ...</span></span>
<span><span class="co">#   ..$ Between: 'qsu' num [1:7, 1:7] 23 49 25 15 2 ...</span></span>
<span><span class="co">#   ..$ Within : 'qsu' num [1:7, 1:7] 6.7 16.29 16.52 6.07 24.5 ...</span></span>
<span><span class="co">#  $ ODA: Net official development assistance and official aid received (constant 2018 US$):List of 3</span></span>
<span><span class="co">#   ..$ Overall: 'qsu' num [1:7, 1:7] 1537 787 1972 1105 39 ...</span></span>
<span><span class="co">#   ..$ Between: 'qsu' num [1:7, 1:7] 31 32 37 21 1 ...</span></span>
<span><span class="co">#   ..$ Within : 'qsu' num [1:7, 1:7] 49.6 24.6 53.3 52.6 39 ...</span></span></code></pre></div>
<p>Such a list of statistics matrices could, for example, be converted
into a tidy data frame using <code>unlist2d</code> (more about this in
the section on list-processing):</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fu"><a href="../reference/unlist2d.html">unlist2d</a></span><span class="op">(</span><span class="va">l</span>, idcols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Variable"</span>, <span class="st">"Trans"</span><span class="op">)</span>, row.names <span class="op">=</span> <span class="st">"Region"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#                                    Variable   Trans                     Region    N      Mean</span></span>
<span><span class="co"># 1 PCGDP: GDP per capita (constant 2010 US$) Overall        East Asia &amp; Pacific 1467 10513.244</span></span>
<span><span class="co"># 2 PCGDP: GDP per capita (constant 2010 US$) Overall      Europe &amp; Central Asia 2243 25992.962</span></span>
<span><span class="co"># 3 PCGDP: GDP per capita (constant 2010 US$) Overall  Latin America &amp; Caribbean 1976  7628.448</span></span>
<span><span class="co"># 4 PCGDP: GDP per capita (constant 2010 US$) Overall Middle East &amp; North Africa  842 13878.421</span></span>
<span><span class="co"># 5 PCGDP: GDP per capita (constant 2010 US$) Overall              North America  180 48699.760</span></span>
<span><span class="co"># 6 PCGDP: GDP per capita (constant 2010 US$) Overall                 South Asia  382  1235.926</span></span>
<span><span class="co">#          SD        Min        Max      Skew      Kurt</span></span>
<span><span class="co"># 1 14383.551   132.0776  71992.152 1.6392248  4.741856</span></span>
<span><span class="co"># 2 26435.132   366.9354 196061.417 2.2022472 10.197685</span></span>
<span><span class="co"># 3  8818.505  1005.4085  88391.333 4.1701769 29.373869</span></span>
<span><span class="co"># 4 18419.791   578.5996 116232.753 2.4177586  9.766883</span></span>
<span><span class="co"># 5 24196.285 16405.9053 113236.091 0.9380056  2.968769</span></span>
<span><span class="co"># 6  1611.223   265.9625   8476.564 2.7873830 10.340176</span></span></code></pre></div>
<p>This is not yet end of <code>qsu</code>’s functionality, as we can
also do all of the above on panel-surveys utilizing weights
(<code>w</code> argument).</p>
<p>Finally, we can look at (weighted) pairwise correlations in this
data:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/pwcor_pwcov_pwnobs.html">pwcor</a></span><span class="op">(</span><span class="va">wlddev</span><span class="op">[</span><span class="fl">9</span><span class="op">:</span><span class="fl">12</span><span class="op">]</span>, N <span class="op">=</span> <span class="cn">TRUE</span>, P <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#               PCGDP        LIFEEX         GINI          ODA</span></span>
<span><span class="co"># PCGDP    1   (9470)   .57* (9022) -.44* (1735) -.16* (7128)</span></span>
<span><span class="co"># LIFEEX  .57* (9022)   1   (11670) -.35* (1742) -.02  (8142)</span></span>
<span><span class="co"># GINI   -.44* (1735)  -.35* (1742)   1   (1744) -.20* (1109)</span></span>
<span><span class="co"># ODA    -.16* (7128)  -.02  (8142) -.20* (1109)   1   (8608)</span></span></code></pre></div>
<p>which can of course also be computed on averaged and
within-transformed data:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="../reference/pwcor_pwcov_pwnobs.html">pwcor</a></span><span class="op">(</span><span class="fu"><a href="../reference/fmean.html">fmean</a></span><span class="op">(</span><span class="va">wlddev</span><span class="op">[</span><span class="fl">9</span><span class="op">:</span><span class="fl">12</span><span class="op">]</span>, <span class="va">wlddev</span><span class="op">$</span><span class="va">iso3c</span><span class="op">)</span>, N <span class="op">=</span> <span class="cn">TRUE</span>, P <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, show <span class="op">=</span> <span class="st">"lower.tri"</span><span class="op">)</span></span>
<span><span class="co">#              PCGDP      LIFEEX        GINI         ODA</span></span>
<span><span class="co"># PCGDP    1   (206)                                    </span></span>
<span><span class="co"># LIFEEX  .60* (199)   1   (207)                        </span></span>
<span><span class="co"># GINI   -.42* (165) -.40* (165)   1   (167)            </span></span>
<span><span class="co"># ODA    -.25* (172) -.21* (172) -.19* (145)   1   (178)</span></span>
<span></span>
<span><span class="co"># N is same as overall N shown above...</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="../reference/pwcor_pwcov_pwnobs.html">pwcor</a></span><span class="op">(</span><span class="fu"><a href="../reference/fbetween_fwithin.html">fwithin</a></span><span class="op">(</span><span class="va">wlddev</span><span class="op">[</span><span class="fl">9</span><span class="op">:</span><span class="fl">12</span><span class="op">]</span>, <span class="va">wlddev</span><span class="op">$</span><span class="va">iso3c</span><span class="op">)</span>, P <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, show <span class="op">=</span> <span class="st">"lower.tri"</span><span class="op">)</span></span>
<span><span class="co">#         PCGDP LIFEEX   GINI    ODA</span></span>
<span><span class="co"># PCGDP     1                       </span></span>
<span><span class="co"># LIFEEX   .31*    1                </span></span>
<span><span class="co"># GINI    -.01   -.16*    1         </span></span>
<span><span class="co"># ODA     -.01    .17*  -.08*    1</span></span></code></pre></div>
<p>A useful function called by <code>pwcor</code> is
<code>pwnobs</code>, which is very handy to explore the joint
observation structure when selecting variables to include in a
statistical model:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/pwcor_pwcov_pwnobs.html">pwnobs</a></span><span class="op">(</span><span class="va">wlddev</span><span class="op">)</span></span>
<span><span class="co">#         country iso3c  date  year decade region income  OECD PCGDP LIFEEX GINI  ODA   POP</span></span>
<span><span class="co"># country   13176 13176 13176 13176  13176  13176  13176 13176  9470  11670 1744 8608 12919</span></span>
<span><span class="co"># iso3c     13176 13176 13176 13176  13176  13176  13176 13176  9470  11670 1744 8608 12919</span></span>
<span><span class="co"># date      13176 13176 13176 13176  13176  13176  13176 13176  9470  11670 1744 8608 12919</span></span>
<span><span class="co"># year      13176 13176 13176 13176  13176  13176  13176 13176  9470  11670 1744 8608 12919</span></span>
<span><span class="co"># decade    13176 13176 13176 13176  13176  13176  13176 13176  9470  11670 1744 8608 12919</span></span>
<span><span class="co"># region    13176 13176 13176 13176  13176  13176  13176 13176  9470  11670 1744 8608 12919</span></span>
<span><span class="co"># income    13176 13176 13176 13176  13176  13176  13176 13176  9470  11670 1744 8608 12919</span></span>
<span><span class="co"># OECD      13176 13176 13176 13176  13176  13176  13176 13176  9470  11670 1744 8608 12919</span></span>
<span><span class="co"># PCGDP      9470  9470  9470  9470   9470   9470   9470  9470  9470   9022 1735 7128  9470</span></span>
<span><span class="co"># LIFEEX    11670 11670 11670 11670  11670  11670  11670 11670  9022  11670 1742 8142 11659</span></span>
<span><span class="co"># GINI       1744  1744  1744  1744   1744   1744   1744  1744  1735   1742 1744 1109  1744</span></span>
<span><span class="co"># ODA        8608  8608  8608  8608   8608   8608   8608  8608  7128   8142 1109 8608  8597</span></span>
<span><span class="co"># POP       12919 12919 12919 12919  12919  12919  12919 12919  9470  11659 1744 8597 12919</span></span></code></pre></div>
<p>Note that both <code>pwcor/pwcov</code> and <code>pwnobs</code> are
faster on matrices.</p>
<!-- *Note:* Other distributional statistics like the *median* and *quantiles* are currently not implemented for reasons having to do with computation speed (>10x faster than `base::summary` and suitable for really large panels) and the algorithm^[`qsu` uses a numerically stable online algorithm generalized from Welford's Algorithm to compute variances.] behind `qsu`, but might come in a further update of `qsu`.  -->
</div>
<div class="section level3">
<h3 id="ggdc10s---ggdc-10-sector-database">1.2 <code>GGDC10S</code> - GGDC 10-Sector Database<a class="anchor" aria-label="anchor" href="#ggdc10s---ggdc-10-sector-database"></a>
</h3>
<p>The Groningen Growth and Development Centre 10-Sector Database
provides long-run data on sectoral productivity performance in Africa,
Asia, and Latin America. Variables covered in the data set are annual
series of value added (VA, in local currency), and persons employed
(EMP) for 10 broad sectors.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">GGDC10S</span><span class="op">)</span></span>
<span><span class="co">#   Country Regioncode             Region Variable Year      AGR      MIN       MAN        PU</span></span>
<span><span class="co"># 1     BWA        SSA Sub-saharan Africa       VA 1960       NA       NA        NA        NA</span></span>
<span><span class="co"># 2     BWA        SSA Sub-saharan Africa       VA 1961       NA       NA        NA        NA</span></span>
<span><span class="co"># 3     BWA        SSA Sub-saharan Africa       VA 1962       NA       NA        NA        NA</span></span>
<span><span class="co"># 4     BWA        SSA Sub-saharan Africa       VA 1963       NA       NA        NA        NA</span></span>
<span><span class="co"># 5     BWA        SSA Sub-saharan Africa       VA 1964 16.30154 3.494075 0.7365696 0.1043936</span></span>
<span><span class="co"># 6     BWA        SSA Sub-saharan Africa       VA 1965 15.72700 2.495768 1.0181992 0.1350976</span></span>
<span><span class="co">#         CON      WRT      TRA     FIRE      GOV      OTH      SUM</span></span>
<span><span class="co"># 1        NA       NA       NA       NA       NA       NA       NA</span></span>
<span><span class="co"># 2        NA       NA       NA       NA       NA       NA       NA</span></span>
<span><span class="co"># 3        NA       NA       NA       NA       NA       NA       NA</span></span>
<span><span class="co"># 4        NA       NA       NA       NA       NA       NA       NA</span></span>
<span><span class="co"># 5 0.6600454 6.243732 1.658928 1.119194 4.822485 2.341328 37.48229</span></span>
<span><span class="co"># 6 1.3462312 7.064825 1.939007 1.246789 5.695848 2.678338 39.34710</span></span>
<span></span>
<span><span class="fu"><a href="../reference/small-helpers.html">namlab</a></span><span class="op">(</span><span class="va">GGDC10S</span>, class <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#      Variable     Class                                                 Label</span></span>
<span><span class="co"># 1     Country character                                               Country</span></span>
<span><span class="co"># 2  Regioncode character                                           Region code</span></span>
<span><span class="co"># 3      Region character                                                Region</span></span>
<span><span class="co"># 4    Variable character                                              Variable</span></span>
<span><span class="co"># 5        Year   numeric                                                  Year</span></span>
<span><span class="co"># 6         AGR   numeric                                          Agriculture </span></span>
<span><span class="co"># 7         MIN   numeric                                                Mining</span></span>
<span><span class="co"># 8         MAN   numeric                                         Manufacturing</span></span>
<span><span class="co"># 9          PU   numeric                                             Utilities</span></span>
<span><span class="co"># 10        CON   numeric                                          Construction</span></span>
<span><span class="co"># 11        WRT   numeric                         Trade, restaurants and hotels</span></span>
<span><span class="co"># 12        TRA   numeric                  Transport, storage and communication</span></span>
<span><span class="co"># 13       FIRE   numeric Finance, insurance, real estate and business services</span></span>
<span><span class="co"># 14        GOV   numeric                                   Government services</span></span>
<span><span class="co"># 15        OTH   numeric               Community, social and personal services</span></span>
<span><span class="co"># 16        SUM   numeric                               Summation of sector GDP</span></span>
<span></span>
<span><span class="fu"><a href="../reference/fnobs.html">fnobs</a></span><span class="op">(</span><span class="va">GGDC10S</span><span class="op">)</span></span>
<span><span class="co">#    Country Regioncode     Region   Variable       Year        AGR        MIN        MAN         PU </span></span>
<span><span class="co">#       5027       5027       5027       5027       5027       4364       4355       4355       4354 </span></span>
<span><span class="co">#        CON        WRT        TRA       FIRE        GOV        OTH        SUM </span></span>
<span><span class="co">#       4355       4355       4355       4355       3482       4248       4364</span></span>
<span></span>
<span><span class="fu"><a href="../reference/fndistinct.html">fndistinct</a></span><span class="op">(</span><span class="va">GGDC10S</span><span class="op">)</span></span>
<span><span class="co">#    Country Regioncode     Region   Variable       Year        AGR        MIN        MAN         PU </span></span>
<span><span class="co">#         43          6          6          2         67       4353       4224       4353       4237 </span></span>
<span><span class="co">#        CON        WRT        TRA       FIRE        GOV        OTH        SUM </span></span>
<span><span class="co">#       4339       4344       4334       4349       3470       4238       4364</span></span>
<span></span>
<span><span class="co"># The countries included:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="../reference/funique.html">funique</a></span><span class="op">(</span><span class="va">GGDC10S</span><span class="op">$</span><span class="va">Country</span>, sort <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># ARG BOL BRA BWA CHL CHN COL CRI DEW DNK EGY ESP ETH FRA GBR GHA HKG IDN IND ITA JPN KEN KOR MEX MOR MUS MWI MYS NGA NGA(alt) NLD PER PHL SEN SGP SWE THA TWN TZA USA VEN ZAF ZMB</span></span></code></pre></div>
<p>The first problem in summarizing this data is that value added (VA)
is in local currency, the second that it contains 2 different Variables
(VA and EMP) stacked in the same column. One way of solving the first
problem could be converting the data to percentages through dividing by
the overall VA and EMP contained in the last column. A different
solution involving grouped-scaling is introduced in section 6.4. The
second problem is again nicely handled by <code>qsu</code>, which can
also compute panel-statistics by groups.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Converting data to percentages of overall VA / EMP, dapply keeps the attributes, see section 6.1</span></span>
<span><span class="va">pGGDC10S</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ftransform.html">ftransformv</a></span><span class="op">(</span><span class="va">GGDC10S</span>, <span class="fl">6</span><span class="op">:</span><span class="fl">15</span>, <span class="va">`*`</span>, <span class="fl">100</span> <span class="op">/</span> <span class="va">SUM</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Summarizing the sectoral data by variable, overall, between and within countries</span></span>
<span><span class="va">su</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/qsu.html">qsu</a></span><span class="op">(</span><span class="va">pGGDC10S</span>, by <span class="op">=</span> <span class="op">~</span> <span class="va">Variable</span>, pid <span class="op">=</span> <span class="op">~</span> <span class="va">Variable</span> <span class="op">+</span> <span class="va">Country</span>,</span>
<span>          cols <span class="op">=</span> <span class="fl">6</span><span class="op">:</span><span class="fl">16</span>, higher <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># This gives a 4D array of summary statistics</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">su</span><span class="op">)</span></span>
<span><span class="co">#  'qsu' num [1:2, 1:7, 1:3, 1:11] 2225 2139 35.1 17.3 26.7 ...</span></span>
<span><span class="co">#  - attr(*, "dimnames")=List of 4</span></span>
<span><span class="co">#   ..$ : chr [1:2] "EMP" "VA"</span></span>
<span><span class="co">#   ..$ : chr [1:7] "N/T" "Mean" "SD" "Min" ...</span></span>
<span><span class="co">#   ..$ : chr [1:3] "Overall" "Between" "Within"</span></span>
<span><span class="co">#   ..$ : chr [1:11] "AGR" "MIN" "MAN" "PU" ...</span></span>
<span></span>
<span><span class="co"># Permuting this array to a more readible format</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/aperm.html" class="external-link">aperm</a></span><span class="op">(</span><span class="va">su</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4L</span>, <span class="fl">2L</span>, <span class="fl">3L</span>, <span class="fl">1L</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># , , Overall, EMP</span></span>
<span><span class="co"># </span></span>
<span><span class="co">#        N/T        Mean          SD       Min      Max     Skew     Kurt</span></span>
<span><span class="co"># AGR   2225     35.0949     26.7235     0.156      100   0.4856   2.0951</span></span>
<span><span class="co"># MIN   2216      1.0349      1.4247    0.0043   9.4097   3.1281  15.0429</span></span>
<span><span class="co"># MAN   2216     14.9768      8.0392    0.5822  45.2974   0.4272   2.8455</span></span>
<span><span class="co"># PU    2215      0.5782      0.3601    0.0154   2.4786   1.2588   5.5822</span></span>
<span><span class="co"># CON   2216      5.6583      2.9252    0.1417  15.9887  -0.0631   2.2725</span></span>
<span><span class="co"># WRT   2216     14.9155      6.5573     0.809  32.8046  -0.1814   2.3226</span></span>
<span><span class="co"># TRA   2216      4.8193       2.652    0.1506  15.0454   0.9477   4.4695</span></span>
<span><span class="co"># FIRE  2216      4.6501      4.3518    0.0799  21.7717   1.2345   4.0831</span></span>
<span><span class="co"># GOV   1780     13.1263      8.0844         0  34.8897   0.6301   2.5338</span></span>
<span><span class="co"># OTH   2109      8.3977      6.6409     0.421  34.8942   1.4028   4.3191</span></span>
<span><span class="co"># SUM   2225  36846.8741  96318.6544  173.8829   764200   5.0229  30.9814</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># , , Between, EMP</span></span>
<span><span class="co"># </span></span>
<span><span class="co">#       N/T        Mean         SD       Min         Max     Skew     Kurt</span></span>
<span><span class="co"># AGR    42     35.0949    24.1204    0.9997     88.3263   0.5202   2.2437</span></span>
<span><span class="co"># MIN    42      1.0349     1.2304    0.0296      6.8532   2.7313   12.331</span></span>
<span><span class="co"># MAN    42     14.9768     7.0375     1.718     32.3439  -0.0164   2.4321</span></span>
<span><span class="co"># PU     42      0.5782     0.3041    0.0671      1.3226   0.5459   2.6905</span></span>
<span><span class="co"># CON    42      5.6583     2.4748    0.5037     10.3691  -0.4442   2.3251</span></span>
<span><span class="co"># WRT    42     14.9155      5.264    4.0003     26.7699  -0.5478   2.7294</span></span>
<span><span class="co"># TRA    42      4.8193     2.4712     0.374     12.3887   0.9782   4.7857</span></span>
<span><span class="co"># FIRE   42      4.6501     3.4468    0.1505     12.4402   0.6052   2.5883</span></span>
<span><span class="co"># GOV    34     13.1263     7.2832    2.0086     29.1577   0.3858   2.1068</span></span>
<span><span class="co"># OTH    40      8.3977      6.266    1.3508     26.4036   1.4349   4.3185</span></span>
<span><span class="co"># SUM    42  36846.8741  89205.503  369.2353  485820.474   4.0761  19.3159</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># , , Within, EMP</span></span>
<span><span class="co"># </span></span>
<span><span class="co">#           N/T         Mean          SD          Min          Max     Skew     Kurt</span></span>
<span><span class="co"># AGR   52.9762      26.3768     11.5044      -5.3234     107.4891   1.6002  11.9683</span></span>
<span><span class="co"># MIN   52.7619       3.4006      0.7182      -1.4068        7.509  -0.1988  15.0343</span></span>
<span><span class="co"># MAN   52.7619       17.476      3.8861      -1.1061      40.3964   -0.082   7.3994</span></span>
<span><span class="co"># PU    52.7381       1.3896      0.1929       0.6346       2.5461   0.5731   7.8523</span></span>
<span><span class="co"># CON   52.7619       5.7633      1.5596       0.8964      12.9663   0.3077   4.1248</span></span>
<span><span class="co"># WRT   52.7619      15.7581        3.91       3.7356      29.7615   0.3339   3.3386</span></span>
<span><span class="co"># TRA   52.7619       6.3486      0.9623       2.3501      11.1064   0.2671   5.7162</span></span>
<span><span class="co"># FIRE  52.7619       5.8228      2.6567      -2.9836      15.9974   0.5486   4.0288</span></span>
<span><span class="co"># GOV   52.3529       13.263      3.5088      -2.1983       23.611  -0.5647   4.7286</span></span>
<span><span class="co"># OTH    52.725       7.3941      2.1999      -2.3286      17.4413   0.2929   6.4631</span></span>
<span><span class="co"># SUM   52.9762  21'566436.8  36327.1443  21'287906.3  21'844816.3   0.6649  34.2495</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># , , Overall, VA</span></span>
<span><span class="co"># </span></span>
<span><span class="co">#        N/T         Mean          SD       Min             Max     Skew      Kurt</span></span>
<span><span class="co"># AGR   2139      17.3082     15.5066    0.0318          95.222   1.3274    4.8827</span></span>
<span><span class="co"># MIN   2139       5.8514      9.0975         0         59.0602   2.7193   10.9184</span></span>
<span><span class="co"># MAN   2139      20.0651      8.0033     0.979         41.6281  -0.0348    2.6831</span></span>
<span><span class="co"># PU    2139       2.2298      1.1088         0          9.1888   0.8899    6.2385</span></span>
<span><span class="co"># CON   2139       5.8721      2.5113    0.5951         25.8575   1.5002    8.9578</span></span>
<span><span class="co"># WRT   2139       16.631      5.1374    4.5187         39.7594   0.3455    3.2655</span></span>
<span><span class="co"># TRA   2139       7.9329      3.1057    0.7957         25.9625   1.0122    5.7137</span></span>
<span><span class="co"># FIRE  2139       7.0377     12.7077  -151.065         39.1705  -6.2254   59.8739</span></span>
<span><span class="co"># GOV   1702       13.406      6.3521    0.7607         32.5107   0.4888    2.9043</span></span>
<span><span class="co"># OTH   2139       6.4046      5.8416    0.2327         31.4474   1.4978    4.2051</span></span>
<span><span class="co"># SUM   2139  43'961639.1  358'350627         0  8.06794210e+09  15.7682  289.4632</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># , , Between, VA</span></span>
<span><span class="co"># </span></span>
<span><span class="co">#       N/T         Mean          SD        Min             Max     Skew     Kurt</span></span>
<span><span class="co"># AGR    43      17.3082     13.1901     0.6058         63.8364   1.1328   4.7111</span></span>
<span><span class="co"># MIN    43       5.8514      7.5705     0.0475         27.9214   1.7113    4.807</span></span>
<span><span class="co"># MAN    43      20.0651      6.6423     4.1869         32.1138  -0.3591    2.619</span></span>
<span><span class="co"># PU     43       2.2298      0.7457     0.4462           4.307   0.6196   3.8724</span></span>
<span><span class="co"># CON    43       5.8721      1.8455     2.9405         12.9279   1.3285    6.505</span></span>
<span><span class="co"># WRT    43       16.631      4.3779     8.4188         26.3876    0.292   2.4553</span></span>
<span><span class="co"># TRA    43       7.9329      2.7222      2.037         14.8892   0.6362   3.6686</span></span>
<span><span class="co"># FIRE   43       7.0377      9.0284   -35.6144         23.8658   -2.674  15.0975</span></span>
<span><span class="co"># GOV    35       13.406       5.875     1.9757         27.7714   0.5198   3.0416</span></span>
<span><span class="co"># OTH    43       6.4046      5.6137     1.1184         19.5299   1.3274   3.2043</span></span>
<span><span class="co"># SUM    43  43'961639.1  185'785836  5077.7231  1.23317892e+09   5.8098  36.9778</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># , , Within, VA</span></span>
<span><span class="co"># </span></span>
<span><span class="co">#           N/T         Mean          SD              Min             Max     Skew      Kurt</span></span>
<span><span class="co"># AGR   49.7442      26.3768      8.1532            5.245         94.3499    1.234    9.5269</span></span>
<span><span class="co"># MIN   49.7442       3.4006      5.0451          -20.051         35.7053    0.341    13.102</span></span>
<span><span class="co"># MAN   49.7442       17.476      4.4647           1.1188         36.3501  -0.1928    3.9339</span></span>
<span><span class="co"># PU    49.7442       1.3896      0.8206          -1.0904          6.2714   0.5258    5.3462</span></span>
<span><span class="co"># CON   49.7442       5.7633      1.7031          -0.3464         18.6929   0.7493    6.3751</span></span>
<span><span class="co"># WRT   49.7442      15.7581      2.6884           4.6513         32.6691   0.2338    4.4953</span></span>
<span><span class="co"># TRA   49.7442       6.3486      1.4951           0.9187         18.5977   0.6995   10.1129</span></span>
<span><span class="co"># FIRE  49.7442       5.8228      8.9428        -109.6278         54.1241  -2.7728   54.5971</span></span>
<span><span class="co"># GOV   48.6286       13.263      2.4153           5.1249         22.8497   0.1663    3.3083</span></span>
<span><span class="co"># OTH   49.7442       7.3941      1.6159          -0.9151         19.3116   0.7301    9.6613</span></span>
<span><span class="co"># SUM   49.7442  21'566436.8  306'429102  -1.21124805e+09  6.85632962e+09  12.6639  253.1145</span></span></code></pre></div>
<p>The statistics show that the dataset is very consistent: Employment
data cover 42 countries and 53 time-periods in almost all sectors.
Agriculture is the largest sector in terms of employment, amounting to a
35% share of employment across countries and time, with a standard
deviation (SD) of around 27%. The between-country SD in agricultural
employment share is 24% and the within SD is 12%, indicating that
processes of structural change are very gradual and most of the
variation in structure is between countries. The next largest sectors
after agriculture are manufacturing, wholesale and retail trade and
government, each claiming an approx. 15% share of the economy. In these
sectors the between-country SD is also about twice as large as the
within-country SD.</p>
<p>In terms of value added, the data covers 43 countries in 50
time-periods. Agriculture, manufacturing, wholesale and retail trade and
government are also the largest sectors in terms of VA, but with a
diminished agricultural share (around 17%) and a greater share for
manufacturing (around 20%). The variation between countries is again
greater than the variation within countries, but it seems that at least
in terms of agricultural VA share there is also a considerable
within-country SD of 8%. This is also true for the finance and real
estate sector with a within SD of 9%, suggesting (using a bit of common
sense) that a diminishing VA share in agriculture and increased VA share
in finance and real estate was a pattern characterizing most of the
countries in this sample.</p>
<p>As a final step we consider a plot function which can be used to plot
the structural transformation of any supported country. Below for
Botswana:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-datatable.com" class="external-link">data.table</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://magrittr.tidyverse.org" class="external-link">magrittr</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">plotGGDC</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">ctry</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Select and subset</span></span>
<span>  <span class="fu"><a href="../reference/fsubset.html">fsubset</a></span><span class="op">(</span><span class="va">GGDC10S</span>, <span class="va">Country</span> <span class="op">==</span> <span class="va">ctry</span>, <span class="va">Variable</span>, <span class="va">Year</span>, <span class="va">AGR</span><span class="op">:</span><span class="va">SUM</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="co"># Convert to shares and replace negative values with NA</span></span>
<span>  <span class="fu"><a href="../reference/ftransform.html">ftransform</a></span><span class="op">(</span><span class="fu"><a href="../reference/select_replace_vars.html">fselect</a></span><span class="op">(</span><span class="va">.</span>, <span class="va">AGR</span><span class="op">:</span><span class="va">OTH</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>             <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">`*`</span>, <span class="fl">1</span> <span class="op">/</span> <span class="va">SUM</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>             <span class="fu"><a href="../reference/recode-replace.html">replace_outliers</a></span><span class="op">(</span><span class="fl">0</span>, <span class="cn">NA</span>, <span class="st">"min"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="co"># Remove totals column and make proper variable labels</span></span>
<span>  <span class="fu"><a href="../reference/ftransform.html">ftransform</a></span><span class="op">(</span>Variable <span class="op">=</span> <span class="fu"><a href="../reference/recode-replace.html">recode_char</a></span><span class="op">(</span><span class="va">Variable</span>,</span>
<span>                                    VA <span class="op">=</span> <span class="st">"Value Added Share"</span>,</span>
<span>                                    EMP <span class="op">=</span> <span class="st">"Employment Share"</span><span class="op">)</span>,</span>
<span>             SUM <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="co"># Fast conversion to data.table</span></span>
<span>  <span class="va">qDT</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="co"># data.table's melt function</span></span>
<span>  <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/melt.data.table.html" class="external-link">melt</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, variable.name <span class="op">=</span> <span class="st">"Sector"</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="co"># ggplot with some scales provided by the 'scales' package</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">Year</span>, y <span class="op">=</span> <span class="va">value</span>, fill <span class="op">=</span> <span class="va">Sector</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_area</a></span><span class="op">(</span>position <span class="op">=</span> <span class="st">"fill"</span>, alpha <span class="op">=</span> <span class="fl">0.9</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="cn">NULL</span>, y <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_linedraw</a></span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">14L</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span> <span class="op">~</span> <span class="va">Variable</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_fill_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">sub</a></span><span class="op">(</span><span class="st">"#00FF66"</span>, <span class="st">"#00CC66"</span>, <span class="fu"><a href="https://rdrr.io/r/grDevices/palettes.html" class="external-link">rainbow</a></span><span class="op">(</span><span class="fl">10L</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_x_continuous</a></span><span class="op">(</span>breaks <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/pretty_breaks.html" class="external-link">pretty_breaks</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">7L</span><span class="op">)</span>, expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span>breaks <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/pretty_breaks.html" class="external-link">pretty_breaks</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">10L</span><span class="op">)</span>, expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span>,</span>
<span>                       labels <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="va"><a href="https://scales.r-lib.org/reference/percent_format.html" class="external-link">percent</a></span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">315</span>, hjust <span class="op">=</span> <span class="fl">0</span>, margin <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">margin</a></span><span class="op">(</span>t <span class="op">=</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span>,</span>
<span>          strip.background <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_rect</a></span><span class="op">(</span>colour <span class="op">=</span> <span class="st">"grey20"</span>, fill <span class="op">=</span> <span class="st">"grey20"</span><span class="op">)</span>,</span>
<span>          strip.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>face <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Plotting the structural transformation of Botswana</span></span>
<span><span class="fu">plotGGDC</span><span class="op">(</span><span class="st">"BWA"</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="figure/scplot_BWA-1.png" alt="plot of chunk scplot_BWA" width="100%"><p class="caption">
plot of chunk scplot_BWA
</p>
</div>
</div>
</div>
<div class="section level2">
<h2 id="fast-data-manipulation">2. Fast Data Manipulation<a class="anchor" aria-label="anchor" href="#fast-data-manipulation"></a>
</h2>
<p>A lot of R code is not concerned with statistical computations but
with preliminary data wrangling.
<!-- Very frequent operations include selecting, replacing, subsetting, ordering, adding/computing, and deleting data / columns.-->
For various reasons R development has focused on data frames as the main
medium to contain data, although matrices / arrays provide significantly
faster methods for common manipulations.</p>
<p>A first essential step towards optimizing R code is thus to speed up
very frequent manipulations on data frames. <em>collapse</em> introduces
a set of highly optimized functions to efficiently manipulate (mostly)
data frames. Most manipulations can be conducted in non-standard
evaluation or standard evaluation (utilizing different functions), and
all functions preserve the data structure (i.e. they can be used with
data.table, tbl_df, grouped_df, pdata.frame etc.).</p>
<!-- Some of these functions (`fselect`, `roworder`, `franame`, `fsubset`, `ss` and `ftransform`) represent improved versions of existing ones (`dplyr::select`, `dplyr::arrange`, `dplyr::rename`, `base::subset`, `base::[.data.frame` and `base::transform`) while others are added in. Also some functions (`fselect`, `roworder`, `frename`, `colorder`, `fsubset`, `ftransform`, `settransform`, `fcompute`) use non-standard evaluation, whereas others (`get_vars`, `roworderv`, `colorderv`, `ss`, `add_vars`, `num_vars`, etc.) offer some of the same functionality with standard evaluation and are thus more programmer friendly. Here we run through all of them briefly: -->
<div class="section level3">
<h3 id="selecting-and-replacing-columns">2.1 Selecting and Replacing Columns<a class="anchor" aria-label="anchor" href="#selecting-and-replacing-columns"></a>
</h3>
<p><code>fselect</code> is an analogue to <code><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">dplyr::select</a></code>,
but executes about 100x faster. It can be used to select variables using
expressions involving variable names:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://magrittr.tidyverse.org" class="external-link">magrittr</a></span><span class="op">)</span> <span class="co"># Pipe operators</span></span>
<span><span class="fu"><a href="../reference/select_replace_vars.html">fselect</a></span><span class="op">(</span><span class="va">wlddev</span>, <span class="va">country</span>, <span class="va">year</span>, <span class="va">PCGDP</span><span class="op">:</span><span class="va">ODA</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">#       country year PCGDP LIFEEX GINI       ODA</span></span>
<span><span class="co"># 1 Afghanistan 1960    NA 32.446   NA 116769997</span></span>
<span><span class="co"># 2 Afghanistan 1961    NA 32.962   NA 232080002</span></span>
<span></span>
<span><span class="fu"><a href="../reference/select_replace_vars.html">fselect</a></span><span class="op">(</span><span class="va">wlddev</span>, <span class="op">-</span><span class="va">country</span>, <span class="op">-</span><span class="va">year</span>, <span class="op">-</span><span class="op">(</span><span class="va">PCGDP</span><span class="op">:</span><span class="va">ODA</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">#   iso3c       date decade     region     income  OECD     POP</span></span>
<span><span class="co"># 1   AFG 1961-01-01   1960 South Asia Low income FALSE 8996973</span></span>
<span><span class="co"># 2   AFG 1962-01-01   1960 South Asia Low income FALSE 9169410</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/joshuaulrich/microbenchmark/" class="external-link">microbenchmark</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html" class="external-link">microbenchmark</a></span><span class="op">(</span>fselect <span class="op">=</span> <span class="fu">collapse</span><span class="fu">::</span><span class="fu"><a href="../reference/select_replace_vars.html">fselect</a></span><span class="op">(</span><span class="va">wlddev</span>, <span class="va">country</span>, <span class="va">year</span>, <span class="va">PCGDP</span><span class="op">:</span><span class="va">ODA</span><span class="op">)</span>,</span>
<span>               select <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">wlddev</span>, <span class="va">country</span>, <span class="va">year</span>, <span class="va">PCGDP</span><span class="op">:</span><span class="va">ODA</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># Unit: microseconds</span></span>
<span><span class="co">#     expr     min       lq      mean   median       uq      max neval</span></span>
<span><span class="co">#  fselect   2.911   3.4645   4.76297   4.3665   5.3710   20.459   100</span></span>
<span><span class="co">#   select 382.284 393.0055 442.70734 410.3075 441.4265 2951.262   100</span></span></code></pre></div>
<p>in contrast to <code><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">dplyr::select</a></code>, <code>fselect</code> has a
replacement method</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Computing the log of columns</span></span>
<span><span class="fu"><a href="../reference/select_replace_vars.html">fselect</a></span><span class="op">(</span><span class="va">wlddev</span>, <span class="va">PCGDP</span><span class="op">:</span><span class="va">POP</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="../reference/select_replace_vars.html">fselect</a></span><span class="op">(</span><span class="va">wlddev</span>, <span class="va">PCGDP</span><span class="op">:</span><span class="va">POP</span><span class="op">)</span>, <span class="va">log</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">wlddev</span>, <span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">#       country iso3c       date year decade     region     income  OECD PCGDP   LIFEEX GINI      ODA</span></span>
<span><span class="co"># 1 Afghanistan   AFG 1961-01-01 1960   1960 South Asia Low income FALSE    NA 3.479577   NA 18.57572</span></span>
<span><span class="co"># 2 Afghanistan   AFG 1962-01-01 1961   1960 South Asia Low income FALSE    NA 3.495355   NA 19.26259</span></span>
<span><span class="co">#        POP</span></span>
<span><span class="co"># 1 16.01240</span></span>
<span><span class="co"># 2 16.03138</span></span>
<span><span class="co"># Efficient deleting</span></span>
<span><span class="fu"><a href="../reference/select_replace_vars.html">fselect</a></span><span class="op">(</span><span class="va">wlddev</span>, <span class="va">country</span>, <span class="va">year</span>, <span class="va">PCGDP</span><span class="op">:</span><span class="va">POP</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">wlddev</span>, <span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">#   iso3c       date decade     region     income  OECD</span></span>
<span><span class="co"># 1   AFG 1961-01-01   1960 South Asia Low income FALSE</span></span>
<span><span class="co"># 2   AFG 1962-01-01   1960 South Asia Low income FALSE</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/rm.html" class="external-link">rm</a></span><span class="op">(</span><span class="va">wlddev</span><span class="op">)</span></span></code></pre></div>
<p>and it can also return information about the selected columns other
than the data itself.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/select_replace_vars.html">fselect</a></span><span class="op">(</span><span class="va">wlddev</span>, <span class="va">PCGDP</span><span class="op">:</span><span class="va">POP</span>, return <span class="op">=</span> <span class="st">"names"</span><span class="op">)</span></span>
<span><span class="co"># [1] "PCGDP"  "LIFEEX" "GINI"   "ODA"    "POP"</span></span>
<span><span class="fu"><a href="../reference/select_replace_vars.html">fselect</a></span><span class="op">(</span><span class="va">wlddev</span>, <span class="va">PCGDP</span><span class="op">:</span><span class="va">POP</span>, return <span class="op">=</span> <span class="st">"indices"</span><span class="op">)</span></span>
<span><span class="co"># [1]  9 10 11 12 13</span></span>
<span><span class="fu"><a href="../reference/select_replace_vars.html">fselect</a></span><span class="op">(</span><span class="va">wlddev</span>, <span class="va">PCGDP</span><span class="op">:</span><span class="va">POP</span>, return <span class="op">=</span> <span class="st">"named_indices"</span><span class="op">)</span></span>
<span><span class="co">#  PCGDP LIFEEX   GINI    ODA    POP </span></span>
<span><span class="co">#      9     10     11     12     13</span></span>
<span><span class="fu"><a href="../reference/select_replace_vars.html">fselect</a></span><span class="op">(</span><span class="va">wlddev</span>, <span class="va">PCGDP</span><span class="op">:</span><span class="va">POP</span>, return <span class="op">=</span> <span class="st">"logical"</span><span class="op">)</span></span>
<span><span class="co">#  [1] FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE  TRUE  TRUE  TRUE  TRUE  TRUE</span></span>
<span><span class="fu"><a href="../reference/select_replace_vars.html">fselect</a></span><span class="op">(</span><span class="va">wlddev</span>, <span class="va">PCGDP</span><span class="op">:</span><span class="va">POP</span>, return <span class="op">=</span> <span class="st">"named_logical"</span><span class="op">)</span></span>
<span><span class="co"># country   iso3c    date    year  decade  region  income    OECD   PCGDP  LIFEEX    GINI     ODA </span></span>
<span><span class="co">#   FALSE   FALSE   FALSE   FALSE   FALSE   FALSE   FALSE   FALSE    TRUE    TRUE    TRUE    TRUE </span></span>
<span><span class="co">#     POP </span></span>
<span><span class="co">#    TRUE</span></span></code></pre></div>
<!-- `fselect` is a lot faster than `dplyr::select` and maintains this performance on large data.  -->
<p>While <code>fselect</code> is faster than <code><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">dplyr::select</a></code>,
it is also simpler and does not offer special methods for grouped
tibbles (e.g. where grouping columns are always selected) and some other
<em>dplyr</em>-specific features of <code>select</code>. We will see
that this is not a problem at all when working with statistical
functions in <em>collapse</em> that have a grouped_df method, but users
should be careful replacing <code><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">dplyr::select</a></code> with
<code>fselect</code> in <em>dplyr</em> scripts. From <em>collapse</em>
1.6.0, <code>fselect</code> has explicit support for <em>sf</em> data
frames.</p>
<!-- For some reason this does not work in build !! -->
<!-- ```{r, error=FALSE, warning=FALSE} -->
<!-- library(microbenchmark) -->
<!-- library(dplyr) -->
<!-- identical(select(wlddev, country, year, PCGDP:ODA), fselect(wlddev, country, year, PCGDP:ODA)) -->
<!-- microbenchmark(select(wlddev, country, year, PCGDP:ODA), fselect(wlddev, country, year, PCGDP:ODA)) -->
<!-- ``` -->
<p>The standard-evaluation analogue to <code>fselect</code> is the
function <code>get_vars</code>. <code>get_vars</code> can be used to
select variables using names, indices, logical vectors, functions or
regular expressions evaluated against column names:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/select_replace_vars.html">get_vars</a></span><span class="op">(</span><span class="va">wlddev</span>, <span class="fl">9</span><span class="op">:</span><span class="fl">13</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="co">#   PCGDP LIFEEX GINI       ODA     POP</span></span>
<span><span class="co"># 1    NA 32.446   NA 116769997 8996973</span></span>
<span><span class="fu"><a href="../reference/select_replace_vars.html">get_vars</a></span><span class="op">(</span><span class="va">wlddev</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"PCGDP"</span>,<span class="st">"LIFEEX"</span>,<span class="st">"GINI"</span>,<span class="st">"ODA"</span>,<span class="st">"POP"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="co">#   PCGDP LIFEEX GINI       ODA     POP</span></span>
<span><span class="co"># 1    NA 32.446   NA 116769997 8996973</span></span>
<span><span class="fu"><a href="../reference/select_replace_vars.html">get_vars</a></span><span class="op">(</span><span class="va">wlddev</span>, <span class="st">"[[:upper:]]"</span>, regex <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="co">#    OECD PCGDP LIFEEX GINI       ODA     POP</span></span>
<span><span class="co"># 1 FALSE    NA 32.446   NA 116769997 8996973</span></span>
<span><span class="fu"><a href="../reference/select_replace_vars.html">get_vars</a></span><span class="op">(</span><span class="va">wlddev</span>, <span class="st">"PC|LI|GI|OD|PO"</span>, regex <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="co">#   PCGDP LIFEEX GINI       ODA     POP</span></span>
<span><span class="co"># 1    NA 32.446   NA 116769997 8996973</span></span>
<span><span class="co"># Same as above, vectors of regular expressions are sequentially passed to grep</span></span>
<span><span class="fu"><a href="../reference/select_replace_vars.html">get_vars</a></span><span class="op">(</span><span class="va">wlddev</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"PC"</span>,<span class="st">"LI"</span>,<span class="st">"GI"</span>,<span class="st">"OD"</span>,<span class="st">"PO"</span><span class="op">)</span>, regex <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="co">#   PCGDP LIFEEX GINI       ODA     POP</span></span>
<span><span class="co"># 1    NA 32.446   NA 116769997 8996973</span></span>
<span><span class="fu"><a href="../reference/select_replace_vars.html">get_vars</a></span><span class="op">(</span><span class="va">wlddev</span>, <span class="va">is.numeric</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="co">#   year decade PCGDP LIFEEX GINI       ODA     POP</span></span>
<span><span class="co"># 1 1960   1960    NA 32.446   NA 116769997 8996973</span></span>
<span></span>
<span><span class="co"># Returning other information</span></span>
<span><span class="fu"><a href="../reference/select_replace_vars.html">get_vars</a></span><span class="op">(</span><span class="va">wlddev</span>, <span class="va">is.numeric</span>, return <span class="op">=</span> <span class="st">"names"</span><span class="op">)</span></span>
<span><span class="co"># [1] "year"   "decade" "PCGDP"  "LIFEEX" "GINI"   "ODA"    "POP"</span></span>
<span><span class="fu"><a href="../reference/select_replace_vars.html">get_vars</a></span><span class="op">(</span><span class="va">wlddev</span>, <span class="st">"[[:upper:]]"</span>, regex <span class="op">=</span> <span class="cn">TRUE</span>, return <span class="op">=</span> <span class="st">"named_indices"</span><span class="op">)</span></span>
<span><span class="co">#   OECD  PCGDP LIFEEX   GINI    ODA    POP </span></span>
<span><span class="co">#      8      9     10     11     12     13</span></span></code></pre></div>
<p>Replacing operations are conducted analogous:</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/select_replace_vars.html">get_vars</a></span><span class="op">(</span><span class="va">wlddev</span>, <span class="fl">9</span><span class="op">:</span><span class="fl">13</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="../reference/select_replace_vars.html">get_vars</a></span><span class="op">(</span><span class="va">wlddev</span>, <span class="fl">9</span><span class="op">:</span><span class="fl">13</span><span class="op">)</span>, <span class="va">log</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/select_replace_vars.html">get_vars</a></span><span class="op">(</span><span class="va">wlddev</span>, <span class="fl">9</span><span class="op">:</span><span class="fl">13</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">wlddev</span>, <span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">#       country iso3c       date year decade     region     income  OECD</span></span>
<span><span class="co"># 1 Afghanistan   AFG 1961-01-01 1960   1960 South Asia Low income FALSE</span></span>
<span><span class="co"># 2 Afghanistan   AFG 1962-01-01 1961   1960 South Asia Low income FALSE</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/rm.html" class="external-link">rm</a></span><span class="op">(</span><span class="va">wlddev</span><span class="op">)</span></span></code></pre></div>
<p><code>get_vars</code> is about 2x faster than
<code>[.data.frame</code>, and <code>get_vars&lt;-</code> is about 6-8x
faster than <code>[&lt;-.data.frame</code>.</p>
<!-- ```{r} -->
<!-- series <- wlddev[9:12] -->
<!-- microbenchmark(get_vars(wlddev, 9:12), wlddev[9:12]) -->
<!-- microbenchmark(get_vars(wlddev, 9:12) <- series, wlddev[9:12] <- series) -->
<!-- microbenchmark(get_vars(wlddev, 9:12) <- get_vars(wlddev, 9:12), wlddev[9:12] <- wlddev[9:12]) -->
<!-- ``` -->
<p>In addition to <code>get_vars</code>, <em>collapse</em> offers a set
of functions to efficiently select and replace data by data type:
<code>num_vars</code>, <code>cat_vars</code> (for categorical =
non-numeric columns), <code>char_vars</code>, <code>fact_vars</code>,
<code>logi_vars</code> and <code>date_vars</code> (for date and
date-time columns).</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fu"><a href="../reference/select_replace_vars.html">num_vars</a></span><span class="op">(</span><span class="va">wlddev</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">#   year decade PCGDP LIFEEX GINI       ODA     POP</span></span>
<span><span class="co"># 1 1960   1960    NA 32.446   NA 116769997 8996973</span></span>
<span><span class="co"># 2 1961   1960    NA 32.962   NA 232080002 9169410</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fu"><a href="../reference/select_replace_vars.html">cat_vars</a></span><span class="op">(</span><span class="va">wlddev</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">#       country iso3c       date     region     income  OECD</span></span>
<span><span class="co"># 1 Afghanistan   AFG 1961-01-01 South Asia Low income FALSE</span></span>
<span><span class="co"># 2 Afghanistan   AFG 1962-01-01 South Asia Low income FALSE</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fu"><a href="../reference/select_replace_vars.html">fact_vars</a></span><span class="op">(</span><span class="va">wlddev</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">#   iso3c     region     income</span></span>
<span><span class="co"># 1   AFG South Asia Low income</span></span>
<span><span class="co"># 2   AFG South Asia Low income</span></span>
<span></span>
<span><span class="co"># Replacing</span></span>
<span><span class="fu"><a href="../reference/select_replace_vars.html">fact_vars</a></span><span class="op">(</span><span class="va">wlddev</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/select_replace_vars.html">fact_vars</a></span><span class="op">(</span><span class="va">wlddev</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="subsetting">2.2 Subsetting<a class="anchor" aria-label="anchor" href="#subsetting"></a>
</h3>
<p><code>fsubset</code> is an enhanced version of
<code><a href="https://rdrr.io/r/base/subset.html" class="external-link">base::subset</a></code> using C functions from the <em>data.table</em>
package for fast and subsetting operations. In contrast to
<code><a href="https://rdrr.io/r/base/subset.html" class="external-link">base::subset</a></code>, <code>fsubset</code> allows multiple
comma-separated select arguments after the subset argument, and it also
preserves all attributes of subsetted columns:</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Returning only value-added data after 1990</span></span>
<span><span class="fu"><a href="../reference/fsubset.html">fsubset</a></span><span class="op">(</span><span class="va">GGDC10S</span>, <span class="va">Variable</span> <span class="op">==</span> <span class="st">"VA"</span> <span class="op">&amp;</span> <span class="va">Year</span> <span class="op">&gt;</span> <span class="fl">1990</span>, <span class="va">Country</span>, <span class="va">Year</span>, <span class="va">AGR</span><span class="op">:</span><span class="va">GOV</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">#   Country Year      AGR      MIN      MAN       PU      CON      WRT      TRA     FIRE      GOV</span></span>
<span><span class="co"># 1     BWA 1991 303.1157 2646.950 472.6488 160.6079 580.0876 806.7509 232.7884 432.6965 1073.263</span></span>
<span><span class="co"># 2     BWA 1992 333.4364 2690.939 537.4274 178.4532 678.7320 725.2577 285.1403 517.2141 1234.012</span></span>
<span><span class="co"># Same thing</span></span>
<span><span class="fu"><a href="../reference/fsubset.html">fsubset</a></span><span class="op">(</span><span class="va">GGDC10S</span>, <span class="va">Variable</span> <span class="op">==</span> <span class="st">"VA"</span> <span class="op">&amp;</span> <span class="va">Year</span> <span class="op">&gt;</span> <span class="fl">1990</span>, <span class="op">-</span><span class="op">(</span><span class="va">Regioncode</span><span class="op">:</span><span class="va">Variable</span><span class="op">)</span>, <span class="op">-</span><span class="op">(</span><span class="va">OTH</span><span class="op">:</span><span class="va">SUM</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">#   Country Year      AGR      MIN      MAN       PU      CON      WRT      TRA     FIRE      GOV</span></span>
<span><span class="co"># 1     BWA 1991 303.1157 2646.950 472.6488 160.6079 580.0876 806.7509 232.7884 432.6965 1073.263</span></span>
<span><span class="co"># 2     BWA 1992 333.4364 2690.939 537.4274 178.4532 678.7320 725.2577 285.1403 517.2141 1234.012</span></span></code></pre></div>
<p>It is also possible to use standard evaluation with
<code>fsubset</code>, but for these purposes the function
<code>ss</code> exists as a fast and more secure alternative to
<code>[.data.frame</code>:</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/fsubset.html">ss</a></span><span class="op">(</span><span class="va">GGDC10S</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, <span class="fl">6</span><span class="op">:</span><span class="fl">16</span><span class="op">)</span>  <span class="co"># or fsubset(GGDC10S, 1:2, 6:16), but not recommended.</span></span>
<span><span class="co">#   AGR MIN MAN PU CON WRT TRA FIRE GOV OTH SUM</span></span>
<span><span class="co"># 1  NA  NA  NA NA  NA  NA  NA   NA  NA  NA  NA</span></span>
<span><span class="co"># 2  NA  NA  NA NA  NA  NA  NA   NA  NA  NA  NA</span></span>
<span><span class="fu"><a href="../reference/fsubset.html">ss</a></span><span class="op">(</span><span class="va">GGDC10S</span>, <span class="op">-</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"AGR"</span>,<span class="st">"MIN"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">#   AGR MIN</span></span>
<span><span class="co"># 1  NA  NA</span></span>
<span><span class="co"># 2  NA  NA</span></span></code></pre></div>
<p>Thanks to the <em>data.table</em> C code and optimized R code,
<code>fsubset</code> is very fast.</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html" class="external-link">microbenchmark</a></span><span class="op">(</span>base <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">GGDC10S</span>, <span class="va">Variable</span> <span class="op">==</span> <span class="st">"VA"</span> <span class="op">&amp;</span> <span class="va">Year</span> <span class="op">&gt;</span> <span class="fl">1990</span>, <span class="va">AGR</span><span class="op">:</span><span class="va">SUM</span><span class="op">)</span>,</span>
<span>               collapse <span class="op">=</span> <span class="fu"><a href="../reference/fsubset.html">fsubset</a></span><span class="op">(</span><span class="va">GGDC10S</span>, <span class="va">Variable</span> <span class="op">==</span> <span class="st">"VA"</span> <span class="op">&amp;</span> <span class="va">Year</span> <span class="op">&gt;</span> <span class="fl">1990</span>, <span class="va">AGR</span><span class="op">:</span><span class="va">SUM</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># Unit: microseconds</span></span>
<span><span class="co">#      expr     min       lq      mean   median      uq      max neval</span></span>
<span><span class="co">#      base 150.839 156.5585 199.63105 160.3510 166.993 3778.191   100</span></span>
<span><span class="co">#  collapse  45.715  49.0975  51.55545  50.9015  52.357   82.861   100</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html" class="external-link">microbenchmark</a></span><span class="op">(</span><span class="va">GGDC10S</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">]</span>, <span class="fu"><a href="../reference/fsubset.html">ss</a></span><span class="op">(</span><span class="va">GGDC10S</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># Unit: microseconds</span></span>
<span><span class="co">#                     expr    min     lq     mean median     uq    max neval</span></span>
<span><span class="co">#      GGDC10S[1:10, 1:10] 36.367 36.982 38.14599 37.515 38.294 76.219   100</span></span>
<span><span class="co">#  ss(GGDC10S, 1:10, 1:10)  1.886  2.050  2.30666  2.214  2.419  8.405   100</span></span></code></pre></div>
<p>like <code><a href="https://rdrr.io/r/base/subset.html" class="external-link">base::subset</a></code>, <code>fsubset</code> is S3 generic
with methods for vectors, matrices and data frames. For certain classes
such as factors, <code>fsubset.default</code> also improves upon
<code>[</code>, but the largest improvements are with the data frame
method.</p>
</div>
<div class="section level3">
<h3 id="reordering-rows-and-columns">2.3 Reordering Rows and Columns<a class="anchor" aria-label="anchor" href="#reordering-rows-and-columns"></a>
</h3>
<p><code>roworder</code> is a fast analogue to
<code><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">dplyr::arrange</a></code>. The syntax is inspired by
<code><a href="https://rdatatable.gitlab.io/data.table/reference/setorder.html" class="external-link">data.table::setorder</a></code>, so that negative variable names
indicate descending sort.</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/roworder.html">roworder</a></span><span class="op">(</span><span class="va">GGDC10S</span>, <span class="op">-</span><span class="va">Variable</span>, <span class="va">Country</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="../reference/fsubset.html">ss</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">8</span><span class="op">)</span></span>
<span><span class="co">#   Country Regioncode        Region Variable Year          AGR MIN         MAN</span></span>
<span><span class="co"># 1     ARG        LAM Latin America       VA 1950 5.887857e-07   0 3.53443e-06</span></span>
<span><span class="co"># 2     ARG        LAM Latin America       VA 1951 9.165327e-07   0 4.77277e-06</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html" class="external-link">microbenchmark</a></span><span class="op">(</span>collapse <span class="op">=</span> <span class="fu">collapse</span><span class="fu">::</span><span class="fu"><a href="../reference/roworder.html">roworder</a></span><span class="op">(</span><span class="va">GGDC10S</span>, <span class="op">-</span><span class="va">Variable</span>, <span class="va">Country</span><span class="op">)</span>,</span>
<span>               dplyr <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">GGDC10S</span>, <span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html" class="external-link">desc</a></span><span class="op">(</span><span class="va">Variable</span><span class="op">)</span>, <span class="va">Country</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># Unit: microseconds</span></span>
<span><span class="co">#      expr      min       lq      mean   median        uq      max neval</span></span>
<span><span class="co">#  collapse  113.406  152.151  176.7567  165.722  183.0855  538.330   100</span></span>
<span><span class="co">#     dplyr 1240.168 1299.372 1618.5869 1384.755 1507.8160 8350.552   100</span></span></code></pre></div>
<p>In contrast to <code><a href="https://rdatatable.gitlab.io/data.table/reference/setorder.html" class="external-link">data.table::setorder</a></code>,
<code>roworder</code> creates a copy of the data frame (unless data are
already sorted). If this copy is not required,
<code><a href="https://rdatatable.gitlab.io/data.table/reference/setorder.html" class="external-link">data.table::setorder</a></code> is faster. The function
<code>roworderv</code> is a standard evaluation analogue to
<code>roworder</code>:</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Same as above</span></span>
<span><span class="fu"><a href="../reference/roworder.html">roworderv</a></span><span class="op">(</span><span class="va">GGDC10S</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Variable"</span>, <span class="st">"Country"</span><span class="op">)</span>, decreasing <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="cn">TRUE</span>, <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="../reference/fsubset.html">ss</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">8</span><span class="op">)</span></span>
<span><span class="co">#   Country Regioncode        Region Variable Year          AGR MIN         MAN</span></span>
<span><span class="co"># 1     ARG        LAM Latin America       VA 1950 5.887857e-07   0 3.53443e-06</span></span>
<span><span class="co"># 2     ARG        LAM Latin America       VA 1951 9.165327e-07   0 4.77277e-06</span></span></code></pre></div>
<p>With <code>roworderv</code>, it is also possible to move or exchange
rows in a data frame:</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># If length(neworder) &lt; fnrow(data), the default (pos = "front") brings rows to the front</span></span>
<span><span class="fu"><a href="../reference/roworder.html">roworderv</a></span><span class="op">(</span><span class="va">GGDC10S</span>, neworder <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">GGDC10S</span><span class="op">$</span><span class="va">Country</span> <span class="op">==</span> <span class="st">"GHA"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="../reference/fsubset.html">ss</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">8</span><span class="op">)</span></span>
<span><span class="co">#   Country Regioncode             Region Variable Year        AGR         MIN        MAN</span></span>
<span><span class="co"># 1     GHA        SSA Sub-saharan Africa       VA 1960 0.03576160 0.005103683 0.01744687</span></span>
<span><span class="co"># 2     GHA        SSA Sub-saharan Africa       VA 1961 0.03823049 0.005456030 0.01865136</span></span>
<span></span>
<span><span class="co"># pos = "end" brings rows to the end</span></span>
<span><span class="fu"><a href="../reference/roworder.html">roworderv</a></span><span class="op">(</span><span class="va">GGDC10S</span>, neworder <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">GGDC10S</span><span class="op">$</span><span class="va">Country</span> <span class="op">==</span> <span class="st">"BWA"</span><span class="op">)</span>, pos <span class="op">=</span> <span class="st">"end"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="../reference/fsubset.html">ss</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">8</span><span class="op">)</span></span>
<span><span class="co">#   Country Regioncode             Region Variable Year      AGR      MIN     MAN</span></span>
<span><span class="co"># 1     ETH        SSA Sub-saharan Africa       VA 1960       NA       NA      NA</span></span>
<span><span class="co"># 2     ETH        SSA Sub-saharan Africa       VA 1961 4495.614 11.86979 109.616</span></span>
<span></span>
<span><span class="co"># pos = "exchange" arranges selected rows in the order they are passed, without affecting other rows</span></span>
<span><span class="fu"><a href="../reference/roworder.html">roworderv</a></span><span class="op">(</span><span class="va">GGDC10S</span>, neworder <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">with</a></span><span class="op">(</span><span class="va">GGDC10S</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">Country</span> <span class="op">==</span> <span class="st">"GHA"</span><span class="op">)</span>,</span>
<span>                                              <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">Country</span> <span class="op">==</span> <span class="st">"BWA"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>, pos <span class="op">=</span> <span class="st">"exchange"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="../reference/fsubset.html">ss</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">8</span><span class="op">)</span></span>
<span><span class="co">#   Country Regioncode             Region Variable Year        AGR         MIN        MAN</span></span>
<span><span class="co"># 1     GHA        SSA Sub-saharan Africa       VA 1960 0.03576160 0.005103683 0.01744687</span></span>
<span><span class="co"># 2     GHA        SSA Sub-saharan Africa       VA 1961 0.03823049 0.005456030 0.01865136</span></span></code></pre></div>
<p>Similarly, the pair <code>colorder</code> / <code>colorderv</code>
facilitates efficient reordering of columns in a data frame. These
functions not require a deep copy of the data and are very fast. To
reorder columns by reference, see also
<code><a href="https://rdatatable.gitlab.io/data.table/reference/setcolorder.html" class="external-link">data.table::setcolorder</a></code>.</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># The default is again pos = "front" which brings selected columns to the front / left</span></span>
<span><span class="fu"><a href="../reference/colorder.html">colorder</a></span><span class="op">(</span><span class="va">GGDC10S</span>, <span class="va">Variable</span>, <span class="va">Country</span>, <span class="va">Year</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">#   Variable Country Year Regioncode             Region AGR MIN MAN PU CON WRT TRA FIRE GOV OTH SUM</span></span>
<span><span class="co"># 1       VA     BWA 1960        SSA Sub-saharan Africa  NA  NA  NA NA  NA  NA  NA   NA  NA  NA  NA</span></span>
<span><span class="co"># 2       VA     BWA 1961        SSA Sub-saharan Africa  NA  NA  NA NA  NA  NA  NA   NA  NA  NA  NA</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="transforming-and-computing-new-columns">2.4 Transforming and Computing New Columns<a class="anchor" aria-label="anchor" href="#transforming-and-computing-new-columns"></a>
</h3>
<p><code>ftransform</code> is an improved version of
<code><a href="https://rdrr.io/r/base/transform.html" class="external-link">base::transform</a></code> for data frames and lists.
<code>ftransform</code> can be used to compute new columns or modify and
delete existing columns, and always returns the entire data frame.</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/ftransform.html">ftransform</a></span><span class="op">(</span><span class="va">GGDC10S</span>, AGR_perc <span class="op">=</span> <span class="va">AGR</span> <span class="op">/</span> <span class="va">SUM</span> <span class="op">*</span> <span class="fl">100</span>, <span class="co"># Computing Agricultural percentage</span></span>
<span>                    Year <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="va">Year</span><span class="op">)</span>,    <span class="co"># Coercing Year to integer</span></span>
<span>                    AGR <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">tail</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span>     <span class="co"># Deleting column AGR</span></span>
<span><span class="co">#      Country Regioncode                       Region Variable Year      MIN      MAN       PU</span></span>
<span><span class="co"># 5026     EGY       MENA Middle East and North Africa      EMP 2011 27.56394 2373.814 317.9979</span></span>
<span><span class="co"># 5027     EGY       MENA Middle East and North Africa      EMP 2012 24.78083 2348.434 324.9332</span></span>
<span><span class="co">#           CON      WRT      TRA     FIRE      GOV OTH      SUM AGR_perc</span></span>
<span><span class="co"># 5026 2795.264 3020.236 2048.335 814.7403 5635.522  NA 22219.39 23.33961</span></span>
<span><span class="co"># 5027 2931.196 3109.522 2065.004 832.4770 5735.623  NA 22532.56 22.90281</span></span>
<span></span>
<span><span class="co"># Computing scalar results replicates them</span></span>
<span><span class="fu"><a href="../reference/ftransform.html">ftransform</a></span><span class="op">(</span><span class="va">GGDC10S</span>, MIN_mean <span class="op">=</span> <span class="fu"><a href="../reference/fmean.html">fmean</a></span><span class="op">(</span><span class="va">MIN</span><span class="op">)</span>, Intercept <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">tail</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">#      Country Regioncode                       Region Variable Year      AGR      MIN      MAN</span></span>
<span><span class="co"># 5026     EGY       MENA Middle East and North Africa      EMP 2011 5185.919 27.56394 2373.814</span></span>
<span><span class="co"># 5027     EGY       MENA Middle East and North Africa      EMP 2012 5160.590 24.78083 2348.434</span></span>
<span><span class="co">#            PU      CON      WRT      TRA     FIRE      GOV OTH      SUM MIN_mean Intercept</span></span>
<span><span class="co"># 5026 317.9979 2795.264 3020.236 2048.335 814.7403 5635.522  NA 22219.39  1867909         1</span></span>
<span><span class="co"># 5027 324.9332 2931.196 3109.522 2065.004 832.4770 5735.623  NA 22532.56  1867909         1</span></span></code></pre></div>
<p>The modification <code>ftransformv</code> exists to transform
specific columns using a function:</p>
<!--
# Same thing using fselect to get the right indices
# GGDC10S %>% ftransformv(fselect(., AGR:SUM, return = "indices"), `*`, 100/SUM) %>% tail(2)
-->
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Apply the log to columns 6-16</span></span>
<span><span class="va">GGDC10S</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="../reference/ftransform.html">ftransformv</a></span><span class="op">(</span><span class="fl">6</span><span class="op">:</span><span class="fl">16</span>, <span class="va">log</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">tail</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">#      Country Regioncode                       Region Variable Year      AGR      MIN      MAN</span></span>
<span><span class="co"># 5026     EGY       MENA Middle East and North Africa      EMP 2011 8.553702 3.316508 7.772253</span></span>
<span><span class="co"># 5027     EGY       MENA Middle East and North Africa      EMP 2012 8.548806 3.210070 7.761504</span></span>
<span><span class="co">#            PU      CON      WRT      TRA     FIRE      GOV OTH      SUM</span></span>
<span><span class="co"># 5026 5.762045 7.935682 8.013090 7.624782 6.702869 8.636845  NA 10.00872</span></span>
<span><span class="co"># 5027 5.783620 7.983166 8.042224 7.632888 6.724406 8.654452  NA 10.02272</span></span>
<span></span>
<span><span class="co"># Convert data to percentage terms</span></span>
<span><span class="va">GGDC10S</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="../reference/ftransform.html">ftransformv</a></span><span class="op">(</span><span class="fl">6</span><span class="op">:</span><span class="fl">16</span>, <span class="va">`*`</span>, <span class="fl">100</span><span class="op">/</span><span class="va">SUM</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">tail</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">#      Country Regioncode                       Region Variable Year      AGR       MIN      MAN</span></span>
<span><span class="co"># 5026     EGY       MENA Middle East and North Africa      EMP 2011 23.33961 0.1240535 10.68352</span></span>
<span><span class="co"># 5027     EGY       MENA Middle East and North Africa      EMP 2012 22.90281 0.1099779 10.42240</span></span>
<span><span class="co">#            PU      CON      WRT      TRA     FIRE      GOV OTH SUM</span></span>
<span><span class="co"># 5026 1.431173 12.58029 13.59279 9.218680 3.666798 25.36308  NA 100</span></span>
<span><span class="co"># 5027 1.442061 13.00871 13.80013 9.164534 3.694551 25.45482  NA 100</span></span>
<span></span>
<span><span class="co"># Apply log to numeric columns</span></span>
<span><span class="va">GGDC10S</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="../reference/ftransform.html">ftransformv</a></span><span class="op">(</span><span class="va">is.numeric</span>, <span class="va">log</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">tail</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">#      Country Regioncode                       Region Variable     Year      AGR      MIN      MAN</span></span>
<span><span class="co"># 5026     EGY       MENA Middle East and North Africa      EMP 7.606387 8.553702 3.316508 7.772253</span></span>
<span><span class="co"># 5027     EGY       MENA Middle East and North Africa      EMP 7.606885 8.548806 3.210070 7.761504</span></span>
<span><span class="co">#            PU      CON      WRT      TRA     FIRE      GOV OTH      SUM</span></span>
<span><span class="co"># 5026 5.762045 7.935682 8.013090 7.624782 6.702869 8.636845  NA 10.00872</span></span>
<span><span class="co"># 5027 5.783620 7.983166 8.042224 7.632888 6.724406 8.654452  NA 10.02272</span></span></code></pre></div>
<p>Instead of passing comma-separated <code>column = value</code>
expressions, it is also possible to bulk-process data with
<code>fransform</code> by passing a single list of expressions (such as
a data frame). This is useful for more complex transformations involving
multiple steps:</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Same as above, but also replacing any generated infinite values with NA</span></span>
<span><span class="va">GGDC10S</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="../reference/ftransform.html">ftransform</a></span><span class="op">(</span><span class="fu"><a href="../reference/select_replace_vars.html">num_vars</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">log</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="va">replace_Inf</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">tail</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">#      Country Regioncode                       Region Variable     Year      AGR      MIN      MAN</span></span>
<span><span class="co"># 5026     EGY       MENA Middle East and North Africa      EMP 7.606387 8.553702 3.316508 7.772253</span></span>
<span><span class="co"># 5027     EGY       MENA Middle East and North Africa      EMP 7.606885 8.548806 3.210070 7.761504</span></span>
<span><span class="co">#            PU      CON      WRT      TRA     FIRE      GOV OTH      SUM</span></span>
<span><span class="co"># 5026 5.762045 7.935682 8.013090 7.624782 6.702869 8.636845  NA 10.00872</span></span>
<span><span class="co"># 5027 5.783620 7.983166 8.042224 7.632888 6.724406 8.654452  NA 10.02272</span></span></code></pre></div>
<p>This mode of usage toggles automatic column matching and replacement.
Non-matching columns are added to the data frame. Apart from to
<code>ftransform</code>, the function <code>settransform(v)</code> can
be used to change the input data frame by reference:
<!-- and is a simple wrapper around `X <- ftransform(X, ...)`: --></p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Computing a new column and deleting some others by reference</span></span>
<span><span class="fu"><a href="../reference/ftransform.html">settransform</a></span><span class="op">(</span><span class="va">GGDC10S</span>, FIRE_MAN <span class="op">=</span> <span class="va">FIRE</span> <span class="op">/</span> <span class="va">MAN</span>,</span>
<span>                      Regioncode <span class="op">=</span> <span class="cn">NULL</span>, Region <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">tail</a></span><span class="op">(</span><span class="va">GGDC10S</span>, <span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">#      Country Variable Year      AGR      MIN      MAN       PU      CON      WRT      TRA     FIRE</span></span>
<span><span class="co"># 5026     EGY      EMP 2011 5185.919 27.56394 2373.814 317.9979 2795.264 3020.236 2048.335 814.7403</span></span>
<span><span class="co"># 5027     EGY      EMP 2012 5160.590 24.78083 2348.434 324.9332 2931.196 3109.522 2065.004 832.4770</span></span>
<span><span class="co">#           GOV OTH      SUM  FIRE_MAN</span></span>
<span><span class="co"># 5026 5635.522  NA 22219.39 0.3432200</span></span>
<span><span class="co"># 5027 5735.623  NA 22532.56 0.3544817</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/rm.html" class="external-link">rm</a></span><span class="op">(</span><span class="va">GGDC10S</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Bulk-processing the data into percentage terms</span></span>
<span><span class="fu"><a href="../reference/ftransform.html">settransformv</a></span><span class="op">(</span><span class="va">GGDC10S</span>, <span class="fl">6</span><span class="op">:</span><span class="fl">16</span>, <span class="va">`*`</span>, <span class="fl">100</span><span class="op">/</span><span class="va">SUM</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">tail</a></span><span class="op">(</span><span class="va">GGDC10S</span>, <span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">#      Country Regioncode                       Region Variable Year      AGR       MIN      MAN</span></span>
<span><span class="co"># 5026     EGY       MENA Middle East and North Africa      EMP 2011 23.33961 0.1240535 10.68352</span></span>
<span><span class="co"># 5027     EGY       MENA Middle East and North Africa      EMP 2012 22.90281 0.1099779 10.42240</span></span>
<span><span class="co">#            PU      CON      WRT      TRA     FIRE      GOV OTH SUM</span></span>
<span><span class="co"># 5026 1.431173 12.58029 13.59279 9.218680 3.666798 25.36308  NA 100</span></span>
<span><span class="co"># 5027 1.442061 13.00871 13.80013 9.164534 3.694551 25.45482  NA 100</span></span>
<span></span>
<span><span class="co"># Same thing via replacement</span></span>
<span><span class="fu"><a href="../reference/ftransform.html">ftransform</a></span><span class="op">(</span><span class="va">GGDC10S</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/select_replace_vars.html">fselect</a></span><span class="op">(</span><span class="va">GGDC10S</span>, <span class="va">AGR</span><span class="op">:</span><span class="va">SUM</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">`*`</span>, <span class="fl">100</span><span class="op">/</span><span class="va">.</span><span class="op">$</span><span class="va">SUM</span><span class="op">)</span></span>
<span><span class="co"># Or using double pipes</span></span>
<span><span class="va">GGDC10S</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html" class="external-link">%&lt;&gt;%</a></span> <span class="fu"><a href="../reference/ftransform.html">ftransformv</a></span><span class="op">(</span><span class="fl">6</span><span class="op">:</span><span class="fl">16</span>, <span class="va">`*`</span>, <span class="fl">100</span><span class="op">/</span><span class="va">SUM</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/rm.html" class="external-link">rm</a></span><span class="op">(</span><span class="va">GGDC10S</span><span class="op">)</span></span></code></pre></div>
<p>Another convenient addition is provided by the function
<code>fcompute</code>, which can be used to compute new columns in a
data frame environment and returns the computed columns in a new data
frame:</p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/ftransform.html">fcompute</a></span><span class="op">(</span><span class="va">GGDC10S</span>, AGR_perc <span class="op">=</span> <span class="va">AGR</span> <span class="op">/</span> <span class="va">SUM</span> <span class="op">*</span> <span class="fl">100</span>, FIRE_MAN <span class="op">=</span> <span class="va">FIRE</span> <span class="op">/</span> <span class="va">MAN</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">tail</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">#      AGR_perc  FIRE_MAN</span></span>
<span><span class="co"># 5026 23.33961 0.3432200</span></span>
<span><span class="co"># 5027 22.90281 0.3544817</span></span></code></pre></div>
<p>For more complex tasks see <code><a href="../reference/ftransform.html">?ftransform</a></code>.</p>
</div>
<div class="section level3">
<h3 id="adding-and-binding-columns">2.5 Adding and Binding Columns<a class="anchor" aria-label="anchor" href="#adding-and-binding-columns"></a>
</h3>
<p>For cases where multiple columns are computed and need to be added to
a data frame (regardless of whether names are duplicated or not),
<em>collapse</em> introduces the predicate <code>add_vars</code>.
Together with <code>add_vars</code>, the function <code>add_stub</code>
is useful to add a prefix (default) or postfix to computed variables
keeping the variable names unique:</p>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Efficient adding logged versions of some variables</span></span>
<span><span class="fu"><a href="../reference/select_replace_vars.html">add_vars</a></span><span class="op">(</span><span class="va">wlddev</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/select_replace_vars.html">get_vars</a></span><span class="op">(</span><span class="va">wlddev</span>, <span class="fl">9</span><span class="op">:</span><span class="fl">13</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">log10</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="../reference/small-helpers.html">add_stub</a></span><span class="op">(</span><span class="st">"log10."</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">wlddev</span>, <span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">#       country iso3c       date year decade     region     income  OECD PCGDP LIFEEX GINI       ODA</span></span>
<span><span class="co"># 1 Afghanistan   AFG 1961-01-01 1960   1960 South Asia Low income FALSE    NA 32.446   NA 116769997</span></span>
<span><span class="co"># 2 Afghanistan   AFG 1962-01-01 1961   1960 South Asia Low income FALSE    NA 32.962   NA 232080002</span></span>
<span><span class="co">#       POP log10.PCGDP log10.LIFEEX log10.GINI log10.ODA log10.POP</span></span>
<span><span class="co"># 1 8996973          NA     1.511161         NA  8.067331  6.954096</span></span>
<span><span class="co"># 2 9169410          NA     1.518014         NA  8.365638  6.962341</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/rm.html" class="external-link">rm</a></span><span class="op">(</span><span class="va">wlddev</span><span class="op">)</span></span></code></pre></div>
<p>By default <code>add_vars</code> appends a data frame towards the
(right) end, but it can also replace columns in front or at other
positions in the data frame:</p>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/select_replace_vars.html">add_vars</a></span><span class="op">(</span><span class="va">wlddev</span>, <span class="st">"front"</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/select_replace_vars.html">get_vars</a></span><span class="op">(</span><span class="va">wlddev</span>, <span class="fl">9</span><span class="op">:</span><span class="fl">13</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">log10</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="../reference/small-helpers.html">add_stub</a></span><span class="op">(</span><span class="st">"log10."</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">wlddev</span>, <span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">#   log10.PCGDP log10.LIFEEX log10.GINI log10.ODA log10.POP     country iso3c       date year decade</span></span>
<span><span class="co"># 1          NA     1.511161         NA  8.067331  6.954096 Afghanistan   AFG 1961-01-01 1960   1960</span></span>
<span><span class="co"># 2          NA     1.518014         NA  8.365638  6.962341 Afghanistan   AFG 1962-01-01 1961   1960</span></span>
<span><span class="co">#       region     income  OECD PCGDP LIFEEX GINI       ODA     POP</span></span>
<span><span class="co"># 1 South Asia Low income FALSE    NA 32.446   NA 116769997 8996973</span></span>
<span><span class="co"># 2 South Asia Low income FALSE    NA 32.962   NA 232080002 9169410</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/rm.html" class="external-link">rm</a></span><span class="op">(</span><span class="va">wlddev</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/select_replace_vars.html">add_vars</a></span><span class="op">(</span><span class="va">wlddev</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">10L</span>,<span class="fl">12L</span>,<span class="fl">14L</span>,<span class="fl">16L</span>,<span class="fl">18L</span><span class="op">)</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/select_replace_vars.html">get_vars</a></span><span class="op">(</span><span class="va">wlddev</span>, <span class="fl">9</span><span class="op">:</span><span class="fl">13</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">log10</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="../reference/small-helpers.html">add_stub</a></span><span class="op">(</span><span class="st">"log10."</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">wlddev</span>, <span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">#       country iso3c       date year decade     region     income  OECD PCGDP log10.PCGDP LIFEEX</span></span>
<span><span class="co"># 1 Afghanistan   AFG 1961-01-01 1960   1960 South Asia Low income FALSE    NA          NA 32.446</span></span>
<span><span class="co"># 2 Afghanistan   AFG 1962-01-01 1961   1960 South Asia Low income FALSE    NA          NA 32.962</span></span>
<span><span class="co">#   log10.LIFEEX GINI log10.GINI       ODA log10.ODA     POP log10.POP</span></span>
<span><span class="co"># 1     1.511161   NA         NA 116769997  8.067331 8996973  6.954096</span></span>
<span><span class="co"># 2     1.518014   NA         NA 232080002  8.365638 9169410  6.962341</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/rm.html" class="external-link">rm</a></span><span class="op">(</span><span class="va">wlddev</span><span class="op">)</span></span></code></pre></div>
<p><code>add_vars</code> can also be used without replacement, where it
serves as a more efficient version of <code>cbind.data.frame</code>,
with the difference that the data structure and attributes of the first
argument are preserved:</p>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/select_replace_vars.html">add_vars</a></span><span class="op">(</span><span class="va">wlddev</span>, <span class="fu"><a href="../reference/select_replace_vars.html">get_vars</a></span><span class="op">(</span><span class="va">wlddev</span>, <span class="fl">9</span><span class="op">:</span><span class="fl">13</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">log</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="../reference/small-helpers.html">add_stub</a></span><span class="op">(</span><span class="st">"log."</span><span class="op">)</span>,</span>
<span>                 <span class="fu"><a href="../reference/select_replace_vars.html">get_vars</a></span><span class="op">(</span><span class="va">wlddev</span>, <span class="fl">9</span><span class="op">:</span><span class="fl">13</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">log10</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="../reference/small-helpers.html">add_stub</a></span><span class="op">(</span><span class="st">"log10."</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">#       country iso3c       date year decade     region     income  OECD PCGDP LIFEEX GINI       ODA</span></span>
<span><span class="co"># 1 Afghanistan   AFG 1961-01-01 1960   1960 South Asia Low income FALSE    NA 32.446   NA 116769997</span></span>
<span><span class="co"># 2 Afghanistan   AFG 1962-01-01 1961   1960 South Asia Low income FALSE    NA 32.962   NA 232080002</span></span>
<span><span class="co">#       POP log.PCGDP log.LIFEEX log.GINI  log.ODA  log.POP log10.PCGDP log10.LIFEEX log10.GINI</span></span>
<span><span class="co"># 1 8996973        NA   3.479577       NA 18.57572 16.01240          NA     1.511161         NA</span></span>
<span><span class="co"># 2 9169410        NA   3.495355       NA 19.26259 16.03138          NA     1.518014         NA</span></span>
<span><span class="co">#   log10.ODA log10.POP</span></span>
<span><span class="co"># 1  8.067331  6.954096</span></span>
<span><span class="co"># 2  8.365638  6.962341</span></span>
<span></span>
<span><span class="fu"><a href="../reference/select_replace_vars.html">add_vars</a></span><span class="op">(</span><span class="va">wlddev</span>,  <span class="fu"><a href="../reference/select_replace_vars.html">get_vars</a></span><span class="op">(</span><span class="va">wlddev</span>, <span class="fl">9</span><span class="op">:</span><span class="fl">13</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">log</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="../reference/small-helpers.html">add_stub</a></span><span class="op">(</span><span class="st">"log."</span><span class="op">)</span>,</span>
<span>                  <span class="fu"><a href="../reference/select_replace_vars.html">get_vars</a></span><span class="op">(</span><span class="va">wlddev</span>, <span class="fl">9</span><span class="op">:</span><span class="fl">13</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">log10</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="../reference/small-helpers.html">add_stub</a></span><span class="op">(</span><span class="st">"log10."</span><span class="op">)</span>,</span>
<span>         pos <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">10L</span>,<span class="fl">13L</span>,<span class="fl">16L</span>,<span class="fl">19L</span>,<span class="fl">22L</span>,<span class="fl">11L</span>,<span class="fl">14L</span>,<span class="fl">17L</span>,<span class="fl">20L</span>,<span class="fl">23L</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">#       country iso3c       date year decade     region     income  OECD PCGDP log.PCGDP log10.PCGDP</span></span>
<span><span class="co"># 1 Afghanistan   AFG 1961-01-01 1960   1960 South Asia Low income FALSE    NA        NA          NA</span></span>
<span><span class="co"># 2 Afghanistan   AFG 1962-01-01 1961   1960 South Asia Low income FALSE    NA        NA          NA</span></span>
<span><span class="co">#   LIFEEX log.LIFEEX log10.LIFEEX GINI log.GINI log10.GINI       ODA  log.ODA log10.ODA     POP</span></span>
<span><span class="co"># 1 32.446   3.479577     1.511161   NA       NA         NA 116769997 18.57572  8.067331 8996973</span></span>
<span><span class="co"># 2 32.962   3.495355     1.518014   NA       NA         NA 232080002 19.26259  8.365638 9169410</span></span>
<span><span class="co">#    log.POP log10.POP</span></span>
<span><span class="co"># 1 16.01240  6.954096</span></span>
<span><span class="co"># 2 16.03138  6.962341</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/identical.html" class="external-link">identical</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">wlddev</span>, <span class="va">wlddev</span><span class="op">)</span>, <span class="fu"><a href="../reference/select_replace_vars.html">add_vars</a></span><span class="op">(</span><span class="va">wlddev</span>, <span class="va">wlddev</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># [1] TRUE</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html" class="external-link">microbenchmark</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">wlddev</span>, <span class="va">wlddev</span><span class="op">)</span>, <span class="fu"><a href="../reference/select_replace_vars.html">add_vars</a></span><span class="op">(</span><span class="va">wlddev</span>, <span class="va">wlddev</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># Unit: microseconds</span></span>
<span><span class="co">#                      expr    min      lq     mean median      uq    max neval</span></span>
<span><span class="co">#     cbind(wlddev, wlddev) 13.694 14.1040 15.72760 14.391 14.7600 57.072   100</span></span>
<span><span class="co">#  add_vars(wlddev, wlddev)  3.280  3.6285  4.13567  3.813  4.0385 19.352   100</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="renaming-columns">2.6 Renaming Columns<a class="anchor" aria-label="anchor" href="#renaming-columns"></a>
</h3>
<p><code>frename</code> is a fast substitute for
<code><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">dplyr::rename</a></code>:</p>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/frename.html">frename</a></span><span class="op">(</span><span class="va">GGDC10S</span>, AGR <span class="op">=</span> <span class="va">Agriculture</span>, MIN <span class="op">=</span> <span class="va">Mining</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">#   Country Regioncode             Region Variable Year Agriculture Mining MAN PU CON WRT TRA FIRE</span></span>
<span><span class="co"># 1     BWA        SSA Sub-saharan Africa       VA 1960          NA     NA  NA NA  NA  NA  NA   NA</span></span>
<span><span class="co"># 2     BWA        SSA Sub-saharan Africa       VA 1961          NA     NA  NA NA  NA  NA  NA   NA</span></span>
<span><span class="co">#   GOV OTH SUM</span></span>
<span><span class="co"># 1  NA  NA  NA</span></span>
<span><span class="co"># 2  NA  NA  NA</span></span>
<span><span class="fu"><a href="../reference/frename.html">frename</a></span><span class="op">(</span><span class="va">GGDC10S</span>, <span class="va">tolower</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">#   country regioncode             region variable year agr min man pu con wrt tra fire gov oth sum</span></span>
<span><span class="co"># 1     BWA        SSA Sub-saharan Africa       VA 1960  NA  NA  NA NA  NA  NA  NA   NA  NA  NA  NA</span></span>
<span><span class="co"># 2     BWA        SSA Sub-saharan Africa       VA 1961  NA  NA  NA NA  NA  NA  NA   NA  NA  NA  NA</span></span>
<span><span class="fu"><a href="../reference/frename.html">frename</a></span><span class="op">(</span><span class="va">GGDC10S</span>, <span class="va">tolower</span>, cols <span class="op">=</span> <span class="fu"><a href="../reference/small-helpers.html">.c</a></span><span class="op">(</span><span class="va">AGR</span>, <span class="va">MIN</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">#   Country Regioncode             Region Variable Year agr min MAN PU CON WRT TRA FIRE GOV OTH SUM</span></span>
<span><span class="co"># 1     BWA        SSA Sub-saharan Africa       VA 1960  NA  NA  NA NA  NA  NA  NA   NA  NA  NA  NA</span></span>
<span><span class="co"># 2     BWA        SSA Sub-saharan Africa       VA 1961  NA  NA  NA NA  NA  NA  NA   NA  NA  NA  NA</span></span></code></pre></div>
<p>The function <code>setrename</code> does this by reference:</p>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/frename.html">setrename</a></span><span class="op">(</span><span class="va">GGDC10S</span>, AGR <span class="op">=</span> <span class="va">Agriculture</span>, MIN <span class="op">=</span> <span class="va">Mining</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">GGDC10S</span>, <span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">#   Country Regioncode             Region Variable Year Agriculture Mining MAN PU CON WRT TRA FIRE</span></span>
<span><span class="co"># 1     BWA        SSA Sub-saharan Africa       VA 1960          NA     NA  NA NA  NA  NA  NA   NA</span></span>
<span><span class="co"># 2     BWA        SSA Sub-saharan Africa       VA 1961          NA     NA  NA NA  NA  NA  NA   NA</span></span>
<span><span class="co">#   GOV OTH SUM</span></span>
<span><span class="co"># 1  NA  NA  NA</span></span>
<span><span class="co"># 2  NA  NA  NA</span></span>
<span><span class="fu"><a href="../reference/frename.html">setrename</a></span><span class="op">(</span><span class="va">GGDC10S</span>, Agriculture <span class="op">=</span> <span class="va">AGR</span>, Mining <span class="op">=</span> <span class="va">MIN</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/rm.html" class="external-link">rm</a></span><span class="op">(</span><span class="va">GGDC10S</span><span class="op">)</span></span></code></pre></div>
<p>Both functions are not limited to data frames but can be applied to
any R object with a ‘names’ attribute.</p>
</div>
<div class="section level3">
<h3 id="using-shortcuts">2.7 Using Shortcuts<a class="anchor" aria-label="anchor" href="#using-shortcuts"></a>
</h3>
<p>The most frequently required among the functions introduced above can
be abbreviated as follows: <code>fselect -&gt; slt</code>,
<code>fsubset -&gt; sbt</code>, <code>ftransform(v) -&gt; tfm(v)</code>,
<code>settransform(v) -&gt; settfm(v)</code>,
<code>get_vars -&gt; gv</code>, <code>num_vars -&gt; nv</code>,
<code>add_vars -&gt; av</code>. This was done to make it possible to
write faster and more parsimonious code, but is recommended only for
personally kept scripts. A lazy person may also decide to code
everything using shortcuts and then do ctrl+F replacement with the long
names on the finished script.</p>
<!--
and to facilitate the avoidance of piped `%>%` expressions. Needless to say pipes `%>%` have become a very convenient feature of the R language and do a great job avoiding complex nested calls. They do however require reconstructing the entire call before evaluating it, and thus take out a lot of speed:


```r
microbenchmark(standard = tfm(gv(wlddev, 9:12), ODA_GDP = ODA/PCGDP),
               piped = get_vars(wlddev, 9:12) %>% ftransform(ODA_GDP = ODA/PCGDP))
# Unit: microseconds
#      expr    min     lq     mean  median      uq     max neval
#  standard 12.177 18.860 20.82431 19.8850 20.8485 115.661   100
#     piped 15.498 20.295 22.31794 21.1765 22.8985  71.873   100
```
-->
</div>
<div class="section level3">
<h3 id="missing-values-rows">2.8 Missing Values / Rows<a class="anchor" aria-label="anchor" href="#missing-values-rows"></a>
</h3>
<p>The function <code>na_omit</code> is a much faster alternative to
<code><a href="https://rdrr.io/r/stats/na.fail.html" class="external-link">stats::na.omit</a></code> for vectors, matrices and data frames. By
default the ‘na.action’ attribute containing the removed cases is
omitted, but it can be added with the option
<code>na.attr = TRUE</code>. Like <code>fsubset</code>,
<code>na_omit</code> preserves all column attributes as well as
attributes of the data frame itself.</p>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html" class="external-link">microbenchmark</a></span><span class="op">(</span><span class="fu"><a href="../reference/efficient-programming.html">na_omit</a></span><span class="op">(</span><span class="va">wlddev</span>, na.attr <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/stats/na.fail.html" class="external-link">na.omit</a></span><span class="op">(</span><span class="va">wlddev</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># Unit: microseconds</span></span>
<span><span class="co">#                             expr     min      lq      mean   median       uq       max neval</span></span>
<span><span class="co">#  na_omit(wlddev, na.attr = TRUE)  60.393  69.208   84.8126  79.9910   88.683   419.881   100</span></span>
<span><span class="co">#                  na.omit(wlddev) 745.790 856.449 1721.5457 940.6015 1005.177 56344.414   100</span></span></code></pre></div>
<p>Another added feature is the removal of cases missing on certain
columns only:</p>
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/efficient-programming.html">na_omit</a></span><span class="op">(</span><span class="va">wlddev</span>, cols <span class="op">=</span> <span class="fu"><a href="../reference/small-helpers.html">.c</a></span><span class="op">(</span><span class="va">PCGDP</span>, <span class="va">LIFEEX</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">#       country iso3c       date year decade     region     income  OECD    PCGDP LIFEEX GINI</span></span>
<span><span class="co"># 1 Afghanistan   AFG 2003-01-01 2002   2000 South Asia Low income FALSE 330.3036 56.784   NA</span></span>
<span><span class="co"># 2 Afghanistan   AFG 2004-01-01 2003   2000 South Asia Low income FALSE 343.0809 57.271   NA</span></span>
<span><span class="co">#          ODA      POP</span></span>
<span><span class="co"># 1 1790479980 22600770</span></span>
<span><span class="co"># 2 1972890015 23680871</span></span>
<span><span class="co"># only removing missing data from numeric columns -&gt; same and slightly faster than na_omit(wlddev)</span></span>
<span><span class="fu"><a href="../reference/efficient-programming.html">na_omit</a></span><span class="op">(</span><span class="va">wlddev</span>, cols <span class="op">=</span> <span class="va">is.numeric</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">#   country iso3c       date year decade                region              income  OECD    PCGDP</span></span>
<span><span class="co"># 1 Albania   ALB 1997-01-01 1996   1990 Europe &amp; Central Asia Upper middle income FALSE 1869.866</span></span>
<span><span class="co"># 2 Albania   ALB 2003-01-01 2002   2000 Europe &amp; Central Asia Upper middle income FALSE 2572.721</span></span>
<span><span class="co">#   LIFEEX GINI       ODA     POP</span></span>
<span><span class="co"># 1 72.495 27.0 294089996 3168033</span></span>
<span><span class="co"># 2 74.579 31.7 453309998 3051010</span></span></code></pre></div>
<p>For atomic vectors the function <code>na_rm</code> also exists which
is 2x faster than <code>x[!is.na(x)]</code>. Both <code>na_omit</code>
and <code>na_rm</code> return their argument if no missing cases were
found.</p>
<p>The existence of missing cases can be checked using
<code>missing_cases</code>, which is also considerably faster than
<code>complete.cases</code> for data frames.</p>
<p>There is also a function <code>na_insert</code> to randomly insert
missing values into vectors, matrices and data frames. The default is
<code>na_insert(X, prop = 0.1)</code> so that 10% of values are randomly
set to missing.</p>
<p>Finally, a function <code>allNA</code> provides the much needed
opposite of <code>anyNA</code> for atomic vectors.</p>
</div>
<div class="section level3">
<h3 id="unique-values-rows">2.9 Unique Values / Rows<a class="anchor" aria-label="anchor" href="#unique-values-rows"></a>
</h3>
<p>Similar to <code>na_omit</code>, the function <code>funique</code> is
a much faster alternative to <code><a href="https://rdrr.io/r/base/unique.html" class="external-link">base::unique</a></code> for atomic
vectors and data frames. Like most <em>collapse</em> functions it also
seeks to preserve attributes.</p>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/funique.html">funique</a></span><span class="op">(</span><span class="va">GGDC10S</span><span class="op">$</span><span class="va">Variable</span><span class="op">)</span>              <span class="co"># Unique values in order of appearance</span></span>
<span><span class="co"># [1] "VA"  "EMP"</span></span>
<span><span class="co"># attr(,"label")</span></span>
<span><span class="co"># [1] "Variable"</span></span>
<span><span class="co"># attr(,"format.stata")</span></span>
<span><span class="co"># [1] "%9s"</span></span>
<span><span class="fu"><a href="../reference/funique.html">funique</a></span><span class="op">(</span><span class="va">GGDC10S</span><span class="op">$</span><span class="va">Variable</span>, sort <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="co"># Sorted unique values</span></span>
<span><span class="co"># [1] "EMP" "VA" </span></span>
<span><span class="co"># attr(,"label")</span></span>
<span><span class="co"># [1] "Variable"</span></span>
<span><span class="co"># attr(,"format.stata")</span></span>
<span><span class="co"># [1] "%9s"</span></span>
<span></span>
<span><span class="co"># If all values/rows are unique, the original data is returned (no copy)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/identical.html" class="external-link">identical</a></span><span class="op">(</span><span class="fu"><a href="../reference/funique.html">funique</a></span><span class="op">(</span><span class="va">GGDC10S</span><span class="op">)</span>, <span class="va">GGDC10S</span><span class="op">)</span></span>
<span><span class="co"># [1] TRUE</span></span>
<span></span>
<span><span class="co"># Can remove duplicate rows by a subset of columns</span></span>
<span><span class="fu"><a href="../reference/funique.html">funique</a></span><span class="op">(</span><span class="va">GGDC10S</span>, cols <span class="op">=</span> <span class="fu"><a href="../reference/small-helpers.html">.c</a></span><span class="op">(</span><span class="va">Country</span>, <span class="va">Variable</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="../reference/fsubset.html">ss</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">8</span><span class="op">)</span></span>
<span><span class="co">#   Country Regioncode             Region Variable Year AGR MIN MAN</span></span>
<span><span class="co"># 1     BWA        SSA Sub-saharan Africa       VA 1960  NA  NA  NA</span></span>
<span><span class="co"># 2     BWA        SSA Sub-saharan Africa      EMP 1960  NA  NA  NA</span></span>
<span><span class="fu"><a href="../reference/funique.html">funique</a></span><span class="op">(</span><span class="va">GGDC10S</span>, cols <span class="op">=</span> <span class="fu"><a href="../reference/small-helpers.html">.c</a></span><span class="op">(</span><span class="va">Country</span>, <span class="va">Variable</span><span class="op">)</span>, sort <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="../reference/fsubset.html">ss</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">8</span><span class="op">)</span></span>
<span><span class="co">#   Country Regioncode        Region Variable Year          AGR      MIN          MAN</span></span>
<span><span class="co"># 1     ARG        LAM Latin America      EMP 1950 1.799565e+03 32.71936 1.603249e+03</span></span>
<span><span class="co"># 2     ARG        LAM Latin America       VA 1950 5.887857e-07  0.00000 3.534430e-06</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="recoding-and-replacing-values">2.10 Recoding and Replacing Values<a class="anchor" aria-label="anchor" href="#recoding-and-replacing-values"></a>
</h3>
<p>With <code>recode_num</code>, <code>recode_char</code>,
<code>replace_NA</code>, <code>replace_Inf</code> and
<code>replace_outliers</code>, <em>collapse</em> also introduces a set
of functions to efficiently recode and replace numeric and character
values in matrix-like objects (vectors, matrices, arrays, data frames,
lists of atomic objects). When called on a data frame,
<code>recode_num</code>, <code>replace_Inf</code> and
<code>replace_outliers</code> will skip non-numeric columns, and
<code>recode_char</code> skips non-character columns, whereas
<code>replace_NA</code> replaces missing values in all columns.</p>
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Efficient replacing missing values with 0</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html" class="external-link">microbenchmark</a></span><span class="op">(</span><span class="fu"><a href="../reference/collapse-renamed.html">replace_NA</a></span><span class="op">(</span><span class="va">GGDC10S</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># Unit: microseconds</span></span>
<span><span class="co">#                    expr     min      lq     mean   median       uq      max neval</span></span>
<span><span class="co">#  replace_NA(GGDC10S, 0) 109.757 141.163 203.4982 151.0235 163.0775 4579.085   100</span></span>
<span></span>
<span><span class="co"># Adding log-transformed sectoral data: Some NaN and Inf values generated</span></span>
<span><span class="fu"><a href="../reference/select_replace_vars.html">add_vars</a></span><span class="op">(</span><span class="va">GGDC10S</span>, <span class="fl">6</span><span class="op">:</span><span class="fl">16</span><span class="op">*</span><span class="fl">2</span><span class="op">-</span><span class="fl">5</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/select_replace_vars.html">fselect</a></span><span class="op">(</span><span class="va">GGDC10S</span>, <span class="va">AGR</span><span class="op">:</span><span class="va">SUM</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">log</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="va">replace_Inf</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="../reference/small-helpers.html">add_stub</a></span><span class="op">(</span><span class="st">"log."</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">GGDC10S</span>, <span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">#   Country Regioncode             Region Variable Year AGR log.AGR MIN log.MIN MAN log.MAN PU log.PU</span></span>
<span><span class="co"># 1     BWA        SSA Sub-saharan Africa       VA 1960  NA      NA  NA      NA  NA      NA NA     NA</span></span>
<span><span class="co"># 2     BWA        SSA Sub-saharan Africa       VA 1961  NA      NA  NA      NA  NA      NA NA     NA</span></span>
<span><span class="co">#   CON log.CON WRT log.WRT TRA log.TRA FIRE log.FIRE GOV log.GOV OTH log.OTH SUM log.SUM</span></span>
<span><span class="co"># 1  NA      NA  NA      NA  NA      NA   NA       NA  NA      NA  NA      NA  NA      NA</span></span>
<span><span class="co"># 2  NA      NA  NA      NA  NA      NA   NA       NA  NA      NA  NA      NA  NA      NA</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/rm.html" class="external-link">rm</a></span><span class="op">(</span><span class="va">GGDC10S</span><span class="op">)</span></span></code></pre></div>
<p><code>recode_num</code> and <code>recode_char</code> follow the
syntax of <code><a href="https://dplyr.tidyverse.org/reference/recode.html" class="external-link">dplyr::recode</a></code> and provide more or less the same
functionality except that they can efficiently be applied to matrices
and data frames, and that <code>recode_char</code> allows for regular
expression matching implemented via <code><a href="https://rdrr.io/r/base/grep.html" class="external-link">base::grepl</a></code>:</p>
<!-- that `dplyr::recode` offers a method for factors not provided in *collapse*,  -->
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">month.name</span></span>
<span><span class="co">#  [1] "January"   "February"  "March"     "April"     "May"       "June"      "July"      "August"   </span></span>
<span><span class="co">#  [9] "September" "October"   "November"  "December"</span></span>
<span><span class="fu"><a href="../reference/recode-replace.html">recode_char</a></span><span class="op">(</span><span class="va">month.name</span>, ber <span class="op">=</span> <span class="st">"C"</span>, <span class="st">"^J"</span> <span class="op">=</span> <span class="st">"A"</span>, default <span class="op">=</span> <span class="st">"B"</span>, regex <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#  [1] "A" "B" "B" "B" "B" "A" "A" "B" "B" "B" "B" "B"</span></span></code></pre></div>
<p>The perhaps most interesting function in this ensemble is
<code>replace_outliers</code>, which replaces values falling outside a
1- or 2-sided numeric threshold or outside a certain number of column-
standard deviations with a value (default is <code>NA</code>).</p>
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># replace all values below 2 and above 100 with NA</span></span>
<span><span class="fu"><a href="../reference/recode-replace.html">replace_outliers</a></span><span class="op">(</span><span class="va">mtcars</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">100</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span></span>
<span><span class="co">#                mpg cyl disp hp drat    wt  qsec vs am gear carb</span></span>
<span><span class="co"># Mazda RX4     21.0   6   NA NA 3.90 2.620 16.46 NA NA    4    4</span></span>
<span><span class="co"># Mazda RX4 Wag 21.0   6   NA NA 3.90 2.875 17.02 NA NA    4    4</span></span>
<span><span class="co"># Datsun 710    22.8   4   NA 93 3.85 2.320 18.61 NA NA    4   NA</span></span>
<span></span>
<span><span class="co"># replace all value smaller than 2 with NA</span></span>
<span><span class="fu"><a href="../reference/recode-replace.html">replace_outliers</a></span><span class="op">(</span><span class="va">mtcars</span>, <span class="fl">2</span>, single.limit <span class="op">=</span> <span class="st">"min"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span></span>
<span><span class="co">#                mpg cyl disp  hp drat    wt  qsec vs am gear carb</span></span>
<span><span class="co"># Mazda RX4     21.0   6  160 110 3.90 2.620 16.46 NA NA    4    4</span></span>
<span><span class="co"># Mazda RX4 Wag 21.0   6  160 110 3.90 2.875 17.02 NA NA    4    4</span></span>
<span><span class="co"># Datsun 710    22.8   4  108  93 3.85 2.320 18.61 NA NA    4   NA</span></span>
<span></span>
<span><span class="co"># replace all value larger than 100 with NA</span></span>
<span><span class="fu"><a href="../reference/recode-replace.html">replace_outliers</a></span><span class="op">(</span><span class="va">mtcars</span>, <span class="fl">100</span>, single.limit <span class="op">=</span> <span class="st">"max"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span></span>
<span><span class="co">#                mpg cyl disp hp drat    wt  qsec vs am gear carb</span></span>
<span><span class="co"># Mazda RX4     21.0   6   NA NA 3.90 2.620 16.46  0  1    4    4</span></span>
<span><span class="co"># Mazda RX4 Wag 21.0   6   NA NA 3.90 2.875 17.02  0  1    4    4</span></span>
<span><span class="co"># Datsun 710    22.8   4   NA 93 3.85 2.320 18.61  1  1    4    1</span></span>
<span></span>
<span><span class="co"># replace all values above or below 3 column-standard-deviations from the column-mean with NA</span></span>
<span><span class="fu"><a href="../reference/recode-replace.html">replace_outliers</a></span><span class="op">(</span><span class="va">mtcars</span>, <span class="fl">3</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">tail</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span></span>
<span><span class="co">#                mpg cyl disp  hp drat   wt qsec vs am gear carb</span></span>
<span><span class="co"># Ferrari Dino  19.7   6  145 175 3.62 2.77 15.5  0  1    5    6</span></span>
<span><span class="co"># Maserati Bora 15.0   8  301 335 3.54 3.57 14.6  0  1    5   NA</span></span>
<span><span class="co"># Volvo 142E    21.4   4  121 109 4.11 2.78 18.6  1  1    4    2</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="quick-data-object-conversions">3. Quick Data Object Conversions<a class="anchor" aria-label="anchor" href="#quick-data-object-conversions"></a>
</h2>
<p>Apart from code employed for manipulation of data and the actual
statistical computations performed, frequently used data object
conversions with base functions like <code>as.data.frame</code>,
<code>as.matrix</code> or <code>as.factor</code> have a significant
share in slowing down R code. Optimally code would be written without
such conversions, but sometimes they are necessary and thus
<em>collapse</em> provides a set of functions (<code>qDF</code>,
<code>qDT</code>, <code>qTBL</code>, <code>qM</code>, <code>qF</code>,
<code>mrtl</code> and <code>mctl</code>) to speed these conversions up
quite a bit. These functions are fast because they are non-generic and
dispatch different objects internally, perform critical steps in C++,
and, when passed lists of objects, they only check the length of the
first column.</p>
<p><code>qDF</code>, <code>qDT</code> and <code>qTBL</code> efficiently
convert vectors, matrices, higher-dimensional arrays and suitable lists
to data.frame, <em>data.table</em> and <em>tibble</em> respectively.</p>
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">EuStockMarkets</span><span class="op">)</span></span>
<span><span class="co">#  Time-Series [1:1860, 1:4] from 1991 to 1999: 1629 1614 1607 1621 1618 ...</span></span>
<span><span class="co">#  - attr(*, "dimnames")=List of 2</span></span>
<span><span class="co">#   ..$ : NULL</span></span>
<span><span class="co">#   ..$ : chr [1:4] "DAX" "SMI" "CAC" "FTSE"</span></span>
<span><span class="co"># Efficient Conversion of data frames and matrices to data.table</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html" class="external-link">microbenchmark</a></span><span class="op">(</span><span class="fu"><a href="../reference/quick-conversion.html">qDT</a></span><span class="op">(</span><span class="va">wlddev</span><span class="op">)</span>, <span class="fu"><a href="../reference/quick-conversion.html">qDT</a></span><span class="op">(</span><span class="va">EuStockMarkets</span><span class="op">)</span>, <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/as.data.table.html" class="external-link">as.data.table</a></span><span class="op">(</span><span class="va">wlddev</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">EuStockMarkets</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># Unit: microseconds</span></span>
<span><span class="co">#                           expr    min      lq      mean   median       uq      max neval</span></span>
<span><span class="co">#                    qDT(wlddev)  3.075   3.608   4.21439   3.8950   4.2640   12.546   100</span></span>
<span><span class="co">#            qDT(EuStockMarkets)  6.765   8.733  12.09254  12.5050  14.1040   30.217   100</span></span>
<span><span class="co">#          as.data.table(wlddev) 64.206 122.180 253.75023 143.2745 173.1635 3653.346   100</span></span>
<span><span class="co">#  as.data.frame(EuStockMarkets) 64.247  70.971  82.25174  79.6835  84.8700  339.849   100</span></span>
<span></span>
<span><span class="co"># Converting a time series to data.frame</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fu"><a href="../reference/quick-conversion.html">qDF</a></span><span class="op">(</span><span class="va">AirPassengers</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#   AirPassengers</span></span>
<span><span class="co"># 1           112</span></span>
<span><span class="co"># 2           118</span></span>
<span><span class="co"># 3           132</span></span>
<span><span class="co"># 4           129</span></span>
<span><span class="co"># 5           121</span></span>
<span><span class="co"># 6           135</span></span></code></pre></div>
<p>By default these functions drop all unnecessary attributes from
matrices or lists / data frames in the conversion, but this can be
changed using the <code>keep.attr = TRUE</code> argument.</p>
<p>A useful additional feature of <code>qDF</code> and <code>qDT</code>
is the <code>row.names.col</code> argument, enabling the saving of names
/ row-names in a column when converting from vector, matrix, array or
data frame:</p>
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># This saves the row-names in a column named 'car'</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fu"><a href="../reference/quick-conversion.html">qDT</a></span><span class="op">(</span><span class="va">mtcars</span>, <span class="st">"car"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#                  car   mpg   cyl  disp    hp  drat    wt  qsec    vs    am  gear  carb</span></span>
<span><span class="co">#               &lt;char&gt; &lt;num&gt; &lt;num&gt; &lt;num&gt; &lt;num&gt; &lt;num&gt; &lt;num&gt; &lt;num&gt; &lt;num&gt; &lt;num&gt; &lt;num&gt; &lt;num&gt;</span></span>
<span><span class="co"># 1:         Mazda RX4  21.0     6   160   110  3.90 2.620 16.46     0     1     4     4</span></span>
<span><span class="co"># 2:     Mazda RX4 Wag  21.0     6   160   110  3.90 2.875 17.02     0     1     4     4</span></span>
<span><span class="co"># 3:        Datsun 710  22.8     4   108    93  3.85 2.320 18.61     1     1     4     1</span></span>
<span><span class="co"># 4:    Hornet 4 Drive  21.4     6   258   110  3.08 3.215 19.44     1     0     3     1</span></span>
<span><span class="co"># 5: Hornet Sportabout  18.7     8   360   175  3.15 3.440 17.02     0     0     3     2</span></span>
<span><span class="co"># 6:           Valiant  18.1     6   225   105  2.76 3.460 20.22     1     0     3     1</span></span>
<span></span>
<span><span class="va">N_distinct</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fndistinct.html">fndistinct</a></span><span class="op">(</span><span class="va">GGDC10S</span><span class="op">)</span></span>
<span><span class="va">N_distinct</span></span>
<span><span class="co">#    Country Regioncode     Region   Variable       Year        AGR        MIN        MAN         PU </span></span>
<span><span class="co">#         43          6          6          2         67       4353       4224       4353       4237 </span></span>
<span><span class="co">#        CON        WRT        TRA       FIRE        GOV        OTH        SUM </span></span>
<span><span class="co">#       4339       4344       4334       4349       3470       4238       4364</span></span>
<span><span class="co"># Converting a vector to data.frame, saving names</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fu"><a href="../reference/quick-conversion.html">qDF</a></span><span class="op">(</span><span class="va">N_distinct</span>, <span class="st">"variable"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#     variable N_distinct</span></span>
<span><span class="co"># 1    Country         43</span></span>
<span><span class="co"># 2 Regioncode          6</span></span>
<span><span class="co"># 3     Region          6</span></span>
<span><span class="co"># 4   Variable          2</span></span>
<span><span class="co"># 5       Year         67</span></span>
<span><span class="co"># 6        AGR       4353</span></span></code></pre></div>
<p>For the conversion of matrices to list there are also the programmers
functions <code>mrtl</code> and <code>mctl</code>, which row- or column-
wise convert a matrix into a plain list, data.frame or
<em>data.table</em>.</p>
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># This converts the matrix to a list of 1860 row-vectors of length 4.</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html" class="external-link">microbenchmark</a></span><span class="op">(</span><span class="fu"><a href="../reference/quick-conversion.html">mrtl</a></span><span class="op">(</span><span class="va">EuStockMarkets</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># Unit: microseconds</span></span>
<span><span class="co">#                  expr     min       lq     mean  median       uq     max neval</span></span>
<span><span class="co">#  mrtl(EuStockMarkets) 139.728 151.4335 168.5522 155.841 164.6355 399.791   100</span></span></code></pre></div>
<p>For the reverse operation, <code>qM</code> converts vectors,
higher-dimensional arrays, data frames and suitable lists to matrix.</p>
<div class="sourceCode" id="cb51"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Note: kit::psum is the most efficient way to do this</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html" class="external-link">microbenchmark</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="fu"><a href="../reference/quick-conversion.html">qM</a></span><span class="op">(</span><span class="va">mtcars</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">mtcars</span><span class="op">)</span>, <span class="fu">kit</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/kit/man/psum.html" class="external-link">psum</a></span><span class="op">(</span><span class="va">mtcars</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># Unit: nanoseconds</span></span>
<span><span class="co">#                 expr   min      lq      mean  median      uq      max neval</span></span>
<span><span class="co">#  rowSums(qM(mtcars))  5699  7933.5  12702.62  9122.5 11131.5   316315   100</span></span>
<span><span class="co">#      rowSums(mtcars) 38868 41697.0  48003.21 44157.0 51496.0    95981   100</span></span>
<span><span class="co">#    kit::psum(mtcars)   574   820.0 510905.51   943.0  1107.0 50967797   100</span></span></code></pre></div>
<p>At last, <code>qF</code> converts vectors to factor and is quite a
bit faster than <code>as.factor</code>:</p>
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Converting from character</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">wlddev</span><span class="op">$</span><span class="va">country</span><span class="op">)</span></span>
<span><span class="co">#  chr [1:13176] "Afghanistan" "Afghanistan" "Afghanistan" "Afghanistan" "Afghanistan" ...</span></span>
<span><span class="co">#  - attr(*, "label")= chr "Country Name"</span></span>
<span><span class="fu"><a href="../reference/fndistinct.html">fndistinct</a></span><span class="op">(</span><span class="va">wlddev</span><span class="op">$</span><span class="va">country</span><span class="op">)</span></span>
<span><span class="co"># [1] 216</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html" class="external-link">microbenchmark</a></span><span class="op">(</span><span class="fu"><a href="../reference/qF.html">qF</a></span><span class="op">(</span><span class="va">wlddev</span><span class="op">$</span><span class="va">country</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">wlddev</span><span class="op">$</span><span class="va">country</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># Unit: microseconds</span></span>
<span><span class="co">#                       expr     min       lq      mean  median      uq     max neval</span></span>
<span><span class="co">#         qF(wlddev$country)  70.192  71.1965  73.77376  72.160  74.784 107.256   100</span></span>
<span><span class="co">#  as.factor(wlddev$country) 263.794 275.7660 282.21530 278.841 283.761 360.431   100</span></span>
<span></span>
<span><span class="co"># Converting from numeric</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">wlddev</span><span class="op">$</span><span class="va">PCGDP</span><span class="op">)</span></span>
<span><span class="co">#  num [1:13176] NA NA NA NA NA NA NA NA NA NA ...</span></span>
<span><span class="co">#  - attr(*, "label")= chr "GDP per capita (constant 2010 US$)"</span></span>
<span><span class="fu"><a href="../reference/fndistinct.html">fndistinct</a></span><span class="op">(</span><span class="va">wlddev</span><span class="op">$</span><span class="va">PCGDP</span><span class="op">)</span></span>
<span><span class="co"># [1] 9470</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html" class="external-link">microbenchmark</a></span><span class="op">(</span><span class="fu"><a href="../reference/qF.html">qF</a></span><span class="op">(</span><span class="va">wlddev</span><span class="op">$</span><span class="va">PCGDP</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">wlddev</span><span class="op">$</span><span class="va">PCGDP</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># Unit: microseconds</span></span>
<span><span class="co">#                     expr      min       lq     mean   median        uq       max neval</span></span>
<span><span class="co">#         qF(wlddev$PCGDP)  445.096  474.944  531.221  488.146  509.0765  3930.342   100</span></span>
<span><span class="co">#  as.factor(wlddev$PCGDP) 9374.240 9546.132 9823.477 9633.196 9727.5165 13732.499   100</span></span></code></pre></div>
<!-- by default `qF` converts vectors to ordered factor, regulated by the default argument `ordered = TRUE`. This behavior is the same as `as.factor`, but `as.factor` does not attach a class 'ordered'. `qF(x, ordered = FALSE)` will not sort the levels and is slightly faster. Another difference to `as.factor` is that `qF` always adds a `NA` level for missing values, however by default an integer missing value (`NA_integer_`) is provided as the value for that level (thus `qF` behaves identical to `as.factor` with exception of the added level). a slight modification of this behavior can be achieved with `qF(x, na.exclude = FALSE)`, which will still have the `NA` level but now also assigns a positive integer value to the level (implying that missing values can no longer be detected using `is.na`), and attaches an additional class 'na.included'. Factor generation using `qF(x, na.exclude = FALSE)` is advised when using factors to carry out grouped computations with *collapse*'s fast functions, as the class 'na.included' prevents *collapse* functions to execute a missing value check on the factor, and thus yields a performance improvement. -->
</div>
<div class="section level2">
<h2 id="advanced-statistical-programming">4. Advanced Statistical Programming<a class="anchor" aria-label="anchor" href="#advanced-statistical-programming"></a>
</h2>
<p>Having introduced some of the more basic <em>collapse</em> data
manipulation infrastructure in the preceding chapters, this chapter
introduces some of the packages core functionality for programming with
data.</p>
<div class="section level3">
<h3 id="fast-grouped-weighted-statistical-functions">4.1 Fast (Grouped, Weighted) Statistical Functions<a class="anchor" aria-label="anchor" href="#fast-grouped-weighted-statistical-functions"></a>
</h3>
<p>A key feature of <em>collapse</em> is it’s broad set of <em>Fast
Statistical Functions</em>
(<code>fsum, fprod, fmean, fmedian, fmode, fvar, fsd, fmin, fmax, fnth, ffirst, flast, fnobs, fndistinct</code>),
which are able to tangibly speed-up column-wise, grouped and weighted
statistical computations on vectors, matrices or data frames. The basic
syntax common to all of these functions is:</p>
<div class="sourceCode" id="cb53"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" tabindex="-1"></a><span class="fu">FUN</span>(x, <span class="at">g =</span> <span class="cn">NULL</span>, [<span class="at">w =</span> <span class="cn">NULL</span>,] <span class="at">TRA =</span> <span class="cn">NULL</span>, [<span class="at">na.rm =</span> <span class="cn">TRUE</span>,] <span class="at">use.g.names =</span> <span class="cn">TRUE</span>, <span class="at">drop =</span> <span class="cn">TRUE</span>)</span></code></pre></div>
<p>where <code>x</code> is a vector, matrix or data frame,
<code>g</code> takes groups supplied as vector, factor, list of vectors
or <em>GRP</em> object, and <code>w</code> takes a weight vector
(supported by
<code>fsum, fprod, fmean, fmedian, fmode, fnth, fvar</code> and
<code>fsd</code>). <code>TRA</code> can be used to transform
<code>x</code> using the computed statistics and one of 10 available
transformations
(<code>"replace_fill", "replace", "-", "-+", "/", "%", "+", "*", "%%, "-%%"</code>,
discussed in section 6.3). <code>na.rm</code> efficiently skips missing
values during the computation and is <code>TRUE</code> by default.
<code>use.g.names = TRUE</code> generates new row-names from the unique
groups supplied to <code>g</code>, and <code>drop = TRUE</code> returns
a vector when performing simple (non-grouped) computations on matrix or
data frame columns.</p>
<p>With that in mind, let’s start with some simple examples. To
calculate simple column-wise means, it is sufficient to type:</p>
<div class="sourceCode" id="cb54"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/fmean.html">fmean</a></span><span class="op">(</span><span class="va">mtcars</span><span class="op">$</span><span class="va">mpg</span><span class="op">)</span> <span class="co"># Vector</span></span>
<span><span class="co"># [1] 20.09062</span></span>
<span></span>
<span><span class="fu"><a href="../reference/fmean.html">fmean</a></span><span class="op">(</span><span class="va">mtcars</span><span class="op">)</span></span>
<span><span class="co">#        mpg        cyl       disp         hp       drat         wt       qsec         vs         am </span></span>
<span><span class="co">#  20.090625   6.187500 230.721875 146.687500   3.596563   3.217250  17.848750   0.437500   0.406250 </span></span>
<span><span class="co">#       gear       carb </span></span>
<span><span class="co">#   3.687500   2.812500</span></span>
<span></span>
<span><span class="fu"><a href="../reference/fmean.html">fmean</a></span><span class="op">(</span><span class="va">mtcars</span>, drop <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>  <span class="co"># This returns a 1-row data-frame</span></span>
<span><span class="co">#        mpg    cyl     disp       hp     drat      wt     qsec     vs      am   gear   carb</span></span>
<span><span class="co"># 1 20.09062 6.1875 230.7219 146.6875 3.596563 3.21725 17.84875 0.4375 0.40625 3.6875 2.8125</span></span>
<span></span>
<span><span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/quick-conversion.html">qM</a></span><span class="op">(</span><span class="va">mtcars</span><span class="op">)</span> <span class="co"># Generate matrix</span></span>
<span><span class="fu"><a href="../reference/fmean.html">fmean</a></span><span class="op">(</span><span class="va">m</span><span class="op">)</span></span>
<span><span class="co">#        mpg        cyl       disp         hp       drat         wt       qsec         vs         am </span></span>
<span><span class="co">#  20.090625   6.187500 230.721875 146.687500   3.596563   3.217250  17.848750   0.437500   0.406250 </span></span>
<span><span class="co">#       gear       carb </span></span>
<span><span class="co">#   3.687500   2.812500</span></span>
<span></span>
<span><span class="fu"><a href="../reference/fmean.html">fmean</a></span><span class="op">(</span><span class="va">m</span>, drop <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>  <span class="co"># This returns a 1-row matrix</span></span>
<span><span class="co">#           mpg    cyl     disp       hp     drat      wt     qsec     vs      am   gear   carb</span></span>
<span><span class="co"># [1,] 20.09062 6.1875 230.7219 146.6875 3.596563 3.21725 17.84875 0.4375 0.40625 3.6875 2.8125</span></span></code></pre></div>
<p>Note that separate methods for vectors, matrices and data frames are
written in C++, thus no conversions are needed and computations on
matrices and data frames are equally efficient. If we had a weight
vector, weighted statistics are easily computed:</p>
<div class="sourceCode" id="cb55"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">weights</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fu"><a href="../reference/efficient-programming.html">fnrow</a></span><span class="op">(</span><span class="va">mtcars</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="co"># fnrow is a bit faster for data frames</span></span>
<span></span>
<span><span class="fu"><a href="../reference/fmean.html">fmean</a></span><span class="op">(</span><span class="va">mtcars</span>, w <span class="op">=</span> <span class="va">weights</span><span class="op">)</span> <span class="co"># Weighted mean</span></span>
<span><span class="co">#         mpg         cyl        disp          hp        drat          wt        qsec          vs </span></span>
<span><span class="co">#  20.8090714   5.8876772 214.9587303 142.8931066   3.7558442   3.0941361  17.8201120   0.5025300 </span></span>
<span><span class="co">#          am        gear        carb </span></span>
<span><span class="co">#   0.4918237   3.8375831   2.7771280</span></span>
<span><span class="fu"><a href="../reference/fnth_fmedian.html">fmedian</a></span><span class="op">(</span><span class="va">mtcars</span>, w <span class="op">=</span> <span class="va">weights</span><span class="op">)</span> <span class="co"># Weighted median</span></span>
<span><span class="co">#    mpg    cyl   disp     hp   drat     wt   qsec     vs     am   gear   carb </span></span>
<span><span class="co">#  21.00   6.00 160.00 113.00   3.77   3.17  18.00   1.00   0.00   4.00   2.00</span></span>
<span><span class="fu"><a href="../reference/fvar_fsd.html">fsd</a></span><span class="op">(</span><span class="va">mtcars</span>, w <span class="op">=</span> <span class="va">weights</span><span class="op">)</span> <span class="co"># Frequency-weighted standard deviation</span></span>
<span><span class="co">#         mpg         cyl        disp          hp        drat          wt        qsec          vs </span></span>
<span><span class="co">#   5.8799568   1.8416865 122.4274353  74.9459089   0.5413624   0.9689836   1.8516418   0.5089768 </span></span>
<span><span class="co">#          am        gear        carb </span></span>
<span><span class="co">#   0.5089152   0.7557877   1.6744062</span></span>
<span><span class="fu"><a href="../reference/fmode.html">fmode</a></span><span class="op">(</span><span class="va">mtcars</span>, w <span class="op">=</span> <span class="va">weights</span><span class="op">)</span> <span class="co"># Weighted statistical mode (i.e. the value with the largest sum of weights)</span></span>
<span><span class="co">#    mpg    cyl   disp     hp   drat     wt   qsec     vs     am   gear   carb </span></span>
<span><span class="co">#  21.40   4.00 121.00 109.00   3.92   2.78  18.60   1.00   0.00   4.00   2.00</span></span></code></pre></div>
<p>Fast grouped statistics can be calculated by simply passing grouping
vectors or lists of grouping vectors to the fast functions:</p>
<div class="sourceCode" id="cb56"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/fmean.html">fmean</a></span><span class="op">(</span><span class="va">mtcars</span>, <span class="va">mtcars</span><span class="op">$</span><span class="va">cyl</span><span class="op">)</span></span>
<span><span class="co">#        mpg cyl     disp        hp     drat       wt     qsec        vs        am     gear     carb</span></span>
<span><span class="co"># 4 26.66364   4 105.1364  82.63636 4.070909 2.285727 19.13727 0.9090909 0.7272727 4.090909 1.545455</span></span>
<span><span class="co"># 6 19.74286   6 183.3143 122.28571 3.585714 3.117143 17.97714 0.5714286 0.4285714 3.857143 3.428571</span></span>
<span><span class="co"># 8 15.10000   8 353.1000 209.21429 3.229286 3.999214 16.77214 0.0000000 0.1428571 3.285714 3.500000</span></span>
<span></span>
<span><span class="fu"><a href="../reference/fmean.html">fmean</a></span><span class="op">(</span><span class="va">mtcars</span>, <span class="fu"><a href="../reference/select_replace_vars.html">fselect</a></span><span class="op">(</span><span class="va">mtcars</span>, <span class="va">cyl</span>, <span class="va">vs</span>, <span class="va">am</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#            mpg cyl     disp        hp     drat       wt     qsec vs am     gear     carb</span></span>
<span><span class="co"># 4.0.1 26.00000   4 120.3000  91.00000 4.430000 2.140000 16.70000  0  1 5.000000 2.000000</span></span>
<span><span class="co"># 4.1.0 22.90000   4 135.8667  84.66667 3.770000 2.935000 20.97000  1  0 3.666667 1.666667</span></span>
<span><span class="co"># 4.1.1 28.37143   4  89.8000  80.57143 4.148571 2.028286 18.70000  1  1 4.142857 1.428571</span></span>
<span><span class="co"># 6.0.1 20.56667   6 155.0000 131.66667 3.806667 2.755000 16.32667  0  1 4.333333 4.666667</span></span>
<span><span class="co"># 6.1.0 19.12500   6 204.5500 115.25000 3.420000 3.388750 19.21500  1  0 3.500000 2.500000</span></span>
<span><span class="co"># 8.0.0 15.05000   8 357.6167 194.16667 3.120833 4.104083 17.14250  0  0 3.000000 3.083333</span></span>
<span><span class="co"># 8.0.1 15.40000   8 326.0000 299.50000 3.880000 3.370000 14.55000  0  1 5.000000 6.000000</span></span>
<span></span>
<span><span class="co"># Getting column indices</span></span>
<span><span class="va">ind</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/select_replace_vars.html">fselect</a></span><span class="op">(</span><span class="va">mtcars</span>, <span class="va">cyl</span>, <span class="va">vs</span>, <span class="va">am</span>, return <span class="op">=</span> <span class="st">"indices"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/fmean.html">fmean</a></span><span class="op">(</span><span class="fu"><a href="../reference/select_replace_vars.html">get_vars</a></span><span class="op">(</span><span class="va">mtcars</span>, <span class="op">-</span><span class="va">ind</span><span class="op">)</span>, <span class="fu"><a href="../reference/select_replace_vars.html">get_vars</a></span><span class="op">(</span><span class="va">mtcars</span>, <span class="va">ind</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#            mpg     disp        hp     drat       wt     qsec     gear     carb</span></span>
<span><span class="co"># 4.0.1 26.00000 120.3000  91.00000 4.430000 2.140000 16.70000 5.000000 2.000000</span></span>
<span><span class="co"># 4.1.0 22.90000 135.8667  84.66667 3.770000 2.935000 20.97000 3.666667 1.666667</span></span>
<span><span class="co"># 4.1.1 28.37143  89.8000  80.57143 4.148571 2.028286 18.70000 4.142857 1.428571</span></span>
<span><span class="co"># 6.0.1 20.56667 155.0000 131.66667 3.806667 2.755000 16.32667 4.333333 4.666667</span></span>
<span><span class="co"># 6.1.0 19.12500 204.5500 115.25000 3.420000 3.388750 19.21500 3.500000 2.500000</span></span>
<span><span class="co"># 8.0.0 15.05000 357.6167 194.16667 3.120833 4.104083 17.14250 3.000000 3.083333</span></span>
<span><span class="co"># 8.0.1 15.40000 326.0000 299.50000 3.880000 3.370000 14.55000 5.000000 6.000000</span></span></code></pre></div>
<!-- `get_vars` also subsets data.table columns and other data.frame-like classes, and is about 2x the speed of `[.data.frame`. Replacements of the form `get_vars(data, ind) <- newcols` are about 4x as fast as `data[ind] <- newcols`. It is also possible to subset with functions i.e. `get_vars(mtcars, is.ordered)` and regular expressions i.e. `get_vars(mtcars, c("c","v","a"), regex = TRUE)` or  `get_vars(mtcars, "c|v|a", regex = TRUE)`. Next to `get_vars` there are also the predicates `num_vars`, `cat_vars`, `char_vars`, `fact_vars`, `logi_vars` and `date_vars` to subset and replace data by type. -->
</div>
<div class="section level3">
<h3 id="factors-grouping-objects-and-grouped-data-frames">4.2 Factors, Grouping Objects and Grouped Data Frames<a class="anchor" aria-label="anchor" href="#factors-grouping-objects-and-grouped-data-frames"></a>
</h3>
<p>This programming can becomes more efficient when passing
<em>factors</em> or <em>grouping objects</em> to the <code>g</code>
argument, as otherwise vectors and lists of vectors are grouped
internally.</p>
<div class="sourceCode" id="cb57"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># This creates a factor, na.exclude = FALSE attaches a class 'na.included'</span></span>
<span><span class="va">f</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/qF.html">qF</a></span><span class="op">(</span><span class="va">mtcars</span><span class="op">$</span><span class="va">cyl</span>, na.exclude <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co"># The 'na.included' attribute skips a missing value check on this factor</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/attributes.html" class="external-link">attributes</a></span><span class="op">(</span><span class="va">f</span><span class="op">)</span></span>
<span><span class="co"># $levels</span></span>
<span><span class="co"># [1] "4" "6" "8"</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># $class</span></span>
<span><span class="co"># [1] "factor"      "na.included"</span></span>
<span><span class="co"># Saving data without grouping columns</span></span>
<span><span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/select_replace_vars.html">get_vars</a></span><span class="op">(</span><span class="va">mtcars</span>, <span class="op">-</span><span class="va">ind</span><span class="op">)</span></span>
<span><span class="co"># Grouped standard-deviation</span></span>
<span><span class="fu"><a href="../reference/fvar_fsd.html">fsd</a></span><span class="op">(</span><span class="va">dat</span>, <span class="va">f</span><span class="op">)</span></span>
<span><span class="co">#        mpg     disp       hp      drat        wt     qsec      gear     carb</span></span>
<span><span class="co"># 4 4.509828 26.87159 20.93453 0.3654711 0.5695637 1.682445 0.5393599 0.522233</span></span>
<span><span class="co"># 6 1.453567 41.56246 24.26049 0.4760552 0.3563455 1.706866 0.6900656 1.812654</span></span>
<span><span class="co"># 8 2.560048 67.77132 50.97689 0.3723618 0.7594047 1.196014 0.7262730 1.556624</span></span>
<span></span>
<span><span class="co"># Without option na.exclude = FALSE, anyNA needs to be called on the factor (noticeable on larger data).</span></span>
<span><span class="va">f2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/qF.html">qF</a></span><span class="op">(</span><span class="va">mtcars</span><span class="op">$</span><span class="va">cyl</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html" class="external-link">microbenchmark</a></span><span class="op">(</span><span class="fu"><a href="../reference/fvar_fsd.html">fsd</a></span><span class="op">(</span><span class="va">dat</span>, <span class="va">f</span><span class="op">)</span>, <span class="fu"><a href="../reference/fvar_fsd.html">fsd</a></span><span class="op">(</span><span class="va">dat</span>, <span class="va">f2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># Unit: microseconds</span></span>
<span><span class="co">#          expr   min    lq    mean median    uq    max neval</span></span>
<span><span class="co">#   fsd(dat, f) 6.027 6.232 6.51613 6.4165 6.601 11.152   100</span></span>
<span><span class="co">#  fsd(dat, f2) 6.150 6.396 6.77771 6.5190 6.683 25.830   100</span></span></code></pre></div>
<p>For programming purposes <em>GRP</em> objects are preferable over
factors because they never require further checks and they provide
additional information about the grouping (such as group sizes and the
original unique values in each group). The <code>GRP</code> function
creates grouping objects (of class <em>GRP</em>) from vectors or lists
of columns. Grouping is done very efficiently via radix ordering in C
(using the <code>radixorder</code> function):</p>
<div class="sourceCode" id="cb58"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># This creates a 'GRP' object.</span></span>
<span><span class="va">g</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/GRP.html">GRP</a></span><span class="op">(</span><span class="va">mtcars</span>, <span class="op">~</span> <span class="va">cyl</span> <span class="op">+</span> <span class="va">vs</span> <span class="op">+</span> <span class="va">am</span><span class="op">)</span> <span class="co"># Using the formula interface, could also use c("cyl","vs","am") or c(2,8:9)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">g</span><span class="op">)</span></span>
<span><span class="co"># Class 'GRP'  hidden list of 9</span></span>
<span><span class="co">#  $ N.groups    : int 7</span></span>
<span><span class="co">#  $ group.id    : int [1:32] 4 4 3 5 6 5 6 2 2 5 ...</span></span>
<span><span class="co">#  $ group.sizes : int [1:7] 1 3 7 3 4 12 2</span></span>
<span><span class="co">#  $ groups      :'data.frame': 7 obs. of  3 variables:</span></span>
<span><span class="co">#   ..$ cyl: num [1:7] 4 4 4 6 6 8 8</span></span>
<span><span class="co">#   ..$ vs : num [1:7] 0 1 1 0 1 0 0</span></span>
<span><span class="co">#   ..$ am : num [1:7] 1 0 1 1 0 0 1</span></span>
<span><span class="co">#  $ group.vars  : chr [1:3] "cyl" "vs" "am"</span></span>
<span><span class="co">#  $ ordered     : Named logi [1:2] TRUE FALSE</span></span>
<span><span class="co">#   ..- attr(*, "names")= chr [1:2] "ordered" "sorted"</span></span>
<span><span class="co">#  $ order       : int [1:32] 27 8 9 21 3 18 19 20 26 28 ...</span></span>
<span><span class="co">#   ..- attr(*, "starts")= int [1:7] 1 2 5 12 15 19 31</span></span>
<span><span class="co">#   ..- attr(*, "maxgrpn")= int 12</span></span>
<span><span class="co">#   ..- attr(*, "sorted")= logi FALSE</span></span>
<span><span class="co">#  $ group.starts: int [1:7] 27 8 3 1 4 5 29</span></span>
<span><span class="co">#  $ call        : language GRP.default(X = mtcars, by = ~cyl + vs + am)</span></span></code></pre></div>
<p>The first three elements of this object provide information about the
number of groups, the group to which each row belongs, and the size of
each group. A print and a plot method provide further information about
the grouping:</p>
<div class="sourceCode" id="cb59"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">g</span><span class="op">)</span></span>
<span><span class="co"># collapse grouping object of length 32 with 7 ordered groups</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># Call: GRP.default(X = mtcars, by = ~cyl + vs + am), X is unsorted</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># Distribution of group sizes: </span></span>
<span><span class="co">#    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. </span></span>
<span><span class="co">#   1.000   2.500   3.000   4.571   5.500  12.000 </span></span>
<span><span class="co"># </span></span>
<span><span class="co"># Groups with sizes: </span></span>
<span><span class="co"># 4.0.1 4.1.0 4.1.1 6.0.1 6.1.0 8.0.0 8.0.1 </span></span>
<span><span class="co">#     1     3     7     3     4    12     2</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">g</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="figure/GRPplot-1.png" alt="plot of chunk GRPplot" width="100%"><p class="caption">
plot of chunk GRPplot
</p>
</div>
<p>The important elements of the <em>GRP</em> object are directly handed
down to the compiled C++ code of the statistical functions, making
repeated computations over the same groups very efficient.</p>
<div class="sourceCode" id="cb60"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/fvar_fsd.html">fsd</a></span><span class="op">(</span><span class="va">dat</span>, <span class="va">g</span><span class="op">)</span></span>
<span><span class="co">#             mpg      disp       hp      drat        wt       qsec      gear      carb</span></span>
<span><span class="co"># 4.0.1        NA        NA       NA        NA        NA         NA        NA        NA</span></span>
<span><span class="co"># 4.1.0 1.4525839 13.969371 19.65536 0.1300000 0.4075230 1.67143651 0.5773503 0.5773503</span></span>
<span><span class="co"># 4.1.1 4.7577005 18.802128 24.14441 0.3783926 0.4400840 0.94546285 0.3779645 0.5345225</span></span>
<span><span class="co"># 6.0.1 0.7505553  8.660254 37.52777 0.1616581 0.1281601 0.76872188 0.5773503 1.1547005</span></span>
<span><span class="co"># 6.1.0 1.6317169 44.742634  9.17878 0.5919459 0.1162164 0.81590441 0.5773503 1.7320508</span></span>
<span><span class="co"># 8.0.0 2.7743959 71.823494 33.35984 0.2302749 0.7683069 0.80164745 0.0000000 0.9003366</span></span>
<span><span class="co"># 8.0.1 0.5656854 35.355339 50.20458 0.4808326 0.2828427 0.07071068 0.0000000 2.8284271</span></span>
<span></span>
<span><span class="co"># Grouped computation with and without prior grouping</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html" class="external-link">microbenchmark</a></span><span class="op">(</span><span class="fu"><a href="../reference/fvar_fsd.html">fsd</a></span><span class="op">(</span><span class="va">dat</span>, <span class="va">g</span><span class="op">)</span>, <span class="fu"><a href="../reference/fvar_fsd.html">fsd</a></span><span class="op">(</span><span class="va">dat</span>, <span class="fu"><a href="../reference/select_replace_vars.html">get_vars</a></span><span class="op">(</span><span class="va">mtcars</span>, <span class="va">ind</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># Unit: microseconds</span></span>
<span><span class="co">#                             expr    min      lq     mean  median      uq     max neval</span></span>
<span><span class="co">#                      fsd(dat, g) 19.065 21.1765 23.68447 22.9600 24.9690  38.909   100</span></span>
<span><span class="co">#  fsd(dat, get_vars(mtcars, ind)) 31.611 35.2600 44.56823 37.3715 41.1845 327.877   100</span></span></code></pre></div>
<!-- Note at this point that by default (`sort = TRUE`, `order = 1L`), groups are sorted in ascending order, corresponding to *data.table* grouping with `keyby`. The ordering can be reversed (`order = -1L`), or set individually for each of the 3 grouping columns (i.e. `order = c(1L, -1L, -1L)`). If `sort = FALSE`, the grouping is unordered corresponding to *data.table* grouping with `by`.  -->
<p>Yet another possibility is creating a grouped data frame (class
<em>grouped_df</em>). This can either be done using
<code><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">dplyr::group_by</a></code>, which creates a grouped tibble and
requires a conversion of the grouping object using
<code>GRP.grouped_df</code>, or using the more efficient
<code>fgroup_by</code> provided in <em>collapse</em>:</p>
<div class="sourceCode" id="cb61"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">gmtcars</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/GRP.html">fgroup_by</a></span><span class="op">(</span><span class="va">mtcars</span>, <span class="va">cyl</span>, <span class="va">vs</span>, <span class="va">am</span><span class="op">)</span> <span class="co"># fgroup_by() can also be abbreviated as gby()</span></span>
<span><span class="fu"><a href="../reference/fnth_fmedian.html">fmedian</a></span><span class="op">(</span><span class="va">gmtcars</span><span class="op">)</span></span>
<span><span class="co">#   cyl vs am   mpg  disp    hp  drat    wt  qsec gear carb</span></span>
<span><span class="co"># 1   4  0  1 26.00 120.3  91.0 4.430 2.140 16.70  5.0  2.0</span></span>
<span><span class="co"># 2   4  1  0 22.80 140.8  95.0 3.700 3.150 20.01  4.0  2.0</span></span>
<span><span class="co"># 3   4  1  1 30.40  79.0  66.0 4.080 1.935 18.61  4.0  1.0</span></span>
<span><span class="co"># 4   6  0  1 21.00 160.0 110.0 3.900 2.770 16.46  4.0  4.0</span></span>
<span><span class="co"># 5   6  1  0 18.65 196.3 116.5 3.500 3.440 19.17  3.5  2.5</span></span>
<span><span class="co"># 6   8  0  0 15.20 355.0 180.0 3.075 3.810 17.35  3.0  3.0</span></span>
<span><span class="co"># 7   8  0  1 15.40 326.0 299.5 3.880 3.370 14.55  5.0  6.0</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fu"><a href="../reference/GRP.html">fgroup_vars</a></span><span class="op">(</span><span class="va">gmtcars</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#                   cyl vs am</span></span>
<span><span class="co"># Mazda RX4           6  0  1</span></span>
<span><span class="co"># Mazda RX4 Wag       6  0  1</span></span>
<span><span class="co"># Datsun 710          4  1  1</span></span>
<span><span class="co"># Hornet 4 Drive      6  1  0</span></span>
<span><span class="co"># Hornet Sportabout   8  0  0</span></span>
<span><span class="co"># Valiant             6  1  0</span></span>
<span></span>
<span><span class="fu"><a href="../reference/fnth_fmedian.html">fmedian</a></span><span class="op">(</span><span class="va">gmtcars</span>, keep.group_vars <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co">#     mpg  disp    hp  drat    wt  qsec gear carb</span></span>
<span><span class="co"># 1 26.00 120.3  91.0 4.430 2.140 16.70  5.0  2.0</span></span>
<span><span class="co"># 2 22.80 140.8  95.0 3.700 3.150 20.01  4.0  2.0</span></span>
<span><span class="co"># 3 30.40  79.0  66.0 4.080 1.935 18.61  4.0  1.0</span></span>
<span><span class="co"># 4 21.00 160.0 110.0 3.900 2.770 16.46  4.0  4.0</span></span>
<span><span class="co"># 5 18.65 196.3 116.5 3.500 3.440 19.17  3.5  2.5</span></span>
<span><span class="co"># 6 15.20 355.0 180.0 3.075 3.810 17.35  3.0  3.0</span></span>
<span><span class="co"># 7 15.40 326.0 299.5 3.880 3.370 14.55  5.0  6.0</span></span></code></pre></div>
<!-- By default, both are ordered, but must not be. For multiple variables, `GRP` is always superior to creating multiple factors and interacting them, and it is also faster than `base::interaction` for lists of factors. -->
<!-- With factors or *GRP* objects, computations are faster since the fast functions would otherwise internally group the vectors every time they are executed. Compared to factors, grouped computations using `GRP` objects are a bit more efficient, primarily because they require no further checks, while factors are checked for missing values^[Because missing values are stored as the smallest integer in C++, and the values of the factor are used directly to index result vectors in grouped computations. Subsetting a vector with the smallest integer would break the C++ code of the *Fast Statistical Functions* and terminate the R session, which must be avoided.] unless a class '*na.included*' is attached. By default `qF` acts just like `as.factor` and preserves missing values when generating factors. Therefore the most effective way of programming with factors is to use `qF(x, na.exclude = FALSE)` to create the factor. This will create an underlying integer for `NA`'s and attach a class '*na.included*', so that no further checks are run on that factor in the *collapse* ecosystem. -->
<p>Now suppose we wanted to create a new dataset which contains the
<em>mean</em>, <em>sd</em>, <em>min</em> and <em>max</em> of the
variables <em>mpg</em> and <em>disp</em> grouped by <em>cyl</em>,
<em>vs</em> and <em>am</em>:</p>
<div class="sourceCode" id="cb62"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Standard evaluation</span></span>
<span><span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/select_replace_vars.html">get_vars</a></span><span class="op">(</span><span class="va">mtcars</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"mpg"</span>, <span class="st">"disp"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/select_replace_vars.html">add_vars</a></span><span class="op">(</span><span class="va">g</span><span class="op">[[</span><span class="st">"groups"</span><span class="op">]</span><span class="op">]</span>,</span>
<span>         <span class="fu"><a href="../reference/small-helpers.html">add_stub</a></span><span class="op">(</span><span class="fu"><a href="../reference/fmean.html">fmean</a></span><span class="op">(</span><span class="va">dat</span>, <span class="va">g</span>, use.g.names <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>, <span class="st">"mean_"</span><span class="op">)</span>,</span>
<span>         <span class="fu"><a href="../reference/small-helpers.html">add_stub</a></span><span class="op">(</span><span class="fu"><a href="../reference/fvar_fsd.html">fsd</a></span><span class="op">(</span><span class="va">dat</span>, <span class="va">g</span>, use.g.names <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>, <span class="st">"sd_"</span><span class="op">)</span>,</span>
<span>         <span class="fu"><a href="../reference/small-helpers.html">add_stub</a></span><span class="op">(</span><span class="fu"><a href="../reference/fmin_fmax.html">fmin</a></span><span class="op">(</span><span class="va">dat</span>, <span class="va">g</span>, use.g.names <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>, <span class="st">"min_"</span><span class="op">)</span>,</span>
<span>         <span class="fu"><a href="../reference/small-helpers.html">add_stub</a></span><span class="op">(</span><span class="fu"><a href="../reference/fmin_fmax.html">fmax</a></span><span class="op">(</span><span class="va">dat</span>, <span class="va">g</span>, use.g.names <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>, <span class="st">"max_"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#   cyl vs am mean_mpg mean_disp    sd_mpg   sd_disp min_mpg min_disp max_mpg max_disp</span></span>
<span><span class="co"># 1   4  0  1 26.00000  120.3000        NA        NA    26.0    120.3    26.0    120.3</span></span>
<span><span class="co"># 2   4  1  0 22.90000  135.8667 1.4525839 13.969371    21.5    120.1    24.4    146.7</span></span>
<span><span class="co"># 3   4  1  1 28.37143   89.8000 4.7577005 18.802128    21.4     71.1    33.9    121.0</span></span>
<span><span class="co"># 4   6  0  1 20.56667  155.0000 0.7505553  8.660254    19.7    145.0    21.0    160.0</span></span>
<span><span class="co"># 5   6  1  0 19.12500  204.5500 1.6317169 44.742634    17.8    167.6    21.4    258.0</span></span>
<span><span class="co"># 6   8  0  0 15.05000  357.6167 2.7743959 71.823494    10.4    275.8    19.2    472.0</span></span>
<span><span class="co"># 7   8  0  1 15.40000  326.0000 0.5656854 35.355339    15.0    301.0    15.8    351.0</span></span>
<span></span>
<span><span class="co"># Non-Standard evaluation</span></span>
<span><span class="fu"><a href="../reference/GRP.html">fgroup_by</a></span><span class="op">(</span><span class="va">mtcars</span>, <span class="va">cyl</span>, <span class="va">vs</span>, <span class="va">am</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="../reference/select_replace_vars.html">fselect</a></span><span class="op">(</span><span class="va">mpg</span>, <span class="va">disp</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="../reference/select_replace_vars.html">add_vars</a></span><span class="op">(</span><span class="fu"><a href="../reference/GRP.html">fgroup_vars</a></span><span class="op">(</span><span class="va">.</span>, <span class="st">"unique"</span><span class="op">)</span>,</span>
<span>           <span class="fu"><a href="../reference/fmean.html">fmean</a></span><span class="op">(</span><span class="va">.</span>, keep.group_vars <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="../reference/small-helpers.html">add_stub</a></span><span class="op">(</span><span class="st">"mean_"</span><span class="op">)</span>,</span>
<span>           <span class="fu"><a href="../reference/fvar_fsd.html">fsd</a></span><span class="op">(</span><span class="va">.</span>, keep.group_vars <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="../reference/small-helpers.html">add_stub</a></span><span class="op">(</span><span class="st">"sd_"</span><span class="op">)</span>,</span>
<span>           <span class="fu"><a href="../reference/fmin_fmax.html">fmin</a></span><span class="op">(</span><span class="va">.</span>, keep.group_vars <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="../reference/small-helpers.html">add_stub</a></span><span class="op">(</span><span class="st">"min_"</span><span class="op">)</span>,</span>
<span>           <span class="fu"><a href="../reference/fmin_fmax.html">fmax</a></span><span class="op">(</span><span class="va">.</span>, keep.group_vars <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="../reference/small-helpers.html">add_stub</a></span><span class="op">(</span><span class="st">"max_"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#   cyl vs am mean_mpg mean_disp    sd_mpg   sd_disp min_mpg min_disp max_mpg max_disp</span></span>
<span><span class="co"># 1   4  0  1 26.00000  120.3000        NA        NA    26.0    120.3    26.0    120.3</span></span>
<span><span class="co"># 2   4  1  0 22.90000  135.8667 1.4525839 13.969371    21.5    120.1    24.4    146.7</span></span>
<span><span class="co"># 3   4  1  1 28.37143   89.8000 4.7577005 18.802128    21.4     71.1    33.9    121.0</span></span>
<span><span class="co"># 4   6  0  1 20.56667  155.0000 0.7505553  8.660254    19.7    145.0    21.0    160.0</span></span>
<span><span class="co"># 5   6  1  0 19.12500  204.5500 1.6317169 44.742634    17.8    167.6    21.4    258.0</span></span>
<span><span class="co"># 6   8  0  0 15.05000  357.6167 2.7743959 71.823494    10.4    275.8    19.2    472.0</span></span>
<span><span class="co"># 7   8  0  1 15.40000  326.0000 0.5656854 35.355339    15.0    301.0    15.8    351.0</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="grouped-and-weighted-computations">4.3 Grouped and Weighted Computations<a class="anchor" aria-label="anchor" href="#grouped-and-weighted-computations"></a>
</h3>
<!-- , and we could decide to include the original grouping columns and omit the generated row-names, as shown below -->
<p>We could also calculate groupwise-frequency weighted means and
standard-deviations using a weight vector<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content='&lt;p&gt;You may wonder why with weights the standard-deviations
in the group ‘4.0.1’ are &lt;code&gt;0&lt;/code&gt; while they were &lt;code&gt;NA&lt;/code&gt;
without weights. This stirs from the fact that group ‘4.0.1’ only has
one observation, and in the Bessel-corrected estimate of the variance
there is a &lt;code&gt;n - 1&lt;/code&gt; in the denominator which becomes
&lt;code&gt;0&lt;/code&gt; if &lt;code&gt;n = 1&lt;/code&gt; and division by &lt;code&gt;0&lt;/code&gt;
becomes &lt;code&gt;NA&lt;/code&gt; in this case (&lt;code&gt;fvar&lt;/code&gt; was designed
that way to match the behavior or &lt;code&gt;&lt;a href="https://rdrr.io/r/stats/cor.html" class="external-link"&gt;stats::var&lt;/a&gt;&lt;/code&gt;). In the
weighted version the denominator is &lt;code&gt;sum(w) - 1&lt;/code&gt;, and if
&lt;code&gt;sum(w)&lt;/code&gt; is not 1, then the denominator is not
&lt;code&gt;0&lt;/code&gt;. The standard-deviation however is still &lt;code&gt;0&lt;/code&gt;
because the sum of squares in the numerator is &lt;code&gt;0&lt;/code&gt;. In other
words this means that in a weighted aggregation singleton-groups are not
treated like singleton groups unless the corresponding weight is
&lt;code&gt;1&lt;/code&gt;.&lt;/p&gt;'><sup>2</sup></a>.</p>
<!-- There is also a *collapse* predicate `add_vars` which serves as a much faster and more versatile alternative to `cbind.data.frame`. The intention behind `add_vars` is to be able to efficiently add multiple columns to an existing data.frame. Thus in a call `add_vars(data, newcols1, newcols2)`, `newcols1` and `newcols2` are added (by default) at the end of `data`, while preserving all attributes of `data`. -->
<div class="sourceCode" id="cb63"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Grouped and weighted mean and sd and grouped min and max</span></span>
<span><span class="fu"><a href="../reference/select_replace_vars.html">add_vars</a></span><span class="op">(</span><span class="va">g</span><span class="op">[[</span><span class="st">"groups"</span><span class="op">]</span><span class="op">]</span>,</span>
<span>         <span class="fu"><a href="../reference/small-helpers.html">add_stub</a></span><span class="op">(</span><span class="fu"><a href="../reference/fmean.html">fmean</a></span><span class="op">(</span><span class="va">dat</span>, <span class="va">g</span>, <span class="va">weights</span>, use.g.names <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>, <span class="st">"w_mean_"</span><span class="op">)</span>,</span>
<span>         <span class="fu"><a href="../reference/small-helpers.html">add_stub</a></span><span class="op">(</span><span class="fu"><a href="../reference/fvar_fsd.html">fsd</a></span><span class="op">(</span><span class="va">dat</span>, <span class="va">g</span>, <span class="va">weights</span>, use.g.names <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>, <span class="st">"w_sd_"</span><span class="op">)</span>,</span>
<span>         <span class="fu"><a href="../reference/small-helpers.html">add_stub</a></span><span class="op">(</span><span class="fu"><a href="../reference/fmin_fmax.html">fmin</a></span><span class="op">(</span><span class="va">dat</span>, <span class="va">g</span>, use.g.names <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>, <span class="st">"min_"</span><span class="op">)</span>,</span>
<span>         <span class="fu"><a href="../reference/small-helpers.html">add_stub</a></span><span class="op">(</span><span class="fu"><a href="../reference/fmin_fmax.html">fmax</a></span><span class="op">(</span><span class="va">dat</span>, <span class="va">g</span>, use.g.names <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>, <span class="st">"max_"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#   cyl vs am w_mean_mpg w_mean_disp  w_sd_mpg w_sd_disp min_mpg min_disp max_mpg max_disp</span></span>
<span><span class="co"># 1   4  0  1   26.00000   120.30000 0.0000000   0.00000    26.0    120.3    26.0    120.3</span></span>
<span><span class="co"># 2   4  1  0   23.08757   136.62639 1.5306081  14.19412    21.5    120.1    24.4    146.7</span></span>
<span><span class="co"># 3   4  1  1   27.34688    92.65353 4.8723476  21.44005    21.4     71.1    33.9    121.0</span></span>
<span><span class="co"># 4   6  0  1   20.22046   151.00525 0.9349875  10.78832    19.7    145.0    21.0    160.0</span></span>
<span><span class="co"># 5   6  1  0   19.52725   204.86661 1.7612203  50.80083    17.8    167.6    21.4    258.0</span></span>
<span><span class="co"># 6   8  0  0   15.12267   359.56902 2.2886672  70.60949    10.4    275.8    19.2    472.0</span></span>
<span><span class="co"># 7   8  0  1   15.51023   332.88960 0.4758366  29.73979    15.0    301.0    15.8    351.0</span></span>
<span></span>
<span><span class="co"># Binding and reordering columns in a single step: Add columns in specific positions</span></span>
<span><span class="fu"><a href="../reference/select_replace_vars.html">add_vars</a></span><span class="op">(</span><span class="va">g</span><span class="op">[[</span><span class="st">"groups"</span><span class="op">]</span><span class="op">]</span>,</span>
<span>         <span class="fu"><a href="../reference/small-helpers.html">add_stub</a></span><span class="op">(</span><span class="fu"><a href="../reference/fmean.html">fmean</a></span><span class="op">(</span><span class="va">dat</span>, <span class="va">g</span>, <span class="va">weights</span>, use.g.names <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>, <span class="st">"w_mean_"</span><span class="op">)</span>,</span>
<span>         <span class="fu"><a href="../reference/small-helpers.html">add_stub</a></span><span class="op">(</span><span class="fu"><a href="../reference/fvar_fsd.html">fsd</a></span><span class="op">(</span><span class="va">dat</span>, <span class="va">g</span>, <span class="va">weights</span>, use.g.names <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>, <span class="st">"w_sd_"</span><span class="op">)</span>,</span>
<span>         <span class="fu"><a href="../reference/small-helpers.html">add_stub</a></span><span class="op">(</span><span class="fu"><a href="../reference/fmin_fmax.html">fmin</a></span><span class="op">(</span><span class="va">dat</span>, <span class="va">g</span>, use.g.names <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>, <span class="st">"min_"</span><span class="op">)</span>,</span>
<span>         <span class="fu"><a href="../reference/small-helpers.html">add_stub</a></span><span class="op">(</span><span class="fu"><a href="../reference/fmin_fmax.html">fmax</a></span><span class="op">(</span><span class="va">dat</span>, <span class="va">g</span>, use.g.names <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>, <span class="st">"max_"</span><span class="op">)</span>,</span>
<span>         pos <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4</span>,<span class="fl">8</span>,<span class="fl">5</span>,<span class="fl">9</span>,<span class="fl">6</span>,<span class="fl">10</span>,<span class="fl">7</span>,<span class="fl">11</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#   cyl vs am w_mean_mpg  w_sd_mpg min_mpg max_mpg w_mean_disp w_sd_disp min_disp max_disp</span></span>
<span><span class="co"># 1   4  0  1   26.00000 0.0000000    26.0    26.0   120.30000   0.00000    120.3    120.3</span></span>
<span><span class="co"># 2   4  1  0   23.08757 1.5306081    21.5    24.4   136.62639  14.19412    120.1    146.7</span></span>
<span><span class="co"># 3   4  1  1   27.34688 4.8723476    21.4    33.9    92.65353  21.44005     71.1    121.0</span></span>
<span><span class="co"># 4   6  0  1   20.22046 0.9349875    19.7    21.0   151.00525  10.78832    145.0    160.0</span></span>
<span><span class="co"># 5   6  1  0   19.52725 1.7612203    17.8    21.4   204.86661  50.80083    167.6    258.0</span></span>
<span><span class="co"># 6   8  0  0   15.12267 2.2886672    10.4    19.2   359.56902  70.60949    275.8    472.0</span></span>
<span><span class="co"># 7   8  0  1   15.51023 0.4758366    15.0    15.8   332.88960  29.73979    301.0    351.0</span></span></code></pre></div>
<p>The R overhead of this kind of programming in standard-evaluation is
very low:</p>
<div class="sourceCode" id="cb64"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html" class="external-link">microbenchmark</a></span><span class="op">(</span>call <span class="op">=</span> <span class="fu"><a href="../reference/select_replace_vars.html">add_vars</a></span><span class="op">(</span><span class="va">g</span><span class="op">[[</span><span class="st">"groups"</span><span class="op">]</span><span class="op">]</span>,</span>
<span>         <span class="fu"><a href="../reference/small-helpers.html">add_stub</a></span><span class="op">(</span><span class="fu"><a href="../reference/fmean.html">fmean</a></span><span class="op">(</span><span class="va">dat</span>, <span class="va">g</span>, <span class="va">weights</span>, use.g.names <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>, <span class="st">"w_mean_"</span><span class="op">)</span>,</span>
<span>         <span class="fu"><a href="../reference/small-helpers.html">add_stub</a></span><span class="op">(</span><span class="fu"><a href="../reference/fvar_fsd.html">fsd</a></span><span class="op">(</span><span class="va">dat</span>, <span class="va">g</span>, <span class="va">weights</span>, use.g.names <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>, <span class="st">"w_sd_"</span><span class="op">)</span>,</span>
<span>         <span class="fu"><a href="../reference/small-helpers.html">add_stub</a></span><span class="op">(</span><span class="fu"><a href="../reference/fmin_fmax.html">fmin</a></span><span class="op">(</span><span class="va">dat</span>, <span class="va">g</span>, use.g.names <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>, <span class="st">"min_"</span><span class="op">)</span>,</span>
<span>         <span class="fu"><a href="../reference/small-helpers.html">add_stub</a></span><span class="op">(</span><span class="fu"><a href="../reference/fmin_fmax.html">fmax</a></span><span class="op">(</span><span class="va">dat</span>, <span class="va">g</span>, use.g.names <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>, <span class="st">"max_"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># Unit: microseconds</span></span>
<span><span class="co">#  expr    min      lq     mean median     uq   max neval</span></span>
<span><span class="co">#  call 27.388 28.1875 29.56428 28.823 29.356 97.58   100</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="transformations-using-the-tra-argument">4.4 Transformations Using the <code>TRA</code> Argument<a class="anchor" aria-label="anchor" href="#transformations-using-the-tra-argument"></a>
</h3>
<p>As a final layer of added complexity, we could utilize the
<code>TRA</code> argument to generate groupwise-weighted demeaned, and
scaled data, with additional columns giving the group-minimum and
maximum values:</p>
<div class="sourceCode" id="cb65"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fu"><a href="../reference/select_replace_vars.html">add_vars</a></span><span class="op">(</span><span class="fu"><a href="../reference/select_replace_vars.html">get_vars</a></span><span class="op">(</span><span class="va">mtcars</span>, <span class="va">ind</span><span class="op">)</span>,</span>
<span>              <span class="fu"><a href="../reference/small-helpers.html">add_stub</a></span><span class="op">(</span><span class="fu"><a href="../reference/fmean.html">fmean</a></span><span class="op">(</span><span class="va">dat</span>, <span class="va">g</span>, <span class="va">weights</span>, <span class="st">"-"</span><span class="op">)</span>, <span class="st">"w_demean_"</span><span class="op">)</span>, <span class="co"># This calculates weighted group means and uses them to demean the data</span></span>
<span>              <span class="fu"><a href="../reference/small-helpers.html">add_stub</a></span><span class="op">(</span><span class="fu"><a href="../reference/fvar_fsd.html">fsd</a></span><span class="op">(</span><span class="va">dat</span>, <span class="va">g</span>, <span class="va">weights</span>, <span class="st">"/"</span><span class="op">)</span>, <span class="st">"w_scale_"</span><span class="op">)</span>,    <span class="co"># This calculates weighted group sd's and uses them to scale the data</span></span>
<span>              <span class="fu"><a href="../reference/small-helpers.html">add_stub</a></span><span class="op">(</span><span class="fu"><a href="../reference/fmin_fmax.html">fmin</a></span><span class="op">(</span><span class="va">dat</span>, <span class="va">g</span>, <span class="st">"replace"</span><span class="op">)</span>, <span class="st">"min_"</span><span class="op">)</span>,          <span class="co"># This replaces all observations by their group-minimum</span></span>
<span>              <span class="fu"><a href="../reference/small-helpers.html">add_stub</a></span><span class="op">(</span><span class="fu"><a href="../reference/fmin_fmax.html">fmax</a></span><span class="op">(</span><span class="va">dat</span>, <span class="va">g</span>, <span class="st">"replace"</span><span class="op">)</span>, <span class="st">"max_"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>         <span class="co"># This replaces all observations by their group-maximum</span></span>
<span><span class="co">#                   cyl vs am w_demean_mpg w_demean_disp w_scale_mpg w_scale_disp min_mpg min_disp</span></span>
<span><span class="co"># Mazda RX4           6  0  1    0.7795446     8.9947455   22.460194    14.830858    19.7    145.0</span></span>
<span><span class="co"># Mazda RX4 Wag       6  0  1    0.7795446     8.9947455   22.460194    14.830858    19.7    145.0</span></span>
<span><span class="co"># Datsun 710          4  1  1   -4.5468786    15.3464694    4.679469     5.037303    21.4     71.1</span></span>
<span><span class="co"># Hornet 4 Drive      6  1  0    1.8727485    53.1333901   12.150666     5.078657    17.8    167.6</span></span>
<span><span class="co"># Hornet Sportabout   8  0  0    3.5773335     0.4309751    8.170694     5.098465    10.4    275.8</span></span>
<span><span class="co"># Valiant             6  1  0   -1.4272515    20.1333901   10.276966     4.429062    17.8    167.6</span></span>
<span><span class="co">#                   max_mpg max_disp</span></span>
<span><span class="co"># Mazda RX4            21.0      160</span></span>
<span><span class="co"># Mazda RX4 Wag        21.0      160</span></span>
<span><span class="co"># Datsun 710           33.9      121</span></span>
<span><span class="co"># Hornet 4 Drive       21.4      258</span></span>
<span><span class="co"># Hornet Sportabout    19.2      472</span></span>
<span><span class="co"># Valiant              21.4      258</span></span></code></pre></div>
<p>It is also possible to <code>add_vars&lt;-</code> to
<code>mtcars</code> itself. The default option would add these columns
at the end, but we could also specify positions:</p>
<div class="sourceCode" id="cb66"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># This defines the positions where we want to add these columns</span></span>
<span><span class="va">pos</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">8</span>,<span class="fl">3</span>,<span class="fl">9</span>,<span class="fl">4</span>,<span class="fl">10</span>,<span class="fl">5</span>,<span class="fl">11</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/select_replace_vars.html">add_vars</a></span><span class="op">(</span><span class="va">mtcars</span>, <span class="va">pos</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="../reference/small-helpers.html">add_stub</a></span><span class="op">(</span><span class="fu"><a href="../reference/fmean.html">fmean</a></span><span class="op">(</span><span class="va">dat</span>, <span class="va">g</span>, <span class="va">weights</span>, <span class="st">"-"</span><span class="op">)</span>, <span class="st">"w_demean_"</span><span class="op">)</span>,</span>
<span>                           <span class="fu"><a href="../reference/small-helpers.html">add_stub</a></span><span class="op">(</span><span class="fu"><a href="../reference/fvar_fsd.html">fsd</a></span><span class="op">(</span><span class="va">dat</span>, <span class="va">g</span>, <span class="va">weights</span>, <span class="st">"/"</span><span class="op">)</span>, <span class="st">"w_scale_"</span><span class="op">)</span>,</span>
<span>                           <span class="fu"><a href="../reference/small-helpers.html">add_stub</a></span><span class="op">(</span><span class="fu"><a href="../reference/fmin_fmax.html">fmin</a></span><span class="op">(</span><span class="va">dat</span>, <span class="va">g</span>, <span class="st">"replace"</span><span class="op">)</span>, <span class="st">"min_"</span><span class="op">)</span>,</span>
<span>                           <span class="fu"><a href="../reference/small-helpers.html">add_stub</a></span><span class="op">(</span><span class="fu"><a href="../reference/fmin_fmax.html">fmax</a></span><span class="op">(</span><span class="va">dat</span>, <span class="va">g</span>, <span class="st">"replace"</span><span class="op">)</span>, <span class="st">"max_"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">mtcars</span><span class="op">)</span></span>
<span><span class="co">#                    mpg w_demean_mpg w_scale_mpg min_mpg max_mpg cyl disp w_demean_disp w_scale_disp</span></span>
<span><span class="co"># Mazda RX4         21.0    0.7795446   22.460194    19.7    21.0   6  160     8.9947455    14.830858</span></span>
<span><span class="co"># Mazda RX4 Wag     21.0    0.7795446   22.460194    19.7    21.0   6  160     8.9947455    14.830858</span></span>
<span><span class="co"># Datsun 710        22.8   -4.5468786    4.679469    21.4    33.9   4  108    15.3464694     5.037303</span></span>
<span><span class="co"># Hornet 4 Drive    21.4    1.8727485   12.150666    17.8    21.4   6  258    53.1333901     5.078657</span></span>
<span><span class="co"># Hornet Sportabout 18.7    3.5773335    8.170694    10.4    19.2   8  360     0.4309751     5.098465</span></span>
<span><span class="co"># Valiant           18.1   -1.4272515   10.276966    17.8    21.4   6  225    20.1333901     4.429062</span></span>
<span><span class="co">#                   min_disp max_disp  hp drat    wt  qsec vs am gear carb</span></span>
<span><span class="co"># Mazda RX4            145.0      160 110 3.90 2.620 16.46  0  1    4    4</span></span>
<span><span class="co"># Mazda RX4 Wag        145.0      160 110 3.90 2.875 17.02  0  1    4    4</span></span>
<span><span class="co"># Datsun 710            71.1      121  93 3.85 2.320 18.61  1  1    4    1</span></span>
<span><span class="co"># Hornet 4 Drive       167.6      258 110 3.08 3.215 19.44  1  0    3    1</span></span>
<span><span class="co"># Hornet Sportabout    275.8      472 175 3.15 3.440 17.02  0  0    3    2</span></span>
<span><span class="co"># Valiant              167.6      258 105 2.76 3.460 20.22  1  0    3    1</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/rm.html" class="external-link">rm</a></span><span class="op">(</span><span class="va">mtcars</span><span class="op">)</span></span></code></pre></div>
<p>Together with <code>ftransform</code>, things can become arbitrarily
more complex:</p>
<div class="sourceCode" id="cb67"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 2 different grouped and weighted computations (mutate operations) performed in one call</span></span>
<span><span class="fu"><a href="../reference/ftransform.html">settransform</a></span><span class="op">(</span><span class="va">mtcars</span>, carb_dwmed_cyl <span class="op">=</span> <span class="fu"><a href="../reference/fnth_fmedian.html">fmedian</a></span><span class="op">(</span><span class="va">carb</span>, <span class="va">cyl</span>, <span class="va">weights</span>, <span class="st">"-"</span><span class="op">)</span>,</span>
<span>                     carb_wsd_vs_am <span class="op">=</span> <span class="fu"><a href="../reference/fvar_fsd.html">fsd</a></span><span class="op">(</span><span class="va">carb</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">vs</span>, <span class="va">am</span><span class="op">)</span>, <span class="va">weights</span>, <span class="st">"replace"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Multivariate</span></span>
<span><span class="fu"><a href="../reference/ftransform.html">settransform</a></span><span class="op">(</span><span class="va">mtcars</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="../reference/fnth_fmedian.html">fmedian</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>carb_dwmed_cyl <span class="op">=</span> <span class="va">carb</span>, mpg_dwmed_cyl <span class="op">=</span> <span class="va">mpg</span><span class="op">)</span>, <span class="va">cyl</span>, <span class="va">weights</span>, <span class="st">"-"</span><span class="op">)</span>,</span>
<span>                      <span class="fu"><a href="../reference/fvar_fsd.html">fsd</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>carb_wsd_vs_am <span class="op">=</span> <span class="va">carb</span>, mpg_wsd_vs_am <span class="op">=</span> <span class="va">mpg</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">vs</span>, <span class="va">am</span><span class="op">)</span>, <span class="va">weights</span>, <span class="st">"replace"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Nested (Computing the weighted 3rd quartile of mpg, grouped by cyl and carb being greater than it's weighted median, grouped by vs)</span></span>
<span><span class="fu"><a href="../reference/ftransform.html">settransform</a></span><span class="op">(</span><span class="va">mtcars</span>,</span>
<span> mpg_gwQ3_cyl <span class="op">=</span> <span class="fu"><a href="../reference/fnth_fmedian.html">fnth</a></span><span class="op">(</span><span class="va">mpg</span>, <span class="fl">0.75</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">cyl</span>, <span class="va">carb</span> <span class="op">&gt;</span> <span class="fu"><a href="../reference/fnth_fmedian.html">fmedian</a></span><span class="op">(</span><span class="va">carb</span>, <span class="va">vs</span>, <span class="va">weights</span>, <span class="fl">1L</span><span class="op">)</span><span class="op">)</span>, <span class="va">weights</span>, <span class="fl">1L</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">mtcars</span><span class="op">)</span></span>
<span><span class="co">#                    mpg cyl disp  hp drat    wt  qsec vs am gear carb carb_dwmed_cyl carb_wsd_vs_am</span></span>
<span><span class="co"># Mazda RX4         21.0   6  160 110 3.90 2.620 16.46  0  1    4    4              0      2.1897386</span></span>
<span><span class="co"># Mazda RX4 Wag     21.0   6  160 110 3.90 2.875 17.02  0  1    4    4              0      2.1897386</span></span>
<span><span class="co"># Datsun 710        22.8   4  108  93 3.85 2.320 18.61  1  1    4    1             -1      0.5286617</span></span>
<span><span class="co"># Hornet 4 Drive    21.4   6  258 110 3.08 3.215 19.44  1  0    3    1             -3      1.3161442</span></span>
<span><span class="co"># Hornet Sportabout 18.7   8  360 175 3.15 3.440 17.02  0  0    3    2             -2      0.9674070</span></span>
<span><span class="co"># Valiant           18.1   6  225 105 2.76 3.460 20.22  1  0    3    1             -3      1.3161442</span></span>
<span><span class="co">#                   mpg_dwmed_cyl mpg_wsd_vs_am mpg_gwQ3_cyl</span></span>
<span><span class="co"># Mazda RX4                   1.3      4.567045     21.40000</span></span>
<span><span class="co"># Mazda RX4 Wag               1.3      4.567045     21.40000</span></span>
<span><span class="co"># Datsun 710                 -3.2      4.872348     27.95146</span></span>
<span><span class="co"># Hornet 4 Drive              1.7      2.444036     21.40000</span></span>
<span><span class="co"># Hornet Sportabout           3.5      2.288667     16.21512</span></span>
<span><span class="co"># Valiant                    -1.6      2.444036     21.40000</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/rm.html" class="external-link">rm</a></span><span class="op">(</span><span class="va">mtcars</span><span class="op">)</span></span></code></pre></div>
<p>With the full set of 14 <em>Fast Statistical Functions</em>, and
additional vector- valued functions and operators
(<code>fscale/STD, fbetween/B, fwithin/W, fhdbetween/HDB, fhdwithin/HDW, flag/L/F, fdiff/D, fgrowth/G</code>)
discussed later, <em>collapse</em> provides extraordinary new
possibilities for highly complex and efficient statistical programming
in R. Computation speeds generally exceed those of packages like
<em>dplyr</em> or <em>data.table</em>, sometimes by orders of magnitude.
Column-wise matrix computations are also highly efficient and comparable
to packages like <code>matrixStats</code> and base R functions like
<code>colSums</code>. In particular the ability to perform grouped and
weighted computations on matrices is new to R and very useful for
complex computations (such as aggregating input-output tables etc.).</p>
<p>Note that the above examples provide merely suggestions for use of
these features and are focused on programming with data frames (as the
predicates <code>get_vars</code>, <code>add_vars</code> etc. are made
for data frames). Equivalently efficient code could be written using
vectors or matrices.</p>
<!-- comparable to `column-wise computations on matrices are also slightly faster than `base` functions like `colMeans`, `colSums` etc. especially in the presence of missing values.  -->
</div>
</div>
<div class="section level2">
<h2 id="advanced-data-aggregation">5. Advanced Data Aggregation<a class="anchor" aria-label="anchor" href="#advanced-data-aggregation"></a>
</h2>
<p>The grouped statistical programming introduced in the previous
section is the fastest and most customizable way of dealing with many
data transformation problems. Some tasks such as multivariate
aggregations on a single data frame are however so common that this
demanded for a more compact solution which efficiently integrates
multiple computational steps.</p>
<p>For such purposes <code>collap</code> was created as a fast
multi-purpose aggregation command designed to solve complex aggregation
problems efficiently and with a minimum of coding. <code>collap</code>
performs optimally together with the <em>Fast Statistical
Functions</em>, but will also work with other functions.</p>
<p>To perform the above aggregation with <code>collap</code>, one would
simply need to type:</p>
<!-- ^[One can also add a weight-argument `w = weights` here, but `fmin` and `fmax` don't support weights and all S3 methods in this package give errors when encountering unknown arguments. To do a weighted aggregation one would have to either only use `fmean` and `fsd`, or employ a named list of functions wrapping `fmin` and `fmax` in a way that additional arguments are silently swallowed.]: -->
<div class="sourceCode" id="cb68"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/collap.html">collap</a></span><span class="op">(</span><span class="va">mtcars</span>, <span class="va">mpg</span> <span class="op">+</span> <span class="va">disp</span> <span class="op">~</span> <span class="va">cyl</span> <span class="op">+</span> <span class="va">vs</span> <span class="op">+</span> <span class="va">am</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">fmean</span>, <span class="va">fsd</span>, <span class="va">fmin</span>, <span class="va">fmax</span><span class="op">)</span>,</span>
<span>       w <span class="op">=</span> <span class="va">weights</span>, keep.col.order <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co">#   cyl vs am  weights fmean.mpg fmean.disp   fsd.mpg fsd.disp fmin.mpg fmin.disp fmax.mpg fmax.disp</span></span>
<span><span class="co"># 1   4  0  1 1.416054  26.00000  120.30000 0.0000000  0.00000     26.0     120.3     26.0     120.3</span></span>
<span><span class="co"># 2   4  1  0 3.232217  23.08757  136.62639 1.5306081 14.19412     21.5     120.1     24.4     146.7</span></span>
<span><span class="co"># 3   4  1  1 7.893395  27.34688   92.65353 4.8723476 21.44005     21.4      71.1     33.9     121.0</span></span>
<span><span class="co"># 4   6  0  1 1.866025  20.22046  151.00525 0.9349875 10.78832     19.7     145.0     21.0     160.0</span></span>
<span><span class="co"># 5   6  1  0 3.237565  19.52725  204.86661 1.7612203 50.80083     17.8     167.6     21.4     258.0</span></span>
<span><span class="co"># 6   8  0  0 8.054777  15.12267  359.56902 2.2886672 70.60949     10.4     275.8     19.2     472.0</span></span>
<span><span class="co"># 7   8  0  1 2.881698  15.51023  332.88960 0.4758366 29.73979     15.0     301.0     15.8     351.0</span></span></code></pre></div>
<p><code>collap</code> here also saves the sum of the weights in a
column. The original idea behind <code>collap</code> is however better
demonstrated with a different dataset. Consider the <em>World
Development Dataset</em> <code>wlddev</code> introduced in section
1:</p>
<div class="sourceCode" id="cb69"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">wlddev</span><span class="op">)</span></span>
<span><span class="co">#       country iso3c       date year decade     region     income  OECD PCGDP LIFEEX GINI       ODA</span></span>
<span><span class="co"># 1 Afghanistan   AFG 1961-01-01 1960   1960 South Asia Low income FALSE    NA 32.446   NA 116769997</span></span>
<span><span class="co"># 2 Afghanistan   AFG 1962-01-01 1961   1960 South Asia Low income FALSE    NA 32.962   NA 232080002</span></span>
<span><span class="co"># 3 Afghanistan   AFG 1963-01-01 1962   1960 South Asia Low income FALSE    NA 33.471   NA 112839996</span></span>
<span><span class="co"># 4 Afghanistan   AFG 1964-01-01 1963   1960 South Asia Low income FALSE    NA 33.971   NA 237720001</span></span>
<span><span class="co"># 5 Afghanistan   AFG 1965-01-01 1964   1960 South Asia Low income FALSE    NA 34.463   NA 295920013</span></span>
<span><span class="co"># 6 Afghanistan   AFG 1966-01-01 1965   1960 South Asia Low income FALSE    NA 34.948   NA 341839996</span></span>
<span><span class="co">#       POP</span></span>
<span><span class="co"># 1 8996973</span></span>
<span><span class="co"># 2 9169410</span></span>
<span><span class="co"># 3 9351441</span></span>
<span><span class="co"># 4 9543205</span></span>
<span><span class="co"># 5 9744781</span></span>
<span><span class="co"># 6 9956320</span></span></code></pre></div>
<p>Suppose we would like to aggregate this data by country and decade,
but keep all that categorical information. With <code>collap</code> this
is extremely simple:</p>
<div class="sourceCode" id="cb70"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/collap.html">collap</a></span><span class="op">(</span><span class="va">wlddev</span>, <span class="op">~</span> <span class="va">iso3c</span> <span class="op">+</span> <span class="va">decade</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="va">head</span></span>
<span><span class="co">#   country iso3c       date   year decade                    region      income  OECD    PCGDP</span></span>
<span><span class="co"># 1   Aruba   ABW 1961-01-01 1964.5   1960 Latin America &amp; Caribbean High income FALSE       NA</span></span>
<span><span class="co"># 2   Aruba   ABW 1971-01-01 1974.5   1970 Latin America &amp; Caribbean High income FALSE       NA</span></span>
<span><span class="co"># 3   Aruba   ABW 1981-01-01 1984.5   1980 Latin America &amp; Caribbean High income FALSE 20267.30</span></span>
<span><span class="co"># 4   Aruba   ABW 1991-01-01 1994.5   1990 Latin America &amp; Caribbean High income FALSE 26611.44</span></span>
<span><span class="co"># 5   Aruba   ABW 2001-01-01 2004.5   2000 Latin America &amp; Caribbean High income FALSE 26664.99</span></span>
<span><span class="co"># 6   Aruba   ABW 2011-01-01 2014.5   2010 Latin America &amp; Caribbean High income FALSE 24926.17</span></span>
<span><span class="co">#    LIFEEX GINI      ODA      POP</span></span>
<span><span class="co"># 1 67.2592   NA       NA  56984.3</span></span>
<span><span class="co"># 2 70.6372   NA       NA  60080.6</span></span>
<span><span class="co"># 3 73.0153   NA 49745999  61665.9</span></span>
<span><span class="co"># 4 73.6069   NA 29971000  76946.7</span></span>
<span><span class="co"># 5 74.2660   NA 23292000  97939.7</span></span>
<span><span class="co"># 6 75.6546   NA       NA 103994.6</span></span></code></pre></div>
<p>Note that the columns of the data are in the original order and also
retain all their attributes. To understand this result let us briefly
examine the syntax of <code>collap</code>:</p>
<div class="sourceCode" id="cb71"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/collap.html">collap</a></span><span class="op">(</span><span class="va">X</span>, <span class="va">by</span>, FUN <span class="op">=</span> <span class="va">fmean</span>, catFUN <span class="op">=</span> <span class="va">fmode</span>, cols <span class="op">=</span> <span class="cn">NULL</span>, w <span class="op">=</span> <span class="cn">NULL</span>, wFUN <span class="op">=</span> <span class="va">fsum</span>,</span>
<span>       custom <span class="op">=</span> <span class="cn">NULL</span>, keep.by <span class="op">=</span> <span class="cn">TRUE</span>, keep.w <span class="op">=</span> <span class="cn">TRUE</span>, keep.col.order <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>       sort.row <span class="op">=</span> <span class="cn">TRUE</span>, parallel <span class="op">=</span> <span class="cn">FALSE</span>, mc.cores <span class="op">=</span> <span class="fl">1L</span>,</span>
<span>       return <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"wide"</span>,<span class="st">"list"</span>,<span class="st">"long"</span>,<span class="st">"long_dupl"</span><span class="op">)</span>, give.names <span class="op">=</span> <span class="st">"auto"</span><span class="op">)</span> <span class="co"># , ...</span></span></code></pre></div>
<p>It is clear that <code>X</code> is the data and <code>by</code>
supplies the grouping information, which can be a one- or two-sided
formula or alternatively grouping vectors, factors, lists and
<code>GRP</code> objects (like the <em>Fast Statistical Functions</em>).
Then <code>FUN</code> provides the function(s) applied only to numeric
variables in <code>X</code> and defaults to <code>fmean</code>, while
<code>catFUN</code> provides the function(s) applied only to categorical
variables in <code>X</code> and defaults to <code>fmode</code><a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content="&lt;p&gt;I.e. the most frequent value. By default a first-mode is
computed.&lt;/p&gt;"><sup>3</sup></a>.
<code>keep.col.order = TRUE</code> specifies that the data is to be
returned with the original column-order. Thus in the above example it
was sufficient to supply <code>X</code> and <code>by</code> and
<code>collap</code> did the rest for us.</p>
<p>Suppose we only want to aggregate 4 series in this dataset.</p>
<div class="sourceCode" id="cb72"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Same as collap(wlddev, ~ iso3c + decade, cols = 9:12)</span></span>
<span><span class="fu"><a href="../reference/collap.html">collap</a></span><span class="op">(</span><span class="va">wlddev</span>, <span class="va">PCGDP</span> <span class="op">+</span> <span class="va">LIFEEX</span> <span class="op">+</span> <span class="va">GINI</span> <span class="op">+</span> <span class="va">ODA</span> <span class="op">~</span> <span class="va">iso3c</span> <span class="op">+</span> <span class="va">decade</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="va">head</span></span>
<span><span class="co">#   iso3c decade    PCGDP  LIFEEX GINI      ODA</span></span>
<span><span class="co"># 1   ABW   1960       NA 67.2592   NA       NA</span></span>
<span><span class="co"># 2   ABW   1970       NA 70.6372   NA       NA</span></span>
<span><span class="co"># 3   ABW   1980 20267.30 73.0153   NA 49745999</span></span>
<span><span class="co"># 4   ABW   1990 26611.44 73.6069   NA 29971000</span></span>
<span><span class="co"># 5   ABW   2000 26664.99 74.2660   NA 23292000</span></span>
<span><span class="co"># 6   ABW   2010 24926.17 75.6546   NA       NA</span></span></code></pre></div>
<p>As before we could use multiple functions by putting them in a named
or unnamed list<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content="&lt;p&gt;If the list is unnamed, &lt;code&gt;collap&lt;/code&gt; uses
&lt;code&gt;all.vars(substitute(list(FUN1, FUN2, ...)))&lt;/code&gt; to get the
function names. Alternatively it is also possible to pass a character
vector of function names.&lt;/p&gt;"><sup>4</sup></a>:</p>
<div class="sourceCode" id="cb73"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/collap.html">collap</a></span><span class="op">(</span><span class="va">wlddev</span>, <span class="op">~</span> <span class="va">iso3c</span> <span class="op">+</span> <span class="va">decade</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">fmean</span>, <span class="va">fmedian</span>, <span class="va">fsd</span><span class="op">)</span>, cols <span class="op">=</span> <span class="fl">9</span><span class="op">:</span><span class="fl">12</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="va">head</span></span>
<span><span class="co">#   iso3c decade fmean.PCGDP fmedian.PCGDP fsd.PCGDP fmean.LIFEEX fmedian.LIFEEX fsd.LIFEEX</span></span>
<span><span class="co"># 1   ABW   1960          NA            NA        NA      67.2592        67.2740 1.03046880</span></span>
<span><span class="co"># 2   ABW   1970          NA            NA        NA      70.6372        70.6760 0.96813702</span></span>
<span><span class="co"># 3   ABW   1980    20267.30      20280.81 4037.2695      73.0153        73.1260 0.38203753</span></span>
<span><span class="co"># 4   ABW   1990    26611.44      26684.19  592.7919      73.6069        73.6100 0.08549392</span></span>
<span><span class="co"># 5   ABW   2000    26664.99      26992.71 1164.6741      74.2660        74.2215 0.37614448</span></span>
<span><span class="co"># 6   ABW   2010    24926.17      24599.50 1159.7344      75.6546        75.6540 0.42974339</span></span>
<span><span class="co">#   fmean.GINI fmedian.GINI fsd.GINI fmean.ODA fmedian.ODA  fsd.ODA</span></span>
<span><span class="co"># 1         NA           NA       NA        NA          NA       NA</span></span>
<span><span class="co"># 2         NA           NA       NA        NA          NA       NA</span></span>
<span><span class="co"># 3         NA           NA       NA  49745999    39259998 23573651</span></span>
<span><span class="co"># 4         NA           NA       NA  29971000    35155001 17270808</span></span>
<span><span class="co"># 5         NA           NA       NA  23292000    16219999 42969712</span></span>
<span><span class="co"># 6         NA           NA       NA        NA          NA       NA</span></span></code></pre></div>
<p>With multiple functions, we could also request <code>collap</code> to
return a long-format of the data:</p>
<div class="sourceCode" id="cb74"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/collap.html">collap</a></span><span class="op">(</span><span class="va">wlddev</span>, <span class="op">~</span> <span class="va">iso3c</span> <span class="op">+</span> <span class="va">decade</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">fmean</span>, <span class="va">fmedian</span>, <span class="va">fsd</span><span class="op">)</span>, cols <span class="op">=</span> <span class="fl">9</span><span class="op">:</span><span class="fl">12</span>, return <span class="op">=</span> <span class="st">"long"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="va">head</span></span>
<span><span class="co">#   Function iso3c decade    PCGDP  LIFEEX GINI      ODA</span></span>
<span><span class="co"># 1    fmean   ABW   1960       NA 67.2592   NA       NA</span></span>
<span><span class="co"># 2    fmean   ABW   1970       NA 70.6372   NA       NA</span></span>
<span><span class="co"># 3    fmean   ABW   1980 20267.30 73.0153   NA 49745999</span></span>
<span><span class="co"># 4    fmean   ABW   1990 26611.44 73.6069   NA 29971000</span></span>
<span><span class="co"># 5    fmean   ABW   2000 26664.99 74.2660   NA 23292000</span></span>
<span><span class="co"># 6    fmean   ABW   2010 24926.17 75.6546   NA       NA</span></span></code></pre></div>
<p>A very important feature of <code>collap</code> to highlight at this
point is the <code>custom</code> argument, which allows the user to
circumvent the broad distinction into numeric and categorical data (and
the associated <code>FUN</code> and <code>catFUN</code> arguments) and
specify exactly which columns to aggregate using which functions:</p>
<div class="sourceCode" id="cb75"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/collap.html">collap</a></span><span class="op">(</span><span class="va">wlddev</span>, <span class="op">~</span> <span class="va">iso3c</span> <span class="op">+</span> <span class="va">decade</span>,</span>
<span>        custom <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>fmean <span class="op">=</span> <span class="fl">9</span><span class="op">:</span><span class="fl">10</span>, fmedian <span class="op">=</span> <span class="fl">11</span><span class="op">:</span><span class="fl">12</span>,</span>
<span>                      ffirst <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"country"</span>,<span class="st">"region"</span>,<span class="st">"income"</span><span class="op">)</span>,</span>
<span>                      flast <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"year"</span>,<span class="st">"date"</span><span class="op">)</span>,</span>
<span>                      fmode <span class="op">=</span> <span class="st">"OECD"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="va">head</span></span>
<span><span class="co">#   country iso3c       date year decade                    region      income  OECD    PCGDP  LIFEEX</span></span>
<span><span class="co"># 1   Aruba   ABW 1970-01-01 1969   1960 Latin America &amp; Caribbean High income FALSE       NA 67.2592</span></span>
<span><span class="co"># 2   Aruba   ABW 1980-01-01 1979   1970 Latin America &amp; Caribbean High income FALSE       NA 70.6372</span></span>
<span><span class="co"># 3   Aruba   ABW 1990-01-01 1989   1980 Latin America &amp; Caribbean High income FALSE 20267.30 73.0153</span></span>
<span><span class="co"># 4   Aruba   ABW 2000-01-01 1999   1990 Latin America &amp; Caribbean High income FALSE 26611.44 73.6069</span></span>
<span><span class="co"># 5   Aruba   ABW 2010-01-01 2009   2000 Latin America &amp; Caribbean High income FALSE 26664.99 74.2660</span></span>
<span><span class="co"># 6   Aruba   ABW 2020-01-01 2019   2010 Latin America &amp; Caribbean High income FALSE 24926.17 75.6546</span></span>
<span><span class="co">#   GINI      ODA</span></span>
<span><span class="co"># 1   NA       NA</span></span>
<span><span class="co"># 2   NA       NA</span></span>
<span><span class="co"># 3   NA 39259998</span></span>
<span><span class="co"># 4   NA 35155001</span></span>
<span><span class="co"># 5   NA 16219999</span></span>
<span><span class="co"># 6   NA       NA</span></span></code></pre></div>
<p>Since <em>collapse</em> 1.5.0, it is also possible to perform
weighted aggregations and append functions with <code>_uw</code> to
yield an unweighted computation:</p>
<div class="sourceCode" id="cb76"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># This aggregates using weighted mean and mode, and unweighted median, first and last value</span></span>
<span><span class="fu"><a href="../reference/collap.html">collap</a></span><span class="op">(</span><span class="va">wlddev</span>, <span class="op">~</span> <span class="va">region</span> <span class="op">+</span> <span class="va">year</span>, w <span class="op">=</span> <span class="op">~</span> <span class="va">POP</span>,</span>
<span>        custom <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>fmean <span class="op">=</span> <span class="fl">9</span><span class="op">:</span><span class="fl">10</span>, fmedian_uw <span class="op">=</span> <span class="fl">11</span><span class="op">:</span><span class="fl">12</span>,</span>
<span>                      ffirst_uw <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"country"</span>,<span class="st">"region"</span>,<span class="st">"income"</span><span class="op">)</span>,</span>
<span>                      flast_uw <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"year"</span>,<span class="st">"date"</span><span class="op">)</span>,</span>
<span>                      fmode <span class="op">=</span> <span class="st">"OECD"</span><span class="op">)</span>, keep.w <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="va">head</span></span>
<span><span class="co">#          country       date year year              region              region              income</span></span>
<span><span class="co"># 1 American Samoa 1961-01-01 1960 1960 East Asia &amp; Pacific East Asia &amp; Pacific Upper middle income</span></span>
<span><span class="co"># 2 American Samoa 1962-01-01 1961 1961 East Asia &amp; Pacific East Asia &amp; Pacific Upper middle income</span></span>
<span><span class="co"># 3 American Samoa 1963-01-01 1962 1962 East Asia &amp; Pacific East Asia &amp; Pacific Upper middle income</span></span>
<span><span class="co"># 4 American Samoa 1964-01-01 1963 1963 East Asia &amp; Pacific East Asia &amp; Pacific Upper middle income</span></span>
<span><span class="co"># 5 American Samoa 1965-01-01 1964 1964 East Asia &amp; Pacific East Asia &amp; Pacific Upper middle income</span></span>
<span><span class="co"># 6 American Samoa 1966-01-01 1965 1965 East Asia &amp; Pacific East Asia &amp; Pacific Upper middle income</span></span>
<span><span class="co">#    OECD    PCGDP   LIFEEX GINI       ODA</span></span>
<span><span class="co"># 1 FALSE 1313.760 48.20996   NA  37295000</span></span>
<span><span class="co"># 2 FALSE 1395.228 48.73451   NA  26630001</span></span>
<span><span class="co"># 3 FALSE 1463.441 49.39960   NA 100040001</span></span>
<span><span class="co"># 4 FALSE 1540.621 50.37529   NA  40389999</span></span>
<span><span class="co"># 5 FALSE 1665.385 51.57330   NA  70059998</span></span>
<span><span class="co"># 6 FALSE 1733.757 52.94426   NA  91545002</span></span></code></pre></div>
<p>Next to <code>collap</code>, the functions <code>collapv</code>
provides a programmers alternative allowing grouping and weighting
columns to be passed using column names or indices, and the function
<code>collapg</code> operates on grouped data frames.</p>
</div>
<div class="section level2">
<h2 id="data-transformations">6. Data Transformations<a class="anchor" aria-label="anchor" href="#data-transformations"></a>
</h2>
<p>While <code>ftransform</code> and the <code>TRA</code> argument to
the <em>Fast Statistical Functions</em> introduced earlier already
provide a significant scope for transforming data, this section
introduces some further specialized functions covering some advanced and
common use cases, sometimes with greater efficiency.</p>
<!-- *collapse* also provides an ensemble of function to perform common data transformations extremely efficiently and user friendly.  -->
<!-- I start off this section by briefly introducing two apply functions I thought were missing in the base R ensemble, and then quickly move to the more involved functions to carry out extremely fast grouped transformations. -->
<div class="section level3">
<h3 id="row-and-column-arithmetic">6.1 Row and Column Arithmetic<a class="anchor" aria-label="anchor" href="#row-and-column-arithmetic"></a>
</h3>
<p>When dealing with matrices or matrix-like datasets, we often have to
perform operations applying a vector to the rows or columns of the data
object in question. The mathematical operations of base R
(<code>+</code>, <code>-</code>, <code>*</code>, <code>/</code>,
<code>%%</code>, …) operate column-wise and are quite inefficient when
used with data frames. Even in matrix code it is challenging to
efficiently apply a vector <code>v</code> to the rows of a matrix
<code>X</code>.</p>
<p>For this reason <em>collapse</em> introduces a set of efficient row-
and column-wise arithmetic operators for matrix-like objects:
<code>%rr%</code>, <code>%r+%</code>, <code>%r-%</code>,
<code>%r*%</code>, <code>%r/%</code>, <code>%cr%</code>,
<code>%c+%</code>, <code>%c-%</code>, <code>%c*%</code>,
<code>%c/%</code>.</p>
<div class="sourceCode" id="cb77"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/quick-conversion.html">qM</a></span><span class="op">(</span><span class="fu"><a href="../reference/select_replace_vars.html">fselect</a></span><span class="op">(</span><span class="va">GGDC10S</span>, <span class="va">AGR</span><span class="op">:</span><span class="va">SUM</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">v</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fsum.html">fsum</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span></span>
<span><span class="va">v</span></span>
<span><span class="co">#         AGR         MIN         MAN          PU         CON         WRT         TRA        FIRE </span></span>
<span><span class="co"># 11026503529  8134743462 24120129864  1461548426  7845957666 14776120961  6416089614  7216735147 </span></span>
<span><span class="co">#         GOV         OTH         SUM </span></span>
<span><span class="co">#  5962229565  7155872037 94115930269</span></span>
<span></span>
<span><span class="co"># This divides the rows of X by v</span></span>
<span><span class="fu"><a href="../reference/small-helpers.html">all_obj_equal</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span> <span class="op">/</span> <span class="va">v</span><span class="op">)</span>, <span class="va">X</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/outer.html" class="external-link">outer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">)</span>, <span class="va">v</span><span class="op">)</span>, <span class="va">X</span> <span class="op"><a href="../reference/arithmetic.html">%r/%</a></span> <span class="va">v</span><span class="op">)</span></span>
<span><span class="co"># [1] TRUE</span></span>
<span></span>
<span><span class="co"># Base R vs. efficient base R vs. collapse</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html" class="external-link">microbenchmark</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span> <span class="op">/</span> <span class="va">v</span><span class="op">)</span>, <span class="va">X</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/outer.html" class="external-link">outer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">)</span>, <span class="va">v</span><span class="op">)</span>, <span class="va">X</span> <span class="op"><a href="../reference/arithmetic.html">%r/%</a></span> <span class="va">v</span><span class="op">)</span></span>
<span><span class="co"># Unit: microseconds</span></span>
<span><span class="co">#                         expr     min       lq      mean   median       uq      max neval</span></span>
<span><span class="co">#                    t(t(X)/v) 194.873 234.3560 358.13500 284.6425 298.0905 3244.043   100</span></span>
<span><span class="co">#  X/outer(rep(1, nrow(X)), v)  55.555  83.5580 101.45696 108.5885 113.5495  137.637   100</span></span>
<span><span class="co">#                     X %r/% v  11.685  37.2075  83.87657  63.2630  72.7135 2744.663   100</span></span>
<span></span>
<span><span class="co"># Data frame row operations</span></span>
<span><span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/select_replace_vars.html">fselect</a></span><span class="op">(</span><span class="va">GGDC10S</span>, <span class="va">AGR</span><span class="op">:</span><span class="va">SUM</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html" class="external-link">microbenchmark</a></span><span class="op">(</span><span class="va">dat</span> <span class="op"><a href="../reference/arithmetic.html">%r/%</a></span> <span class="va">v</span>, <span class="co"># Same thing using mapply and collapse::copyAttrib</span></span>
<span>               <span class="fu"><a href="../reference/small-helpers.html">copyAttrib</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mapply.html" class="external-link">mapply</a></span><span class="op">(</span><span class="va">`/`</span>, <span class="va">dat</span>, <span class="va">v</span>, SIMPLIFY <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>, <span class="va">dat</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># Unit: microseconds</span></span>
<span><span class="co">#                                                    expr    min     lq      mean median      uq</span></span>
<span><span class="co">#                                              dat %r/% v 15.129 37.187 143.03998 40.139 46.5555</span></span>
<span><span class="co">#  copyAttrib(mapply(`/`, dat, v, SIMPLIFY = FALSE), dat) 59.204 64.124  71.98944 66.379 76.7315</span></span>
<span><span class="co">#       max neval</span></span>
<span><span class="co">#  5089.289   100</span></span>
<span><span class="co">#   110.003   100</span></span>
<span></span>
<span><span class="co"># Data frame column arithmetic is very slow</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html" class="external-link">microbenchmark</a></span><span class="op">(</span><span class="va">dat</span> <span class="op">/</span> <span class="va">dat</span><span class="op">$</span><span class="va">SUM</span>, <span class="va">dat</span> <span class="op">/</span> <span class="fl">5</span>, <span class="va">dat</span> <span class="op">/</span> <span class="va">dat</span>,</span>
<span>               <span class="va">dat</span> <span class="op"><a href="../reference/arithmetic.html">%c/%</a></span> <span class="va">dat</span><span class="op">$</span><span class="va">SUM</span>, <span class="va">dat</span> <span class="op"><a href="../reference/arithmetic.html">%c/%</a></span> <span class="fl">5</span>, <span class="va">dat</span> <span class="op"><a href="../reference/arithmetic.html">%c/%</a></span> <span class="va">dat</span><span class="op">)</span></span>
<span><span class="co"># Unit: microseconds</span></span>
<span><span class="co">#              expr      min        lq       mean    median        uq       max neval</span></span>
<span><span class="co">#       dat/dat$SUM 1275.264 1385.2260 1636.95411 1434.2825 1551.1940  5150.092   100</span></span>
<span><span class="co">#             dat/5  276.012  295.4870 1181.83361  306.2905  327.4260 83176.208   100</span></span>
<span><span class="co">#           dat/dat  295.323  320.1075  417.10858  330.5010  361.7020  3807.711   100</span></span>
<span><span class="co">#  dat %c/% dat$SUM   20.295   45.4075  120.01479   48.5235   55.1245  3520.096   100</span></span>
<span><span class="co">#        dat %c/% 5   17.179   44.5260   87.22996   48.7285   64.1035  3489.223   100</span></span>
<span><span class="co">#      dat %c/% dat   20.459   46.2685   93.95601   51.0040   67.5065  3795.903   100</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="row-and-column-data-apply">6.1 Row and Column Data Apply<a class="anchor" aria-label="anchor" href="#row-and-column-data-apply"></a>
</h3>
<p><code>dapply</code> is an efficient apply command for matrices and
data frames. It can be used to apply functions to rows or (by default)
columns of matrices or data frames and by default returns objects of the
same type and with the same attributes unless the result of each
computation is a scalar.</p>
<div class="sourceCode" id="cb78"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/dapply.html">dapply</a></span><span class="op">(</span><span class="va">mtcars</span>, <span class="va">median</span><span class="op">)</span></span>
<span><span class="co">#     mpg     cyl    disp      hp    drat      wt    qsec      vs      am    gear    carb </span></span>
<span><span class="co">#  19.200   6.000 196.300 123.000   3.695   3.325  17.710   0.000   0.000   4.000   2.000</span></span>
<span></span>
<span><span class="fu"><a href="../reference/dapply.html">dapply</a></span><span class="op">(</span><span class="va">mtcars</span>, <span class="va">median</span>, MARGIN <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="co">#           Mazda RX4       Mazda RX4 Wag          Datsun 710      Hornet 4 Drive   Hornet Sportabout </span></span>
<span><span class="co">#               4.000               4.000               4.000               3.215               3.440 </span></span>
<span><span class="co">#             Valiant          Duster 360           Merc 240D            Merc 230            Merc 280 </span></span>
<span><span class="co">#               3.460               4.000               4.000               4.000               4.000 </span></span>
<span><span class="co">#           Merc 280C          Merc 450SE          Merc 450SL         Merc 450SLC  Cadillac Fleetwood </span></span>
<span><span class="co">#               4.000               4.070               3.730               3.780               5.250 </span></span>
<span><span class="co"># Lincoln Continental   Chrysler Imperial            Fiat 128         Honda Civic      Toyota Corolla </span></span>
<span><span class="co">#               5.424               5.345               4.000               4.000               4.000 </span></span>
<span><span class="co">#       Toyota Corona    Dodge Challenger         AMC Javelin          Camaro Z28    Pontiac Firebird </span></span>
<span><span class="co">#               3.700               3.520               3.435               4.000               3.845 </span></span>
<span><span class="co">#           Fiat X1-9       Porsche 914-2        Lotus Europa      Ford Pantera L        Ferrari Dino </span></span>
<span><span class="co">#               4.000               4.430               4.000               5.000               6.000 </span></span>
<span><span class="co">#       Maserati Bora          Volvo 142E </span></span>
<span><span class="co">#               8.000               4.000</span></span>
<span></span>
<span><span class="fu"><a href="../reference/dapply.html">dapply</a></span><span class="op">(</span><span class="va">mtcars</span>, <span class="va">quantile</span><span class="op">)</span></span>
<span><span class="co">#         mpg cyl    disp    hp  drat      wt    qsec vs am gear carb</span></span>
<span><span class="co"># 0%   10.400   4  71.100  52.0 2.760 1.51300 14.5000  0  0    3    1</span></span>
<span><span class="co"># 25%  15.425   4 120.825  96.5 3.080 2.58125 16.8925  0  0    3    2</span></span>
<span><span class="co"># 50%  19.200   6 196.300 123.0 3.695 3.32500 17.7100  0  0    4    2</span></span>
<span><span class="co"># 75%  22.800   8 326.000 180.0 3.920 3.61000 18.9000  1  1    4    4</span></span>
<span><span class="co"># 100% 33.900   8 472.000 335.0 4.930 5.42400 22.9000  1  1    5    8</span></span>
<span></span>
<span><span class="fu"><a href="../reference/dapply.html">dapply</a></span><span class="op">(</span><span class="va">mtcars</span>, <span class="va">quantile</span>, MARGIN <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="va">head</span></span>
<span><span class="co">#                   0%    25%   50%    75% 100%</span></span>
<span><span class="co"># Mazda RX4          0 3.2600 4.000 18.730  160</span></span>
<span><span class="co"># Mazda RX4 Wag      0 3.3875 4.000 19.010  160</span></span>
<span><span class="co"># Datsun 710         1 1.6600 4.000 20.705  108</span></span>
<span><span class="co"># Hornet 4 Drive     0 2.0000 3.215 20.420  258</span></span>
<span><span class="co"># Hornet Sportabout  0 2.5000 3.440 17.860  360</span></span>
<span><span class="co"># Valiant            0 1.8800 3.460 19.160  225</span></span>
<span></span>
<span><span class="co"># This is considerably more efficient than log(mtcars):</span></span>
<span><span class="fu"><a href="../reference/dapply.html">dapply</a></span><span class="op">(</span><span class="va">mtcars</span>, <span class="va">log</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="va">head</span></span>
<span><span class="co">#                        mpg      cyl     disp       hp     drat        wt     qsec   vs   am</span></span>
<span><span class="co"># Mazda RX4         3.044522 1.791759 5.075174 4.700480 1.360977 0.9631743 2.800933 -Inf    0</span></span>
<span><span class="co"># Mazda RX4 Wag     3.044522 1.791759 5.075174 4.700480 1.360977 1.0560527 2.834389 -Inf    0</span></span>
<span><span class="co"># Datsun 710        3.126761 1.386294 4.682131 4.532599 1.348073 0.8415672 2.923699    0    0</span></span>
<span><span class="co"># Hornet 4 Drive    3.063391 1.791759 5.552960 4.700480 1.124930 1.1678274 2.967333    0 -Inf</span></span>
<span><span class="co"># Hornet Sportabout 2.928524 2.079442 5.886104 5.164786 1.147402 1.2354715 2.834389 -Inf -Inf</span></span>
<span><span class="co"># Valiant           2.895912 1.791759 5.416100 4.653960 1.015231 1.2412686 3.006672    0 -Inf</span></span>
<span><span class="co">#                       gear      carb</span></span>
<span><span class="co"># Mazda RX4         1.386294 1.3862944</span></span>
<span><span class="co"># Mazda RX4 Wag     1.386294 1.3862944</span></span>
<span><span class="co"># Datsun 710        1.386294 0.0000000</span></span>
<span><span class="co"># Hornet 4 Drive    1.098612 0.0000000</span></span>
<span><span class="co"># Hornet Sportabout 1.098612 0.6931472</span></span>
<span><span class="co"># Valiant           1.098612 0.0000000</span></span></code></pre></div>
<p><code>dapply</code> preserves the data structure:</p>
<div class="sourceCode" id="cb79"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">is.data.frame</a></span><span class="op">(</span><span class="fu"><a href="../reference/dapply.html">dapply</a></span><span class="op">(</span><span class="va">mtcars</span>, <span class="va">log</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># [1] TRUE</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">is.matrix</a></span><span class="op">(</span><span class="fu"><a href="../reference/dapply.html">dapply</a></span><span class="op">(</span><span class="va">m</span>, <span class="va">log</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># [1] TRUE</span></span></code></pre></div>
<p>It also delivers seamless conversions, i.e. you can apply functions
to data frame rows or columns and return a matrix and vice-versa:</p>
<div class="sourceCode" id="cb80"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/identical.html" class="external-link">identical</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">m</span><span class="op">)</span>, <span class="fu"><a href="../reference/dapply.html">dapply</a></span><span class="op">(</span><span class="va">mtcars</span>, <span class="va">log</span>, return <span class="op">=</span> <span class="st">"matrix"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># [1] TRUE</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/identical.html" class="external-link">identical</a></span><span class="op">(</span><span class="fu"><a href="../reference/dapply.html">dapply</a></span><span class="op">(</span><span class="va">mtcars</span>, <span class="va">log</span><span class="op">)</span>, <span class="fu"><a href="../reference/dapply.html">dapply</a></span><span class="op">(</span><span class="va">m</span>, <span class="va">log</span>, return <span class="op">=</span> <span class="st">"data.frame"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># [1] TRUE</span></span></code></pre></div>
<p>On data frames, the performance is comparable to <code>lapply</code>,
and <code>dapply</code> is about 2x faster than <code>apply</code> for
row- or column-wise operations on matrices. The most important feature
is that it does not change the structure of the data at all: all
attributes are preserved unless the result is a scalar and
<code>drop = TRUE</code> (the default).</p>
<!-- so you can use `dapply` on a data table, grouped tibble, or on a time series matrix and get a transformed object of the same class back  -->
</div>
<div class="section level3">
<h3 id="split-apply-combine-computing">6.2 Split-Apply-Combine Computing<a class="anchor" aria-label="anchor" href="#split-apply-combine-computing"></a>
</h3>
<p><code>BY</code> is a generalization of <code>dapply</code> for
grouped computations using functions that are not part of the <em>Fast
Statistical Functions</em> introduced above. It fundamentally is a
re-implementation of the <code>lapply(split(x, g), FUN, ...)</code>
computing paradigm in base R, but substantially faster and more
versatile than functions like <code>tapply</code>, <code>by</code> or
<code>aggregate</code>. It is however not faster than <em>dplyr</em> or
<em>data.table</em> for larger grouped computations on data frames
requiring split-apply-combine computing.</p>
<p><code>BY</code> is S3 generic with methods for vector, matrix,
data.frame and grouped_df<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content="&lt;p&gt;&lt;code&gt;BY.grouped_df&lt;/code&gt; is probably only useful
together with the &lt;code&gt;expand.wide = TRUE&lt;/code&gt; argument which
&lt;em&gt;dplyr&lt;/em&gt; does not have, because otherwise &lt;em&gt;dplyr&lt;/em&gt;’s
&lt;code&gt;summarise&lt;/code&gt; and &lt;code&gt;mutate&lt;/code&gt; are substantially faster
on larger data.&lt;/p&gt;"><sup>5</sup></a>. It also supports the same grouping
(<code>g</code>) inputs as the <em>Fast Statistical Functions</em>
(grouping vectors, factors, lists or <em>GRP</em> objects). Below the
use of <code>BY</code> is demonstrated on vectors matrices and data
frames.</p>
<!-- On bigger data.frame's however split-apply combine computing with *dplyr* is faster.  -->
<div class="sourceCode" id="cb81"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">v</span> <span class="op">&lt;-</span> <span class="va">iris</span><span class="op">$</span><span class="va">Sepal.Length</span>   <span class="co"># A numeric vector</span></span>
<span><span class="va">f</span> <span class="op">&lt;-</span> <span class="va">iris</span><span class="op">$</span><span class="va">Species</span>        <span class="co"># A factor</span></span>
<span></span>
<span><span class="co">## default vector method</span></span>
<span><span class="fu"><a href="../reference/BY.html">BY</a></span><span class="op">(</span><span class="va">v</span>, <span class="va">f</span>, <span class="va">sum</span><span class="op">)</span>                          <span class="co"># Sum by species, about 2x faster than tapply(v, f, sum)</span></span>
<span><span class="co">#     setosa versicolor  virginica </span></span>
<span><span class="co">#      250.3      296.8      329.4</span></span>
<span></span>
<span><span class="fu"><a href="../reference/BY.html">BY</a></span><span class="op">(</span><span class="va">v</span>, <span class="va">f</span>, <span class="va">quantile</span><span class="op">)</span>                     <span class="co"># Species quantiles: by default stacked</span></span>
<span><span class="co">#       setosa.0%      setosa.25%      setosa.50%      setosa.75%     setosa.100%   versicolor.0% </span></span>
<span><span class="co">#           4.300           4.800           5.000           5.200           5.800           4.900 </span></span>
<span><span class="co">#  versicolor.25%  versicolor.50%  versicolor.75% versicolor.100%    virginica.0%   virginica.25% </span></span>
<span><span class="co">#           5.600           5.900           6.300           7.000           4.900           6.225 </span></span>
<span><span class="co">#   virginica.50%   virginica.75%  virginica.100% </span></span>
<span><span class="co">#           6.500           6.900           7.900</span></span>
<span></span>
<span><span class="fu"><a href="../reference/BY.html">BY</a></span><span class="op">(</span><span class="va">v</span>, <span class="va">f</span>, <span class="va">quantile</span>, expand.wide <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="co"># Wide format</span></span>
<span><span class="co">#             0%   25% 50% 75% 100%</span></span>
<span><span class="co"># setosa     4.3 4.800 5.0 5.2  5.8</span></span>
<span><span class="co"># versicolor 4.9 5.600 5.9 6.3  7.0</span></span>
<span><span class="co"># virginica  4.9 6.225 6.5 6.9  7.9</span></span>
<span></span>
<span><span class="co">## matrix method</span></span>
<span><span class="va">miris</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/quick-conversion.html">qM</a></span><span class="op">(</span><span class="fu"><a href="../reference/select_replace_vars.html">num_vars</a></span><span class="op">(</span><span class="va">iris</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/BY.html">BY</a></span><span class="op">(</span><span class="va">miris</span>, <span class="va">f</span>, <span class="va">sum</span><span class="op">)</span>                          <span class="co"># Also returns as matrix</span></span>
<span><span class="co">#            Sepal.Length Sepal.Width Petal.Length Petal.Width</span></span>
<span><span class="co"># setosa            250.3       171.4         73.1        12.3</span></span>
<span><span class="co"># versicolor        296.8       138.5        213.0        66.3</span></span>
<span><span class="co"># virginica         329.4       148.7        277.6       101.3</span></span>
<span></span>
<span><span class="fu"><a href="../reference/BY.html">BY</a></span><span class="op">(</span><span class="va">miris</span>, <span class="va">f</span>, <span class="va">quantile</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="va">head</span></span>
<span><span class="co">#               Sepal.Length Sepal.Width Petal.Length Petal.Width</span></span>
<span><span class="co"># setosa.0%              4.3       2.300        1.000         0.1</span></span>
<span><span class="co"># setosa.25%             4.8       3.200        1.400         0.2</span></span>
<span><span class="co"># setosa.50%             5.0       3.400        1.500         0.2</span></span>
<span><span class="co"># setosa.75%             5.2       3.675        1.575         0.3</span></span>
<span><span class="co"># setosa.100%            5.8       4.400        1.900         0.6</span></span>
<span><span class="co"># versicolor.0%          4.9       2.000        3.000         1.0</span></span>
<span></span>
<span><span class="fu"><a href="../reference/BY.html">BY</a></span><span class="op">(</span><span class="va">miris</span>, <span class="va">f</span>, <span class="va">quantile</span>, expand.wide <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">[</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">]</span></span>
<span><span class="co">#            Sepal.Length.0% Sepal.Length.25% Sepal.Length.50% Sepal.Length.75% Sepal.Length.100%</span></span>
<span><span class="co"># setosa                 4.3            4.800              5.0              5.2               5.8</span></span>
<span><span class="co"># versicolor             4.9            5.600              5.9              6.3               7.0</span></span>
<span><span class="co"># virginica              4.9            6.225              6.5              6.9               7.9</span></span>
<span></span>
<span><span class="fu"><a href="../reference/BY.html">BY</a></span><span class="op">(</span><span class="va">miris</span>, <span class="va">f</span>, <span class="va">quantile</span>, expand.wide <span class="op">=</span> <span class="cn">TRUE</span>, return <span class="op">=</span> <span class="st">"list"</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">]</span> <span class="co"># list of matrices</span></span>
<span><span class="co"># $Sepal.Length</span></span>
<span><span class="co">#             0%   25% 50% 75% 100%</span></span>
<span><span class="co"># setosa     4.3 4.800 5.0 5.2  5.8</span></span>
<span><span class="co"># versicolor 4.9 5.600 5.9 6.3  7.0</span></span>
<span><span class="co"># virginica  4.9 6.225 6.5 6.9  7.9</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># $Sepal.Width</span></span>
<span><span class="co">#             0%   25% 50%   75% 100%</span></span>
<span><span class="co"># setosa     2.3 3.200 3.4 3.675  4.4</span></span>
<span><span class="co"># versicolor 2.0 2.525 2.8 3.000  3.4</span></span>
<span><span class="co"># virginica  2.2 2.800 3.0 3.175  3.8</span></span>
<span></span>
<span><span class="co">## data.frame method</span></span>
<span><span class="fu"><a href="../reference/BY.html">BY</a></span><span class="op">(</span><span class="fu"><a href="../reference/select_replace_vars.html">num_vars</a></span><span class="op">(</span><span class="va">iris</span><span class="op">)</span>, <span class="va">f</span>, <span class="va">sum</span><span class="op">)</span>             <span class="co"># Also returns a data.frame etc...</span></span>
<span><span class="co">#            Sepal.Length Sepal.Width Petal.Length Petal.Width</span></span>
<span><span class="co"># setosa            250.3       171.4         73.1        12.3</span></span>
<span><span class="co"># versicolor        296.8       138.5        213.0        66.3</span></span>
<span><span class="co"># virginica         329.4       148.7        277.6       101.3</span></span>
<span></span>
<span><span class="co">## Conversions</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/identical.html" class="external-link">identical</a></span><span class="op">(</span><span class="fu"><a href="../reference/BY.html">BY</a></span><span class="op">(</span><span class="fu"><a href="../reference/select_replace_vars.html">num_vars</a></span><span class="op">(</span><span class="va">iris</span><span class="op">)</span>, <span class="va">f</span>, <span class="va">sum</span><span class="op">)</span>, <span class="fu"><a href="../reference/BY.html">BY</a></span><span class="op">(</span><span class="va">miris</span>, <span class="va">f</span>, <span class="va">sum</span>, return <span class="op">=</span> <span class="st">"data.frame"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># [1] TRUE</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/identical.html" class="external-link">identical</a></span><span class="op">(</span><span class="fu"><a href="../reference/BY.html">BY</a></span><span class="op">(</span><span class="va">miris</span>, <span class="va">f</span>, <span class="va">sum</span><span class="op">)</span>, <span class="fu"><a href="../reference/BY.html">BY</a></span><span class="op">(</span><span class="fu"><a href="../reference/select_replace_vars.html">num_vars</a></span><span class="op">(</span><span class="va">iris</span><span class="op">)</span>, <span class="va">f</span>, <span class="va">sum</span>, return <span class="op">=</span> <span class="st">"matrix"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># [1] TRUE</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="fast-grouped-replacing-and-sweeping-out-statistics">6.3 Fast (Grouped) Replacing and Sweeping-out Statistics<a class="anchor" aria-label="anchor" href="#fast-grouped-replacing-and-sweeping-out-statistics"></a>
</h3>
<p><code>TRA</code> is an S3 generic that efficiently transforms data by
either replacing data values with supplied statistics or sweeping the
statistics out of the data. It is the workhorse function behind the
row-wise arithmetic operators introduced above (<code>%rr%</code>,
<code>%r+%</code>, <code>%r-%</code>, <code>%r*%</code>,
<code>%r/%</code>), and generalizes those to grouped operations. The 10
operations supported by <code>TRA</code> are:</p>
<ul>
<li><p>1 - “replace_fill” : replace and overwrite missing values (same
as dplyr::mutate)</p></li>
<li><p>2 - “replace” : replace but preserve missing values</p></li>
<li><p>3 - “-” : subtract (center)</p></li>
<li><p>4 - “-+” : subtract group-statistics but add average of group
statistics</p></li>
<li><p>5 - “/” : divide (scale)</p></li>
<li><p>6 - “%” : compute percentages (divide and multiply by
100)</p></li>
<li><p>7 - “+” : add</p></li>
<li><p>8 - “*” : multiply</p></li>
<li><p>9 - “%%” : modulus</p></li>
<li><p>10 - “-%%” : subtract modulus</p></li>
</ul>
<p><code>TRA</code> is also incorporated as an argument to all <em>Fast
Statistical Functions</em>. Therefore it is only really necessary and
advisable to use the <code>TRA</code> function if both aggregate
statistics and transformed data are required, or to sweep out statistics
otherwise obtained (e.g. regression or correlation coefficients etc.).
The code below computes the column means of the iris-matrix obtained
above, and uses them to demean that matrix. <!--
The code below shows 4 identical ways to center data in the *collapse* package.

For the very common centering and averaging tasks, *collapse* supplies 2 special functions `fwithin` and `fbetween` (discussed in section 6.5) which are slightly faster and more memory efficient than `fmean(..., TRA = "-")` and `fmean(..., TRA = "replace")`. --></p>
<div class="sourceCode" id="cb82"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Note: All examples below generalize to vectors or data frames</span></span>
<span><span class="va">stats</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fmean.html">fmean</a></span><span class="op">(</span><span class="va">miris</span><span class="op">)</span>               <span class="co"># Saving stats</span></span>
<span></span>
<span><span class="co"># 6 identical ways of centering a matrix</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html" class="external-link">microbenchmark</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sweep.html" class="external-link">sweep</a></span><span class="op">(</span><span class="va">miris</span>, <span class="fl">2</span>, <span class="va">stats</span>, <span class="st">"-"</span><span class="op">)</span>,  <span class="co"># base R</span></span>
<span>               <span class="va">miris</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/outer.html" class="external-link">outer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">iris</span><span class="op">)</span><span class="op">)</span>, <span class="va">stats</span><span class="op">)</span>,</span>
<span>               <span class="fu"><a href="../reference/TRA.html">TRA</a></span><span class="op">(</span><span class="va">miris</span>, <span class="fu"><a href="../reference/fmean.html">fmean</a></span><span class="op">(</span><span class="va">miris</span><span class="op">)</span>, <span class="st">"-"</span><span class="op">)</span>,</span>
<span>               <span class="va">miris</span> <span class="op"><a href="../reference/arithmetic.html">%r-%</a></span> <span class="fu"><a href="../reference/fmean.html">fmean</a></span><span class="op">(</span><span class="va">miris</span><span class="op">)</span>,      <span class="co"># The operator is actually a wrapper around TRA</span></span>
<span>               <span class="fu"><a href="../reference/fmean.html">fmean</a></span><span class="op">(</span><span class="va">miris</span>, TRA <span class="op">=</span> <span class="st">"-"</span><span class="op">)</span>,      <span class="co"># better for any operation if the stats are not needed</span></span>
<span>               <span class="fu"><a href="../reference/fbetween_fwithin.html">fwithin</a></span><span class="op">(</span><span class="va">miris</span><span class="op">)</span><span class="op">)</span>               <span class="co"># fastest, fwithin is discussed in section 6.5</span></span>
<span><span class="co"># Unit: microseconds</span></span>
<span><span class="co">#                                      expr    min      lq     mean  median      uq    max neval</span></span>
<span><span class="co">#               sweep(miris, 2, stats, "-") 15.457 16.2975 17.57711 17.0355 17.6915 53.505   100</span></span>
<span><span class="co">#  miris - outer(rep(1, nrow(iris)), stats)  4.715  5.6375  6.36812  6.0270  6.6010 21.402   100</span></span>
<span><span class="co">#             TRA(miris, fmean(miris), "-")  3.075  3.3210  3.98930  3.6080  4.4895 14.678   100</span></span>
<span><span class="co">#                   miris %r-% fmean(miris)  3.362  3.8130  4.68425  4.0590  4.5305 42.066   100</span></span>
<span><span class="co">#                   fmean(miris, TRA = "-")  2.583  2.8085  3.79496  2.9930  4.2640 29.848   100</span></span>
<span><span class="co">#                            fwithin(miris)  3.321  3.6080  5.26768  3.8130  4.9815 78.474   100</span></span>
<span></span>
<span><span class="co"># Simple replacing [same as fmean(miris, TRA = "replace") or fbetween(miris)]</span></span>
<span><span class="fu"><a href="../reference/TRA.html">TRA</a></span><span class="op">(</span><span class="va">miris</span>, <span class="fu"><a href="../reference/fmean.html">fmean</a></span><span class="op">(</span><span class="va">miris</span><span class="op">)</span>, <span class="st">"replace"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span></span>
<span><span class="co">#      Sepal.Length Sepal.Width Petal.Length Petal.Width</span></span>
<span><span class="co"># [1,]     5.843333    3.057333        3.758    1.199333</span></span>
<span><span class="co"># [2,]     5.843333    3.057333        3.758    1.199333</span></span>
<span><span class="co"># [3,]     5.843333    3.057333        3.758    1.199333</span></span>
<span></span>
<span><span class="co"># Simple scaling [same as fsd(miris, TRA = "/")]</span></span>
<span><span class="fu"><a href="../reference/TRA.html">TRA</a></span><span class="op">(</span><span class="va">miris</span>, <span class="fu"><a href="../reference/fvar_fsd.html">fsd</a></span><span class="op">(</span><span class="va">miris</span><span class="op">)</span>, <span class="st">"/"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span></span>
<span><span class="co">#      Sepal.Length Sepal.Width Petal.Length Petal.Width</span></span>
<span><span class="co"># [1,]     6.158928    8.029986    0.7930671   0.2623854</span></span>
<span><span class="co"># [2,]     5.917402    6.882845    0.7930671   0.2623854</span></span>
<span><span class="co"># [3,]     5.675875    7.341701    0.7364195   0.2623854</span></span></code></pre></div>
<p>All of the above is functionality also offered by
<code><a href="https://rdrr.io/r/base/sweep.html" class="external-link">base::sweep</a></code>, but <code>TRA</code> is significantly faster.
The big advantage of <code>TRA</code> is that it also supports grouped
operations:</p>
<div class="sourceCode" id="cb83"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Grouped centering [same as fmean(miris, f, TRA = "-") or fwithin(m, f)]</span></span>
<span><span class="fu"><a href="../reference/TRA.html">TRA</a></span><span class="op">(</span><span class="va">miris</span>, <span class="fu"><a href="../reference/fmean.html">fmean</a></span><span class="op">(</span><span class="va">miris</span>, <span class="va">f</span><span class="op">)</span>, <span class="st">"-"</span>, <span class="va">f</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span></span>
<span><span class="co">#      Sepal.Length Sepal.Width Petal.Length Petal.Width</span></span>
<span><span class="co"># [1,]        0.094       0.072       -0.062      -0.046</span></span>
<span><span class="co"># [2,]       -0.106      -0.428       -0.062      -0.046</span></span>
<span><span class="co"># [3,]       -0.306      -0.228       -0.162      -0.046</span></span>
<span></span>
<span><span class="co"># Grouped replacing [same as fmean(m, f, TRA = "replace") or fbetween(m, f)]</span></span>
<span><span class="fu"><a href="../reference/TRA.html">TRA</a></span><span class="op">(</span><span class="va">miris</span>, <span class="fu"><a href="../reference/fmean.html">fmean</a></span><span class="op">(</span><span class="va">miris</span>, <span class="va">f</span><span class="op">)</span>, <span class="st">"replace"</span>, <span class="va">f</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span></span>
<span><span class="co">#      Sepal.Length Sepal.Width Petal.Length Petal.Width</span></span>
<span><span class="co"># [1,]        5.006       3.428        1.462       0.246</span></span>
<span><span class="co"># [2,]        5.006       3.428        1.462       0.246</span></span>
<span><span class="co"># [3,]        5.006       3.428        1.462       0.246</span></span>
<span></span>
<span><span class="co"># Groupwise percentages [same as fsum(m, f, TRA = "%")]</span></span>
<span><span class="fu"><a href="../reference/TRA.html">TRA</a></span><span class="op">(</span><span class="va">miris</span>, <span class="fu"><a href="../reference/fsum.html">fsum</a></span><span class="op">(</span><span class="va">miris</span>, <span class="va">f</span><span class="op">)</span>, <span class="st">"%"</span>, <span class="va">f</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span></span>
<span><span class="co">#      Sepal.Length Sepal.Width Petal.Length Petal.Width</span></span>
<span><span class="co"># [1,]     2.037555    2.042007     1.915185    1.626016</span></span>
<span><span class="co"># [2,]     1.957651    1.750292     1.915185    1.626016</span></span>
<span><span class="co"># [3,]     1.877747    1.866978     1.778386    1.626016</span></span></code></pre></div>
<!--
A somewhat special operation performed by `TRA` is the grouped centering on the overall statistic (which for the mean is also performed more efficiently by `fwithin`):

```r
# Grouped centering on the overall mean [same as fmean(m, f, TRA = "-+") or fwithin(m, f, mean = "overall.mean")]
head(TRA(miris, fmean(miris, f), "-+", f), 3)
#      Sepal.Length Sepal.Width Petal.Length Petal.Width
# [1,]     5.937333    3.129333        3.696    1.153333
# [2,]     5.737333    2.629333        3.696    1.153333
# [3,]     5.537333    2.829333        3.596    1.153333
head(TRA(TRA(miris, fmean(miris, f), "-", f), fmean(miris), "+"), 3) # Same thing done manually!
#      Sepal.Length Sepal.Width Petal.Length Petal.Width
# [1,]     5.937333    3.129333        3.696    1.153333
# [2,]     5.737333    2.629333        3.696    1.153333
# [3,]     5.537333    2.829333        3.596    1.153333

# This group-centers data on the overall median!
head(fmedian(miris, f, TRA = "-+"), 3)
#      Sepal.Length Sepal.Width Petal.Length Petal.Width
# [1,]          5.9    3.166667          3.7    1.166667
# [2,]          5.7    2.666667          3.7    1.166667
# [3,]          5.5    2.866667          3.6    1.166667
```
This is the within transformation also computed by `qsu` discussed in section 1. It's utility in the case of grouped centering is demonstrated visually in section 6.5.
-->
<p>As mentioned, calling the <code><a href="../reference/TRA.html">TRA()</a></code> function does not make
much sense if the same task can be performed using the <em>Fast
Statistical Functions</em> or the arithmetic operators. It is however a
very useful function to call for complex transformations involving
grouped sweeping operations with precomputed quantities.</p>
</div>
<div class="section level3">
<h3 id="fast-standardizing">6.4 Fast Standardizing<a class="anchor" aria-label="anchor" href="#fast-standardizing"></a>
</h3>
<p>The function <code>fscale</code> can be used to efficiently
standardize (i.e. scale and center) data using a numerically stable
online algorithm. It’s structure is the same as the <em>Fast Statistical
Functions</em>. The standardization-operator <code>STD</code> also
exists as a wrapper around <code>fscale</code>. The difference is that
by default <code>STD</code> adds a prefix to standardized variables and
also provides an enhanced method for data frames (more about operators
in the next section).</p>
<div class="sourceCode" id="cb84"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># fscale doesn't rename columns</span></span>
<span><span class="fu"><a href="../reference/fscale.html">fscale</a></span><span class="op">(</span><span class="va">mtcars</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">#                     mpg        cyl       disp         hp      drat         wt       qsec         vs</span></span>
<span><span class="co"># Mazda RX4     0.1508848 -0.1049878 -0.5706198 -0.5350928 0.5675137 -0.6103996 -0.7771651 -0.8680278</span></span>
<span><span class="co"># Mazda RX4 Wag 0.1508848 -0.1049878 -0.5706198 -0.5350928 0.5675137 -0.3497853 -0.4637808 -0.8680278</span></span>
<span><span class="co">#                     am      gear      carb</span></span>
<span><span class="co"># Mazda RX4     1.189901 0.4235542 0.7352031</span></span>
<span><span class="co"># Mazda RX4 Wag 1.189901 0.4235542 0.7352031</span></span>
<span></span>
<span><span class="co"># By default adds a prefix</span></span>
<span><span class="fu"><a href="../reference/fscale.html">STD</a></span><span class="op">(</span><span class="va">mtcars</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">#                 STD.mpg    STD.cyl   STD.disp     STD.hp  STD.drat     STD.wt   STD.qsec     STD.vs</span></span>
<span><span class="co"># Mazda RX4     0.1508848 -0.1049878 -0.5706198 -0.5350928 0.5675137 -0.6103996 -0.7771651 -0.8680278</span></span>
<span><span class="co"># Mazda RX4 Wag 0.1508848 -0.1049878 -0.5706198 -0.5350928 0.5675137 -0.3497853 -0.4637808 -0.8680278</span></span>
<span><span class="co">#                 STD.am  STD.gear  STD.carb</span></span>
<span><span class="co"># Mazda RX4     1.189901 0.4235542 0.7352031</span></span>
<span><span class="co"># Mazda RX4 Wag 1.189901 0.4235542 0.7352031</span></span>
<span></span>
<span><span class="co"># See that is works</span></span>
<span><span class="fu"><a href="../reference/fscale.html">STD</a></span><span class="op">(</span><span class="va">mtcars</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="va">qsu</span></span>
<span><span class="co">#            N  Mean  SD      Min     Max</span></span>
<span><span class="co"># STD.mpg   32     0   1  -1.6079  2.2913</span></span>
<span><span class="co"># STD.cyl   32     0   1  -1.2249  1.0149</span></span>
<span><span class="co"># STD.disp  32    -0   1  -1.2879  1.9468</span></span>
<span><span class="co"># STD.hp    32     0   1   -1.381  2.7466</span></span>
<span><span class="co"># STD.drat  32    -0   1  -1.5646  2.4939</span></span>
<span><span class="co"># STD.wt    32    -0   1  -1.7418  2.2553</span></span>
<span><span class="co"># STD.qsec  32    -0   1   -1.874  2.8268</span></span>
<span><span class="co"># STD.vs    32     0   1   -0.868   1.116</span></span>
<span><span class="co"># STD.am    32    -0   1  -0.8141  1.1899</span></span>
<span><span class="co"># STD.gear  32    -0   1  -0.9318  1.7789</span></span>
<span><span class="co"># STD.carb  32    -0   1  -1.1222  3.2117</span></span>
<span></span>
<span><span class="co"># We can also scale and center to a different mean and standard deviation:</span></span>
<span><span class="fu"><a href="../reference/qsu.html">qsu</a></span><span class="op">(</span><span class="fu"><a href="../reference/fscale.html">fscale</a></span><span class="op">(</span><span class="va">mtcars</span>, mean <span class="op">=</span> <span class="fl">5</span>, sd <span class="op">=</span> <span class="fl">3</span><span class="op">)</span><span class="op">)</span><span class="op">[</span>, <span class="fu"><a href="../reference/small-helpers.html">.c</a></span><span class="op">(</span><span class="va">Mean</span>, <span class="va">SD</span><span class="op">)</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="va">t</span></span>
<span><span class="co">#       mpg  cyl  disp  hp  drat  wt  qsec  vs  am  gear  carb</span></span>
<span><span class="co"># Mean    5    5     5   5     5   5     5   5   5     5     5</span></span>
<span><span class="co"># SD      3    3     3   3     3   3     3   3   3     3     3</span></span>
<span></span>
<span><span class="co"># Or not center at all. In that case scaling is mean-preserving, in contrast to fsd(mtcars, TRA = "/")</span></span>
<span><span class="fu"><a href="../reference/qsu.html">qsu</a></span><span class="op">(</span><span class="fu"><a href="../reference/fscale.html">fscale</a></span><span class="op">(</span><span class="va">mtcars</span>, mean <span class="op">=</span> <span class="cn">FALSE</span>, sd <span class="op">=</span> <span class="fl">3</span><span class="op">)</span><span class="op">)</span><span class="op">[</span>, <span class="fu"><a href="../reference/small-helpers.html">.c</a></span><span class="op">(</span><span class="va">Mean</span>, <span class="va">SD</span><span class="op">)</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="va">t</span></span>
<span><span class="co">#           mpg     cyl      disp        hp    drat      wt     qsec      vs      am    gear    carb</span></span>
<span><span class="co"># Mean  20.0906  6.1875  230.7219  146.6875  3.5966  3.2172  17.8487  0.4375  0.4062  3.6875  2.8125</span></span>
<span><span class="co"># SD          3       3         3         3       3       3        3       3       3       3       3</span></span></code></pre></div>
<p>Scaling with <code>fscale / STD</code> can also be done groupwise and
/ or weighted. For example the Groningen Growth and Development Center
10-Sector Database provides annual series of value added in local
currency and persons employed for 10 broad sectors in several African,
Asian, and Latin American countries.</p>
<div class="sourceCode" id="cb85"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">GGDC10S</span><span class="op">)</span></span>
<span><span class="co">#   Country Regioncode             Region Variable Year      AGR      MIN       MAN        PU</span></span>
<span><span class="co"># 1     BWA        SSA Sub-saharan Africa       VA 1960       NA       NA        NA        NA</span></span>
<span><span class="co"># 2     BWA        SSA Sub-saharan Africa       VA 1961       NA       NA        NA        NA</span></span>
<span><span class="co"># 3     BWA        SSA Sub-saharan Africa       VA 1962       NA       NA        NA        NA</span></span>
<span><span class="co"># 4     BWA        SSA Sub-saharan Africa       VA 1963       NA       NA        NA        NA</span></span>
<span><span class="co"># 5     BWA        SSA Sub-saharan Africa       VA 1964 16.30154 3.494075 0.7365696 0.1043936</span></span>
<span><span class="co"># 6     BWA        SSA Sub-saharan Africa       VA 1965 15.72700 2.495768 1.0181992 0.1350976</span></span>
<span><span class="co">#         CON      WRT      TRA     FIRE      GOV      OTH      SUM</span></span>
<span><span class="co"># 1        NA       NA       NA       NA       NA       NA       NA</span></span>
<span><span class="co"># 2        NA       NA       NA       NA       NA       NA       NA</span></span>
<span><span class="co"># 3        NA       NA       NA       NA       NA       NA       NA</span></span>
<span><span class="co"># 4        NA       NA       NA       NA       NA       NA       NA</span></span>
<span><span class="co"># 5 0.6600454 6.243732 1.658928 1.119194 4.822485 2.341328 37.48229</span></span>
<span><span class="co"># 6 1.3462312 7.064825 1.939007 1.246789 5.695848 2.678338 39.34710</span></span></code></pre></div>
<p>If we wanted to correlate this data across countries and sectors, it
needs to be standardized:</p>
<div class="sourceCode" id="cb86"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Standardizing Sectors by Variable and Country</span></span>
<span><span class="va">STD_GGDC10S</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fscale.html">STD</a></span><span class="op">(</span><span class="va">GGDC10S</span>, <span class="op">~</span> <span class="va">Variable</span> <span class="op">+</span> <span class="va">Country</span>, cols <span class="op">=</span> <span class="fl">6</span><span class="op">:</span><span class="fl">16</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">STD_GGDC10S</span><span class="op">)</span></span>
<span><span class="co">#   Variable Country    STD.AGR    STD.MIN    STD.MAN     STD.PU    STD.CON    STD.WRT    STD.TRA</span></span>
<span><span class="co"># 1       VA     BWA         NA         NA         NA         NA         NA         NA         NA</span></span>
<span><span class="co"># 2       VA     BWA         NA         NA         NA         NA         NA         NA         NA</span></span>
<span><span class="co"># 3       VA     BWA         NA         NA         NA         NA         NA         NA         NA</span></span>
<span><span class="co"># 4       VA     BWA         NA         NA         NA         NA         NA         NA         NA</span></span>
<span><span class="co"># 5       VA     BWA -0.7382911 -0.7165772 -0.6682536 -0.8051315 -0.6922839 -0.6032762 -0.5889923</span></span>
<span><span class="co"># 6       VA     BWA -0.7392424 -0.7167359 -0.6680535 -0.8050172 -0.6917529 -0.6030211 -0.5887320</span></span>
<span><span class="co">#     STD.FIRE    STD.GOV    STD.OTH    STD.SUM</span></span>
<span><span class="co"># 1         NA         NA         NA         NA</span></span>
<span><span class="co"># 2         NA         NA         NA         NA</span></span>
<span><span class="co"># 3         NA         NA         NA         NA</span></span>
<span><span class="co"># 4         NA         NA         NA         NA</span></span>
<span><span class="co"># 5 -0.6349956 -0.6561054 -0.5959744 -0.6758663</span></span>
<span><span class="co"># 6 -0.6349359 -0.6558634 -0.5957137 -0.6757768</span></span>
<span></span>
<span><span class="co"># Correlating Standardized Value-Added across countries</span></span>
<span><span class="fu"><a href="../reference/fsubset.html">fsubset</a></span><span class="op">(</span><span class="va">STD_GGDC10S</span>, <span class="va">Variable</span> <span class="op">==</span> <span class="st">"VA"</span>, <span class="va">STD.AGR</span><span class="op">:</span><span class="va">STD.SUM</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="va">pwcor</span></span>
<span><span class="co">#          STD.AGR STD.MIN STD.MAN STD.PU STD.CON STD.WRT STD.TRA STD.FIRE STD.GOV STD.OTH STD.SUM</span></span>
<span><span class="co"># STD.AGR       1      .88     .93    .88     .89     .90     .90      .86     .93     .88     .90</span></span>
<span><span class="co"># STD.MIN      .88      1      .86    .84     .85     .85     .84      .83     .88     .84     .86</span></span>
<span><span class="co"># STD.MAN      .93     .86      1     .95     .96     .97     .98      .95     .98     .97     .98</span></span>
<span><span class="co"># STD.PU       .88     .84     .95     1      .95     .96     .96      .95     .96     .96     .97</span></span>
<span><span class="co"># STD.CON      .89     .85     .96    .95      1      .98     .98      .97     .98     .97     .98</span></span>
<span><span class="co"># STD.WRT      .90     .85     .97    .96     .98      1      .99      .98     .99     .99    1.00</span></span>
<span><span class="co"># STD.TRA      .90     .84     .98    .96     .98     .99      1       .98     .99     .99     .99</span></span>
<span><span class="co"># STD.FIRE     .86     .83     .95    .95     .97     .98     .98       1      .98     .98     .98</span></span>
<span><span class="co"># STD.GOV      .93     .88     .98    .96     .98     .99     .99      .98      1      .99    1.00</span></span>
<span><span class="co"># STD.OTH      .88     .84     .97    .96     .97     .99     .99      .98     .99      1      .99</span></span>
<span><span class="co"># STD.SUM      .90     .86     .98    .97     .98    1.00     .99      .98    1.00     .99      1</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="fast-centering-and-averaging">6.5 Fast Centering and Averaging<a class="anchor" aria-label="anchor" href="#fast-centering-and-averaging"></a>
</h3>
<p>As a slightly faster alternative to
<code>fmean(x, g, w, TRA = "-"/"-+")</code> or
<code>fmean(x, g, w, TRA = "replace"/"replace_fill")</code>,
<code>fwithin</code> and <code>fbetween</code> can be used to perform
common (grouped, weighted) centering and averaging tasks (also known as
<em>between</em>- and <em>within</em>- transformations in the language
of panel data econometrics). <code>fbetween</code> /
<code>fwithin</code> are faster than <code>fmean(..., TRA = ...)</code>
because they don’t materialize the full set of computed averages. The
operators <code>W</code> and <code>B</code> also exist.</p>
<div class="sourceCode" id="cb87"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Simple centering and averaging</span></span>
<span><span class="fu"><a href="../reference/fbetween_fwithin.html">fbetween</a></span><span class="op">(</span><span class="va">mtcars</span><span class="op">$</span><span class="va">mpg</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="va">head</span></span>
<span><span class="co"># [1] 20.09062 20.09062 20.09062 20.09062 20.09062 20.09062</span></span>
<span></span>
<span><span class="fu"><a href="../reference/fbetween_fwithin.html">fwithin</a></span><span class="op">(</span><span class="va">mtcars</span><span class="op">$</span><span class="va">mpg</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="va">head</span></span>
<span><span class="co"># [1]  0.909375  0.909375  2.709375  1.309375 -1.390625 -1.990625</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/all.equal.html" class="external-link">all.equal</a></span><span class="op">(</span><span class="fu"><a href="../reference/fbetween_fwithin.html">fbetween</a></span><span class="op">(</span><span class="va">mtcars</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="../reference/fbetween_fwithin.html">fwithin</a></span><span class="op">(</span><span class="va">mtcars</span><span class="op">)</span>, <span class="va">mtcars</span><span class="op">)</span></span>
<span><span class="co"># [1] TRUE</span></span>
<span></span>
<span><span class="co">## Groupwise centering and averaging</span></span>
<span><span class="fu"><a href="../reference/fbetween_fwithin.html">fbetween</a></span><span class="op">(</span><span class="va">mtcars</span><span class="op">$</span><span class="va">mpg</span>, <span class="va">mtcars</span><span class="op">$</span><span class="va">cyl</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="va">head</span></span>
<span><span class="co"># [1] 19.74286 19.74286 26.66364 19.74286 15.10000 19.74286</span></span>
<span></span>
<span><span class="fu"><a href="../reference/fbetween_fwithin.html">fwithin</a></span><span class="op">(</span><span class="va">mtcars</span><span class="op">$</span><span class="va">mpg</span>, <span class="va">mtcars</span><span class="op">$</span><span class="va">cyl</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="va">head</span></span>
<span><span class="co"># [1]  1.257143  1.257143 -3.863636  1.657143  3.600000 -1.642857</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/all.equal.html" class="external-link">all.equal</a></span><span class="op">(</span><span class="fu"><a href="../reference/fbetween_fwithin.html">fbetween</a></span><span class="op">(</span><span class="va">mtcars</span>, <span class="va">mtcars</span><span class="op">$</span><span class="va">cyl</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="../reference/fbetween_fwithin.html">fwithin</a></span><span class="op">(</span><span class="va">mtcars</span>, <span class="va">mtcars</span><span class="op">$</span><span class="va">cyl</span><span class="op">)</span>, <span class="va">mtcars</span><span class="op">)</span></span>
<span><span class="co"># [1] TRUE</span></span></code></pre></div>
<p>To demonstrate more clearly the utility of the operators which exists
for all fast transformation and time series functions, the code below
implements the task of demeaning 4 series by country and saving the
country-id using the within-operator <code>W</code> as opposed to
<code>fwithin</code> which requires all input to be passed externally
like the <em>Fast Statistical Functions</em>.</p>
<div class="sourceCode" id="cb88"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Center 4 series in this dataset by country</span></span>
<span><span class="fu"><a href="../reference/fbetween_fwithin.html">W</a></span><span class="op">(</span><span class="va">wlddev</span>, <span class="op">~</span> <span class="va">iso3c</span>, cols <span class="op">=</span> <span class="fl">9</span><span class="op">:</span><span class="fl">12</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="va">head</span></span>
<span><span class="co">#   iso3c W.PCGDP  W.LIFEEX W.GINI       W.ODA</span></span>
<span><span class="co"># 1   AFG      NA -16.75117     NA -1370778502</span></span>
<span><span class="co"># 2   AFG      NA -16.23517     NA -1255468497</span></span>
<span><span class="co"># 3   AFG      NA -15.72617     NA -1374708502</span></span>
<span><span class="co"># 4   AFG      NA -15.22617     NA -1249828497</span></span>
<span><span class="co"># 5   AFG      NA -14.73417     NA -1191628485</span></span>
<span><span class="co"># 6   AFG      NA -14.24917     NA -1145708502</span></span>
<span></span>
<span><span class="co"># Same thing done manually using fwithin...</span></span>
<span><span class="fu"><a href="../reference/select_replace_vars.html">add_vars</a></span><span class="op">(</span><span class="fu"><a href="../reference/select_replace_vars.html">get_vars</a></span><span class="op">(</span><span class="va">wlddev</span>, <span class="st">"iso3c"</span><span class="op">)</span>,</span>
<span>         <span class="fu"><a href="../reference/select_replace_vars.html">get_vars</a></span><span class="op">(</span><span class="va">wlddev</span>, <span class="fl">9</span><span class="op">:</span><span class="fl">12</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>         <span class="fu"><a href="../reference/fbetween_fwithin.html">fwithin</a></span><span class="op">(</span><span class="va">wlddev</span><span class="op">$</span><span class="va">iso3c</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>         <span class="fu"><a href="../reference/small-helpers.html">add_stub</a></span><span class="op">(</span><span class="st">"W."</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="va">head</span></span>
<span><span class="co">#   iso3c W.PCGDP  W.LIFEEX W.GINI       W.ODA</span></span>
<span><span class="co"># 1   AFG      NA -16.75117     NA -1370778502</span></span>
<span><span class="co"># 2   AFG      NA -16.23517     NA -1255468497</span></span>
<span><span class="co"># 3   AFG      NA -15.72617     NA -1374708502</span></span>
<span><span class="co"># 4   AFG      NA -15.22617     NA -1249828497</span></span>
<span><span class="co"># 5   AFG      NA -14.73417     NA -1191628485</span></span>
<span><span class="co"># 6   AFG      NA -14.24917     NA -1145708502</span></span></code></pre></div>
<p>It is also possible to drop the id’s in <code>W</code> using the
argument <code>keep.by = FALSE</code>. <code>fbetween / B</code> and
<code>fwithin / W</code> each have one additional computational
option:</p>
<div class="sourceCode" id="cb89"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># This replaces missing values with the group-mean: Same as fmean(x, g, TRA = "replace_fill")</span></span>
<span><span class="fu"><a href="../reference/fbetween_fwithin.html">B</a></span><span class="op">(</span><span class="va">wlddev</span>, <span class="op">~</span> <span class="va">iso3c</span>, cols <span class="op">=</span> <span class="fl">9</span><span class="op">:</span><span class="fl">12</span>, fill <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="va">head</span></span>
<span><span class="co">#   iso3c  B.PCGDP B.LIFEEX B.GINI      B.ODA</span></span>
<span><span class="co"># 1   AFG 483.8351 49.19717     NA 1487548499</span></span>
<span><span class="co"># 2   AFG 483.8351 49.19717     NA 1487548499</span></span>
<span><span class="co"># 3   AFG 483.8351 49.19717     NA 1487548499</span></span>
<span><span class="co"># 4   AFG 483.8351 49.19717     NA 1487548499</span></span>
<span><span class="co"># 5   AFG 483.8351 49.19717     NA 1487548499</span></span>
<span><span class="co"># 6   AFG 483.8351 49.19717     NA 1487548499</span></span>
<span></span>
<span><span class="co"># This adds back the overall mean after subtracting out group means: Same as fmean(x, g, TRA = "-+")</span></span>
<span><span class="fu"><a href="../reference/fbetween_fwithin.html">W</a></span><span class="op">(</span><span class="va">wlddev</span>, <span class="op">~</span> <span class="va">iso3c</span>, cols <span class="op">=</span> <span class="fl">9</span><span class="op">:</span><span class="fl">12</span>, mean <span class="op">=</span> <span class="st">"overall.mean"</span><span class="op">)</span>  <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="va">head</span></span>
<span><span class="co">#   iso3c W.PCGDP W.LIFEEX W.GINI      W.ODA</span></span>
<span><span class="co"># 1   AFG      NA 47.54514     NA -916058371</span></span>
<span><span class="co"># 2   AFG      NA 48.06114     NA -800748366</span></span>
<span><span class="co"># 3   AFG      NA 48.57014     NA -919988371</span></span>
<span><span class="co"># 4   AFG      NA 49.07014     NA -795108366</span></span>
<span><span class="co"># 5   AFG      NA 49.56214     NA -736908354</span></span>
<span><span class="co"># 6   AFG      NA 50.04714     NA -690988371</span></span>
<span></span>
<span><span class="co"># Visual demonstration of centering on the overall mean vs. simple centering</span></span>
<span><span class="va">oldpar</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">iris</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">]</span>, col <span class="op">=</span> <span class="va">iris</span><span class="op">$</span><span class="va">Species</span>, main <span class="op">=</span> <span class="st">"Raw Data"</span><span class="op">)</span>                       <span class="co"># Raw data</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="../reference/fbetween_fwithin.html">W</a></span><span class="op">(</span><span class="va">iris</span>, <span class="op">~</span> <span class="va">Species</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span>, col <span class="op">=</span> <span class="va">iris</span><span class="op">$</span><span class="va">Species</span>, main <span class="op">=</span> <span class="st">"Simple Centering"</span><span class="op">)</span> <span class="co"># Simple centering</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="../reference/fbetween_fwithin.html">W</a></span><span class="op">(</span><span class="va">iris</span>, <span class="op">~</span> <span class="va">Species</span>, mean <span class="op">=</span> <span class="st">"overall.mean"</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span>, col <span class="op">=</span> <span class="va">iris</span><span class="op">$</span><span class="va">Species</span>,     <span class="co"># Centering on overall mean: Preserves level of data</span></span>
<span>     main <span class="op">=</span> <span class="st">"Added Overall Mean"</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="figure/BWplot-1.png" alt="plot of chunk BWplot" width="100%"><p class="caption">
plot of chunk BWplot
</p>
</div>
<div class="sourceCode" id="cb90"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span><span class="va">oldpar</span><span class="op">)</span></span></code></pre></div>
<!--
# Note: This is not just slightly faster than fmean(x, g, TRA = "-+"), but if weights are used, fmean(x, g, w, "-+")
# gives a wrong result: It subtracts weighted group means but then centers on the frequency-weighted average of those group means,
# whereas fwithin(x, g, w, mean = "overall.mean") will also center on the properly weighted overall mean.
-->
<p>Another great utility of operators is that they can be employed in
regression formulas in a manor that is both very efficient and pleasing
to the eyes. The code below demonstrates the use of <code>W</code> and
<code>B</code> to efficiently run fixed-effects regressions with
<code>lm</code>.</p>
<div class="sourceCode" id="cb91"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># When using operators in formulas, we need to remove missing values beforehand to obtain the same results as a Fixed-Effects package</span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span> <span class="va">wlddev</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="../reference/select_replace_vars.html">fselect</a></span><span class="op">(</span><span class="va">iso3c</span>, <span class="va">year</span>, <span class="va">PCGDP</span>, <span class="va">LIFEEX</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="va">na_omit</span></span>
<span></span>
<span><span class="co"># classical lm() -&gt; iso3c is a factor, creates a matrix of 200+ country dummies.</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">PCGDP</span> <span class="op">~</span> <span class="va">LIFEEX</span> <span class="op">+</span> <span class="va">iso3c</span>, <span class="va">data</span><span class="op">)</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">]</span></span>
<span><span class="co"># (Intercept)      LIFEEX </span></span>
<span><span class="co">#   -2837.039     380.448</span></span>
<span></span>
<span><span class="co"># Centering each variable individually</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="fu"><a href="../reference/fbetween_fwithin.html">W</a></span><span class="op">(</span><span class="va">PCGDP</span>, <span class="va">iso3c</span><span class="op">)</span> <span class="op">~</span> <span class="fu"><a href="../reference/fbetween_fwithin.html">W</a></span><span class="op">(</span><span class="va">LIFEEX</span>, <span class="va">iso3c</span><span class="op">)</span>, <span class="va">data</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#      (Intercept) W(LIFEEX, iso3c) </span></span>
<span><span class="co">#     5.596034e-13     3.804480e+02</span></span>
<span></span>
<span><span class="co"># Centering the data</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">W.PCGDP</span> <span class="op">~</span> <span class="va">W.LIFEEX</span>, <span class="fu"><a href="../reference/fbetween_fwithin.html">W</a></span><span class="op">(</span><span class="va">data</span>, <span class="va">PCGDP</span> <span class="op">+</span> <span class="va">LIFEEX</span> <span class="op">~</span> <span class="va">iso3c</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#  (Intercept)     W.LIFEEX </span></span>
<span><span class="co"># 5.596034e-13 3.804480e+02</span></span>
<span></span>
<span><span class="co"># Adding the overall mean back to the data only changes the intercept</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">W.PCGDP</span> <span class="op">~</span> <span class="va">W.LIFEEX</span>, <span class="fu"><a href="../reference/fbetween_fwithin.html">W</a></span><span class="op">(</span><span class="va">data</span>, <span class="va">PCGDP</span> <span class="op">+</span> <span class="va">LIFEEX</span>  <span class="op">~</span> <span class="va">iso3c</span>, mean <span class="op">=</span> <span class="st">"overall.mean"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># (Intercept)    W.LIFEEX </span></span>
<span><span class="co">#  -14020.142     380.448</span></span>
<span></span>
<span><span class="co"># Procedure suggested by Mundlak (1978) - controlling for group averages instead of demeaning</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">PCGDP</span> <span class="op">~</span> <span class="va">LIFEEX</span> <span class="op">+</span> <span class="fu"><a href="../reference/fbetween_fwithin.html">B</a></span><span class="op">(</span><span class="va">LIFEEX</span>, <span class="va">iso3c</span><span class="op">)</span>, <span class="va">data</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#      (Intercept)           LIFEEX B(LIFEEX, iso3c) </span></span>
<span><span class="co">#      -52254.7421         380.4480         585.8386</span></span></code></pre></div>
<p>In general it is recommended calling the long names
(i.e. <code>fwithin</code> or <code>fscale</code> etc.) for programming
since they are a bit more efficient on the R-side of things and require
all input in terms of data. For all other purposes the operators are
more convenient. It is important to note that the operators can do
everything the functions can do (i.e. you can also pass grouping vectors
or <em>GRP</em> objects to them). They are just simple wrappers that in
the data frame method add 4 additional features:</p>
<ul>
<li>The possibility of formula input to <code>by</code>
i.e. <code>W(mtcars, ~ cyl)</code> or
<code>W(mtcars, mpg ~ cyl)</code>
</li>
<li>They preserve grouping columns (<code>cyl</code> in the above
example) when passed in a formula (default
<code>keep.by = TRUE</code>)</li>
<li>The ability to subset many columns using the <code>cols</code>
argument (i.e. <code>W(mtcars, ~ cyl, cols = 4:7)</code> is the same as
<code>W(mtcars, hp + drat + wt + qsec ~ cyl)</code>)</li>
<li>They rename transformed columns by adding a prefix (default
<code>stub = "W."</code>)</li>
</ul>
<!-- That's it about operators! If you like this kind of parsimony use them, otherwise leave it. --><!-- # Now with cyl, vs and am fixed effects --><!-- lm(W(mpg,list(cyl,vs,am)) ~ W(carb,list(cyl,vs,am)), data = mtcars) --><!-- lm(mpg ~ carb, data = W(mtcars, ~ cyl + vs + am, stub = FALSE)) --><!-- lm(mpg ~ carb + collapse::B(carb,list(cyl,vs,am)), data = mtcars) --><!-- # Now with cyl, vs and am fixed effects weighted by hp: --><!-- lm(W(mpg,list(cyl,vs,am),hp) ~ W(carb,list(cyl,vs,am),hp), data = mtcars) --><!-- lm(mpg ~ carb, data = W(mtcars, ~ cyl + vs + am, ~ hp, stub = FALSE)) --><!-- lm(mpg ~ carb + collapse::B(carb,list(cyl,vs,am),hp), data = mtcars)       # This gives a slightly different coefficient!! -->
</div>
<div class="section level3">
<h3 id="hd-centering-and-linear-prediction">6.6 HD Centering and Linear Prediction<a class="anchor" aria-label="anchor" href="#hd-centering-and-linear-prediction"></a>
</h3>
<p>Sometimes simple centering is not enough, for example if a linear
model with multiple levels of fixed-effects needs to be estimated,
potentially involving interactions with continuous covariates. For these
purposes <code>fhdwithin / HDW</code> and <code>fhdbetween / HDB</code>
were created as efficient multi-purpose functions for linear prediction
and partialling out. They operate by splitting complex regression
problems in 2 parts: Factors and factor-interactions are projected out
using <code><a href="https://lrberge.github.io/fixest/reference/demean.html" class="external-link">fixest::demean</a></code>, an efficient <code>C++</code> routine
for centering vectors on multiple factors, whereas continuous variables
are dealt with using a standard <code>chol</code> or <code>qr</code>
decomposition in base R. The examples below show the use of the
<code>HDW</code> operator in manually solving a regression problem with
country and time fixed effects.</p>
<div class="sourceCode" id="cb92"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data</span><span class="op">$</span><span class="va">year</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/qF.html">qF</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">year</span>, na.exclude <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="co"># the country code (iso3c) is already a factor</span></span>
<span></span>
<span><span class="co"># classical lm() -&gt; creates a matrix of 196 country dummies and 56 year dummies</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">PCGDP</span> <span class="op">~</span> <span class="va">LIFEEX</span> <span class="op">+</span> <span class="va">iso3c</span> <span class="op">+</span> <span class="va">year</span>, <span class="va">data</span><span class="op">)</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">]</span></span>
<span><span class="co"># (Intercept)      LIFEEX </span></span>
<span><span class="co">#  37388.0493   -333.0115</span></span>
<span></span>
<span><span class="co"># Centering each variable individually</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="fu"><a href="../reference/fhdbetween_fhdwithin.html">HDW</a></span><span class="op">(</span><span class="va">PCGDP</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">iso3c</span>, <span class="va">year</span><span class="op">)</span><span class="op">)</span> <span class="op">~</span> <span class="fu"><a href="../reference/fhdbetween_fhdwithin.html">HDW</a></span><span class="op">(</span><span class="va">LIFEEX</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">iso3c</span>, <span class="va">year</span><span class="op">)</span><span class="op">)</span>, <span class="va">data</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#                    (Intercept) HDW(LIFEEX, list(iso3c, year)) </span></span>
<span><span class="co">#                  -2.450245e-13                  -3.330115e+02</span></span>
<span></span>
<span><span class="co"># Centering the entire data</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">HDW.PCGDP</span> <span class="op">~</span> <span class="va">HDW.LIFEEX</span>, <span class="fu"><a href="../reference/fhdbetween_fhdwithin.html">HDW</a></span><span class="op">(</span><span class="va">data</span>, <span class="va">PCGDP</span> <span class="op">+</span> <span class="va">LIFEEX</span> <span class="op">~</span> <span class="va">iso3c</span> <span class="op">+</span> <span class="va">year</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#   (Intercept)    HDW.LIFEEX </span></span>
<span><span class="co"># -2.450245e-13 -3.330115e+02</span></span>
<span></span>
<span><span class="co"># Procedure suggested by Mundlak (1978) - controlling for averages instead of demeaning</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">PCGDP</span> <span class="op">~</span> <span class="va">LIFEEX</span> <span class="op">+</span> <span class="fu"><a href="../reference/fhdbetween_fhdwithin.html">HDB</a></span><span class="op">(</span><span class="va">LIFEEX</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">iso3c</span>, <span class="va">year</span><span class="op">)</span><span class="op">)</span>, <span class="va">data</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#                    (Intercept)                         LIFEEX HDB(LIFEEX, list(iso3c, year)) </span></span>
<span><span class="co">#                    -48141.1094                      -333.0115                      1236.2681</span></span></code></pre></div>
<p>We may wish to test whether including time fixed-effects in the above
regression actually impacts the fit. This can be done with the fast
F-test:</p>
<div class="sourceCode" id="cb93"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># The syntax is fFtest(y, exc, X, ...). 'exc' are exclusion restrictions.</span></span>
<span><span class="va">data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/exposition.html" class="external-link">%$%</a></span> <span class="fu"><a href="../reference/fFtest.html">fFtest</a></span><span class="op">(</span><span class="va">PCGDP</span>, <span class="va">year</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">LIFEEX</span>, <span class="va">iso3c</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#                     R-Sq.  DF1  DF2  F-Stat.  P-Value</span></span>
<span><span class="co"># Full Model          0.894  258 8763  286.130    0.000</span></span>
<span><span class="co"># Restricted Model    0.873  199 8822  304.661    0.000</span></span>
<span><span class="co"># Exclusion Rest.     0.021   59 8763   29.280    0.000</span></span></code></pre></div>
<p>The test shows that the time fixed-effects (accounted for like year
dummies) are jointly significant.</p>
<p>One can also use <code>fhdbetween / HDB</code> and
<code>fhdwithin / HDW</code> to project out interactions and continuous
covariates.</p>
<div class="sourceCode" id="cb94"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">wlddev</span><span class="op">$</span><span class="va">year</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">wlddev</span><span class="op">$</span><span class="va">year</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># classical lm() -&gt; full country-year interaction, -&gt; 200+ country dummies, 200+ trends, year and ODA</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">PCGDP</span> <span class="op">~</span> <span class="va">LIFEEX</span> <span class="op">+</span> <span class="va">iso3c</span> <span class="op">*</span> <span class="va">year</span> <span class="op">+</span> <span class="va">ODA</span>, <span class="va">wlddev</span><span class="op">)</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">]</span></span>
<span><span class="co">#   (Intercept)        LIFEEX </span></span>
<span><span class="co"># -7.257955e+05  8.938626e+00</span></span>
<span></span>
<span><span class="co"># Same using HDW</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">HDW.PCGDP</span> <span class="op">~</span> <span class="va">HDW.LIFEEX</span>, <span class="fu"><a href="../reference/fhdbetween_fhdwithin.html">HDW</a></span><span class="op">(</span><span class="va">wlddev</span>, <span class="va">PCGDP</span> <span class="op">+</span> <span class="va">LIFEEX</span> <span class="op">~</span> <span class="va">iso3c</span> <span class="op">*</span> <span class="va">year</span> <span class="op">+</span> <span class="va">ODA</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#  (Intercept)   HDW.LIFEEX </span></span>
<span><span class="co"># 3.403288e-12 8.938626e+00</span></span>
<span></span>
<span><span class="co"># example of a simple continuous problem</span></span>
<span><span class="fu"><a href="../reference/fhdbetween_fhdwithin.html">HDW</a></span><span class="op">(</span><span class="va">iris</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">]</span>, <span class="va">iris</span><span class="op">[</span><span class="fl">3</span><span class="op">:</span><span class="fl">4</span><span class="op">]</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="va">head</span></span>
<span><span class="co">#   HDW.Sepal.Length HDW.Sepal.Width</span></span>
<span><span class="co"># 1       0.21483967       0.2001352</span></span>
<span><span class="co"># 2       0.01483967      -0.2998648</span></span>
<span><span class="co"># 3      -0.13098262      -0.1255786</span></span>
<span><span class="co"># 4      -0.33933805      -0.1741510</span></span>
<span><span class="co"># 5       0.11483967       0.3001352</span></span>
<span><span class="co"># 6       0.41621663       0.6044681</span></span>
<span></span>
<span><span class="co"># May include factors..</span></span>
<span><span class="fu"><a href="../reference/fhdbetween_fhdwithin.html">HDW</a></span><span class="op">(</span><span class="va">iris</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">]</span>, <span class="va">iris</span><span class="op">[</span><span class="fl">3</span><span class="op">:</span><span class="fl">5</span><span class="op">]</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="va">head</span></span>
<span><span class="co">#   HDW.Sepal.Length HDW.Sepal.Width</span></span>
<span><span class="co"># 1       0.14989286       0.1102684</span></span>
<span><span class="co"># 2      -0.05010714      -0.3897316</span></span>
<span><span class="co"># 3      -0.15951256      -0.1742640</span></span>
<span><span class="co"># 4      -0.44070173      -0.3051992</span></span>
<span><span class="co"># 5       0.04989286       0.2102684</span></span>
<span><span class="co"># 6       0.17930818       0.3391766</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="time-series-and-panel-series">7. Time Series and Panel Series<a class="anchor" aria-label="anchor" href="#time-series-and-panel-series"></a>
</h2>
<p><em>collapse</em> also presents some essential contributions in the
time series domain, particularly in the area of (irregular) time series,
panel data and efficient and secure computations on (potentially
unordered) time-dependent vectors and (unbalanced) panels.</p>
<div class="section level3">
<h3 id="panel-series-to-array-conversions">7.1 Panel Series to Array Conversions<a class="anchor" aria-label="anchor" href="#panel-series-to-array-conversions"></a>
</h3>
<p>To facilitate the exploration and access of panel data,
<code>psmat</code> was created as an S3 generic to efficiently obtain
matrices or 3D-arrays from panel data.</p>
<div class="sourceCode" id="cb95"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mts</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/psmat.html">psmat</a></span><span class="op">(</span><span class="va">wlddev</span>, <span class="va">PCGDP</span> <span class="op">~</span> <span class="va">iso3c</span>, <span class="op">~</span> <span class="va">year</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">mts</span><span class="op">)</span></span>
<span><span class="co">#  'psmat' num [1:216, 1:61] NA NA NA NA NA ...</span></span>
<span><span class="co">#  - attr(*, "dimnames")=List of 2</span></span>
<span><span class="co">#   ..$ : chr [1:216] "ABW" "AFG" "AGO" "ALB" ...</span></span>
<span><span class="co">#   ..$ : chr [1:61] "1960" "1961" "1962" "1963" ...</span></span>
<span><span class="co">#  - attr(*, "transpose")= logi FALSE</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log10</a></span><span class="op">(</span><span class="va">mts</span><span class="op">)</span>, main <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"Log10"</span>, <span class="fu"><a href="../reference/small-helpers.html">vlabels</a></span><span class="op">(</span><span class="va">wlddev</span><span class="op">$</span><span class="va">PCGDP</span><span class="op">)</span><span class="op">)</span>, xlab <span class="op">=</span> <span class="st">"Year"</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="figure/psmatplot-1.png" alt="plot of chunk psmatplot" width="100%"><p class="caption">
plot of chunk psmatplot
</p>
</div>
<p>Passing a data frame of panel series to <code>psmat</code> generates
a 3D array:</p>
<div class="sourceCode" id="cb96"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Get panel series array</span></span>
<span><span class="va">psar</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/psmat.html">psmat</a></span><span class="op">(</span><span class="va">wlddev</span>, <span class="op">~</span> <span class="va">iso3c</span>, <span class="op">~</span> <span class="va">year</span>, cols <span class="op">=</span> <span class="fl">9</span><span class="op">:</span><span class="fl">12</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">psar</span><span class="op">)</span></span>
<span><span class="co">#  'psmat' num [1:216, 1:61, 1:4] NA NA NA NA NA ...</span></span>
<span><span class="co">#  - attr(*, "dimnames")=List of 3</span></span>
<span><span class="co">#   ..$ : chr [1:216] "ABW" "AFG" "AGO" "ALB" ...</span></span>
<span><span class="co">#   ..$ : chr [1:61] "1960" "1961" "1962" "1963" ...</span></span>
<span><span class="co">#   ..$ : chr [1:4] "PCGDP" "LIFEEX" "GINI" "ODA"</span></span>
<span><span class="co">#  - attr(*, "transpose")= logi FALSE</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">psar</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="figure/psarplot-1.png" alt="plot of chunk psarplot" width="100%"><p class="caption">
plot of chunk psarplot
</p>
</div>
<div class="sourceCode" id="cb97"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Plot array of Panel Series aggregated by region:</span></span>
<span><span class="fu"><a href="../reference/collap.html">collap</a></span><span class="op">(</span><span class="va">wlddev</span>, <span class="op">~</span> <span class="va">region</span> <span class="op">+</span> <span class="va">year</span>, cols <span class="op">=</span> <span class="fl">9</span><span class="op">:</span><span class="fl">12</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/psmat.html">psmat</a></span><span class="op">(</span> <span class="op">~</span> <span class="va">region</span>, <span class="op">~</span> <span class="va">year</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span>legend <span class="op">=</span> <span class="cn">TRUE</span>, labs <span class="op">=</span> <span class="fu"><a href="../reference/small-helpers.html">vlabels</a></span><span class="op">(</span><span class="va">wlddev</span><span class="op">)</span><span class="op">[</span><span class="fl">9</span><span class="op">:</span><span class="fl">12</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="figure/psarplot2-1.png" alt="plot of chunk psarplot2" width="100%"><p class="caption">
plot of chunk psarplot2
</p>
</div>
<p><code>psmat</code> can also output a list of panel series matrices,
which can be used among other things to reshape the data with
<code>unlist2d</code> (discussed in more detail in List-Processing
section).</p>
<div class="sourceCode" id="cb98"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># This gives list of ps-matrices</span></span>
<span><span class="va">psml</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/psmat.html">psmat</a></span><span class="op">(</span><span class="va">wlddev</span>, <span class="op">~</span> <span class="va">iso3c</span>, <span class="op">~</span> <span class="va">year</span>, <span class="fl">9</span><span class="op">:</span><span class="fl">12</span>, array <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">psml</span>, give.attr <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co"># List of 4</span></span>
<span><span class="co">#  $ PCGDP : 'psmat' num [1:216, 1:61] NA NA NA NA NA ...</span></span>
<span><span class="co">#  $ LIFEEX: 'psmat' num [1:216, 1:61] 65.7 32.4 37.5 62.3 NA ...</span></span>
<span><span class="co">#  $ GINI  : 'psmat' num [1:216, 1:61] NA NA NA NA NA NA NA NA NA NA ...</span></span>
<span><span class="co">#  $ ODA   : 'psmat' num [1:216, 1:61] NA 116769997 -390000 NA NA ...</span></span>
<span></span>
<span><span class="co"># Using unlist2d, can generate a data.frame</span></span>
<span><span class="fu"><a href="../reference/unlist2d.html">unlist2d</a></span><span class="op">(</span><span class="va">psml</span>, idcols <span class="op">=</span> <span class="st">"Variable"</span>, row.names <span class="op">=</span> <span class="st">"Country"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://sebkrantz.github.io/collapse/reference/select_replace_vars.html">gv</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="va">head</span></span>
<span><span class="co">#   Variable Country 1960 1961 1962 1963 1964 1965 1966 1967</span></span>
<span><span class="co"># 1    PCGDP     ABW   NA   NA   NA   NA   NA   NA   NA   NA</span></span>
<span><span class="co"># 2    PCGDP     AFG   NA   NA   NA   NA   NA   NA   NA   NA</span></span>
<span><span class="co"># 3    PCGDP     AGO   NA   NA   NA   NA   NA   NA   NA   NA</span></span>
<span><span class="co"># 4    PCGDP     ALB   NA   NA   NA   NA   NA   NA   NA   NA</span></span>
<span><span class="co"># 5    PCGDP     AND   NA   NA   NA   NA   NA   NA   NA   NA</span></span>
<span><span class="co"># 6    PCGDP     ARE   NA   NA   NA   NA   NA   NA   NA   NA</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="panel-series-acf-pacf-and-ccf">7.2 Panel Series ACF, PACF and CCF<a class="anchor" aria-label="anchor" href="#panel-series-acf-pacf-and-ccf"></a>
</h3>
<p>The correlation structure of panel data can also be explored with
<code>psacf</code>, <code>pspacf</code> and <code>psccf</code>. These
functions are exact analogues to <code><a href="https://rdrr.io/r/stats/acf.html" class="external-link">stats::acf</a></code>,
<code><a href="https://rdrr.io/r/stats/acf.html" class="external-link">stats::pacf</a></code> and <code><a href="https://rdrr.io/r/stats/acf.html" class="external-link">stats::ccf</a></code>. They use
<code>fscale</code> to group-scale panel data by the panel-id provided,
and then compute the covariance of a sequence of panel-lags (generated
with <code>flag</code> discussed below) with the group-scaled
level-series, dividing by the variance of the group-scaled level series.
The Partial-ACF is generated from the ACF using a Yule-Walker
decomposition (as in <code><a href="https://rdrr.io/r/stats/acf.html" class="external-link">stats::pacf</a></code>).</p>
<div class="sourceCode" id="cb99"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Panel-ACF of GDP per Capita</span></span>
<span><span class="fu"><a href="../reference/psacf.html">psacf</a></span><span class="op">(</span><span class="va">wlddev</span>, <span class="va">PCGDP</span> <span class="op">~</span> <span class="va">iso3c</span>, <span class="op">~</span><span class="va">year</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="figure/PSACF-1.png" alt="plot of chunk PSACF" width="100%"><p class="caption">
plot of chunk PSACF
</p>
</div>
<div class="sourceCode" id="cb100"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Panel-Partial-ACF of GDP per Capia</span></span>
<span><span class="fu"><a href="../reference/psacf.html">pspacf</a></span><span class="op">(</span><span class="va">wlddev</span>, <span class="va">PCGDP</span> <span class="op">~</span> <span class="va">iso3c</span>, <span class="op">~</span><span class="va">year</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="figure/PSACF-2.png" alt="plot of chunk PSACF" width="100%"><p class="caption">
plot of chunk PSACF
</p>
</div>
<div class="sourceCode" id="cb101"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Panel- Cross-Correlation function of GDP per Capia and Life-Expectancy</span></span>
<span><span class="va">wlddev</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/exposition.html" class="external-link">%$%</a></span> <span class="fu"><a href="../reference/psacf.html">psccf</a></span><span class="op">(</span><span class="va">PCGDP</span>, <span class="va">LIFEEX</span>, <span class="va">iso3c</span>, <span class="va">year</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="figure/PSACF-3.png" alt="plot of chunk PSACF" width="100%"><p class="caption">
plot of chunk PSACF
</p>
</div>
<div class="sourceCode" id="cb102"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Multivariate Panel-auto and cross-correlation function of 3 variables:</span></span>
<span><span class="fu"><a href="../reference/psacf.html">psacf</a></span><span class="op">(</span><span class="va">wlddev</span>, <span class="va">PCGDP</span> <span class="op">+</span> <span class="va">LIFEEX</span> <span class="op">+</span> <span class="va">ODA</span> <span class="op">~</span> <span class="va">iso3c</span>, <span class="op">~</span><span class="va">year</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="figure/PSACF-4.png" alt="plot of chunk PSACF" width="100%"><p class="caption">
plot of chunk PSACF
</p>
</div>
</div>
<div class="section level3">
<h3 id="fast-lags-and-leads">7.3 Fast Lags and Leads<a class="anchor" aria-label="anchor" href="#fast-lags-and-leads"></a>
</h3>
<p><code>flag</code> and the corresponding lag- and lead- operators
<code>L</code> and <code>F</code> are S3 generics to efficiently compute
lags and leads on time series and panel data. The code below shows how
to compute simple lags and leads on the classic Box &amp; Jenkins
airline data that comes with R.</p>
<div class="sourceCode" id="cb103"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 1 lag</span></span>
<span><span class="fu"><a href="../reference/flag.html">L</a></span><span class="op">(</span><span class="va">AirPassengers</span><span class="op">)</span></span>
<span><span class="co">#      Jan Feb Mar Apr May Jun Jul Aug Sep Oct Nov Dec</span></span>
<span><span class="co"># 1949  NA 112 118 132 129 121 135 148 148 136 119 104</span></span>
<span><span class="co"># 1950 118 115 126 141 135 125 149 170 170 158 133 114</span></span>
<span><span class="co"># 1951 140 145 150 178 163 172 178 199 199 184 162 146</span></span>
<span><span class="co"># 1952 166 171 180 193 181 183 218 230 242 209 191 172</span></span>
<span><span class="co"># 1953 194 196 196 236 235 229 243 264 272 237 211 180</span></span>
<span><span class="co"># 1954 201 204 188 235 227 234 264 302 293 259 229 203</span></span>
<span><span class="co"># 1955 229 242 233 267 269 270 315 364 347 312 274 237</span></span>
<span><span class="co"># 1956 278 284 277 317 313 318 374 413 405 355 306 271</span></span>
<span><span class="co"># 1957 306 315 301 356 348 355 422 465 467 404 347 305</span></span>
<span><span class="co"># 1958 336 340 318 362 348 363 435 491 505 404 359 310</span></span>
<span><span class="co"># 1959 337 360 342 406 396 420 472 548 559 463 407 362</span></span>
<span><span class="co"># 1960 405 417 391 419 461 472 535 622 606 508 461 390</span></span>
<span></span>
<span><span class="co"># 3 identical ways of computing 1 lag</span></span>
<span><span class="fu"><a href="../reference/small-helpers.html">all_identical</a></span><span class="op">(</span><span class="fu"><a href="../reference/flag.html">flag</a></span><span class="op">(</span><span class="va">AirPassengers</span><span class="op">)</span>, <span class="fu"><a href="../reference/flag.html">L</a></span><span class="op">(</span><span class="va">AirPassengers</span><span class="op">)</span>, <span class="fu"><a href="../reference/flag.html">F</a></span><span class="op">(</span><span class="va">AirPassengers</span>,<span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># [1] TRUE</span></span>
<span></span>
<span><span class="co"># 1 lead and 3 lags - output as matrix</span></span>
<span><span class="fu"><a href="../reference/flag.html">L</a></span><span class="op">(</span><span class="va">AirPassengers</span>, <span class="op">-</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="va">head</span></span>
<span><span class="co">#       F1  --  L1  L2  L3</span></span>
<span><span class="co"># [1,] 118 112  NA  NA  NA</span></span>
<span><span class="co"># [2,] 132 118 112  NA  NA</span></span>
<span><span class="co"># [3,] 129 132 118 112  NA</span></span>
<span><span class="co"># [4,] 121 129 132 118 112</span></span>
<span><span class="co"># [5,] 135 121 129 132 118</span></span>
<span><span class="co"># [6,] 148 135 121 129 132</span></span>
<span></span>
<span><span class="co"># ... this is still a time series object:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/attributes.html" class="external-link">attributes</a></span><span class="op">(</span><span class="fu"><a href="../reference/flag.html">L</a></span><span class="op">(</span><span class="va">AirPassengers</span>, <span class="op">-</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># $tsp</span></span>
<span><span class="co"># [1] 1949.000 1960.917   12.000</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># $class</span></span>
<span><span class="co"># [1] "ts"     "matrix"</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># $dim</span></span>
<span><span class="co"># [1] 144   5</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># $dimnames</span></span>
<span><span class="co"># $dimnames[[1]]</span></span>
<span><span class="co"># NULL</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># $dimnames[[2]]</span></span>
<span><span class="co"># [1] "F1" "--" "L1" "L2" "L3"</span></span></code></pre></div>
<p><code>flag / L / F</code> also work well on (time series) matrices.
Below a regression with daily closing prices of major European stock
indices is run: Germany DAX (Ibis), Switzerland SMI, France CAC, and UK
FTSE. The data are sampled in business time, i.e. weekends and holidays
are omitted.</p>
<div class="sourceCode" id="cb104"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">EuStockMarkets</span><span class="op">)</span></span>
<span><span class="co">#  Time-Series [1:1860, 1:4] from 1991 to 1999: 1629 1614 1607 1621 1618 ...</span></span>
<span><span class="co">#  - attr(*, "dimnames")=List of 2</span></span>
<span><span class="co">#   ..$ : NULL</span></span>
<span><span class="co">#   ..$ : chr [1:4] "DAX" "SMI" "CAC" "FTSE"</span></span>
<span></span>
<span><span class="co"># Data is recorded on 260 days per year, 1991-1999</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/tsp.html" class="external-link">tsp</a></span><span class="op">(</span><span class="va">EuStockMarkets</span><span class="op">)</span></span>
<span><span class="co"># [1] 1991.496 1998.646  260.000</span></span>
<span><span class="va">freq</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/time.html" class="external-link">frequency</a></span><span class="op">(</span><span class="va">EuStockMarkets</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># There is some obvious seasonality</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/stl.html" class="external-link">stl</a></span><span class="op">(</span><span class="va">EuStockMarkets</span><span class="op">[</span>, <span class="st">"DAX"</span><span class="op">]</span>, <span class="va">freq</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="va">plot</span></span></code></pre></div>
<div class="figure">
<img src="figure/mts-1.png" alt="plot of chunk mts" width="100%"><p class="caption">
plot of chunk mts
</p>
</div>
<div class="sourceCode" id="cb105"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># 1 annual lead and 1 annual lag</span></span>
<span><span class="fu"><a href="../reference/flag.html">L</a></span><span class="op">(</span><span class="va">EuStockMarkets</span>, <span class="op">-</span><span class="fl">1</span><span class="op">:</span><span class="fl">1</span><span class="op">*</span><span class="va">freq</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="va">head</span></span>
<span><span class="co">#      F260.DAX     DAX L260.DAX F260.SMI    SMI L260.SMI F260.CAC    CAC L260.CAC F260.FTSE   FTSE</span></span>
<span><span class="co"># [1,]  1755.98 1628.75       NA   1846.6 1678.1       NA   1907.3 1772.8       NA    2515.8 2443.6</span></span>
<span><span class="co"># [2,]  1754.95 1613.63       NA   1854.8 1688.5       NA   1900.6 1750.5       NA    2521.2 2460.2</span></span>
<span><span class="co"># [3,]  1759.90 1606.51       NA   1845.3 1678.6       NA   1880.9 1718.0       NA    2493.9 2448.2</span></span>
<span><span class="co"># [4,]  1759.84 1621.04       NA   1854.5 1684.1       NA   1873.5 1708.1       NA    2476.1 2470.4</span></span>
<span><span class="co"># [5,]  1776.50 1618.16       NA   1870.5 1686.6       NA   1883.6 1723.1       NA    2497.1 2484.7</span></span>
<span><span class="co"># [6,]  1769.98 1610.61       NA   1862.6 1671.6       NA   1868.5 1714.3       NA    2469.0 2466.8</span></span>
<span><span class="co">#      L260.FTSE</span></span>
<span><span class="co"># [1,]        NA</span></span>
<span><span class="co"># [2,]        NA</span></span>
<span><span class="co"># [3,]        NA</span></span>
<span><span class="co"># [4,]        NA</span></span>
<span><span class="co"># [5,]        NA</span></span>
<span><span class="co"># [6,]        NA</span></span>
<span></span>
<span><span class="co"># DAX regressed on it's own 2 annual lags and the lags of the other indicators</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">DAX</span> <span class="op">~</span><span class="va">.</span>, data <span class="op">=</span> <span class="fu"><a href="../reference/flag.html">L</a></span><span class="op">(</span><span class="va">EuStockMarkets</span>, <span class="fl">0</span><span class="op">:</span><span class="fl">2</span><span class="op">*</span><span class="va">freq</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="va">summary</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># Call:</span></span>
<span><span class="co"># lm(formula = DAX ~ ., data = L(EuStockMarkets, 0:2 * freq))</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># Residuals:</span></span>
<span><span class="co">#     Min      1Q  Median      3Q     Max </span></span>
<span><span class="co"># -240.46  -51.28  -12.01   45.19  358.02 </span></span>
<span><span class="co"># </span></span>
<span><span class="co"># Coefficients:</span></span>
<span><span class="co">#               Estimate Std. Error t value Pr(&gt;|t|)    </span></span>
<span><span class="co"># (Intercept) -564.02041   93.94903  -6.003 2.49e-09 ***</span></span>
<span><span class="co"># L260.DAX      -0.12577    0.03002  -4.189 2.99e-05 ***</span></span>
<span><span class="co"># L520.DAX      -0.12528    0.04103  -3.053  0.00231 ** </span></span>
<span><span class="co"># SMI            0.32601    0.01726  18.890  &lt; 2e-16 ***</span></span>
<span><span class="co"># L260.SMI       0.27499    0.02517  10.926  &lt; 2e-16 ***</span></span>
<span><span class="co"># L520.SMI       0.04602    0.02602   1.769  0.07721 .  </span></span>
<span><span class="co"># CAC            0.59637    0.02349  25.389  &lt; 2e-16 ***</span></span>
<span><span class="co"># L260.CAC      -0.14283    0.02763  -5.169 2.72e-07 ***</span></span>
<span><span class="co"># L520.CAC       0.05196    0.03657   1.421  0.15557    </span></span>
<span><span class="co"># FTSE           0.01002    0.02403   0.417  0.67675    </span></span>
<span><span class="co"># L260.FTSE      0.04509    0.02807   1.606  0.10843    </span></span>
<span><span class="co"># L520.FTSE      0.10601    0.02717   3.902  0.00010 ***</span></span>
<span><span class="co"># ---</span></span>
<span><span class="co"># Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># Residual standard error: 83.06 on 1328 degrees of freedom</span></span>
<span><span class="co">#   (520 observations deleted due to missingness)</span></span>
<span><span class="co"># Multiple R-squared:  0.9943,  Adjusted R-squared:  0.9942 </span></span>
<span><span class="co"># F-statistic: 2.092e+04 on 11 and 1328 DF,  p-value: &lt; 2.2e-16</span></span></code></pre></div>
<p>Since v1.5.0, irregular time series are supported:</p>
<div class="sourceCode" id="cb106"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">t</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/efficient-programming.html">seq_row</a></span><span class="op">(</span><span class="va">EuStockMarkets</span><span class="op">)</span><span class="op">[</span><span class="op">-</span><span class="fl">4L</span><span class="op">]</span></span>
<span></span>
<span><span class="fu"><a href="../reference/flag.html">flag</a></span><span class="op">(</span><span class="va">EuStockMarkets</span><span class="op">[</span><span class="op">-</span><span class="fl">4L</span>, <span class="op">]</span>, <span class="op">-</span><span class="fl">1</span><span class="op">:</span><span class="fl">1</span>, t <span class="op">=</span> <span class="va">t</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="va">head</span></span>
<span><span class="co">#       F1.DAX     DAX  L1.DAX F1.SMI    SMI L1.SMI F1.CAC    CAC L1.CAC F1.FTSE   FTSE L1.FTSE</span></span>
<span><span class="co"># [1,] 1613.63 1628.75      NA 1688.5 1678.1     NA 1750.5 1772.8     NA  2460.2 2443.6      NA</span></span>
<span><span class="co"># [2,] 1606.51 1613.63 1628.75 1678.6 1688.5 1678.1 1718.0 1750.5 1772.8  2448.2 2460.2  2443.6</span></span>
<span><span class="co"># [3,]      NA 1606.51 1613.63     NA 1678.6 1688.5     NA 1718.0 1750.5      NA 2448.2  2460.2</span></span>
<span><span class="co"># [4,] 1610.61 1618.16      NA 1671.6 1686.6     NA 1714.3 1723.1     NA  2466.8 2484.7      NA</span></span>
<span><span class="co"># [5,] 1630.75 1610.61 1618.16 1682.9 1671.6 1686.6 1734.5 1714.3 1723.1  2487.9 2466.8  2484.7</span></span>
<span><span class="co"># [6,] 1640.17 1630.75 1610.61 1703.6 1682.9 1671.6 1757.4 1734.5 1714.3  2508.4 2487.9  2466.8</span></span></code></pre></div>
<p>The main innovation of <code>flag / L / F</code> is the ability to
very efficiently compute sequences of lags and leads on panel data, and
that this panel data need not be ordered or balanced:</p>
<div class="sourceCode" id="cb107"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># This lags all 4 series</span></span>
<span><span class="fu"><a href="../reference/flag.html">L</a></span><span class="op">(</span><span class="va">wlddev</span>, <span class="fl">1L</span>, <span class="op">~</span> <span class="va">iso3c</span>, <span class="op">~</span> <span class="va">year</span>, cols <span class="op">=</span> <span class="fl">9</span><span class="op">:</span><span class="fl">12</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="va">head</span></span>
<span><span class="co">#   iso3c year L1.PCGDP L1.LIFEEX L1.GINI    L1.ODA</span></span>
<span><span class="co"># 1   AFG 1960       NA        NA      NA        NA</span></span>
<span><span class="co"># 2   AFG 1961       NA    32.446      NA 116769997</span></span>
<span><span class="co"># 3   AFG 1962       NA    32.962      NA 232080002</span></span>
<span><span class="co"># 4   AFG 1963       NA    33.471      NA 112839996</span></span>
<span><span class="co"># 5   AFG 1964       NA    33.971      NA 237720001</span></span>
<span><span class="co"># 6   AFG 1965       NA    34.463      NA 295920013</span></span>
<span></span>
<span><span class="co"># Without t: Works here because data is ordered, but gives a message</span></span>
<span><span class="fu"><a href="../reference/flag.html">L</a></span><span class="op">(</span><span class="va">wlddev</span>, <span class="fl">1L</span>, <span class="op">~</span> <span class="va">iso3c</span>, cols <span class="op">=</span> <span class="fl">9</span><span class="op">:</span><span class="fl">12</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="va">head</span></span>
<span><span class="co">#   iso3c L1.PCGDP L1.LIFEEX L1.GINI    L1.ODA</span></span>
<span><span class="co"># 1   AFG       NA        NA      NA        NA</span></span>
<span><span class="co"># 2   AFG       NA    32.446      NA 116769997</span></span>
<span><span class="co"># 3   AFG       NA    32.962      NA 232080002</span></span>
<span><span class="co"># 4   AFG       NA    33.471      NA 112839996</span></span>
<span><span class="co"># 5   AFG       NA    33.971      NA 237720001</span></span>
<span><span class="co"># 6   AFG       NA    34.463      NA 295920013</span></span>
<span></span>
<span><span class="co"># 1 lead and 2 lags of Life Expectancy</span></span>
<span><span class="co"># after removing the 4th row, thus creating an unbalanced panel</span></span>
<span><span class="va">wlddev</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="../reference/fsubset.html">ss</a></span><span class="op">(</span><span class="op">-</span><span class="fl">4L</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/flag.html">L</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, <span class="va">LIFEEX</span> <span class="op">~</span> <span class="va">iso3c</span>, <span class="op">~</span><span class="va">year</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="va">head</span></span>
<span><span class="co">#   iso3c year F1.LIFEEX LIFEEX L1.LIFEEX L2.LIFEEX</span></span>
<span><span class="co"># 1   AFG 1960    32.962 32.446        NA        NA</span></span>
<span><span class="co"># 2   AFG 1961    33.471 32.962    32.446        NA</span></span>
<span><span class="co"># 3   AFG 1962        NA 33.471    32.962    32.446</span></span>
<span><span class="co"># 4   AFG 1964    34.948 34.463        NA    33.471</span></span>
<span><span class="co"># 5   AFG 1965    35.430 34.948    34.463        NA</span></span>
<span><span class="co"># 6   AFG 1966    35.914 35.430    34.948    34.463</span></span></code></pre></div>
<p>Optimal performance is obtained if the panel-id is a factor, and the
time variable also a factor or an integer variable. In that case an
ordering vector of the data is computed directly without any prior
sorting or grouping, and the data is accessed through this vector. Thus
the data need not be sorted to compute a fully-identified panel-lag,
which is a key advantage to, say, the <code>shift</code> function in
<code>data.table</code>.</p>
<!--
One caveat of the direct computation of the ordering is that `flag / L / F` requires regularly spaced panel data, and provides errors for repeated values or gaps in time within any group:


```r
g <- c(1,1,1,2,2,2)
tryCatch(flag(1:6, 1, g, t = c(1,2,3,1,2,2)),
         error = function(e) e)
# <Rcpp::exception in eval(expr, envir, enclos): Repeated values of timevar within one or more groups>
tryCatch(flag(1:6, 1, g, t = c(1,2,3,1,2,4)),
         error = function(e) e)
# [1] NA  1  2 NA  4 NA
```

Note that all of this does not require the panel to be balanced. `flag / L /F` works for unbalanced panel data as long as there are no gaps or repeated values in the time-variable for an individual. Since this sacrifices some functionality for speed and has been a requested feature, *collapse* 1.2.0 introduced the function `seqid`, which can be used to generate an new panel-id variable which identifies consecutive time-sequences at the sub-individual level, an thus enables the use of `flag / L /F` on irregular panels.
-->
<p>One intended area of use, especially for the operators <code>L</code>
and <code>F</code>, is to substantially facilitate the implementation of
dynamic models in various contexts (independent of the estimation
package). Below different ways <code>L</code> can be used to estimate a
dynamic panel-model using <code>lm</code> are shown:</p>
<div class="sourceCode" id="cb108"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Different ways of regressing GDP on it's lags and life-Expectancy and it's lags</span></span>
<span></span>
<span><span class="co"># 1 - Precomputing lags</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">PCGDP</span> <span class="op">~</span> <span class="va">.</span>, <span class="fu"><a href="../reference/flag.html">L</a></span><span class="op">(</span><span class="va">wlddev</span>, <span class="fl">0</span><span class="op">:</span><span class="fl">2</span>, <span class="va">PCGDP</span> <span class="op">+</span> <span class="va">LIFEEX</span> <span class="op">~</span> <span class="va">iso3c</span>, <span class="op">~</span> <span class="va">year</span>, keep.ids <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="va">summary</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># Call:</span></span>
<span><span class="co"># lm(formula = PCGDP ~ ., data = L(wlddev, 0:2, PCGDP + LIFEEX ~ </span></span>
<span><span class="co">#     iso3c, ~year, keep.ids = FALSE))</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># Residuals:</span></span>
<span><span class="co">#      Min       1Q   Median       3Q      Max </span></span>
<span><span class="co"># -16776.5   -102.2    -17.2     91.5  12277.1 </span></span>
<span><span class="co"># </span></span>
<span><span class="co"># Coefficients:</span></span>
<span><span class="co">#               Estimate Std. Error t value Pr(&gt;|t|)    </span></span>
<span><span class="co"># (Intercept) -333.93994   61.04617  -5.470 4.62e-08 ***</span></span>
<span><span class="co"># L1.PCGDP       1.31959    0.01021 129.270  &lt; 2e-16 ***</span></span>
<span><span class="co"># L2.PCGDP      -0.31707    0.01029 -30.815  &lt; 2e-16 ***</span></span>
<span><span class="co"># LIFEEX       -17.77368   35.47772  -0.501    0.616    </span></span>
<span><span class="co"># L1.LIFEEX     45.76286   65.87124   0.695    0.487    </span></span>
<span><span class="co"># L2.LIFEEX    -21.43005   34.98964  -0.612    0.540    </span></span>
<span><span class="co"># ---</span></span>
<span><span class="co"># Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># Residual standard error: 787.3 on 8609 degrees of freedom</span></span>
<span><span class="co">#   (4561 observations deleted due to missingness)</span></span>
<span><span class="co"># Multiple R-squared:  0.9976,  Adjusted R-squared:  0.9976 </span></span>
<span><span class="co"># F-statistic: 7.26e+05 on 5 and 8609 DF,  p-value: &lt; 2.2e-16</span></span>
<span></span>
<span><span class="co"># 2 - Ad-hoc computation in lm formula</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">PCGDP</span> <span class="op">~</span> <span class="fu"><a href="../reference/flag.html">L</a></span><span class="op">(</span><span class="va">PCGDP</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, <span class="va">iso3c</span>, <span class="va">year</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="../reference/flag.html">L</a></span><span class="op">(</span><span class="va">LIFEEX</span>, <span class="fl">0</span><span class="op">:</span><span class="fl">2</span>, <span class="va">iso3c</span>, <span class="va">year</span><span class="op">)</span>, <span class="va">wlddev</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="va">summary</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># Call:</span></span>
<span><span class="co"># lm(formula = PCGDP ~ L(PCGDP, 1:2, iso3c, year) + L(LIFEEX, 0:2, </span></span>
<span><span class="co">#     iso3c, year), data = wlddev)</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># Residuals:</span></span>
<span><span class="co">#      Min       1Q   Median       3Q      Max </span></span>
<span><span class="co"># -16776.5   -102.2    -17.2     91.5  12277.1 </span></span>
<span><span class="co"># </span></span>
<span><span class="co"># Coefficients:</span></span>
<span><span class="co">#                                 Estimate Std. Error t value Pr(&gt;|t|)    </span></span>
<span><span class="co"># (Intercept)                   -333.93994   61.04617  -5.470 4.62e-08 ***</span></span>
<span><span class="co"># L(PCGDP, 1:2, iso3c, year)L1     1.31959    0.01021 129.270  &lt; 2e-16 ***</span></span>
<span><span class="co"># L(PCGDP, 1:2, iso3c, year)L2    -0.31707    0.01029 -30.815  &lt; 2e-16 ***</span></span>
<span><span class="co"># L(LIFEEX, 0:2, iso3c, year)--  -17.77368   35.47772  -0.501    0.616    </span></span>
<span><span class="co"># L(LIFEEX, 0:2, iso3c, year)L1   45.76286   65.87124   0.695    0.487    </span></span>
<span><span class="co"># L(LIFEEX, 0:2, iso3c, year)L2  -21.43005   34.98964  -0.612    0.540    </span></span>
<span><span class="co"># ---</span></span>
<span><span class="co"># Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># Residual standard error: 787.3 on 8609 degrees of freedom</span></span>
<span><span class="co">#   (4561 observations deleted due to missingness)</span></span>
<span><span class="co"># Multiple R-squared:  0.9976,  Adjusted R-squared:  0.9976 </span></span>
<span><span class="co"># F-statistic: 7.26e+05 on 5 and 8609 DF,  p-value: &lt; 2.2e-16</span></span>
<span></span>
<span><span class="co"># 3 - Precomputing panel-identifiers</span></span>
<span><span class="va">g</span> <span class="op">=</span> <span class="fu"><a href="../reference/qF.html">qF</a></span><span class="op">(</span><span class="va">wlddev</span><span class="op">$</span><span class="va">iso3c</span>, na.exclude <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">t</span> <span class="op">=</span> <span class="fu"><a href="../reference/qF.html">qF</a></span><span class="op">(</span><span class="va">wlddev</span><span class="op">$</span><span class="va">year</span>, na.exclude <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">PCGDP</span> <span class="op">~</span> <span class="fu"><a href="../reference/flag.html">L</a></span><span class="op">(</span><span class="va">PCGDP</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, <span class="va">g</span>, <span class="va">t</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="../reference/flag.html">L</a></span><span class="op">(</span><span class="va">LIFEEX</span>, <span class="fl">0</span><span class="op">:</span><span class="fl">2</span>, <span class="va">g</span>, <span class="va">t</span><span class="op">)</span>, <span class="va">wlddev</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="va">summary</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># Call:</span></span>
<span><span class="co"># lm(formula = PCGDP ~ L(PCGDP, 1:2, g, t) + L(LIFEEX, 0:2, g, </span></span>
<span><span class="co">#     t), data = wlddev)</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># Residuals:</span></span>
<span><span class="co">#      Min       1Q   Median       3Q      Max </span></span>
<span><span class="co"># -16776.5   -102.2    -17.2     91.5  12277.1 </span></span>
<span><span class="co"># </span></span>
<span><span class="co"># Coefficients:</span></span>
<span><span class="co">#                          Estimate Std. Error t value Pr(&gt;|t|)    </span></span>
<span><span class="co"># (Intercept)            -333.93994   61.04617  -5.470 4.62e-08 ***</span></span>
<span><span class="co"># L(PCGDP, 1:2, g, t)L1     1.31959    0.01021 129.270  &lt; 2e-16 ***</span></span>
<span><span class="co"># L(PCGDP, 1:2, g, t)L2    -0.31707    0.01029 -30.815  &lt; 2e-16 ***</span></span>
<span><span class="co"># L(LIFEEX, 0:2, g, t)--  -17.77368   35.47772  -0.501    0.616    </span></span>
<span><span class="co"># L(LIFEEX, 0:2, g, t)L1   45.76286   65.87124   0.695    0.487    </span></span>
<span><span class="co"># L(LIFEEX, 0:2, g, t)L2  -21.43005   34.98964  -0.612    0.540    </span></span>
<span><span class="co"># ---</span></span>
<span><span class="co"># Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># Residual standard error: 787.3 on 8609 degrees of freedom</span></span>
<span><span class="co">#   (4561 observations deleted due to missingness)</span></span>
<span><span class="co"># Multiple R-squared:  0.9976,  Adjusted R-squared:  0.9976 </span></span>
<span><span class="co"># F-statistic: 7.26e+05 on 5 and 8609 DF,  p-value: &lt; 2.2e-16</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="fast-differences-and-growth-rates">7.4 Fast Differences and Growth Rates<a class="anchor" aria-label="anchor" href="#fast-differences-and-growth-rates"></a>
</h3>
<p>Similarly to <code>flag / L / F</code>, <code>fdiff / D / Dlog</code>
computes sequences of suitably lagged / leaded and iterated differences,
quasi-differences or (quasi-)log-differences on time series and panel
data, and <code>fgrowth / G</code> computes growth rates. Using again
the <code>Airpassengers</code> data, the seasonal decomposition shows
significant seasonality:</p>
<div class="sourceCode" id="cb109"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/stl.html" class="external-link">stl</a></span><span class="op">(</span><span class="va">AirPassengers</span>, <span class="st">"periodic"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="va">plot</span></span></code></pre></div>
<div class="figure">
<img src="figure/stl-1.png" alt="plot of chunk stl" width="100%"><p class="caption">
plot of chunk stl
</p>
</div>
<p>We can test the statistical significance of this seasonality by
jointly testing a set of monthly dummies regressed on the differenced
series. Given that the seasonal fluctuations are increasing in
magnitude, using growth rates for the test seems more appropriate:</p>
<div class="sourceCode" id="cb110"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">f</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/qF.html">qF</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/time.html" class="external-link">cycle</a></span><span class="op">(</span><span class="va">AirPassengers</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/fFtest.html">fFtest</a></span><span class="op">(</span><span class="fu"><a href="../reference/fgrowth.html">fgrowth</a></span><span class="op">(</span><span class="va">AirPassengers</span><span class="op">)</span>, <span class="va">f</span><span class="op">)</span></span>
<span><span class="co">#   R-Sq.     DF1     DF2 F-Stat. P-value </span></span>
<span><span class="co">#   0.874      11     131  82.238   0.000</span></span></code></pre></div>
<p>The test shows significant seasonality, accounting for 87% of the
variation in the growth rate of the series. We can plot the series
together with the ordinary, seasonal (12-month) and deseasonalized
monthly growth rate using:</p>
<div class="sourceCode" id="cb111"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/fgrowth.html">G</a></span><span class="op">(</span><span class="va">AirPassengers</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">12</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span>W.G1 <span class="op">=</span> <span class="fu"><a href="../reference/fbetween_fwithin.html">W</a></span><span class="op">(</span><span class="fu"><a href="../reference/fgrowth.html">G</a></span><span class="op">(</span><span class="va">AirPassengers</span><span class="op">)</span>, <span class="va">f</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span>main <span class="op">=</span> <span class="st">"Growth Rate of Airpassengers"</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="figure/Gplot-1.png" alt="plot of chunk Gplot" width="100%"><p class="caption">
plot of chunk Gplot
</p>
</div>
<p>It is evident that taking the annualized growth rate also removes the
periodic behavior. We can also compute second differences or growth
rates of growth rates. Below a plot of the ordinary and annual first and
second differences of the data:</p>
<div class="sourceCode" id="cb112"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/fdiff.html">D</a></span><span class="op">(</span><span class="va">AirPassengers</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">12</span><span class="op">)</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="va">plot</span></span></code></pre></div>
<div class="figure">
<img src="figure/Dplot-1.png" alt="plot of chunk Dplot" width="100%"><p class="caption">
plot of chunk Dplot
</p>
</div>
<p>In general, both <code>fdiff / D</code> and <code>fgrowth / G</code>
can compute sequences of lagged / leaded and iterated differences /
growth rates.</p>
<div class="sourceCode" id="cb113"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># sequence of leaded/lagged and iterated differences</span></span>
<span><span class="va">y</span> <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span></span>
<span><span class="fu"><a href="../reference/fdiff.html">D</a></span><span class="op">(</span><span class="va">y</span>, <span class="op">-</span><span class="fl">2</span><span class="op">:</span><span class="fl">2</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span></span>
<span><span class="co">#       F2D1 F2D2 F2D3 FD1 FD2 FD3 -- D1 D2 D3 L2D1 L2D2 L2D3</span></span>
<span><span class="co">#  [1,]   -2    0    0  -1   0   0  1 NA NA NA   NA   NA   NA</span></span>
<span><span class="co">#  [2,]   -2    0    0  -1   0   0  2  1 NA NA   NA   NA   NA</span></span>
<span><span class="co">#  [3,]   -2    0    0  -1   0   0  3  1  0 NA    2   NA   NA</span></span>
<span><span class="co">#  [4,]   -2    0    0  -1   0   0  4  1  0  0    2   NA   NA</span></span>
<span><span class="co">#  [5,]   -2    0   NA  -1   0   0  5  1  0  0    2    0   NA</span></span>
<span><span class="co">#  [6,]   -2    0   NA  -1   0   0  6  1  0  0    2    0   NA</span></span>
<span><span class="co">#  [7,]   -2   NA   NA  -1   0   0  7  1  0  0    2    0    0</span></span>
<span><span class="co">#  [8,]   -2   NA   NA  -1   0  NA  8  1  0  0    2    0    0</span></span>
<span><span class="co">#  [9,]   NA   NA   NA  -1  NA  NA  9  1  0  0    2    0    0</span></span>
<span><span class="co"># [10,]   NA   NA   NA  NA  NA  NA 10  1  0  0    2    0    0</span></span></code></pre></div>
<p>All of this also works for panel data. The code below gives an
example:</p>
<div class="sourceCode" id="cb114"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">g</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, each <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span><span class="va">t</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>, <span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/fdiff.html">D</a></span><span class="op">(</span><span class="va">y</span>, <span class="op">-</span><span class="fl">2</span><span class="op">:</span><span class="fl">2</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, <span class="va">g</span>, <span class="va">t</span><span class="op">)</span></span>
<span><span class="co">#       F2D1 F2D2 FD1 FD2 -- D1 D2 L2D1 L2D2</span></span>
<span><span class="co">#  [1,]   -2    0  -1   0  1 NA NA   NA   NA</span></span>
<span><span class="co">#  [2,]   -2   NA  -1   0  2  1 NA   NA   NA</span></span>
<span><span class="co">#  [3,]   -2   NA  -1   0  3  1  0    2   NA</span></span>
<span><span class="co">#  [4,]   NA   NA  -1  NA  4  1  0    2   NA</span></span>
<span><span class="co">#  [5,]   NA   NA  NA  NA  5  1  0    2    0</span></span>
<span><span class="co">#  [6,]   -2    0  -1   0  6 NA NA   NA   NA</span></span>
<span><span class="co">#  [7,]   -2   NA  -1   0  7  1 NA   NA   NA</span></span>
<span><span class="co">#  [8,]   -2   NA  -1   0  8  1  0    2   NA</span></span>
<span><span class="co">#  [9,]   NA   NA  -1  NA  9  1  0    2   NA</span></span>
<span><span class="co"># [10,]   NA   NA  NA  NA 10  1  0    2    0</span></span></code></pre></div>
<p>Calls to <code>flag / L / F</code>, <code>fdiff / D</code> and
<code>fgrowth / G</code> can be nested. In the example below,
<code>L.matrix</code> is called on the right-half ob the above
sequence:</p>
<div class="sourceCode" id="cb115"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/flag.html">L</a></span><span class="op">(</span><span class="fu"><a href="../reference/fdiff.html">D</a></span><span class="op">(</span><span class="va">y</span>, <span class="fl">0</span><span class="op">:</span><span class="fl">2</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, <span class="va">g</span>, <span class="va">t</span><span class="op">)</span>, <span class="fl">0</span><span class="op">:</span><span class="fl">1</span>, <span class="va">g</span>, <span class="va">t</span><span class="op">)</span></span>
<span><span class="co">#       -- L1.-- D1 L1.D1 D2 L1.D2 L2D1 L1.L2D1 L2D2 L1.L2D2</span></span>
<span><span class="co">#  [1,]  1    NA NA    NA NA    NA   NA      NA   NA      NA</span></span>
<span><span class="co">#  [2,]  2     1  1    NA NA    NA   NA      NA   NA      NA</span></span>
<span><span class="co">#  [3,]  3     2  1     1  0    NA    2      NA   NA      NA</span></span>
<span><span class="co">#  [4,]  4     3  1     1  0     0    2       2   NA      NA</span></span>
<span><span class="co">#  [5,]  5     4  1     1  0     0    2       2    0      NA</span></span>
<span><span class="co">#  [6,]  6    NA NA    NA NA    NA   NA      NA   NA      NA</span></span>
<span><span class="co">#  [7,]  7     6  1    NA NA    NA   NA      NA   NA      NA</span></span>
<span><span class="co">#  [8,]  8     7  1     1  0    NA    2      NA   NA      NA</span></span>
<span><span class="co">#  [9,]  9     8  1     1  0     0    2       2   NA      NA</span></span>
<span><span class="co"># [10,] 10     9  1     1  0     0    2       2    0      NA</span></span></code></pre></div>
<!-- THIS GAVE ERROR ON CRAN Checks !! -->
<!-- If `n * diff` (or `n` in `flag / L / F`) exceeds the length of the data or the average group size in panel-computations, all of these functions will throw appropriate errors: -->
<!-- ```{r} -->
<!-- D(y, 3, 2, g, t) -->
<!-- ``` -->
<p><code>fdiff / D</code> and <code>fgrowth / G</code> also come with a
data frame method, making the computation of growth-variables on
datasets very easy:</p>
<div class="sourceCode" id="cb116"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/fgrowth.html">G</a></span><span class="op">(</span><span class="va">GGDC10S</span>, <span class="fl">1L</span>, <span class="fl">1L</span>, <span class="op">~</span> <span class="va">Variable</span> <span class="op">+</span> <span class="va">Country</span>, <span class="op">~</span> <span class="va">Year</span>, cols <span class="op">=</span> <span class="fl">6</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="va">head</span></span>
<span><span class="co">#   Variable Country Year    G1.AGR    G1.MIN   G1.MAN    G1.PU   G1.CON</span></span>
<span><span class="co"># 1       VA     BWA 1960        NA        NA       NA       NA       NA</span></span>
<span><span class="co"># 2       VA     BWA 1961        NA        NA       NA       NA       NA</span></span>
<span><span class="co"># 3       VA     BWA 1962        NA        NA       NA       NA       NA</span></span>
<span><span class="co"># 4       VA     BWA 1963        NA        NA       NA       NA       NA</span></span>
<span><span class="co"># 5       VA     BWA 1964        NA        NA       NA       NA       NA</span></span>
<span><span class="co"># 6       VA     BWA 1965 -3.524492 -28.57143 38.23529 29.41176 103.9604</span></span></code></pre></div>
<!-- One could also add variables by reference using *data.table*: -->
<!-- ```{r, warning=FALSE, message=FALSE, error=FALSE} -->
<!-- head(qDT(wlddev)[, paste0("G.", names(wlddev)[9:12]) := fgrowth(.SD,1,1,iso3c,year), .SDcols = 9:12]) -->
<!-- ``` -->
<!-- When working with *data.table* it is important to realize that while collapse functions will work with *data.table* grouping using `by` or `keyby`, this is very slow because it will run a method-dispatch for every group. It is much better and more secure to utilize the functions fast internal grouping facilities, as I have done in the above example. -->
<p>The code below estimates a dynamic panel model regressing the 10-year
growth rate of GDP per capita on it’s 10-year lagged level and the
10-year growth rate of life-expectancy:</p>
<div class="sourceCode" id="cb117"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="fu"><a href="../reference/fgrowth.html">G</a></span><span class="op">(</span><span class="va">PCGDP</span>,<span class="fl">10</span>,<span class="fl">1</span>,<span class="va">iso3c</span>,<span class="va">year</span><span class="op">)</span> <span class="op">~</span></span>
<span>             <span class="fu"><a href="../reference/flag.html">L</a></span><span class="op">(</span><span class="va">PCGDP</span>,<span class="fl">10</span>,<span class="va">iso3c</span>,<span class="va">year</span><span class="op">)</span> <span class="op">+</span></span>
<span>             <span class="fu"><a href="../reference/fgrowth.html">G</a></span><span class="op">(</span><span class="va">LIFEEX</span>,<span class="fl">10</span>,<span class="fl">1</span>,<span class="va">iso3c</span>,<span class="va">year</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">wlddev</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># Call:</span></span>
<span><span class="co"># lm(formula = G(PCGDP, 10, 1, iso3c, year) ~ L(PCGDP, 10, iso3c, </span></span>
<span><span class="co">#     year) + G(LIFEEX, 10, 1, iso3c, year), data = wlddev)</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># Residuals:</span></span>
<span><span class="co">#     Min      1Q  Median      3Q     Max </span></span>
<span><span class="co"># -104.32  -21.97   -3.96   13.26 1714.58 </span></span>
<span><span class="co"># </span></span>
<span><span class="co"># Coefficients:</span></span>
<span><span class="co">#                                 Estimate Std. Error t value Pr(&gt;|t|)    </span></span>
<span><span class="co"># (Intercept)                    2.740e+01  1.089e+00  25.168  &lt; 2e-16 ***</span></span>
<span><span class="co"># L(PCGDP, 10, iso3c, year)     -3.337e-04  4.756e-05  -7.016 2.49e-12 ***</span></span>
<span><span class="co"># G(LIFEEX, 10, 1, iso3c, year)  4.617e-01  1.124e-01   4.107 4.05e-05 ***</span></span>
<span><span class="co"># ---</span></span>
<span><span class="co"># Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># Residual standard error: 58.43 on 7113 degrees of freedom</span></span>
<span><span class="co">#   (6060 observations deleted due to missingness)</span></span>
<span><span class="co"># Multiple R-squared:  0.01132, Adjusted R-squared:  0.01104 </span></span>
<span><span class="co"># F-statistic: 40.73 on 2 and 7113 DF,  p-value: &lt; 2.2e-16</span></span></code></pre></div>
<p>To go a step further, the code below regresses the 10-year growth
rate of GDP on the 10-year lagged levels and 10-year growth rates of GDP
and life expectancy, with country and time-fixed effects projected out
using <code>HDW</code>. The standard errors are unreliable without
bootstrapping, but this example nicely demonstrates the potential for
complex estimations brought by <em>collapse</em>.</p>
<div class="sourceCode" id="cb118"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">moddat</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fhdbetween_fhdwithin.html">HDW</a></span><span class="op">(</span><span class="fu"><a href="../reference/flag.html">L</a></span><span class="op">(</span><span class="fu"><a href="../reference/fgrowth.html">G</a></span><span class="op">(</span><span class="va">wlddev</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">10</span><span class="op">)</span>, <span class="fl">1</span>, <span class="op">~</span><span class="va">iso3c</span>, <span class="op">~</span><span class="va">year</span>, <span class="fl">9</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">10</span><span class="op">)</span>, <span class="op">~</span><span class="va">iso3c</span>, <span class="op">~</span><span class="va">year</span><span class="op">)</span>, <span class="op">~</span><span class="va">iso3c</span> <span class="op">+</span> <span class="fu"><a href="../reference/qF.html">qF</a></span><span class="op">(</span><span class="va">year</span><span class="op">)</span><span class="op">)</span><span class="op">[</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">5</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">HDW.L10G1.PCGDP</span> <span class="op">~</span><span class="va">.</span> , <span class="va">moddat</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># Call:</span></span>
<span><span class="co"># lm(formula = HDW.L10G1.PCGDP ~ ., data = moddat)</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># Residuals:</span></span>
<span><span class="co">#     Min      1Q  Median      3Q     Max </span></span>
<span><span class="co"># -807.68  -10.80   -0.64   10.23  779.99 </span></span>
<span><span class="co"># </span></span>
<span><span class="co"># Coefficients:</span></span>
<span><span class="co">#                        Estimate Std. Error t value Pr(&gt;|t|)    </span></span>
<span><span class="co"># (Intercept)           1.907e-15  4.930e-01   0.000 1.000000    </span></span>
<span><span class="co"># HDW.L10.PCGDP        -2.500e-03  1.292e-04 -19.347  &lt; 2e-16 ***</span></span>
<span><span class="co"># HDW.L10.L10G1.PCGDP  -5.885e-01  1.082e-02 -54.412  &lt; 2e-16 ***</span></span>
<span><span class="co"># HDW.L10.LIFEEX        1.056e+00  2.885e-01   3.661 0.000254 ***</span></span>
<span><span class="co"># HDW.L10G1.LIFEEX      6.927e-01  1.154e-01   6.002 2.08e-09 ***</span></span>
<span><span class="co"># HDW.L10.L10G1.LIFEEX  8.749e-01  1.108e-01   7.899 3.39e-15 ***</span></span>
<span><span class="co"># ---</span></span>
<span><span class="co"># Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># Residual standard error: 35.69 on 5235 degrees of freedom</span></span>
<span><span class="co"># Multiple R-squared:  0.4029,  Adjusted R-squared:  0.4023 </span></span>
<span><span class="co"># F-statistic: 706.4 on 5 and 5235 DF,  p-value: &lt; 2.2e-16</span></span></code></pre></div>
<!-- How long did it take to run this computation? About 4 milliseconds on my laptop (2x 2.2 GHZ, 8 GB RAM), so there is plenty of room to do this with much larger data. -->
<!-- ```{r} -->
<!-- microbenchmark(HDW(L(G(wlddev, c(0, 10), 1, ~iso3c, ~year, 9:10), c(0, 10), ~iso3c, ~year), ~iso3c + qF(year))) -->
<!-- ``` -->
<p>One of the inconveniences of the above computations is that it
requires declaring the panel-identifiers <code>iso3c</code> and
<code>year</code> again and again for each function. A great remedy here
are the <em>plm</em> classes <em>pseries</em> and <em>pdata.frame</em>
which <em>collapse</em> was built to support. This shows how one could
run the same regression with plm:</p>
<div class="sourceCode" id="cb119"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pwlddev</span> <span class="op">&lt;-</span> <span class="fu">plm</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/plm/man/pdata.frame.html" class="external-link">pdata.frame</a></span><span class="op">(</span><span class="va">wlddev</span>, index <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"iso3c"</span>, <span class="st">"year"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">moddat</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fhdbetween_fhdwithin.html">HDW</a></span><span class="op">(</span><span class="fu"><a href="../reference/flag.html">L</a></span><span class="op">(</span><span class="fu"><a href="../reference/fgrowth.html">G</a></span><span class="op">(</span><span class="va">pwlddev</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">10</span><span class="op">)</span>, <span class="fl">1</span>, <span class="fl">9</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">10</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">[</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">5</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">HDW.L10G1.PCGDP</span> <span class="op">~</span><span class="va">.</span> , <span class="va">moddat</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># Call:</span></span>
<span><span class="co"># lm(formula = HDW.L10G1.PCGDP ~ ., data = moddat)</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># Residuals:</span></span>
<span><span class="co">#     Min      1Q  Median      3Q     Max </span></span>
<span><span class="co"># -677.61  -12.45   -1.02   10.86  913.22 </span></span>
<span><span class="co"># </span></span>
<span><span class="co"># Coefficients:</span></span>
<span><span class="co">#                        Estimate Std. Error t value Pr(&gt;|t|)    </span></span>
<span><span class="co"># (Intercept)           0.1456192  0.5187976   0.281 0.778962    </span></span>
<span><span class="co"># HDW.L10.PCGDP        -0.0022910  0.0001253 -18.291  &lt; 2e-16 ***</span></span>
<span><span class="co"># HDW.L10.L10G1.PCGDP  -0.5859896  0.0113538 -51.612  &lt; 2e-16 ***</span></span>
<span><span class="co"># HDW.L10.LIFEEX        0.8701877  0.2456255   3.543 0.000399 ***</span></span>
<span><span class="co"># HDW.L10G1.LIFEEX      0.6910533  0.1132028   6.105 1.11e-09 ***</span></span>
<span><span class="co"># HDW.L10.L10G1.LIFEEX  0.8990853  0.1068241   8.417  &lt; 2e-16 ***</span></span>
<span><span class="co"># ---</span></span>
<span><span class="co"># Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># Residual standard error: 37.51 on 5235 degrees of freedom</span></span>
<span><span class="co">#   (7935 observations deleted due to missingness)</span></span>
<span><span class="co"># Multiple R-squared:  0.3784,  Adjusted R-squared:  0.3778 </span></span>
<span><span class="co"># F-statistic: 637.4 on 5 and 5235 DF,  p-value: &lt; 2.2e-16</span></span></code></pre></div>
<p>To learn more about the integration of <em>collapse</em> and
<em>plm</em>, consult the corresponding vignette.</p>
</div>
</div>
<div class="section level2">
<h2 id="list-processing-and-a-panel-var-example">8. List Processing and a Panel-VAR Example<a class="anchor" aria-label="anchor" href="#list-processing-and-a-panel-var-example"></a>
</h2>
<p><em>collapse</em> also provides an ensemble of list-processing
functions that grew out of a necessity of working with complex nested
lists of data objects. The example provided in this section is also
somewhat complex, but it demonstrates the utility of these functions
while also providing a nice data-transformation task.</p>
<p>When summarizing the <code>GGDC10S</code> data in section 1, it was
evident that certain sectors have a high share of economic activity in
almost all countries in the sample. This prompts the question of whether
there exist common patterns in the interaction of these important
sectors across countries. One way to empirically study this could be
through a (Structural) Panel-Vector-Autoregression (PSVAR) in value
added with the 6 most important sectors (excluding government):
Agriculture, manufacturing, wholesale and retail trade, construction,
transport and storage and finance and real estate.</p>
<p>For this we will use the <em>vars</em> package<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content="&lt;p&gt;I noticed there is a &lt;em&gt;panelvar&lt;/em&gt; package, but I am
more familiar with &lt;em&gt;vars&lt;/em&gt; and &lt;em&gt;panelvar&lt;/em&gt; can be pretty
slow in my experience. We also have about 50 years of data here, so
dynamic panel bias is not a big issue.&lt;/p&gt;"><sup>6</sup></a>. Since <em>vars</em>
natively does not support panel-VAR, we need to create the central
<em>varest</em> object manually and then run the <code>SVAR</code>
function to impose identification restrictions. We start with exploring
and harmonizing the data:
<!-- and then the `irf` and `fevd` commands which create the impulse response functions and the forecast error variance decompositions, respectively.  --></p>
<!-- # We will estimate a panel-VAR with 1 lag -->
<!-- p <- 1 -->
<!-- # This creates a data.table containing the value added of the 6 most important non-government sectors -->
<!-- data <- qDT(GGDC10S)[Variable == "VA", c("Country","Year","AGR","MAN","WRT","CON","TRA","FIRE")] -->
<!-- # Standardizing by country takes country fixed-effects and gets rid of local-currencies -->
<!-- get_vars(data, 3:8) <- STD(data, ~ Country, cols = 3:8, keep.by = FALSE) -->
<!-- # This also subtracts time fixed-effects accounting for global shocks -->
<!-- data <- na_omit(cbind(get_vars(data, 1), W(data, ~ Year, cols = 3:8))) -->
<!-- # Here we add p panel-lags to the country-scaled and time-demeaned data -->
<!-- data <- cbind(get_vars(data, -(1:2)), L(data, 1:p, ~Country, ~Year, keep.ids = FALSE)) -->
<!-- # This removes missing values generated by L from all but the first row  -->
<!-- data <- rbind(data[1:p], na_omit(data[-(1:p)])) # (vars will treat this as a single time series) -->
<!-- # adding a contant term -->
<!-- data[["const"]] <- rep(1, nrow(data)) -->
<!-- # saving the names of the 6 sectors -->
<!-- nam <- names(data)[1:6] -->
<!-- AGRmat <- sweep(AGRmat, 1, rowMeans(AGRmat, na.rm = TRUE), "-") -->
<div class="sourceCode" id="cb120"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://www.pfaffikus.de" class="external-link">vars</a></span><span class="op">)</span></span>
<span><span class="co"># The 6 most important non-government sectors (see section 1)</span></span>
<span><span class="va">sec</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"AGR"</span>, <span class="st">"MAN"</span>, <span class="st">"WRT"</span>, <span class="st">"CON"</span>, <span class="st">"TRA"</span>, <span class="st">"FIRE"</span><span class="op">)</span></span>
<span><span class="co"># This creates a data.frame containing the value added of the 6 most important non-government sectors</span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fsubset.html">fsubset</a></span><span class="op">(</span><span class="va">GGDC10S</span>, <span class="va">Variable</span> <span class="op">==</span> <span class="st">"VA"</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Country"</span>, <span class="st">"Year"</span>, <span class="va">sec</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/efficient-programming.html">na_omit</a></span><span class="op">(</span>cols <span class="op">=</span> <span class="va">sec</span><span class="op">)</span></span>
<span><span class="co"># Let's look at the log VA in agriculture across countries:</span></span>
<span><span class="va">AGRmat</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/psmat.html">psmat</a></span><span class="op">(</span><span class="va">data</span>, <span class="va">AGR</span> <span class="op">~</span> <span class="va">Country</span>, <span class="op">~</span> <span class="va">Year</span>, transpose <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="va">log</span>   <span class="co"># Converting to panel series matrix</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">AGRmat</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="figure/AGRmat-1.png" alt="plot of chunk AGRmat" width="100%"><p class="caption">
plot of chunk AGRmat
</p>
</div>
<p>The plot shows quite some heterogeneity both in the levels (VA is in
local currency) and in trend growth rates. In the panel-VAR estimation
we are only really interested in the sectoral relationships within
countries. Thus we need to harmonize this sectoral data further. One way
would be taking growth rates or log-differences of the data, but VAR’s
are usually estimated in levels unless the data are cointegrated (and
value added series do not, in general, exhibit unit-root behavior). Thus
to harmonize the data further we opt for subtracting a country-sector
specific cubic trend from the data in logs:</p>
<div class="sourceCode" id="cb121"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Subtracting a country specific cubic growth trend</span></span>
<span><span class="va">AGRmat</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dapply.html">dapply</a></span><span class="op">(</span><span class="va">AGRmat</span>, <span class="va">fhdwithin</span>, <span class="fu"><a href="https://rdrr.io/r/stats/poly.html" class="external-link">poly</a></span><span class="op">(</span><span class="fu"><a href="../reference/efficient-programming.html">seq_row</a></span><span class="op">(</span><span class="va">AGRmat</span><span class="op">)</span>, <span class="fl">3</span><span class="op">)</span>, fill <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">AGRmat</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="figure/AGRmatplot-1.png" alt="plot of chunk AGRmatplot" width="100%"><p class="caption">
plot of chunk AGRmatplot
</p>
</div>
<p>This seems to have done a decent job in curbing most of the
heterogeneity. Some series however have a high variance around that
cubic trend. Therefore a final step is to standardize the data to bring
the variances in line:</p>
<div class="sourceCode" id="cb122"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Standardizing the cubic log-detrended data</span></span>
<span><span class="va">AGRmat</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fscale.html">fscale</a></span><span class="op">(</span><span class="va">AGRmat</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">AGRmat</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="figure/AGRmatplot2-1.png" alt="plot of chunk AGRmatplot2" width="100%"><p class="caption">
plot of chunk AGRmatplot2
</p>
</div>
<p>Now this looks pretty good, and is about the most we can do in terms
of harmonization without differencing the data. The code below applies
these transformations to all sectors:</p>
<div class="sourceCode" id="cb123"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Taking logs</span></span>
<span><span class="fu"><a href="../reference/ftransform.html">settransformv</a></span><span class="op">(</span><span class="va">data</span>, <span class="fl">3</span><span class="op">:</span><span class="fl">8</span>, <span class="va">log</span><span class="op">)</span></span>
<span><span class="co"># Projecting out country FE and cubic trends from complete cases</span></span>
<span><span class="fu"><a href="https://sebkrantz.github.io/collapse/reference/select_replace_vars.html">gv</a></span><span class="op">(</span><span class="va">data</span>, <span class="fl">3</span><span class="op">:</span><span class="fl">8</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fhdbetween_fhdwithin.html">HDW</a></span><span class="op">(</span><span class="va">data</span>, <span class="op">~</span> <span class="fu"><a href="../reference/qF.html">qF</a></span><span class="op">(</span><span class="va">Country</span><span class="op">)</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/stats/poly.html" class="external-link">poly</a></span><span class="op">(</span><span class="va">Year</span>, <span class="fl">3</span><span class="op">)</span>, fill <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co"># Scaling</span></span>
<span><span class="fu"><a href="https://sebkrantz.github.io/collapse/reference/select_replace_vars.html">gv</a></span><span class="op">(</span><span class="va">data</span>, <span class="fl">3</span><span class="op">:</span><span class="fl">8</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fscale.html">STD</a></span><span class="op">(</span><span class="va">data</span>, <span class="op">~</span> <span class="va">Country</span>, cols <span class="op">=</span> <span class="fl">3</span><span class="op">:</span><span class="fl">8</span>, keep.by <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Check the plot</span></span>
<span><span class="fu"><a href="../reference/psmat.html">psmat</a></span><span class="op">(</span><span class="va">data</span>, <span class="op">~</span> <span class="va">Country</span>, <span class="op">~</span> <span class="va">Year</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="va">plot</span></span></code></pre></div>
<div class="figure">
<img src="figure/psmatplot2-1.png" alt="plot of chunk psmatplot2" width="100%"><p class="caption">
plot of chunk psmatplot2
</p>
</div>
<p>Since the data is annual, let us estimate the Panel-VAR with one
lag:</p>
<div class="sourceCode" id="cb124"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># This adds one lag of all series to the data</span></span>
<span><span class="fu"><a href="../reference/select_replace_vars.html">add_vars</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/flag.html">L</a></span><span class="op">(</span><span class="va">data</span>, <span class="fl">1</span>, <span class="op">~</span> <span class="va">Country</span>, <span class="op">~</span> <span class="va">Year</span>, keep.ids <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co"># This removes missing values from all but the first row and drops identifier columns (vars is made for time series without gaps)</span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="fu"><a href="../reference/fsubset.html">ss</a></span><span class="op">(</span><span class="va">data</span>, <span class="fl">1</span>, <span class="op">-</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="../reference/efficient-programming.html">na_omit</a></span><span class="op">(</span><span class="fu"><a href="../reference/fsubset.html">ss</a></span><span class="op">(</span><span class="va">data</span>, <span class="op">-</span><span class="fl">1</span>, <span class="op">-</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span></span>
<span><span class="co">#   STD.HDW.AGR STD.HDW.MAN STD.HDW.WRT STD.HDW.CON STD.HDW.TRA STD.HDW.FIRE L1.STD.HDW.AGR</span></span>
<span><span class="co"># 1  0.65713943   2.2350584    1.946383 -0.03574399   1.0877811    1.0476507             NA</span></span>
<span><span class="co"># 2 -0.14377115   1.8693570    1.905081  1.23225734   1.0542315    0.9105622     0.65713943</span></span>
<span><span class="co"># 3 -0.09209878  -0.8212004    1.997253 -0.01783824   0.6718465    0.6134260    -0.14377115</span></span>
<span><span class="co"># 4 -0.25213869  -1.7830320   -1.970855 -2.68332505  -1.8475551    0.4382902    -0.09209878</span></span>
<span><span class="co"># 5 -0.31623401  -4.2931567   -1.822211 -2.75551916  -0.7066491   -2.1982640    -0.25213869</span></span>
<span><span class="co"># 6 -0.72691916  -1.3219387   -2.079333 -0.12148295  -1.1398220   -2.2230474    -0.31623401</span></span>
<span><span class="co">#   L1.STD.HDW.MAN L1.STD.HDW.WRT L1.STD.HDW.CON L1.STD.HDW.TRA L1.STD.HDW.FIRE</span></span>
<span><span class="co"># 1             NA             NA             NA             NA              NA</span></span>
<span><span class="co"># 2      2.2350584       1.946383    -0.03574399      1.0877811       1.0476507</span></span>
<span><span class="co"># 3      1.8693570       1.905081     1.23225734      1.0542315       0.9105622</span></span>
<span><span class="co"># 4     -0.8212004       1.997253    -0.01783824      0.6718465       0.6134260</span></span>
<span><span class="co"># 5     -1.7830320      -1.970855    -2.68332505     -1.8475551       0.4382902</span></span>
<span><span class="co"># 6     -4.2931567      -1.822211    -2.75551916     -0.7066491      -2.1982640</span></span></code></pre></div>
<p>Having prepared the data, the code below estimates the panel-VAR
using <code>lm</code> and creates the <em>varest</em> object:</p>
<!-- pVAR <- list(varresult = setNames(lapply(seq_len(6), function(i)    # list of 6 lm's each regressing -->
<!--                lm(as.formula(paste0(nam[i],"~ -1 + . ")),           # the sector on all lags of  -->
<!--                get_vars(data, c(i,7:length(data)))[-(1:p)])), nam), # itself and other sectors -->
<!--              datamat = data[-(1:p)], # The full data containing levels and lags of the sectors -->
<!--              y = do.call(cbind, get_vars(data, 1:6)), # Only the levels data as matrix -->
<!--              type = "const", # Specifying that a constant term was added -->
<!--              p = p, # The lag-order -->
<!--              K = 6, # The number of variables -->
<!--              obs = nrow(data)-p, # The number of non-missing obs -->
<!--              totobs = nrow(data), # The total number of obs -->
<!--              restrictions = NULL,  -->
<!--              call = quote(VAR(y = data))) -->
<div class="sourceCode" id="cb125"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># saving the names of the 6 sectors</span></span>
<span><span class="va">nam</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">6</span><span class="op">]</span></span>
<span></span>
<span><span class="va">pVAR</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>varresult <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html" class="external-link">setNames</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fl">6</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span>    <span class="co"># list of 6 lm's each regressing</span></span>
<span>               <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/formula.html" class="external-link">as.formula</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">nam</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="st">"~ -1 + . "</span><span class="op">)</span><span class="op">)</span>,          <span class="co"># the sector on all lags of</span></span>
<span>               <span class="fu"><a href="../reference/select_replace_vars.html">get_vars</a></span><span class="op">(</span><span class="va">data</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">i</span>, <span class="fl">7</span><span class="op">:</span><span class="fu"><a href="../reference/efficient-programming.html">fncol</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>, <span class="va">nam</span><span class="op">)</span>,         <span class="co"># itself and other sectors, removing the missing first row</span></span>
<span>             datamat <span class="op">=</span> <span class="fu"><a href="../reference/fsubset.html">ss</a></span><span class="op">(</span><span class="va">data</span>, <span class="op">-</span><span class="fl">1</span><span class="op">)</span>,                                <span class="co"># The full data containing levels and lags of the sectors, removing the missing first row</span></span>
<span>             y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">cbind</span>, <span class="fu"><a href="../reference/select_replace_vars.html">get_vars</a></span><span class="op">(</span><span class="va">data</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">6</span><span class="op">)</span><span class="op">)</span>,               <span class="co"># Only the levels data as matrix</span></span>
<span>             type <span class="op">=</span> <span class="st">"none"</span>,                                         <span class="co"># No constant or tend term: We harmonized the data already</span></span>
<span>             p <span class="op">=</span> <span class="fl">1</span>,                                                 <span class="co"># The lag-order</span></span>
<span>             K <span class="op">=</span> <span class="fl">6</span>,                                                 <span class="co"># The number of variables</span></span>
<span>             obs <span class="op">=</span> <span class="fu"><a href="../reference/efficient-programming.html">fnrow</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">-</span><span class="fl">1</span>,                                   <span class="co"># The number of non-missing obs</span></span>
<span>             totobs <span class="op">=</span> <span class="fu"><a href="../reference/efficient-programming.html">fnrow</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span>,                                  <span class="co"># The total number of obs</span></span>
<span>             restrictions <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>             call <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/substitute.html" class="external-link">quote</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/vars/man/VAR.html" class="external-link">VAR</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">data</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">pVAR</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="st">"varest"</span></span></code></pre></div>
<p>The significant serial-correlation test below suggests that the
panel-VAR with one lag is ill-identified, but the sample size is also
quite large so the test is prone to reject, and the test is likely also
still picking up remaining cross-sectional heterogeneity. For the
purposes of this vignette this shall not bother us.</p>
<div class="sourceCode" id="cb126"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/vars/man/serial.html" class="external-link">serial.test</a></span><span class="op">(</span><span class="va">pVAR</span><span class="op">)</span></span>
<span><span class="co"># </span></span>
<span><span class="co">#   Portmanteau Test (asymptotic)</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># data:  Residuals of VAR object pVAR</span></span>
<span><span class="co"># Chi-squared = 1680.8, df = 540, p-value &lt; 2.2e-16</span></span></code></pre></div>
<p>By default the VAR is identified using a Choleski ordering of the
direct impact matrix in which the first variable (here Agriculture) is
assumed to not be directly impacted by any other sector in the current
period, and this descends down to the last variable (Finance and Real
Estate), which is assumed to be impacted by all other sectors in the
current period. For structural identification it is usually necessary to
impose restrictions on the direct impact matrix in line with economic
theory. It is difficult to conceive theories on the average worldwide
interaction of broad economic sectors, but to aid identification we will
compute the correlation matrix in growth rates and restrict the lowest
coefficients to be 0, which should be better than just imposing a random
Choleski ordering.
<!-- This will also provide room for a demonstration of the grouped tibble methods for *collapse* functions, discussed in more detail in the '*collapse* and *dplyr*' vignette: --></p>
<!-- # This computes the correlation matrix in panel growth rates of VA of the 6 sectors, removing very large positive or negative growth rates:  -->
<!-- corr <- GGDC10S %>% fsubset(Variable == "VA") %>%                           # Taking VA series -->
<!--           G(by = ~Country, t = ~Year, cols = sec) %>% {                    # Exact panel growth rates -->
<!--            STD(replace_outliers(get_vars(.,3:8), c(-100, 100)), .$Country) # Standardizing (i.e. harmonizing trend growth rates and variance, and removing some gross outliers) -->
<!--           } %>% na_omit %>% pwcor                                          # Computing correlations -->
<!-- corr -->
<!-- ```{r} -->
<!-- # This computes the average correlation in growth rates of value added of the 6 sectors in each country -->
<!-- corr <- GGDC10S %>% fsubset(Variable == "VA") %>%         # Only VA data -->
<!--               psmat(~ Country, ~ Year, cols = sec) %>%   # Convert to 3D Array -->
<!--                 apply(1, function(x) pwcor(G(x))) %>%    # For each country (dimension 1) compute pairwise correlations of the sectoral growth rates -->
<!--                    rowMeans %>%                          # Compute the mean correlation coefficient across countries -->
<!--                      structure(dim = c(6,6),             # Output as a correlation matrix, class 'pwcor' for pretty printing -->
<!--                                dimnames = list(sec, sec),  -->
<!--                                class = "pwcov")  -->
<!-- corr -->
<!-- # Another solution using data.table ... a bit more compact -->
<!-- qDT(GGDC10S)[Variable == "VA", pwcor(fgrowth(.SD)), by = Country, .SDcols = sec][, -->
<!--              coef := rowid(Country)][, mean(V1), by = coef][[2]] %>% -->
<!--              structure(dim = c(6,6), dimnames = list(sec, sec), class = "pwcor") -->
<!-- ``` -->
<div class="sourceCode" id="cb127"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># This computes the pairwise correlations between standardized sectoral growth rates across countries</span></span>
<span><span class="va">corr</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fsubset.html">fsubset</a></span><span class="op">(</span><span class="va">GGDC10S</span>, <span class="va">Variable</span> <span class="op">==</span> <span class="st">"VA"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>   <span class="co"># Subset rows: Only VA</span></span>
<span>           <span class="fu"><a href="../reference/GRP.html">fgroup_by</a></span><span class="op">(</span><span class="va">Country</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>                <span class="co"># Group by country</span></span>
<span>                <span class="fu"><a href="../reference/select_replace_vars.html">get_vars</a></span><span class="op">(</span><span class="va">sec</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>                <span class="co"># Select the 6 sectors</span></span>
<span>                   <span class="va">fgrowth</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>                   <span class="co"># Compute Sectoral growth rates (a time-variable can be passed, but not necessary here as the data is ordered)</span></span>
<span>                      <span class="va">fscale</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>                 <span class="co"># Scale and center (i.e. standardize)</span></span>
<span>                         <span class="va">pwcor</span>                   <span class="co"># Compute Pairwise correlations</span></span>
<span></span>
<span><span class="va">corr</span></span>
<span><span class="co">#        AGR   MAN   WRT   CON   TRA  FIRE</span></span>
<span><span class="co"># AGR     1    .55   .59   .39   .52   .41</span></span>
<span><span class="co"># MAN    .55    1    .67   .54   .65   .48</span></span>
<span><span class="co"># WRT    .59   .67    1    .56   .66   .52</span></span>
<span><span class="co"># CON    .39   .54   .56    1    .53   .46</span></span>
<span><span class="co"># TRA    .52   .65   .66   .53    1    .51</span></span>
<span><span class="co"># FIRE   .41   .48   .52   .46   .51    1</span></span>
<span></span>
<span><span class="co"># We need to impose K*(K-1)/2 = 15 (with K = 6 variables) restrictions for identification</span></span>
<span><span class="va">corr</span><span class="op">[</span><span class="va">corr</span> <span class="op">&lt;=</span> <span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="va">corr</span><span class="op">)</span><span class="op">[</span><span class="fl">15</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span><span class="va">corr</span></span>
<span><span class="co">#        AGR   MAN   WRT   CON   TRA  FIRE</span></span>
<span><span class="co"># AGR     1    .55   .59   .00   .00   .00</span></span>
<span><span class="co"># MAN    .55    1    .67   .54   .65   .00</span></span>
<span><span class="co"># WRT    .59   .67    1    .56   .66   .00</span></span>
<span><span class="co"># CON    .00   .54   .56    1    .00   .00</span></span>
<span><span class="co"># TRA    .00   .65   .66   .00    1    .00</span></span>
<span><span class="co"># FIRE   .00   .00   .00   .00   .00    1</span></span>
<span></span>
<span><span class="co"># The rest is unknown (i.e. will be estimated)</span></span>
<span><span class="va">corr</span><span class="op">[</span><span class="va">corr</span> <span class="op">&gt;</span> <span class="fl">0</span> <span class="op">&amp;</span> <span class="va">corr</span> <span class="op">&lt;</span> <span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">NA</span></span>
<span></span>
<span><span class="co"># Using a diagonal shock vcov matrix (standard assumption for SVAR)</span></span>
<span><span class="va">Bmat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="fl">6</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="va">Bmat</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="cn">NA</span></span>
<span></span>
<span></span>
<span><span class="co"># This estimates the Panel-SVAR using Maximum Likelihood:</span></span>
<span><span class="va">pSVAR</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/vars/man/SVAR.html" class="external-link">SVAR</a></span><span class="op">(</span><span class="va">pVAR</span>, Amat <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">unclass</a></span><span class="op">(</span><span class="va">corr</span><span class="op">)</span>, Bmat <span class="op">=</span> <span class="va">Bmat</span>, estmethod <span class="op">=</span> <span class="st">"direct"</span><span class="op">)</span></span>
<span><span class="va">pSVAR</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># SVAR Estimation Results:</span></span>
<span><span class="co"># ======================== </span></span>
<span><span class="co"># </span></span>
<span><span class="co"># </span></span>
<span><span class="co"># Estimated A matrix:</span></span>
<span><span class="co">#              STD.HDW.AGR STD.HDW.MAN STD.HDW.WRT STD.HDW.CON STD.HDW.TRA STD.HDW.FIRE</span></span>
<span><span class="co"># STD.HDW.AGR       1.0000    -0.59223     0.51301      0.0000     0.00000            0</span></span>
<span><span class="co"># STD.HDW.MAN      -0.2547     1.00000    -0.07819     -0.1711     0.14207            0</span></span>
<span><span class="co"># STD.HDW.WRT      -0.3924    -0.56875     1.00000     -0.0135    -0.01391            0</span></span>
<span><span class="co"># STD.HDW.CON       0.0000     0.02595    -0.18541      1.0000     0.00000            0</span></span>
<span><span class="co"># STD.HDW.TRA       0.0000    -0.03321    -0.05370      0.0000     1.00000            0</span></span>
<span><span class="co"># STD.HDW.FIRE      0.0000     0.00000     0.00000      0.0000     0.00000            1</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># Estimated B matrix:</span></span>
<span><span class="co">#              STD.HDW.AGR STD.HDW.MAN STD.HDW.WRT STD.HDW.CON STD.HDW.TRA STD.HDW.FIRE</span></span>
<span><span class="co"># STD.HDW.AGR        0.678      0.0000      0.0000      0.0000      0.0000       0.0000</span></span>
<span><span class="co"># STD.HDW.MAN        0.000      0.6248      0.0000      0.0000      0.0000       0.0000</span></span>
<span><span class="co"># STD.HDW.WRT        0.000      0.0000      0.4155      0.0000      0.0000       0.0000</span></span>
<span><span class="co"># STD.HDW.CON        0.000      0.0000      0.0000      0.5028      0.0000       0.0000</span></span>
<span><span class="co"># STD.HDW.TRA        0.000      0.0000      0.0000      0.0000      0.5593       0.0000</span></span>
<span><span class="co"># STD.HDW.FIRE       0.000      0.0000      0.0000      0.0000      0.0000       0.6475</span></span></code></pre></div>
<p>Now this object is quite involved, which brings us to the actual
subject of this section:</p>
<div class="sourceCode" id="cb128"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># psVAR$var$varresult is a list containing the 6 linear models fitted above, it is not displayed in full here.</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">pSVAR</span>, give.attr <span class="op">=</span> <span class="cn">FALSE</span>, max.level <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span><span class="co"># List of 13</span></span>
<span><span class="co">#  $ A      : num [1:6, 1:6] 1 -0.255 -0.392 0 0 ...</span></span>
<span><span class="co">#  $ Ase    : num [1:6, 1:6] 0 0 0 0 0 0 0 0 0 0 ...</span></span>
<span><span class="co">#  $ B      : num [1:6, 1:6] 0.678 0 0 0 0 ...</span></span>
<span><span class="co">#  $ Bse    : num [1:6, 1:6] 0 0 0 0 0 0 0 0 0 0 ...</span></span>
<span><span class="co">#  $ LRIM   : NULL</span></span>
<span><span class="co">#  $ Sigma.U: num [1:6, 1:6] 43.898 24.88 23.941 4.873 0.661 ...</span></span>
<span><span class="co">#  $ LR     :List of 5</span></span>
<span><span class="co">#   ..$ statistic: Named num 1130</span></span>
<span><span class="co">#   ..$ parameter: Named num 1</span></span>
<span><span class="co">#   ..$ p.value  : Named num 0</span></span>
<span><span class="co">#   ..$ method   : chr "LR overidentification"</span></span>
<span><span class="co">#   ..$ data.name: symbol data</span></span>
<span><span class="co">#  $ opt    :List of 5</span></span>
<span><span class="co">#   ..$ par        : num [1:20] -0.2547 -0.3924 -0.5922 -0.5688 0.0259 ...</span></span>
<span><span class="co">#   ..$ value      : num 10924</span></span>
<span><span class="co">#   ..$ counts     : Named int [1:2] 501 NA</span></span>
<span><span class="co">#   ..$ convergence: int 1</span></span>
<span><span class="co">#   ..$ message    : NULL</span></span>
<span><span class="co">#  $ start  : num [1:20] 0.1 0.1 0.1 0.1 0.1 0.1 0.1 0.1 0.1 0.1 ...</span></span>
<span><span class="co">#  $ type   : chr "AB-model"</span></span>
<span><span class="co">#  $ var    :List of 10</span></span>
<span><span class="co">#   ..$ varresult   :List of 6</span></span>
<span><span class="co">#   .. ..$ STD.HDW.AGR :List of 13</span></span>
<span><span class="co">#   .. ..$ STD.HDW.MAN :List of 13</span></span>
<span><span class="co">#   .. ..$ STD.HDW.WRT :List of 13</span></span>
<span><span class="co">#   .. ..$ STD.HDW.CON :List of 13</span></span>
<span><span class="co">#   .. ..$ STD.HDW.TRA :List of 13</span></span>
<span><span class="co">#   .. ..$ STD.HDW.FIRE:List of 13</span></span>
<span><span class="co">#   ..$ datamat     :'data.frame':  2060 obs. of  12 variables:</span></span>
<span><span class="co">#   .. ..$ STD.HDW.AGR    : num [1:2060] -0.1438 -0.0921 -0.2521 -0.3162 -0.7269 ...</span></span>
<span><span class="co">#   .. ..$ STD.HDW.MAN    : num [1:2060] 1.869 -0.821 -1.783 -4.293 -1.322 ...</span></span>
<span><span class="co">#   .. ..$ STD.HDW.WRT    : num [1:2060] 1.91 2 -1.97 -1.82 -2.08 ...</span></span>
<span><span class="co">#   .. ..$ STD.HDW.CON    : num [1:2060] 1.2323 -0.0178 -2.6833 -2.7555 -0.1215 ...</span></span>
<span><span class="co">#   .. ..$ STD.HDW.TRA    : num [1:2060] 1.054 0.672 -1.848 -0.707 -1.14 ...</span></span>
<span><span class="co">#   .. ..$ STD.HDW.FIRE   : num [1:2060] 0.911 0.613 0.438 -2.198 -2.223 ...</span></span>
<span><span class="co">#   .. ..$ L1.STD.HDW.AGR : num [1:2060] 0.6571 -0.1438 -0.0921 -0.2521 -0.3162 ...</span></span>
<span><span class="co">#   .. ..$ L1.STD.HDW.MAN : num [1:2060] 2.235 1.869 -0.821 -1.783 -4.293 ...</span></span>
<span><span class="co">#   .. ..$ L1.STD.HDW.WRT : num [1:2060] 1.95 1.91 2 -1.97 -1.82 ...</span></span>
<span><span class="co">#   .. ..$ L1.STD.HDW.CON : num [1:2060] -0.0357 1.2323 -0.0178 -2.6833 -2.7555 ...</span></span>
<span><span class="co">#   .. ..$ L1.STD.HDW.TRA : num [1:2060] 1.088 1.054 0.672 -1.848 -0.707 ...</span></span>
<span><span class="co">#   .. ..$ L1.STD.HDW.FIRE: num [1:2060] 1.048 0.911 0.613 0.438 -2.198 ...</span></span>
<span><span class="co">#   ..$ y           : num [1:2061, 1:6] 0.6571 -0.1438 -0.0921 -0.2521 -0.3162 ...</span></span>
<span><span class="co">#   ..$ type        : chr "none"</span></span>
<span><span class="co">#   ..$ p           : num 1</span></span>
<span><span class="co">#   ..$ K           : num 6</span></span>
<span><span class="co">#   ..$ obs         : num 2060</span></span>
<span><span class="co">#   ..$ totobs      : int 2061</span></span>
<span><span class="co">#   ..$ restrictions: NULL</span></span>
<span><span class="co">#   ..$ call        : language VAR(y = data)</span></span>
<span><span class="co">#  $ iter   : Named int 501</span></span>
<span><span class="co">#  $ call   : language SVAR(x = pVAR, estmethod = "direct", Amat = unclass(corr), Bmat = Bmat)</span></span></code></pre></div>
<div class="section level3">
<h3 id="list-search-and-identification">8.1 List Search and Identification<a class="anchor" aria-label="anchor" href="#list-search-and-identification"></a>
</h3>
<p>When dealing with such a list-like object, we might be interested in
its complexity by measuring the level of nesting. This can be done with
<code>ldepth</code>:</p>
<div class="sourceCode" id="cb129"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># The list-tree of this object has 5 levels of nesting</span></span>
<span><span class="fu"><a href="../reference/ldepth.html">ldepth</a></span><span class="op">(</span><span class="va">pSVAR</span><span class="op">)</span></span>
<span><span class="co"># [1] 5</span></span>
<span></span>
<span><span class="co"># This data has a depth of 1, thus this dataset does not contain list-columns</span></span>
<span><span class="fu"><a href="../reference/ldepth.html">ldepth</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span></span>
<span><span class="co"># [1] 1</span></span></code></pre></div>
<p>Further we might be interested in knowing whether this list-object
contains non-atomic elements like call, terms or formulas. The function
<code>is.regular</code> in the <em>collapse</em> package checks if an
object is atomic or list-like, and the recursive version
<code>is_unlistable</code> checks whether all objects in a nested
structure are atomic or list-like:</p>
<div class="sourceCode" id="cb130"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Is this object composed only of atomic elements e.g. can it be unlisted?</span></span>
<span><span class="fu"><a href="../reference/is_unlistable.html">is_unlistable</a></span><span class="op">(</span><span class="va">pSVAR</span><span class="op">)</span></span>
<span><span class="co"># [1] FALSE</span></span></code></pre></div>
<p>Evidently this object is not unlistable, from viewing its structure
we know that it contains several call and terms objects. We might also
want to know if this object saves some kind of residuals or fitted
values. This can be done using <code>has_elem</code>, which also
supports regular expression search of element names:</p>
<div class="sourceCode" id="cb131"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Does this object contain an element with "fitted" in its name?</span></span>
<span><span class="fu"><a href="../reference/extract_list.html">has_elem</a></span><span class="op">(</span><span class="va">pSVAR</span>, <span class="st">"fitted"</span>, regex <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co"># [1] TRUE</span></span>
<span></span>
<span><span class="co"># Does this object contain an element with "residuals" in its name?</span></span>
<span><span class="fu"><a href="../reference/extract_list.html">has_elem</a></span><span class="op">(</span><span class="va">pSVAR</span>, <span class="st">"residuals"</span>, regex <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co"># [1] TRUE</span></span></code></pre></div>
<p>We might also want to know whether the object contains some kind of
data-matrix. This can be checked by calling:</p>
<div class="sourceCode" id="cb132"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Is there a matrix stored in this object?</span></span>
<span><span class="fu"><a href="../reference/extract_list.html">has_elem</a></span><span class="op">(</span><span class="va">pSVAR</span>, <span class="va">is.matrix</span><span class="op">)</span></span>
<span><span class="co"># [1] TRUE</span></span></code></pre></div>
<p>These functions can sometimes be helpful in exploring objects. A much
greater advantage of having functions to search and check lists is the
ability to write more complex programs with them (which will not be
demonstrated here).</p>
</div>
<div class="section level3">
<h3 id="list-subsetting">8.2 List Subsetting<a class="anchor" aria-label="anchor" href="#list-subsetting"></a>
</h3>
<p>Having gathered some information about the <code>pSVAR</code> object,
this section introduces several extractor functions to pull out elements
from such lists: <code>get_elem</code> can be used to pull out elements
from lists in a simplified format<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content="&lt;p&gt;The &lt;em&gt;vars&lt;/em&gt; package also provides convenient
extractor functions for some quantities, but &lt;code&gt;get_elem&lt;/code&gt; of
course works in a much broader range of contexts.&lt;/p&gt;"><sup>7</sup></a>.</p>
<div class="sourceCode" id="cb133"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># This is the path to the residuals from a single equation</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">pSVAR</span><span class="op">$</span><span class="va">var</span><span class="op">$</span><span class="va">varresult</span><span class="op">$</span><span class="va">STD.HDW.AGR</span><span class="op">$</span><span class="va">residuals</span><span class="op">)</span></span>
<span><span class="co">#  Named num [1:2060] -0.7234 -0.1962 -0.1993 0.0739 -0.1418 ...</span></span>
<span><span class="co">#  - attr(*, "names")= chr [1:2060] "2" "3" "4" "5" ...</span></span>
<span></span>
<span><span class="co"># get_elem gets the residuals from all 6 equations and puts them in a top-level list</span></span>
<span><span class="va">resid</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/extract_list.html">get_elem</a></span><span class="op">(</span><span class="va">pSVAR</span>, <span class="st">"residuals"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">resid</span>, give.attr <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co"># List of 6</span></span>
<span><span class="co">#  $ STD.HDW.AGR : Named num [1:2060] -0.7234 -0.1962 -0.1993 0.0739 -0.1418 ...</span></span>
<span><span class="co">#  $ STD.HDW.MAN : Named num [1:2060] 0.363 -1.989 -1.167 -3.082 1.474 ...</span></span>
<span><span class="co">#  $ STD.HDW.WRT : Named num [1:2060] 0.37 0.628 -3.054 -0.406 -0.384 ...</span></span>
<span><span class="co">#  $ STD.HDW.CON : Named num [1:2060] 1.035 -1.093 -2.62 -0.611 2.307 ...</span></span>
<span><span class="co">#  $ STD.HDW.TRA : Named num [1:2060] 0.1481 -0.2599 -2.2361 0.8619 -0.0915 ...</span></span>
<span><span class="co">#  $ STD.HDW.FIRE: Named num [1:2060] -0.11396 -0.33092 0.11754 -2.10521 -0.00968 ...</span></span>
<span></span>
<span><span class="co"># Quick conversion to matrix and plotting</span></span>
<span><span class="fu"><a href="../reference/quick-conversion.html">qM</a></span><span class="op">(</span><span class="va">resid</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/stats/plot.ts.html" class="external-link">plot.ts</a></span><span class="op">(</span>main <span class="op">=</span> <span class="st">"Panel-VAR Residuals"</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="figure/PVARplot-1.png" alt="plot of chunk PVARplot" width="100%"><p class="caption">
plot of chunk PVARplot
</p>
</div>
<p>Similarly, we could pull out and plot the fitted values:</p>
<div class="sourceCode" id="cb134"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Regular expression search and retrieval of fitted values</span></span>
<span><span class="fu"><a href="../reference/extract_list.html">get_elem</a></span><span class="op">(</span><span class="va">pSVAR</span>, <span class="st">"^fi"</span>, regex <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="va">qM</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/plot.ts.html" class="external-link">plot.ts</a></span><span class="op">(</span>main <span class="op">=</span> <span class="st">"Panel-VAR Fitted Values"</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="figure/PVARfittedplot-1.png" alt="plot of chunk PVARfittedplot" width="100%"><p class="caption">
plot of chunk PVARfittedplot
</p>
</div>
<p>Below the main quantities of interest in SVAR analysis are computed:
The impulse response functions (IRF’s) and forecast error variance
decompositions (FEVD’s):</p>
<div class="sourceCode" id="cb135"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># This computes orthogonalized impulse response functions</span></span>
<span><span class="va">pIRF</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/vars/man/irf.html" class="external-link">irf</a></span><span class="op">(</span><span class="va">pSVAR</span><span class="op">)</span></span>
<span><span class="co"># This computes the forecast error variance decompositions</span></span>
<span><span class="va">pFEVD</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/vars/man/fevd.html" class="external-link">fevd</a></span><span class="op">(</span><span class="va">pSVAR</span><span class="op">)</span></span></code></pre></div>
<p>The <code>pIRF</code> object contains the IRF’s with lower and upper
confidence bounds and some atomic elements providing information about
the object:</p>
<div class="sourceCode" id="cb136"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># See the structure of a vars IRF object:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">pIRF</span>, give.attr <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co"># List of 11</span></span>
<span><span class="co">#  $ irf       :List of 6</span></span>
<span><span class="co">#   ..$ STD.HDW.AGR : num [1:11, 1:6] 0.611 0.399 0.268 0.185 0.132 ...</span></span>
<span><span class="co">#   ..$ STD.HDW.MAN : num [1:11, 1:6] 0.1774 0.1549 0.134 0.1142 0.0959 ...</span></span>
<span><span class="co">#   ..$ STD.HDW.WRT : num [1:11, 1:6] -0.1807 -0.1071 -0.0647 -0.0402 -0.0259 ...</span></span>
<span><span class="co">#   ..$ STD.HDW.CON : num [1:11, 1:6] 0.0215 0.0383 0.0442 0.0438 0.0403 ...</span></span>
<span><span class="co">#   ..$ STD.HDW.TRA : num [1:11, 1:6] -0.02595 -0.01257 -0.00721 -0.00511 -0.00421 ...</span></span>
<span><span class="co">#   ..$ STD.HDW.FIRE: num [1:11, 1:6] 0 0.0122 0.0147 0.0132 0.0104 ...</span></span>
<span><span class="co">#  $ Lower     :List of 6</span></span>
<span><span class="co">#   ..$ STD.HDW.AGR : num [1:11, 1:6] 0.1137 -0.0144 -0.0393 -0.0446 -0.0439 ...</span></span>
<span><span class="co">#   ..$ STD.HDW.MAN : num [1:11, 1:6] -0.6474 -0.3434 -0.2069 -0.125 -0.0734 ...</span></span>
<span><span class="co">#   ..$ STD.HDW.WRT : num [1:11, 1:6] -0.659 -0.427 -0.311 -0.236 -0.189 ...</span></span>
<span><span class="co">#   ..$ STD.HDW.CON : num [1:11, 1:6] -0.721 -0.417 -0.258 -0.183 -0.123 ...</span></span>
<span><span class="co">#   ..$ STD.HDW.TRA : num [1:11, 1:6] -0.4161 -0.2568 -0.169 -0.1231 -0.0894 ...</span></span>
<span><span class="co">#   ..$ STD.HDW.FIRE: num [1:11, 1:6] 0 -0.0157 -0.022 -0.0227 -0.0211 ...</span></span>
<span><span class="co">#  $ Upper     :List of 6</span></span>
<span><span class="co">#   ..$ STD.HDW.AGR : num [1:11, 1:6] 1.218 0.801 0.565 0.389 0.275 ...</span></span>
<span><span class="co">#   ..$ STD.HDW.MAN : num [1:11, 1:6] 0.906 0.601 0.439 0.328 0.239 ...</span></span>
<span><span class="co">#   ..$ STD.HDW.WRT : num [1:11, 1:6] 0.846 0.601 0.428 0.319 0.239 ...</span></span>
<span><span class="co">#   ..$ STD.HDW.CON : num [1:11, 1:6] 0.716 0.514 0.4 0.305 0.234 ...</span></span>
<span><span class="co">#   ..$ STD.HDW.TRA : num [1:11, 1:6] 0.2866 0.21 0.1591 0.1207 0.0899 ...</span></span>
<span><span class="co">#   ..$ STD.HDW.FIRE: num [1:11, 1:6] 0 0.0363 0.0471 0.0461 0.0405 ...</span></span>
<span><span class="co">#  $ response  : chr [1:6] "STD.HDW.AGR" "STD.HDW.MAN" "STD.HDW.WRT" "STD.HDW.CON" ...</span></span>
<span><span class="co">#  $ impulse   : chr [1:6] "STD.HDW.AGR" "STD.HDW.MAN" "STD.HDW.WRT" "STD.HDW.CON" ...</span></span>
<span><span class="co">#  $ ortho     : logi TRUE</span></span>
<span><span class="co">#  $ cumulative: logi FALSE</span></span>
<span><span class="co">#  $ runs      : num 100</span></span>
<span><span class="co">#  $ ci        : num 0.05</span></span>
<span><span class="co">#  $ boot      : logi TRUE</span></span>
<span><span class="co">#  $ model     : chr "svarest"</span></span></code></pre></div>
<p>We could separately access the top-level atomic or list elements
using <code>atomic_elem</code> or <code>list_elem</code>:</p>
<div class="sourceCode" id="cb137"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Pool-out top-level atomic elements in the list</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="fu"><a href="../reference/extract_list.html">atomic_elem</a></span><span class="op">(</span><span class="va">pIRF</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># List of 8</span></span>
<span><span class="co">#  $ response  : chr [1:6] "STD.HDW.AGR" "STD.HDW.MAN" "STD.HDW.WRT" "STD.HDW.CON" ...</span></span>
<span><span class="co">#  $ impulse   : chr [1:6] "STD.HDW.AGR" "STD.HDW.MAN" "STD.HDW.WRT" "STD.HDW.CON" ...</span></span>
<span><span class="co">#  $ ortho     : logi TRUE</span></span>
<span><span class="co">#  $ cumulative: logi FALSE</span></span>
<span><span class="co">#  $ runs      : num 100</span></span>
<span><span class="co">#  $ ci        : num 0.05</span></span>
<span><span class="co">#  $ boot      : logi TRUE</span></span>
<span><span class="co">#  $ model     : chr "svarest"</span></span></code></pre></div>
<p>There are also recursive versions of <code>atomic_elem</code> and
<code>list_elem</code> named <code>reg_elem</code> and
<code>irreg_elem</code> which can be used to split nested lists into the
atomic and non-atomic parts. These are not covered in this vignette.</p>
</div>
<div class="section level3">
<h3 id="recursive-apply-and-unlisting-in-2d">8.3 Recursive Apply and Unlisting in 2D<a class="anchor" aria-label="anchor" href="#recursive-apply-and-unlisting-in-2d"></a>
</h3>
<p><em>vars</em> supplies simple <code>plot</code> methods for IRF and
FEVD objects using base graphics. <!-- , for example: -->
<!-- ```{r} -->
<!-- # Plot the forecast-error variance decmpositions -->
<!-- plot(pFEVD) --> <!-- ``` -->
<!-- `plot(pIRF)` would give us 6 charts of all sectoral responses to each sectoral shock.  -->
In this section we however want to generate nicer and more compact plots
using <code>ggplot2</code>, and also compute some statistics on the IRF
data. Starting with the latter, the code below sums the 10-period
impulse response coefficients of each sector in response to each
sectoral impulse and stores them in a data frame:</p>
<div class="sourceCode" id="cb138"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Computing the cumulative impact after 10 periods</span></span>
<span><span class="fu"><a href="../reference/extract_list.html">list_elem</a></span><span class="op">(</span><span class="va">pIRF</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>                            <span class="co"># Pull out the sublist elements containing the IRF coefficients + CI's</span></span>
<span>  <span class="fu"><a href="../reference/rapply2d.html">rapply2d</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="../reference/fsum.html">fsum</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>  <span class="co"># Recursively apply the column-sums to coefficient matrices (could also use colSums)</span></span>
<span>  <span class="fu"><a href="../reference/unlist2d.html">unlist2d</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Type"</span>, <span class="st">"Impulse"</span><span class="op">)</span><span class="op">)</span>               <span class="co"># Recursively row-bind the result to a data.frame and add identifier columns</span></span>
<span><span class="co">#     Type      Impulse STD.HDW.AGR STD.HDW.MAN STD.HDW.WRT STD.HDW.CON STD.HDW.TRA STD.HDW.FIRE</span></span>
<span><span class="co"># 1    irf  STD.HDW.AGR        1.92        1.08        1.68        0.83        0.72         0.54</span></span>
<span><span class="co"># 2    irf  STD.HDW.MAN        0.98        2.22        2.12        1.09        0.97         1.05</span></span>
<span><span class="co"># 3    irf  STD.HDW.WRT       -0.47       -0.27        0.65        0.17        0.03        -0.02</span></span>
<span><span class="co"># 4    irf  STD.HDW.CON        0.33        0.39        0.34        2.00        0.55         0.38</span></span>
<span><span class="co"># 5    irf  STD.HDW.TRA       -0.07       -0.11       -0.24       -0.30        1.31        -0.20</span></span>
<span><span class="co"># 6    irf STD.HDW.FIRE        0.07       -0.07        0.02       -0.09       -0.06         1.84</span></span>
<span><span class="co"># 7  Lower  STD.HDW.AGR       -0.18       -2.08       -3.14       -0.68       -2.46        -0.68</span></span>
<span><span class="co"># 8  Lower  STD.HDW.MAN       -1.52        0.38       -1.30       -0.86       -1.82         0.12</span></span>
<span><span class="co"># 9  Lower  STD.HDW.WRT       -2.38       -2.65       -0.22       -2.68       -2.01        -1.20</span></span>
<span><span class="co"># 10 Lower  STD.HDW.CON       -2.01       -2.47       -2.16        0.53       -1.68        -0.80</span></span>
<span><span class="co"># 11 Lower  STD.HDW.TRA       -1.32       -1.34       -1.17       -1.64        0.31        -0.69</span></span>
<span><span class="co"># 12 Lower STD.HDW.FIRE       -0.16       -0.26       -0.16       -0.27       -0.20         0.96</span></span>
<span><span class="co"># 13 Upper  STD.HDW.AGR        3.97        3.18        3.21        3.69        2.61         1.58</span></span>
<span><span class="co"># 14 Upper  STD.HDW.MAN        3.19        3.85        3.00        3.60        3.05         1.78</span></span>
<span><span class="co"># 15 Upper  STD.HDW.WRT        3.06        2.66        4.41        2.49        3.31         1.47</span></span>
<span><span class="co"># 16 Upper  STD.HDW.CON        2.85        3.30        3.20        3.88        2.59         1.76</span></span>
<span><span class="co"># 17 Upper  STD.HDW.TRA        1.08        1.93        1.76        0.72        2.82         0.63</span></span>
<span><span class="co"># 18 Upper STD.HDW.FIRE        0.30        0.15        0.30        0.12        0.18         2.21</span></span></code></pre></div>
<p>The function <code>rapply2d</code> used here is very similar to
<code><a href="https://rdrr.io/r/base/rapply.html" class="external-link">base::rapply</a></code>, with the difference that the result is not
simplified / unlisted by default and that <code>rapply2d</code> will
treat data frames like atomic objects and apply functions to them.
<code>unlist2d</code> is an efficient generalization of
<code><a href="https://rdrr.io/r/base/unlist.html" class="external-link">base::unlist</a></code> to 2-dimensions, or one could also think of it
as a recursive generalization of <code>do.call(rbind, ...)</code>. It
efficiently unlists nested lists of data objects and creates a data
frame with identifier columns for each level of nesting on the left, and
the content of the list in columns on the right.</p>
<p>The above cumulative coefficients suggest that Agriculture responds
mostly to it’s own shock, and a bit to shocks in Manufacturing and
Wholesale and Retail Trade. Similar patters can be observed for
Manufacturing and Wholesale and Retail Trade. Thus these three sectors
seem to be interlinked in most countries. The remaining three sectors
are mostly affected by their own dynamics, but also by Agriculture and
Manufacturing.</p>
<!-- Finance and Real Estate sector seems even more independent and really only responds to it's own dynamics. Manufacturing and Transport and Storage seem to be pretty interlinked with the other broad sectors. Wholesale and Retail Trade and Construction exhibit some strange dynamics (i.e. WRT responds more to the CON shock that to it's own shock, and CON responds strongly negatively to the WRT shock). -->
<p>Let us use <code>ggplot2</code> to create nice compact plots of the
IRF’s and FEVD’s. For this task <code>unlist2d</code> will again be
extremely helpful in creating the data frame representation required.
Starting with the IRF’s, we will discard the upper and lower bounds and
just use the impulses:</p>
<div class="sourceCode" id="cb139"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># This binds the matrices after adding integer row-names to them to a data.table</span></span>
<span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span> <span class="va">pIRF</span><span class="op">$</span><span class="va">irf</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>                      <span class="co"># Get only the coefficient matrices, discard the confidence bounds</span></span>
<span>           <span class="fu"><a href="../reference/unlist2d.html">unlist2d</a></span><span class="op">(</span>idcols <span class="op">=</span> <span class="st">"Impulse"</span>,   <span class="co"># Recursive unlisting to data.table creating a factor id-column</span></span>
<span>                    row.names <span class="op">=</span> <span class="st">"Time"</span>,   <span class="co"># and saving generated rownames in a variable called 'Time'</span></span>
<span>                    id.factor <span class="op">=</span> <span class="cn">TRUE</span>,     <span class="co"># -&gt; Create Id column ('Impulse') as factor</span></span>
<span>                    DT <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>            <span class="co"># -&gt; Output as data.table (default is data.frame)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">data</span>, <span class="fl">3</span><span class="op">)</span></span>
<span><span class="co">#        Impulse  Time STD.HDW.AGR STD.HDW.MAN STD.HDW.WRT STD.HDW.CON STD.HDW.TRA STD.HDW.FIRE</span></span>
<span><span class="co">#         &lt;fctr&gt; &lt;int&gt;       &lt;num&gt;       &lt;num&gt;       &lt;num&gt;       &lt;num&gt;       &lt;num&gt;        &lt;num&gt;</span></span>
<span><span class="co"># 1: STD.HDW.AGR     1   0.6113132   0.1896711   0.3488940  0.05976606  0.02503336   0.00000000</span></span>
<span><span class="co"># 2: STD.HDW.AGR     2   0.3986337   0.1892803   0.3014961  0.09430567  0.07263670   0.03669857</span></span>
<span><span class="co"># 3: STD.HDW.AGR     3   0.2676944   0.1654161   0.2491999  0.10769335  0.09330830   0.06042380</span></span>
<span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/melt.data.table.html" class="external-link">melt</a></span><span class="op">(</span><span class="va">data</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">)</span>                   <span class="co"># Using data.table's melt</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">data</span>, <span class="fl">3</span><span class="op">)</span></span>
<span><span class="co">#        Impulse  Time    variable     value</span></span>
<span><span class="co">#         &lt;fctr&gt; &lt;int&gt;      &lt;fctr&gt;     &lt;num&gt;</span></span>
<span><span class="co"># 1: STD.HDW.AGR     1 STD.HDW.AGR 0.6113132</span></span>
<span><span class="co"># 2: STD.HDW.AGR     2 STD.HDW.AGR 0.3986337</span></span>
<span><span class="co"># 3: STD.HDW.AGR     3 STD.HDW.AGR 0.2676944</span></span>
<span></span>
<span><span class="co"># Here comes the plot:</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">data</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">Time</span>, y <span class="op">=</span> <span class="va">value</span>, color <span class="op">=</span> <span class="va">Impulse</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html" class="external-link">I</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_hline</a></span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>y <span class="op">=</span> <span class="cn">NULL</span>, title <span class="op">=</span> <span class="st">"Orthogonal Impulse Response Functions"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_color_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/palettes.html" class="external-link">rainbow</a></span><span class="op">(</span><span class="fl">6</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span> <span class="va">variable</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_light</a></span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">14</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_x_continuous</a></span><span class="op">(</span>breaks <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/pretty_breaks.html" class="external-link">pretty_breaks</a></span><span class="op">(</span>n<span class="op">=</span><span class="fl">7</span><span class="op">)</span>, expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span>breaks <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/pretty_breaks.html" class="external-link">pretty_breaks</a></span><span class="op">(</span>n<span class="op">=</span><span class="fl">7</span><span class="op">)</span>, expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>axis.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>colour <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span>,</span>
<span>      plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>hjust <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span>,</span>
<span>      strip.background <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_rect</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"white"</span>, colour <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span>,</span>
<span>      strip.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>face <span class="op">=</span> <span class="st">"bold"</span>, colour <span class="op">=</span> <span class="st">"grey30"</span><span class="op">)</span>,</span>
<span>      axis.ticks <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_line</a></span><span class="op">(</span>colour <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span>,</span>
<span>      panel.border <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_rect</a></span><span class="op">(</span>colour <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="figure/IRFplot-1.png" alt="plot of chunk IRFplot" width="100%"><p class="caption">
plot of chunk IRFplot
</p>
</div>
<p>To round things off, below we do the same thing for the FEVD’s:</p>
<div class="sourceCode" id="cb140"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/unlist2d.html">unlist2d</a></span><span class="op">(</span><span class="va">pFEVD</span>, idcols <span class="op">=</span> <span class="st">"variable"</span>, row.names <span class="op">=</span> <span class="st">"Time"</span>, id.factor <span class="op">=</span> <span class="cn">TRUE</span>, DT <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>            <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/melt.data.table.html" class="external-link">melt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"variable"</span>, <span class="st">"Time"</span><span class="op">)</span>, variable.name <span class="op">=</span> <span class="st">"Sector"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">data</span>, <span class="fl">3</span><span class="op">)</span></span>
<span><span class="co">#       variable  Time      Sector     value</span></span>
<span><span class="co">#         &lt;fctr&gt; &lt;int&gt;      &lt;fctr&gt;     &lt;num&gt;</span></span>
<span><span class="co"># 1: STD.HDW.AGR     1 STD.HDW.AGR 0.8513029</span></span>
<span><span class="co"># 2: STD.HDW.AGR     2 STD.HDW.AGR 0.8385913</span></span>
<span><span class="co"># 3: STD.HDW.AGR     3 STD.HDW.AGR 0.8264789</span></span>
<span></span>
<span><span class="co"># Here comes the plot:</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">data</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">Time</span>, y <span class="op">=</span> <span class="va">value</span>, fill <span class="op">=</span> <span class="va">Sector</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_area</a></span><span class="op">(</span>position <span class="op">=</span> <span class="st">"fill"</span>, alpha <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>y <span class="op">=</span> <span class="cn">NULL</span>, title <span class="op">=</span> <span class="st">"Forecast Error Variance Decompositions"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_fill_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/palettes.html" class="external-link">rainbow</a></span><span class="op">(</span><span class="fl">6</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span> <span class="fu"><a href="https://magrittr.tidyverse.org/reference/aliases.html" class="external-link">set_class</a></span><span class="op">(</span><span class="va">variable</span>, <span class="st">"factor"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_linedraw</a></span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">14</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_x_continuous</a></span><span class="op">(</span>breaks <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/pretty_breaks.html" class="external-link">pretty_breaks</a></span><span class="op">(</span>n<span class="op">=</span><span class="fl">7</span><span class="op">)</span>, expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span>breaks <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/pretty_breaks.html" class="external-link">pretty_breaks</a></span><span class="op">(</span>n<span class="op">=</span><span class="fl">7</span><span class="op">)</span>, expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>hjust <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span>,</span>
<span>      strip.background <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_rect</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"white"</span>, colour <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span>,</span>
<span>      strip.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>face <span class="op">=</span> <span class="st">"bold"</span>, colour <span class="op">=</span> <span class="st">"grey30"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="figure/FEVDplot-1.png" alt="plot of chunk FEVDplot" width="100%"><p class="caption">
plot of chunk FEVDplot
</p>
</div>
<p>Both the IRF’s and the FEVD’s show that Agriculture, Manufacturing
and Wholesale and Retail Trade are broadly interlinked, even in the
short-run, and that Agriculture and Manufacturing explain some of the
variation in Construction, Transport and Finance at longer horizons. Of
course the identification strategy used for this example was not really
structural or theory based. A better strategy could be to aggregate the
World Input-Output Database and use those shares for identification
(which would be another very nice <em>collapse</em> exercise, but not
for this vignette).</p>
<!-- . There are also not much dynamics in the FEVD, suggesting that longer lag-lengths might be appropriate. The most important point of critique for this analysis is the structural identification strategy which is highly dubious (as correlation does not imply causation and we are also restricting sectoral relationships with a lower correlation to be 0 in the current period). A better method could be to aggregate the World Input-Output Database and use those shares for identification (which would be another very nice *collapse* exercise, but not for this vignette). -->
</div>
</div>
<div class="section level2">
<h2 id="going-further">Going Further<a class="anchor" aria-label="anchor" href="#going-further"></a>
</h2>
<p>To learn more about <em>collapse</em>, just examine the documentation
<code><a href="../reference/collapse-documentation.html">help("collapse-documentation")</a></code> which is organized,
extensive and contains lots of examples.</p>
</div>
<div class="section level2">
<h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<p>Timmer, M. P., de Vries, G. J., &amp; de Vries, K. (2015). “Patterns
of Structural Change in Developing Countries.” . In J. Weiss, &amp; M.
Tribe (Eds.), <em>Routledge Handbook of Industry and Development.</em>
(pp. 65-83). Routledge.</p>
<p>Mundlak, Yair. 1978. “On the Pooling of Time Series and Cross Section
Data.” <em>Econometrica</em> 46 (1): 69–85.</p>
<!-- ## Benchmarks vs. *dplyr* and *data.table* -->
<!-- **Notes:**  -->
<!-- * Benchmarks are run on real and generated data, always with missing values. The largest data size is 10 columns each 1 Million Obs. and 100000 groups. -->
<!-- * Benchmarks are run on a conventional Windows 8.1 laptop with 2x 2.2 GHZ Intel i5 processor, 8GB DDR3 RAM and a Samsung 850 EVO SSD.  -->
<!-- * *data.table* multi-threading is enabled and 2 thread are used. *collapse* and *dplyr* are not parallelized.  -->
<!-- ### Aggregations -->
<!-- #### Large Data -->
<!-- ```{r, eval=RUNBENCH} -->
<!-- # Creating a data.table with 10 columns and 1 mio. obs, including 10% missing values -->
<!-- testdat <- na_insert(qDT(replicate(10, rnorm(1e6), simplify = FALSE)), prop = 0.1)  -->
<!-- testdat[["g1"]] <- sample.int(1000, 1e6, replace = TRUE) # 1000 groups -->
<!-- testdat[["g2"]] <- sample.int(100, 1e6, replace = TRUE) # 100 groups -->
<!-- # The average group size is 10, there are about 100000 groups -->
<!-- gtestdat <- group_by(testdat, g1, g2) -->
<!-- g <- GRP(testdat, ~ g1 + g2) -->
<!-- g -->
<!-- # Function performing the comparison -->
<!-- benchFUN <- function(FUN, fFUN, neval = 10, narm = TRUE, ...) { -->
<!--   eval(substitute(microbenchmark( -->
<!--    dplyr = summarize_all(group_by(testdat, g1, g2), FUN, ...), -->
<!--    dplyr_grouped = summarize_all(gtestdat, FUN, ...), -->
<!--    data.table_2_threads = testdat[, lapply(.SD, FUN, ...), keyby = c("g1","g2")], -->
<!--    collapse = collap(testdat, ~ g1 + g2, fFUN, keep.col.order = FALSE, na.rm = narm), -->
<!--    collapse_grouped = collap(testdat, g, fFUN, cols = 1:10, keep.col.order = FALSE, na.rm = narm),  -->
<!--    times = neval -->
<!--   ))) -->
<!-- } -->
<!-- # Sum -->
<!-- benchFUN(sum, fsum, na.rm = TRUE) -->
<!-- # Product -->
<!-- benchFUN(prod, fprod, na.rm = TRUE) -->
<!-- # Mean -->
<!-- benchFUN(mean, fmean, na.rm = TRUE) -->
<!-- # Maximum -->
<!-- benchFUN(max, fmax, na.rm = TRUE) -->
<!-- # Median -->
<!-- benchFUN(median, fmedian, 1, na.rm = TRUE) -->
<!-- # Variance -->
<!-- benchFUN(var, fvar, 1, na.rm = TRUE) -->
<!-- # Note: fvar implements a numerically stable online variance using Welfords Algorithm. -->
<!-- # Last Value -->
<!-- benchFUN(last, flast, 1, narm = FALSE) -->
<!-- # Note: collapse functions ffirst and flast by default also remove missing values i.e. take the first and last non-missing data point -->
<!-- # Number of Observations -->
<!-- options(collapse_unused_arg_action = "none") -->
<!-- benchFUN(function(x) sum(!is.na(x)), fnobs, 1) -->
<!-- # Number of Distinct Values -->
<!-- benchFUN(n_distinct, fndistinct, 1, na.rm = TRUE) -->
<!-- ``` -->
<!-- Below some weighted and mode computations that are not straightforward in *dplyr* or *data.table*: -->
<!-- ```{r, eval=RUNBENCH} -->
<!-- # Weighted Mean -->
<!-- w <- abs(100*rnorm(1e6)) + 1 -->
<!-- testdat[["w"]] <- w -->
<!-- # Seems not possible with dplyr ... -->
<!-- system.time(testdat[, lapply(.SD, weighted.mean, w = w, na.rm = TRUE), keyby = c("g1","g2")]) -->
<!-- system.time(collap(testdat, ~ g1 + g2, w = w)) -->
<!-- # Weighted Variance -->
<!-- system.time(collap(testdat, ~ g1 + g2, fvar, w = w)) -->
<!-- # Mode -->
<!-- system.time(collap(testdat, ~ g1 + g2, fmode)) -->
<!-- # Note: This mode function uses index hashing in C++ -->
<!-- # Weighted Mode -->
<!-- system.time(collap(testdat, ~ g1 + g2, fmode, w = w)) -->
<!-- ``` -->
<!-- #### Typical Data -->
<!-- #### Small Data -->
<!-- When it comes to larger aggregation problems, the performance if *collapse* is broadly in line with *data.table* (at least on this machine), and offers the additional advantage of high-performance weighted and categorical aggregations: -->
<!-- I believe on really huge datasets aggregated on a multi-core machine, *data.table*'s memory efficiency and thread-parallelization will let it run faster with some GeForce optimized functions, but that does not apply to most users (I have tested up to 10 million obs. on my laptop where *collapse* is still very much in line). In comparison to *collapse* and *data.table* the performance of *dplyr* on this data is rather poor, especially for base functions that are not highly optimized like `sum`. I do however very much appreciate the tidyverse ecosystem for highly organized data exploration and transformation. Therefore I have created methods for all of the *Fast Statistical Functions* as well as `collap`, enabling them to be used effectively in the *dplyr* ecosystem where they produce amazing speed gains. This is the subject of the '*collapse* and *dplyr*' vignette. -->
<!-- Apart from its non-reliance on non-standard evaluation, a central advantage of *collapse* for programming is the speed it maintains on smaller problems where it's more efficient R code compared to *dplyr* and *data.table* really plays out: -->
<!-- ```{r, eval=RUNBENCH} -->
<!-- # 12000 obs in 1500 groups: A more typical case -->
<!-- GRP(wlddev, ~ iso3c + decade) -->
<!-- library(microbenchmark) -->
<!-- dtwlddev <- qDT(wlddev) -->
<!-- microbenchmark(dplyr = dtwlddev %>% group_by(iso3c,decade) %>% select_at(9:12) %>% summarise_all(sum, na.rm = TRUE), -->
<!--                data.table = dtwlddev[, lapply(.SD, sum, na.rm = TRUE), by = c("iso3c","decade"), .SDcols = 9:12], -->
<!--                collap = collap(dtwlddev, ~ iso3c + decade, fsum, cols = 9:12), -->
<!--                fast_fun = fsum(get_vars(dtwlddev, 9:12), GRP(dtwlddev, ~ iso3c + decade), use.g.names = FALSE)) # We can gain a bit coding it manually -->
<!-- # Now going really small: -->
<!-- dtmtcars <- qDT(mtcars) -->
<!-- microbenchmark(dplyr = dtmtcars %>% group_by(cyl,vs,am) %>% summarise_all(sum, na.rm = TRUE),      # Large R overhead -->
<!--                data.table = dtmtcars[, lapply(.SD, sum, na.rm = TRUE), by = c("cyl","vs","am")],   # Large R overhead -->
<!--                collap = collap(dtmtcars, ~ cyl + vs + am, fsum),                                   # Now this is still quite efficient -->
<!--                fast_fun = fsum(dtmtcars, GRP(dtmtcars, ~ cyl + vs + am), use.g.names = FALSE))     # And this is nearly the speed of a full C++ implementation -->
<!-- ``` -->
<!-- In general, the smaller the problem, the greater advantage *collapse* has over other packages because it's R overhead (i.e. the R code executed before the actual C-function doing the hard work is called) is carefully minimized. Most users working on typical datasets (< 1 Mio obs.) will find that their code runs significantly faster when implemented in *collapse* compared to other solutions. -->
<!-- ### Transformation Benchmarks -->
<!-- Below I provide benchmarks for some very common data transformation tasks, again comparing *collapse* to *dplyr* and *data.table*: -->
<!-- ```{r, eval=RUNBENCH} -->
<!-- # The average group size is 10, there are about 100000 groups -->
<!-- GRP(testdat, ~ g1 + g2) -->
<!-- # get indices of grouping columns -->
<!-- ind <- get_vars(testdat, c("g1","g2"), "indices") -->
<!-- # Centering -->
<!-- system.time(testdat %>% group_by(g1,g2) %>% mutate_all(function(x) x - mean.default(x, na.rm = TRUE))) -->
<!-- system.time(testdat[, lapply(.SD, function(x) x - mean(x, na.rm = TRUE)), keyby = c("g1","g2")]) -->
<!-- system.time(W(testdat, ~ g1 + g2)) -->
<!-- # Weighted Centering -->
<!-- # Can't easily be done in dplyr.. -->
<!-- system.time(testdat[, lapply(.SD, function(x) x - weighted.mean(x, w, na.rm = TRUE)), keyby = c("g1","g2")]) -->
<!-- system.time(W(testdat, ~ g1 + g2, ~ w)) -->
<!-- # Centering on the overall mean -->
<!-- # Can't easily be done in dplyr or data.table. -->
<!-- system.time(W(testdat, ~ g1 + g2, mean = "overall.mean"))      # Ordinary -->
<!-- system.time(W(testdat, ~ g1 + g2, ~ w, mean = "overall.mean")) # Weighted -->
<!-- # Centering on both grouping variables simultaneously -->
<!-- # Can't be done in dplyr or data.table at all! -->
<!-- system.time(HDW(testdat, ~ qF(g1) + qF(g2), variable.wise = TRUE))        # Ordinary -->
<!-- system.time(HDW(testdat, ~ qF(g1) + qF(g2), w = w, variable.wise = TRUE)) # Weighted -->
<!-- # Proportions -->
<!-- system.time(testdat %>% group_by(g1,g2) %>% mutate_all(function(x) x/sum(x, na.rm = TRUE))) -->
<!-- system.time(testdat[, lapply(.SD, function(x) x/sum(x, na.rm = TRUE)), keyby = c("g1","g2")]) -->
<!-- system.time(fsum(get_vars(testdat, -ind), get_vars(testdat, ind), TRA = "/")) -->
<!-- # Scaling -->
<!-- system.time(testdat %>% group_by(g1,g2) %>% mutate_all(function(x) x/sd(x, na.rm = TRUE))) -->
<!-- system.time(testdat[, lapply(.SD, function(x) x/sd(x, na.rm = TRUE)), keyby = c("g1","g2")]) -->
<!-- system.time(fsd(get_vars(testdat, -ind), get_vars(testdat, ind), TRA = "/")) -->
<!-- system.time(fsd(get_vars(testdat, -ind), get_vars(testdat, ind), w, "/")) # Weighted Scaling. Need a weighted sd to do in dplyr or data.table -->
<!-- # Scaling and centering (i.e. standardizing) -->
<!-- system.time(testdat %>% group_by(g1,g2) %>% mutate_all(function(x) (x - mean.default(x, na.rm = TRUE))/sd(x, na.rm = TRUE))) -->
<!-- system.time(testdat[, lapply(.SD, function(x) (x - mean(x, na.rm = TRUE))/sd(x, na.rm = TRUE)), keyby = c("g1","g2")]) -->
<!-- system.time(STD(testdat, ~ g1 + g2)) -->
<!-- system.time(STD(testdat, ~ g1 + g2, ~ w))  # Weighted standardizing: Also difficult to do in dplyr or data.table -->
<!-- # Replacing data with any ststistic, here the sum: -->
<!-- system.time(testdat %>% group_by(g1,g2) %>% mutate_all(sum, na.rm = TRUE)) -->
<!-- system.time(testdat[, setdiff(names(testdat), c("g1","g2")) := lapply(.SD, sum, na.rm = TRUE), keyby = c("g1","g2")]) -->
<!-- system.time(fsum(get_vars(testdat, -ind), get_vars(testdat, ind), TRA = "replace_fill")) # dplyr and data.table also fill missing values. -->
<!-- system.time(fsum(get_vars(testdat, -ind), get_vars(testdat, ind), TRA = "replace")) # This preserves missing values, and is not easily implemented in dplyr or data.table -->
<!-- ``` -->
<!-- The message is clear: *collapse* outperforms *dplyr* and *data.table* both in scope and speed when it comes to grouped and / or weighted transformations of data. This capacity of *collapse* should make it attractive to econometricians and people programming with complex panel data. In the '*collapse* and *plm*' vignette I provide a programming example by implementing a more general case of the Hausman and Taylor (1981) estimator with two levels of fixed effects, as well as further benchmarks. -->
<!-- <!-- This capacity with `B` and `W` can be extremely useful to implement complex fixed-effects and instrumental-variables procedures (Like Hausman-Taylor 1985 etc.) not implemented in standard packages. Bootstrapping can be used to obtain proper standard errors. `fbetween / B` and `fwithin / W` are also orders of magnitudes faster than implementations in standard packages - for large problems. The code below shows the time required to average / center 1 Million observations in 100,000 groups:  -->
<!-- <!-- ````{r} -->
<!-- <!-- x <- abs(1000*rnorm(1e6))+100 -->
<!-- <!-- f <- qF(sample.int(1e5, 1e6, replace = TRUE), na.exclude = FALSE) -->
<!-- <!-- system.time(ave(x, f)) # Base R equivalent of fbetween / B -->
<!-- <!-- system.time(B(x, f)) -->
<!-- <!-- system.time(W(x, f)) -->
<!-- <!-- ``` -->
<!-- ### Time-Computation Benchmarks -->
<!-- Below I provide some benchmarks for lags, differences and growth rates on panel data. I will run microbenchmarks on the `wlddev` dataset. benchmarks on larger panels are already provided in the other vignettes. Again I compare *collapse* to *dplyr* and *data.table*: -->
<!-- ```{r, eval=RUNBENCH} -->
<!-- # We have a balanced panel of 216 countries, each observed for 59 years -->
<!-- descr(wlddev, cols = c("iso3c", "year")) -->
<!-- # 1 Panel-Lag -->
<!-- suppressMessages( -->
<!-- microbenchmark(dplyr_not_ordered = wlddev %>% group_by(iso3c) %>% select_at(9:12) %>% mutate_all(lag), -->
<!--                dplyr_ordered = wlddev %>% arrange(iso3c,year) %>% group_by(iso3c) %>% select_at(9:12) %>% mutate_all(lag), -->
<!--                data.table_not_ordered = dtwlddev[, shift(.SD), keyby = iso3c, .SDcols = 9:12], -->
<!--                data.table_ordered = dtwlddev[order(year), shift(.SD), keyby = iso3c, .SDcols = 9:12], -->
<!--                collapse_not_ordered = L(wlddev, 1, ~iso3c, cols = 9:12), -->
<!--                collapse_ordered = L(wlddev, 1, ~iso3c, ~year, cols = 9:12), -->
<!--                subtract_from_CNO = message("Panel-lag computed without timevar: Assuming ordered data"))) -->
<!-- # Sequence of 1 lead and 3 lags: Not possible in dplyr -->
<!-- microbenchmark(data.table_not_ordered = dtwlddev[, shift(.SD, -1:3), keyby = iso3c, .SDcols = 9:12], -->
<!--                data.table_ordered = dtwlddev[order(year), shift(.SD, -1:3), keyby = iso3c, .SDcols = 9:12], -->
<!--                collapse_ordered = L(wlddev, -1:3, ~iso3c, ~year, cols = 9:12)) -->
<!-- # 1 Panel-difference -->
<!-- microbenchmark(dplyr_not_ordered = wlddev %>% group_by(iso3c) %>% select_at(9:12) %>% mutate_all(function(x) x - lag(x)), -->
<!--                dplyr_ordered = wlddev %>% arrange(iso3c,year) %>% group_by(iso3c) %>% select_at(9:12) %>% mutate_all(function(x) x - lag(x)), -->
<!--                data.table_not_ordered = dtwlddev[, lapply(.SD, function(x) x - shift(x)), keyby = iso3c, .SDcols = 9:12], -->
<!--                data.table_ordered = dtwlddev[order(year), lapply(.SD, function(x) x - shift(x)), keyby = iso3c, .SDcols = 9:12], -->
<!--                collapse_ordered = D(wlddev, 1, 1, ~iso3c, ~year, cols = 9:12)) -->
<!-- # Iterated Panel-Difference: Not straightforward in dplyr or data.table -->
<!-- microbenchmark(collapse_ordered = D(wlddev, 1, 2, ~iso3c, ~year, cols = 9:12)) -->
<!-- # Sequence of Lagged/Leaded Differences: Not straightforward in dplyr or data.table -->
<!-- microbenchmark(collapse_ordered = D(wlddev, -1:3, 1, ~iso3c, ~year, cols = 9:12)) -->
<!-- # Sequence of Lagged/Leaded and Iterated Differences: Not straightforward in dplyr or data.table -->
<!-- microbenchmark(collapse_ordered = D(wlddev, -1:3, 1:2, ~iso3c, ~year, cols = 9:12)) -->
<!-- # The same applies to growth rates or log-differences. -->
<!-- microbenchmark(collapse_ordered_growth = G(wlddev, 1, 1, ~iso3c, ~year, cols = 9:12), -->
<!--                collapse_ordered_logdiff = G(wlddev, 1, 1, ~iso3c, ~year, cols = 9:12, logdiff = TRUE)) -->
<!-- ``` -->
<!-- The results are similar to the grouped transformations: *collapse* substantially facilitates and speeds up these complex operations in R. Again *plm* classes are very useful to avoid having to specify panel-identifiers all the time. See the '*collapse* and *plm*' vignette for more details. -->
</div>

  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Sebastian Krantz.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.9000.</p>
</div>

    </footer>
</div>





  </body>
</html>
